<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Sistema de Inventario - Liceo RÃ­os de Chile</title>
    <style>
        @import url("https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap");

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary: #1e7e34;
            --primary-dark: #155724;
            --primary-light: #28a745;
            --secondary: #2d5a3d;
            --accent: #34995e;
            --success: #28a745;
            --warning: #f39c12;
            --danger: #e74c3c;
            --info: #3498db;
            --dark: #2c3e50;
            --light: #ecf0f1;
            --white: #ffffff;
            --gray-100: #f8f9fa;
            --gray-200: #e9ecef;
            --gray-300: #dee2e6;
            --gray-400: #ced4da;
            --gray-500: #adb5bd;
            --gray-600: #6c757d;
            --gray-700: #495057;
            --gray-800: #343a40;
            --gray-900: #212529;
        }

        body {
            font-family: "Inter", -apple-system, BlinkMacSystemFont, sans-serif;
            background: linear-gradient(135deg,
                    var(--primary) 0%,
                    var(--primary-dark) 100%);
            min-height: 100vh;
            color: var(--gray-800);
            line-height: 1.6;
        }

        /* Loading Spinner */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.9);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        .loading-text {
            margin-top: 1rem;
            color: var(--gray-600);
            font-weight: 500;
        }

        /* Connection Status */
        .connection-status {
            position: fixed;
            bottom: 20px;
            right: 20px;
            padding: 0.5rem 1rem;
            border-radius: 2rem;
            font-size: 0.75rem;
            font-weight: 600;
            z-index: 1000;
            transition: all 0.3s ease;
        }

        .connection-online {
            background: rgba(39, 174, 96, 0.9);
            color: white;
        }

        .connection-offline {
            background: rgba(231, 76, 60, 0.9);
            color: white;
        }

        .connection-syncing {
            background: rgba(243, 156, 18, 0.9);
            color: white;
        }

        /* Email Status */
        .email-status {
            position: fixed;
            bottom: 70px;
            right: 20px;
            padding: 0.5rem 1rem;
            border-radius: 2rem;
            font-size: 0.75rem;
            font-weight: 600;
            z-index: 1000;
            transition: all 0.3s ease;
        }

        .email-ready {
            background: rgba(39, 174, 96, 0.9);
            color: white;
        }

        .email-sending {
            background: rgba(243, 156, 18, 0.9);
            color: white;
        }

        .email-error {
            background: rgba(231, 76, 60, 0.9);
            color: white;
        }

        /* Utility Classes */
        .shadow-sm {
            box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1),
                0 1px 2px 0 rgba(0, 0, 0, 0.06);
        }

        .shadow {
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1),
                0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }

        .shadow-lg {
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1),
                0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }

        .shadow-xl {
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1),
                0 10px 10px -5px rgba(0, 0, 0, 0.04);
        }

        .rounded {
            border-radius: 0.375rem;
        }

        .rounded-lg {
            border-radius: 0.5rem;
        }

        .rounded-xl {
            border-radius: 0.75rem;
        }

        .rounded-2xl {
            border-radius: 1rem;
        }

        .hidden {
            display: none !important;
        }

        /* Login Screen */
        .login-container {
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 2rem;
            position: relative;
            overflow: hidden;
        }

        .login-container::before {
            content: "";
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: radial-gradient(circle at 20% 50%,
                    rgba(255, 255, 255, 0.1) 0%,
                    transparent 50%),
                radial-gradient(circle at 80% 20%,
                    rgba(255, 255, 255, 0.1) 0%,
                    transparent 50%),
                radial-gradient(circle at 40% 80%,
                    rgba(255, 255, 255, 0.1) 0%,
                    transparent 50%);
            pointer-events: none;
        }

        .login-card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            border-radius: 1.5rem;
            padding: 3rem;
            width: 100%;
            max-width: 480px;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
            border: 1px solid rgba(255, 255, 255, 0.2);
            position: relative;
            animation: slideUp 0.6s ease-out;
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .login-header {
            text-align: center;
            margin-bottom: 2.5rem;
        }

        .logo {
            width: 80px;
            height: 80px;
            margin: 0 auto 1.5rem;
            background: url("LRC.png") center/contain no-repeat;
            background-color: white;
            padding: 8px;
            box-shadow: 0 4px 12px rgba(30, 126, 52, 0.2);
            animation: logoFloat 3s ease-in-out infinite;
        }

        @keyframes logoFloat {

            0%,
            100% {
                transform: translateY(0px);
            }

            50% {
                transform: translateY(-5px);
            }
        }

        .login-title {
            font-size: 1.875rem;
            font-weight: 800;
            color: var(--gray-800);
            margin-bottom: 0.5rem;
        }

        .login-subtitle {
            color: var(--gray-600);
            font-size: 0.875rem;
            font-weight: 500;
        }

        .user-type-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
            margin-bottom: 2rem;
        }

        .user-type-card {
            background: var(--gray-100);
            border: 2px solid transparent;
            border-radius: 1rem;
            padding: 1.5rem;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .user-type-card:hover {
            background: var(--gray-200);
            transform: translateY(-2px);
        }

        .user-type-card.active {
            background: var(--primary);
            color: white;
            border-color: var(--primary-dark);
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(30, 126, 52, 0.3);
        }

        .user-type-card.full-width {
            grid-column: 1 / -1;
        }

        .user-type-icon {
            font-size: 2rem;
            margin-bottom: 0.75rem;
            display: block;
        }

        .user-type-title {
            font-weight: 600;
            margin-bottom: 0.25rem;
        }

        .user-type-desc {
            font-size: 0.75rem;
            opacity: 0.8;
        }

        .form-group {
            margin-bottom: 1.5rem;
        }

        .form-label {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-bottom: 0.75rem;
            font-weight: 600;
            color: var(--gray-700);
            font-size: 0.875rem;
            flex-wrap: wrap;
        }

        .help-icon {
            width: 24px;
            height: 24px;
            background: var(--primary);
            color: white;
            border-radius: 50%;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            font-weight: bold;
            cursor: pointer;
            position: relative;
            transition: all 0.3s ease;
            border: none;
            margin-left: 8px;
            flex-shrink: 0;
            vertical-align: middle;
        }

        .help-icon:hover {
            background: var(--primary-dark);
            transform: scale(1.1);
            z-index: 10;
        }

        /* Info Modal Styles */
        .info-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            z-index: 2500;
            animation: modalFadeIn 0.3s ease-out;
        }

        .info-modal-content {
            background: white;
            border-radius: 1rem;
            margin: 2% auto;
            padding: 0;
            width: 90%;
            max-width: 600px;
            max-height: 90vh;
            overflow-y: auto;
            position: relative;
            animation: modalSlideUp 0.3s ease-out;
            box-shadow: 0 25px 50px rgba(0, 0, 0, 0.3);
        }

        .info-modal-header {
            background: var(--primary);
            color: white;
            padding: 1.5rem;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .info-modal-title {
            font-size: 1.25rem;
            font-weight: 700;
            margin: 0;
        }

        .info-modal-close {
            background: none;
            border: none;
            color: white;
            font-size: 1.5rem;
            cursor: pointer;
            padding: 0.5rem;
            border-radius: 0.375rem;
            transition: background 0.3s ease;
        }

        .info-modal-close:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        .info-modal-body {
            padding: 2rem;
            max-height: 70vh;
            overflow-y: auto;
        }

        .info-question {
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--gray-800);
            margin-bottom: 1rem;
        }

        .info-description {
            color: var(--gray-600);
            line-height: 1.6;
            margin-bottom: 1.5rem;
        }

        .info-examples {
            margin-bottom: 1.5rem;
        }

        .info-examples h4 {
            font-weight: 600;
            color: var(--gray-800);
            margin-bottom: 1rem;
        }

        .example-list {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .example-list li {
            background: var(--gray-50);
            padding: 0.75rem 1rem;
            border-radius: 0.5rem;
            margin-bottom: 0.5rem;
            font-family: "Courier New", monospace;
            font-size: 0.9rem;
            border-left: 4px solid var(--primary);
        }

        .info-usage {
            background: var(--gray-50);
            border-radius: 0.75rem;
            padding: 1.5rem;
        }

        .info-usage h4 {
            font-weight: 600;
            color: var(--gray-800);
            margin-bottom: 1rem;
        }

        .usage-list {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .usage-list li {
            display: flex;
            align-items: flex-start;
            gap: 0.75rem;
            margin-bottom: 0.75rem;
            color: var(--gray-700);
            line-height: 1.5;
        }

        .usage-list li::before {
            content: "â¢";
            color: var(--primary);
            font-weight: bold;
            font-size: 1.2rem;
        }

        /* Location Input Enhanced */
        .location-grid {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 1rem;
            margin-bottom: 1rem;
        }

        .location-field {
            position: relative;
        }

        .location-field label {
            display: block;
            font-weight: 600;
            color: var(--gray-700);
            margin-bottom: 0.5rem;
            font-size: 0.875rem;
        }

        .location-input {
            width: 100%;
            padding: 0.875rem 1rem;
            border: 2px solid var(--gray-300);
            border-radius: 0.75rem;
            font-size: 1rem;
            transition: all 0.3s ease;
            background: white;
            text-align: center;
            font-weight: 600;
        }

        .location-input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(30, 126, 52, 0.1);
        }

        .location-preview {
            background: var(--gray-50);
            border: 2px dashed var(--gray-300);
            border-radius: 0.75rem;
            padding: 1rem;
            text-align: center;
            margin-top: 1rem;
        }

        .location-preview-value {
            font-size: 1rem;
            font-weight: 600;
            color: var(--primary);
            font-family: "Inter", sans-serif;
        }

        .form-input {
            width: 100%;
            padding: 0.875rem 1rem;
            border: 2px solid var(--gray-300);
            border-radius: 0.75rem;
            font-size: 1rem;
            transition: all 0.3s ease;
            background: white;
        }

        .form-input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(30, 126, 52, 0.1);
        }

        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            padding: 0.875rem 1.5rem;
            font-size: 1rem;
            font-weight: 600;
            border: none;
            border-radius: 0.75rem;
            cursor: pointer;
            transition: all 0.3s ease;
            text-decoration: none;
            position: relative;
            overflow: hidden;
        }

        .btn-primary {
            background: var(--primary);
            color: white;
            width: 100%;
        }

        .btn-primary:hover {
            background: var(--primary-dark);
            transform: translateY(-1px);
            box-shadow: 0 10px 25px rgba(30, 126, 52, 0.3);
        }

        .btn-secondary {
            background: var(--gray-600);
            color: white;
        }

        .btn-secondary:hover {
            background: var(--gray-700);
        }

        .btn-success {
            background: var(--success);
            color: white;
        }

        .btn-success:hover {
            background: #229954;
        }

        .btn-danger {
            background: var(--danger);
            color: white;
        }

        .btn-danger:hover {
            background: #c0392b;
        }

        .btn-warning {
            background: var(--warning);
            color: white;
        }

        .btn-warning:hover {
            background: #d68910;
        }

        /* Dashboard */
        .dashboard {
            display: none;
            min-height: 100vh;
            animation: fadeIn 0.5s ease-out;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
            }

            to {
                opacity: 1;
            }
        }

        .header {
            background: white;
            color: var(--gray-800);
            padding: 1.5rem 2rem;
            position: sticky;
            top: 0;
            z-index: 50;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            border-bottom: 3px solid var(--primary);
        }

        .header-content {
            max-width: 1400px;
            margin: 0 auto;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 1.5rem;
        }

        .header-logo {
            width: 60px;
            height: 60px;
            background: url("LRC.png") center/contain no-repeat;
            background-color: white;
            padding: 8px;
            box-shadow: 0 4px 12px rgba(30, 126, 52, 0.2);
        }

        .header-info h1 {
            font-size: 1.75rem;
            font-weight: 700;
            color: var(--gray-800);
            margin-bottom: 0.25rem;
        }

        .header-subtitle {
            font-size: 0.9rem;
            color: var(--primary);
            font-weight: 500;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 1.5rem;
            position: relative;
        }

        .user-badge {
            background: var(--primary);
            color: white;
            padding: 0.6rem 1.2rem;
            border-radius: 2rem;
            font-size: 0.875rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .logout-btn {
            background: var(--gray-600);
            color: white;
            padding: 0.6rem 1.2rem;
            border: none;
            border-radius: 0.5rem;
            font-size: 0.875rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .logout-btn:hover {
            background: var(--gray-700);
            transform: translateY(-1px);
        }

        /* Notification Bell Styles */
        .notification-bell {
            position: relative;
            background: var(--primary);
            color: white;
            padding: 0.6rem;
            border-radius: 50%;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            width: 45px;
            height: 45px;
            margin-right: 1rem;
        }

        .notification-bell:hover {
            background: var(--primary-dark);
            transform: scale(1.05);
        }

        .bell-icon {
            font-size: 1.2rem;
        }

        .notification-count {
            position: absolute;
            top: -5px;
            right: -5px;
            background: var(--danger);
            color: white;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            font-size: 0.7rem;
            font-weight: bold;
            display: flex;
            align-items: center;
            justify-content: center;
            min-width: 20px;
            border: 2px solid white;
        }

        .notification-count.hidden {
            display: none;
        }

        /* Notification Dropdown */
        .notification-dropdown {
            position: fixed;
            top: 70px;
            right: 0;
            background: white;
            border-radius: 1rem;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.15);
            width: 420px;
            max-height: 500px;
            overflow: hidden;
            z-index: 1000;
            border: 1px solid #e2e8f0;
            transform: translateY(-10px);
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
        }

        .notification-dropdown.active {
            transform: translateY(0);
            opacity: 1;
            visibility: visible;
        }

        .notification-header {
            background: var(--primary);
            color: white;
            padding: 1rem 1.5rem;
            border-radius: 1rem 1rem 0 0;
            font-weight: 600;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .notification-header h4 {
            margin: 0;
            font-size: 1rem;
        }

        .clear-notifications {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: white;
            padding: 0.3rem 0.6rem;
            border-radius: 0.5rem;
            font-size: 0.8rem;
            cursor: pointer;
            transition: background 0.3s ease;
        }

        .clear-notifications:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        .notification-list {
            max-height: 400px;
            overflow-y: auto;
        }

        .notification-item {
            padding: 1rem 1.5rem;
            border-bottom: 1px solid var(--gray-100);
            transition: background 0.3s ease;
        }

        .notification-item:hover {
            background: var(--gray-50);
        }

        .notification-item:last-child {
            border-bottom: none;
        }

        .notification-item.overdue {
            border-left: 4px solid var(--danger);
            background: rgba(231, 76, 60, 0.02);
        }

        .notification-item.warning {
            border-left: 4px solid var(--warning);
            background: rgba(243, 156, 18, 0.02);
        }

        .notification-icon {
            font-size: 1.2rem;
            margin-right: 0.8rem;
        }

        .notification-content {
            flex: 1;
        }

        .notification-title {
            font-weight: 600;
            color: var(--gray-800);
            margin-bottom: 0.3rem;
            font-size: 0.9rem;
        }

        .notification-message {
            color: var(--gray-600);
            font-size: 0.85rem;
            line-height: 1.4;
        }

        .notification-time {
            color: var(--gray-500);
            font-size: 0.75rem;
            margin-top: 0.3rem;
        }

        .no-notifications {
            padding: 2rem 1.5rem;
            text-align: center;
            color: var(--gray-500);
        }

        .no-notifications-icon {
            font-size: 3rem;
            margin-bottom: 1rem;
            opacity: 0.5;
        }

        .welcome-banner {
            background: linear-gradient(135deg,
                    var(--primary) 0%,
                    var(--primary-dark) 100%);
            color: white;
            padding: 3rem 2rem;
            border-radius: 1.5rem;
            margin-bottom: 2rem;
            text-align: center;
            position: relative;
            overflow: hidden;
        }

        .welcome-banner::before {
            content: "";
            position: absolute;
            top: -50%;
            right: -20%;
            width: 300px;
            height: 300px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 50%;
        }

        .welcome-banner::after {
            content: "";
            position: absolute;
            bottom: -30%;
            left: -10%;
            width: 200px;
            height: 200px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 50%;
        }

        .welcome-content {
            position: relative;
            z-index: 2;
        }

        .welcome-title {
            font-size: 2.5rem;
            font-weight: 800;
            margin-bottom: 0.5rem;
        }

        .welcome-subtitle {
            font-size: 1.1rem;
            opacity: 0.9;
        }

        /* User Info Card Enhanced */
        .user-info-card {
            background: white;
            border-radius: 1.5rem;
            padding: 2rem;
            margin-bottom: 2rem;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            border: 1px solid var(--gray-100);
            display: grid;
            grid-template-columns: auto 1fr auto;
            align-items: center;
            gap: 2rem;
        }

        .user-avatar {
            width: 80px;
            height: 80px;
            background: linear-gradient(135deg,
                    var(--primary) 0%,
                    var(--primary-light) 100%);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2rem;
            color: white;
            font-weight: 800;
        }

        .user-details {
            flex: 1;
        }

        .user-details h3 {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--gray-800);
            margin-bottom: 0.25rem;
        }

        .user-details .user-email {
            color: var(--gray-600);
            margin-bottom: 1rem;
            font-size: 0.95rem;
        }

        .permissions-label {
            font-weight: 600;
            color: var(--gray-700);
            margin-bottom: 0.75rem;
            display: block;
            font-size: 0.875rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .permissions-grid {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
        }

        .permission-badge {
            background: var(--primary);
            color: white;
            padding: 0.4rem 0.8rem;
            border-radius: 1.5rem;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.3px;
        }

        .user-actions {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
            align-items: end;
        }

        .user-status {
            background: var(--success);
            color: white;
            padding: 0.4rem 1rem;
            border-radius: 1.5rem;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
        }

        .session-time {
            color: var(--gray-500);
            font-size: 0.75rem;
        }

        /* Dashboard Navigation Cards */
        .dashboard-navigation {
            margin-bottom: 3rem;
        }

        .nav-title {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--gray-800);
            margin-bottom: 1.5rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .dashboard-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 1.5rem;
        }

        .dashboard-card {
            background: white;
            border-radius: 1.5rem;
            padding: 2.5rem;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.08);
            border: 2px solid var(--gray-100);
            position: relative;
            overflow: hidden;
        }

        .dashboard-card::before {
            content: "";
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: var(--primary);
            transform: scaleX(0);
            transition: transform 0.3s ease;
        }

        .dashboard-card:hover::before {
            transform: scaleX(1);
        }

        .dashboard-card:hover {
            transform: translateY(-8px);
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.15);
            border-color: var(--primary);
        }

        .dashboard-card-icon {
            width: 80px;
            height: 80px;
            background: linear-gradient(135deg,
                    var(--primary) 0%,
                    var(--primary-light) 100%);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 1.5rem;
            font-size: 2rem;
            color: white;
            transition: transform 0.3s ease;
        }

        .dashboard-card:hover .dashboard-card-icon {
            transform: scale(1.1);
        }

        .dashboard-card-title {
            font-size: 1.25rem;
            font-weight: 700;
            color: var(--gray-800);
            margin-bottom: 0.75rem;
        }

        .dashboard-card-desc {
            color: var(--gray-600);
            font-size: 0.95rem;
            line-height: 1.5;
        }

        /* Quick Stats Section */
        .quick-stats-section {
            margin-top: 2rem;
        }

        .section-title {
            font-size: 1.25rem;
            font-weight: 700;
            color: var(--gray-800);
            margin-bottom: 1.5rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1.5rem;
        }

        .stat-card {
            background: linear-gradient(135deg,
                    var(--primary) 0%,
                    var(--primary-dark) 100%);
            color: white;
            padding: 2rem;
            border-radius: 1rem;
            position: relative;
            overflow: hidden;
            transition: transform 0.3s ease;
        }

        .stat-card:hover {
            transform: translateY(-4px);
        }

        .stat-card::before {
            content: "";
            position: absolute;
            top: 0;
            right: 0;
            width: 100px;
            height: 100px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 50%;
            transform: translate(30px, -30px);
        }

        .stat-icon {
            font-size: 2.5rem;
            margin-bottom: 1rem;
            opacity: 0.9;
        }

        .stat-value {
            font-size: 2.5rem;
            font-weight: 800;
            margin-bottom: 0.5rem;
        }

        .stat-label {
            font-size: 0.875rem;
            font-weight: 500;
            opacity: 0.9;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 2rem;
        }

        .navigation {
            background: white;
            border-radius: 1rem;
            padding: 0.5rem;
            margin-bottom: 2rem;
            display: flex;
            gap: 0.5rem;
            box-shadow: var(--shadow);
            overflow-x: auto;
        }

        .nav-item {
            padding: 0.875rem 1.5rem;
            border-radius: 0.75rem;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
            white-space: nowrap;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .nav-item:hover {
            background: var(--gray-100);
        }

        .nav-item.active {
            background: var(--primary);
            color: white;
            box-shadow: 0 4px 12px rgba(30, 126, 52, 0.3);
        }

        .content-card {
            background: white;
            border-radius: 1rem;
            padding: 2rem;
            box-shadow: var(--shadow);
            min-height: 500px;
        }

        .content-title {
            font-size: 1.875rem;
            font-weight: 800;
            color: var(--gray-800);
            margin-bottom: 2rem;
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        /* Table */
        .table-container {
            background: white;
            border-radius: 1rem;
            overflow: hidden;
            box-shadow: var(--shadow);
        }

        .table-header {
            background: var(--gray-50);
            padding: 1.5rem;
            border-bottom: 1px solid var(--gray-200);
        }

        .search-input {
            width: 100%;
            max-width: 400px;
            padding: 0.75rem 1rem;
            border: 1px solid var(--gray-300);
            border-radius: 0.5rem;
            font-size: 0.875rem;
        }

        .search-input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(30, 126, 52, 0.1);
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th,
        td {
            padding: 1rem 1.5rem;
            text-align: left;
            border-bottom: 1px solid var(--gray-200);
        }

        th {
            background: var(--gray-50);
            font-weight: 600;
            color: var(--gray-700);
            font-size: 0.875rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        tr:hover {
            background: var(--gray-50);
        }

        .status-badge {
            padding: 0.25rem 0.75rem;
            border-radius: 9999px;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .status-available {
            background: rgba(39, 174, 96, 0.1);
            color: var(--success);
        }

        .status-in-use {
            background: rgba(52, 152, 219, 0.1);
            color: #3498db;
        }

        .status-maintenance {
            background: rgba(243, 156, 18, 0.1);
            color: var(--warning);
        }

        .status-unavailable {
            background: rgba(231, 76, 60, 0.1);
            color: var(--danger);
        }

        /* Management Section - Compact Design */
        .management-header {
            background: white;
            border-radius: 1rem;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.08);
            text-align: center;
            border: 1px solid var(--gray-100);
        }

        .management-title {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--gray-800);
            margin-bottom: 0.5rem;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
        }

        .management-subtitle {
            color: var(--gray-600);
            font-size: 0.9rem;
            line-height: 1.5;
        }

        /* Management Info Cards - Compact */
        .management-info {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 1.5rem;
        }

        .info-card {
            background: white;
            border-radius: 0.75rem;
            padding: 1rem;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
            border: 1px solid var(--gray-100);
            text-align: center;
        }

        .info-number {
            font-size: 1.5rem;
            font-weight: 800;
            color: var(--primary);
            display: block;
            margin-bottom: 0.25rem;
        }

        .info-label {
            color: var(--gray-600);
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.3px;
        }

        /* Action Grid - Compact */
        .action-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 1.2rem;
            margin-bottom: 2rem;
        }

        .action-card {
            background: white;
            border-radius: 1rem;
            padding: 1.5rem;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.08);
            border: 2px solid var(--gray-100);
            position: relative;
            overflow: hidden;
        }

        .action-card::before {
            content: "";
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: linear-gradient(90deg,
                    var(--primary) 0%,
                    var(--primary-light) 100%);
            transform: scaleX(0);
            transition: transform 0.3s ease;
        }

        .action-card:hover::before {
            transform: scaleX(1);
        }

        .action-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 30px rgba(0, 0, 0, 0.12);
            border-color: var(--primary);
        }

        .action-icon {
            width: 60px;
            height: 60px;
            background: linear-gradient(135deg,
                    var(--primary) 0%,
                    var(--primary-light) 100%);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 1rem;
            font-size: 1.8rem;
            color: white;
            transition: all 0.3s ease;
        }

        .action-card:hover .action-icon {
            transform: scale(1.1);
            box-shadow: 0 8px 20px rgba(30, 126, 52, 0.3);
        }

        .action-title {
            font-size: 1.1rem;
            font-weight: 700;
            margin-bottom: 0.5rem;
            color: var(--gray-800);
        }

        .action-desc {
            font-size: 0.85rem;
            color: var(--gray-600);
            line-height: 1.4;
            margin-bottom: 1rem;
        }

        .action-features {
            list-style: none;
            padding: 0;
            margin: 0;
            display: flex;
            flex-direction: column;
            gap: 0.3rem;
        }

        .action-features li {
            color: var(--gray-500);
            font-size: 0.75rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .action-features li::before {
            content: "â";
            color: var(--primary);
            font-weight: bold;
        }

        /* Operation Result - Compact */
        .operation-result-container {
            margin-top: 1.5rem;
        }

        .result-card {
            background: white;
            border-radius: 1rem;
            padding: 1.5rem;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.08);
            border-left: 4px solid var(--primary);
        }

        /* Special Action Cards */
        .action-card.primary {
            border-color: var(--primary);
            background: linear-gradient(145deg,
                    rgba(30, 126, 52, 0.02) 0%,
                    rgba(30, 126, 52, 0.05) 100%);
        }

        .action-card.warning {
            border-color: var(--warning);
        }

        .action-card.warning .action-icon {
            background: linear-gradient(135deg, var(--warning) 0%, #e67e22 100%);
        }

        .action-card.danger {
            border-color: var(--danger);
        }

        .action-card.danger .action-icon {
            background: linear-gradient(135deg, var(--danger) 0%, #c0392b 100%);
        }

        /* Alerts */
        .alert {
            padding: 1rem 1.5rem;
            border-radius: 0.75rem;
            margin-bottom: 1.5rem;
            display: flex;
            align-items: flex-start;
            gap: 0.75rem;
        }

        .alert-warning {
            background: rgba(243, 156, 18, 0.1);
            border: 1px solid rgba(243, 156, 18, 0.2);
            color: #b7791f;
        }

        .alert-success {
            background: rgba(39, 174, 96, 0.1);
            border: 1px solid rgba(39, 174, 96, 0.2);
            color: #196f3d;
        }

        .alert-danger {
            background: rgba(231, 76, 60, 0.1);
            border: 1px solid rgba(231, 76, 60, 0.2);
            color: #922b21;
        }

        .alert-info {
            background: rgba(52, 152, 219, 0.1);
            border: 1px solid rgba(52, 152, 219, 0.2);
            color: #1b4f72;
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1500;
            animation: modalFadeIn 0.3s ease-out;
        }

        @keyframes modalFadeIn {
            from {
                opacity: 0;
            }

            to {
                opacity: 1;
            }
        }

        .modal-content {
            background: white;
            border-radius: 1rem;
            margin: 5% auto;
            padding: 2rem;
            width: 90%;
            max-width: 600px;
            max-height: 80vh;
            overflow-y: auto;
            position: relative;
            animation: modalSlideUp 0.3s ease-out;
        }

        @keyframes modalSlideUp {
            from {
                opacity: 0;
                transform: translateY(50px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .modal-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 1.5rem;
        }

        .modal-title {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--gray-800);
        }

        .close-btn {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: var(--gray-500);
            padding: 0.5rem;
            border-radius: 0.375rem;
            transition: all 0.3s ease;
        }

        .close-btn:hover {
            background: var(--gray-100);
            color: var(--gray-700);
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
        }

        /* Export Section */
        .export-section {
            background: var(--gray-50);
            border-radius: 1rem;
            padding: 1.5rem;
            margin-bottom: 2rem;
            display: flex;
            gap: 1rem;
        }

        /* Advanced Statistics Styles */
        .stats-header {
            background: linear-gradient(135deg,
                    var(--primary) 0%,
                    var(--primary-dark) 100%);
            color: white;
            padding: 2rem;
            border-radius: 1rem;
            margin-bottom: 2rem;
            text-align: center;
        }

        .stats-header h2 {
            font-size: 2.5rem;
            font-weight: 800;
            margin-bottom: 0.5rem;
        }

        .stats-header p {
            font-size: 1.1rem;
            opacity: 0.9;
        }

        .stats-overview {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1.5rem;
            margin-bottom: 3rem;
        }

        .overview-card {
            background: white;
            border-radius: 1rem;
            padding: 2rem;
            text-align: center;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
            border: 1px solid var(--gray-200);
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .overview-card::before {
            content: "";
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: var(--primary);
        }

        .overview-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.15);
        }

        .overview-icon {
            width: 60px;
            height: 60px;
            background: var(--primary);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 1rem;
            font-size: 1.5rem;
            color: white;
        }

        .overview-number {
            font-size: 2.5rem;
            font-weight: 800;
            color: var(--gray-800);
            margin-bottom: 0.5rem;
        }

        .overview-label {
            color: var(--gray-600);
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            font-size: 0.875rem;
        }

        .charts-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 2rem;
            margin-bottom: 2rem;
        }

        .chart-card {
            background: white;
            border-radius: 1rem;
            padding: 2rem;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
        }

        .chart-title {
            font-size: 1.25rem;
            font-weight: 700;
            color: var(--gray-800);
            margin-bottom: 1.5rem;
            text-align: center;
        }

        .status-chart {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .status-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 1rem;
            border-radius: 0.5rem;
            background: var(--gray-50);
        }

        .status-info {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .status-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
        }

        .status-available {
            background: var(--success);
        }

        .status-in-use {
            background: var(--info);
        }

        .status-maintenance {
            background: var(--warning);
        }

        .status-unavailable {
            background: var(--danger);
        }

        .status-count {
            font-weight: 700;
            font-size: 1.1rem;
            color: var(--gray-800);
        }

        .category-chart {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .category-bar {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .category-info {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .category-name {
            font-weight: 600;
            color: var(--gray-700);
        }

        .category-percentage {
            font-weight: 700;
            color: var(--primary);
        }

        .progress-bar {
            height: 8px;
            background: var(--gray-200);
            border-radius: 4px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg,
                    var(--primary) 0%,
                    var(--primary-light) 100%);
            border-radius: 4px;
            transition: width 1s ease-in-out;
        }

        .insights-section {
            background: white;
            border-radius: 1rem;
            padding: 2rem;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
        }

        .insights-title {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--gray-800);
            margin-bottom: 1.5rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .insight-item {
            display: flex;
            align-items: flex-start;
            gap: 1rem;
            padding: 1rem;
            border-radius: 0.5rem;
            margin-bottom: 1rem;
            background: var(--gray-50);
        }

        .insight-icon {
            width: 40px;
            height: 40px;
            background: var(--primary);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 1.2rem;
            flex-shrink: 0;
        }

        .insight-content h4 {
            font-weight: 600;
            color: var(--gray-800);
            margin-bottom: 0.25rem;
        }

        .insight-content p {
            color: var(--gray-600);
            font-size: 0.9rem;
            line-height: 1.4;
        }

        /* PRÃSTAMOS ACTIVOS - SECCIÃN OPTIMIZADA AL 90% */

        /* Contenedor principal reducido al 90% */
        #content-loans {
            max-width: 95%;
            margin: 0 auto;
            padding: 0 0.5rem;
        }

        /* Header de prÃ©stamos activos */
        #content-loans .content-title {
            font-size: 1.6rem;
            font-weight: 700;
            margin-bottom: 1.5rem;
            color: var(--gray-800);
        }

        /* Botones de recordatorios masivos - Compactos */
        .bulk-reminder-buttons {
            display: flex;
            gap: 1rem;
            flex-wrap: wrap;
            align-items: center;
            margin-bottom: 1.5rem;
        }

        .bulk-reminder-btn {
            padding: 0.7rem 1.3rem !important;
            font-size: 0.9rem !important;
            font-weight: 600 !important;
            border-radius: 0.7rem !important;
            white-space: nowrap;
            transition: all 0.3s ease;
            border: none;
            cursor: pointer;
        }

        .bulk-reminder-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 15px rgba(0, 0, 0, 0.15);
        }

        /* Cards de resumen - MÃ¡s compactas */
        .loans-summary-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 1rem;
            margin-bottom: 2rem;
        }

        .loans-summary-card {
            background: white;
            border-radius: 1rem;
            padding: 1.3rem;
            text-align: center;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.08);
            border: 1px solid var(--gray-100);
            transition: all 0.3s ease;
        }

        .loans-summary-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.12);
        }

        .loans-summary-number {
            font-size: 1.8rem;
            font-weight: 800;
            margin-bottom: 0.4rem;
            display: block;
            line-height: 1;
        }

        .loans-summary-label {
            color: var(--gray-600);
            font-size: 0.8rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.3px;
            line-height: 1.3;
        }

        .loans-summary-total {
            color: var(--primary);
        }

        .loans-summary-upcoming {
            color: var(--warning);
        }

        .loans-summary-overdue {
            color: var(--danger);
        }

        .loans-summary-ontime {
            color: var(--success);
        }

        /* Tabla de prÃ©stamos activos - Optimizada */
        #content-loans .table-container {
            background: white;
            border-radius: 1rem;
            overflow-x: auto;
            overflow-y: visible;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.08);
            margin-bottom: 2rem;
        }

        #content-loans .table-container table {
            min-width: 1200px;
            width: 100%;
        }

        #content-loans .table-header {
            background: var(--gray-50);
            padding: 1.2rem;
            border-bottom: 1px solid var(--gray-200);
        }

        #activeLoansBody {
            font-size: 0.9rem;
        }

        #activeLoansBody tr {
            transition: background-color 0.2s ease;
        }

        #activeLoansBody tr:hover {
            background-color: var(--gray-50);
        }

        /* Celdas especÃ­ficas de la tabla - Compactas */
        .loan-product-cell {
            min-width: 200px;
            max-width: 250px;
            padding: 0.8rem !important;
            width: 20%;
        }

        .loan-borrower-cell {
            min-width: 150px;
            max-width: 180px;
            padding: 0.8rem !important;
            width: 15%;
        }

        .loan-email-cell {
            min-width: 200px;
            max-width: 250px;
            padding: 0.8rem !important;
            word-break: break-word;
            font-size: 0.85rem;
            width: 18%;
        }

        .loan-quantity-cell {
            text-align: center;
            font-weight: bold;
            min-width: 80px;
            max-width: 100px;
            padding: 0.8rem !important;
            width: 8%;
        }

        .loan-date-cell {
            min-width: 110px;
            max-width: 130px;
            font-size: 0.85rem;
            padding: 0.8rem !important;
            width: 12%;
        }

        .loan-status-cell {
            min-width: 160px;
            max-width: 200px;
            text-align: center;
            padding: 0.8rem !important;
            width: 15%;
        }

        /* Estados de prÃ©stamos mejorados */
        .status-overdue {
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% {
                opacity: 1;
            }

            50% {
                opacity: 0.7;
            }

            100% {
                opacity: 1;
            }
        }

        .status-info-text {
            font-size: 0.72rem;
            font-weight: 500;
            margin-top: 0.2rem;
            display: block;
            line-height: 1.2;
        }

        /* Responsive mejorado */
        @media (max-width: 768px) {
            .container {
                padding: 1rem;
            }

            .login-card {
                padding: 2rem;
                margin: 1rem;
            }

            .user-type-grid {
                grid-template-columns: 1fr;
            }

            .header-content {
                flex-direction: column;
                gap: 1rem;
                text-align: center;
            }

            .header-left {
                flex-direction: column;
                text-align: center;
            }

            .navigation {
                overflow-x: auto;
            }

            .stats-grid {
                grid-template-columns: 1fr;
            }

            .stats-overview {
                grid-template-columns: repeat(2, 1fr);
            }

            .charts-grid {
                grid-template-columns: 1fr;
            }

            .action-grid {
                grid-template-columns: 1fr;
            }

            .dashboard-cards {
                grid-template-columns: 1fr;
            }

            .permissions-grid {
                justify-content: center;
            }

            .form-row {
                grid-template-columns: 1fr;
            }

            .modal-content {
                margin: 5% 1rem;
                width: auto;
            }

            .export-section {
                flex-direction: column;
            }

            .stats-header h2 {
                font-size: 2rem;
            }

            .overview-number {
                font-size: 2rem;
            }

            /* Mobile Dashboard */
            .welcome-banner {
                padding: 2rem 1rem;
            }

            .welcome-title {
                font-size: 2rem;
            }

            .user-info-card {
                grid-template-columns: 1fr;
                text-align: center;
                gap: 1.5rem;
            }

            .user-actions {
                align-items: center;
            }

            /* Mobile Notifications */
            .notification-bell {
                width: 40px;
                height: 40px;
                margin-right: 0.5rem;
            }

            .notification-dropdown {
                width: 95vw;
                max-width: 400px;
                max-height: 70vh;
            }

            .notification-item {
                padding: 0.8rem 1rem;
            }

            .notification-message {
                font-size: 0.8rem;
            }

            /* Mobile Management */
            .management-header {
                padding: 1.5rem 1rem;
            }

            .management-title {
                font-size: 1.3rem;
                flex-direction: column;
                gap: 0.3rem;
            }

            .management-info {
                grid-template-columns: repeat(2, 1fr);
            }

            .action-grid {
                grid-template-columns: 1fr;
            }

            .action-card {
                padding: 1.2rem;
            }

            .action-icon {
                width: 50px;
                height: 50px;
                font-size: 1.5rem;
            }

            /* Modals en mÃ³vil */
            .info-modal-content {
                margin: 5% 1rem;
                width: auto;
            }

            .location-grid {
                grid-template-columns: 1fr;
                gap: 1rem;
            }

            .location-input {
                text-align: left;
            }

            /* Tabla en mÃ³vil */
            .table-container {
                overflow-x: auto;
            }

            .table-container table {
                font-size: 0.75rem;
                min-width: 800px;
            }

            .table-container th,
            .table-container td {
                padding: 0.5rem 0.3rem;
                vertical-align: top;
            }

            /* PRÃSTAMOS ACTIVOS EN MÃVIL */
            #content-loans {
                max-width: 95%;
            }

            #content-loans .content-title {
                font-size: 1.3rem;
            }

            .loans-summary-cards {
                grid-template-columns: repeat(2, 1fr);
                gap: 0.6rem;
            }

            .loans-summary-card {
                padding: 1rem;
            }

            .loans-summary-number {
                font-size: 1.5rem;
            }

            .loans-summary-label {
                font-size: 0.75rem;
            }

            .bulk-reminder-buttons {
                flex-direction: column;
                gap: 0.5rem;
                width: 100%;
            }

            .bulk-reminder-btn {
                padding: 0.6rem 1rem !important;
                font-size: 0.8rem !important;
                width: 100%;
            }
        }

        /* Tablets */
        @media (max-width: 1024px) and (min-width: 769px) {
            #content-loans {
                max-width: 92%;
            }

            .table-container table {
                font-size: 0.85rem;
            }

            .bulk-reminder-btn {
                padding: 0.65rem 1.2rem !important;
                font-size: 0.85rem !important;
            }
        }

        /* Sistema de Solicitudes para Visitantes */
        .visitor-request-section {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%);
            color: white;
            padding: 2rem;
            border-radius: 1rem;
            text-align: center;
            margin-bottom: 2rem;
            animation: slideInFromTop 0.6s ease-out;
        }

        @keyframes slideInFromTop {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .visitor-request-section h3 {
            color: white !important;
            margin: 0 0 1rem 0;
            font-size: 1.3rem;
        }

        .visitor-request-section p {
            margin: 0 0 1.5rem 0;
            opacity: 0.9;
            font-size: 0.95rem;
            line-height: 1.4;
        }

        /* VerificaciÃ³n de producto en modal */
        .product-verification {
            margin-top: 1rem;
            padding: 1rem;
            border-radius: 0.5rem;
            border: 2px dashed var(--gray-300);
            font-size: 0.9rem;
            line-height: 1.4;
        }

        .product-found {
            background: rgba(39, 174, 96, 0.1);
            border-color: var(--success);
            color: var(--success);
        }

        .product-not-found {
            background: rgba(231, 76, 60, 0.1);
            border-color: var(--danger);
            color: var(--danger);
        }

        .product-searching {
            background: rgba(243, 156, 18, 0.1);
            border-color: var(--warning);
            color: var(--warning);
        }

        /* Notificaciones de solicitudes */
        .notification-item.request {
            border-left: 4px solid var(--warning);
            background: rgba(243, 156, 18, 0.03);
        }

        .notification-actions {
            margin-top: 1rem;
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
        }

        .btn-small {
            padding: 0.4rem 0.8rem;
            font-size: 0.8rem;
            border-radius: 0.4rem;
        }

        /* Responsive para solicitudes */
        @media (max-width: 768px) {
            .visitor-request-section {
                padding: 1.5rem 1rem;
                margin-bottom: 1.5rem;
            }

            .notification-actions {
                flex-direction: column;
            }

            .btn-small {
                width: 100%;
                justify-content: center;
            }
        }

        /* Estilos para solicitudes mÃºltiples */
        .product-item {
            background: white;
            border: 1px solid var(--gray-200);
            border-radius: 0.75rem;
            padding: 1rem;
            margin-bottom: 0.75rem;
            display: flex;
            align-items: center;
            justify-content: space-between;
            transition: all 0.3s ease;
        }

        .product-item:hover {
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            border-color: var(--primary);
        }

        .product-item-info {
            flex: 1;
            margin-right: 1rem;
        }

        .product-item-name {
            font-weight: 700;
            color: var(--gray-800);
            margin-bottom: 0.25rem;
        }

        .product-item-details {
            font-size: 0.85rem;
            color: var(--gray-600);
            display: flex;
            gap: 1rem;
            flex-wrap: wrap;
        }

        .product-item-remove {
            background: var(--danger);
            color: white;
            border: none;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .product-item-remove:hover {
            background: #c0392b;
            transform: scale(1.1);
        }

        .date-warning {
            background: rgba(243, 156, 18, 0.1);
            border: 1px solid var(--warning);
            color: #b7791f;
            padding: 0.75rem;
            border-radius: 0.5rem;
            margin-top: 0.5rem;
            font-size: 0.85rem;
        }

        .date-valid {
            background: rgba(39, 174, 96, 0.1);
            border: 1px solid var(--success);
            color: #196f3d;
            padding: 0.75rem;
            border-radius: 0.5rem;
            margin-top: 0.5rem;
            font-size: 0.85rem;
        }

        /* SoluciÃ³n simple para alineaciÃ³n de fechas */
        .form-row .form-group {
            vertical-align: top;
        }

        .form-row .form-group .form-label {
            min-height: 2.8rem;
            display: flex;
            align-items: flex-end;
            padding-bottom: 0.2rem;
        }

        .form-row .form-group .form-input[type="date"] {
            height: 3rem;
            vertical-align: top;
        }

        /* EspecÃ­fico para las fechas del modal de solicitud */
        #requestedDate,
        #returnDate {
            height: 3rem !important;
            padding: 0.875rem 1rem !important;
            margin-top: 0 !important;
        }

        /* Estilos para selecciÃ³n de mÃºltiples productos */
        .product-selection-item {
            margin: 0.5rem 0;
            padding: 0.75rem;
            border: 1px solid var(--gray-300);
            border-radius: 0.5rem;
            cursor: pointer;
            transition: all 0.3s ease;
            background: white;
        }

        .product-selection-item:hover {
            border-color: var(--primary);
            background: rgba(30, 126, 52, 0.05);
            transform: translateY(-1px);
        }

        .product-selection-item:active {
            transform: translateY(0);
        }

        .product-selection-name {
            font-weight: 600;
            color: var(--gray-800);
            margin-bottom: 0.25rem;
        }

        .product-selection-details {
            font-size: 0.85rem;
            color: var(--gray-600);
        }

        .search-tip {
            background: rgba(30, 126, 52, 0.1);
            border: 1px solid var(--primary);
            border-radius: 0.5rem;
            padding: 0.75rem;
            margin-top: 0.5rem;
            font-size: 0.85rem;
            color: var(--primary);
        }

        /* Estilos para solicitudes en lote */
        .bulk-request {
            border-left: 4px solid var(--primary) !important;
            background: rgba(30, 126, 52, 0.02) !important;
        }

        .bulk-info {
            margin: 0.5rem 0;
            padding: 0.5rem;
            background: rgba(30, 126, 52, 0.1);
            border-radius: 0.375rem;
            font-size: 0.8rem;
            color: var(--primary);
        }

        .bulk-request .notification-title {
            color: var(--primary) !important;
            font-weight: 700;
        }

        .notification-actions {
            margin-top: 1rem;
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
        }

        .notification-actions .btn-small {
            font-size: 0.75rem;
            padding: 0.4rem 0.6rem;
            white-space: nowrap;
        }

        @media (max-width: 1200px) {
            #content-loans {
                max-width: 98%;
            }

            #content-loans .table-container {
                overflow-x: scroll;
                -webkit-overflow-scrolling: touch;
            }

            #content-loans .table-container table {
                min-width: 1000px;
            }
        }

        @media (max-width: 768px) {
            #content-loans .table-container table {
                font-size: 0.8rem;
                min-width: 900px;
            }

            .loan-status-cell div {
                font-size: 0.75rem !important;
                line-height: 1.2;
            }

            .loans-summary-cards {
                grid-template-columns: repeat(2, 1fr);
                gap: 0.5rem;
            }
        }

        /* Alerta de desconexiÃ³n persistente */
        .offline-alert {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            background: linear-gradient(135deg, #dc3545 0%, #c82333 100%);
            color: white;
            padding: 15px 20px;
            box-shadow: 0 4px 15px rgba(220, 53, 69, 0.4);
            z-index: 9998;
            border-bottom: 3px solid #a71e2a;
            animation: slideDownAlert 0.5s ease-out;
        }

        @keyframes slideDownAlert {
            from {
                transform: translateY(-100%);
                opacity: 0;
            }

            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .offline-content {
            max-width: 1200px;
            margin: 0 auto;
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .offline-icon {
            font-size: 2rem;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {

            0%,
            100% {
                transform: scale(1);
            }

            50% {
                transform: scale(1.1);
            }
        }

        .offline-message {
            flex: 1;
        }

        .offline-title {
            font-size: 1.1rem;
            font-weight: bold;
            margin-bottom: 5px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .offline-text {
            font-size: 0.9rem;
            opacity: 0.95;
            line-height: 1.4;
        }

        .offline-actions {
            display: flex;
            gap: 10px;
        }

        .btn-reconnect {
            background: rgba(255, 255, 255, 0.2);
            color: white;
            border: 2px solid rgba(255, 255, 255, 0.3);
            padding: 8px 15px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.85rem;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .btn-reconnect:hover {
            background: rgba(255, 255, 255, 0.3);
            border-color: rgba(255, 255, 255, 0.5);
            transform: translateY(-1px);
        }

        .btn-offline-close {
            background: transparent;
            color: white;
            border: 2px solid rgba(255, 255, 255, 0.3);
            padding: 8px 12px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.85rem;
            transition: all 0.3s ease;
        }

        .btn-offline-close:hover {
            background: rgba(255, 255, 255, 0.1);
            border-color: rgba(255, 255, 255, 0.5);
        }

        /* Alerta minimizada */
        .offline-minimized {
            position: fixed;
            top: 20px;
            right: 20px;
            background: #dc3545;
            color: white;
            padding: 10px 15px;
            border-radius: 25px;
            cursor: pointer;
            z-index: 9999;
            box-shadow: 0 4px 15px rgba(220, 53, 69, 0.4);
            transition: all 0.3s ease;
            font-size: 0.85rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .offline-minimized:hover {
            transform: scale(1.05);
            box-shadow: 0 6px 20px rgba(220, 53, 69, 0.5);
        }

        .offline-min-icon {
            animation: pulse 2s infinite;
        }

        /* Ajustar el header cuando hay alerta */
        .body-with-offline-alert .header {
            margin-top: 80px;
        }

        .body-with-offline-alert .login-container {
            padding-top: 100px;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .offline-alert {
                padding: 12px 15px;
            }

            .offline-content {
                flex-direction: column;
                text-align: center;
                gap: 10px;
            }

            .offline-actions {
                justify-content: center;
                width: 100%;
            }

            .offline-title {
                font-size: 1rem;
            }

            .offline-text {
                font-size: 0.8rem;
            }

            .offline-minimized {
                top: 10px;
                right: 10px;
                padding: 8px 12px;
            }
        }

        .table-header {
            background: var(--gray-50);
            padding: 1.5rem;
            border-bottom: 1px solid var(--gray-200);
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 1rem;
        }

        .table-header-left {
            flex: 1;
            min-width: 250px;
        }

        .table-header-right {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .inventory-info {
            font-size: 0.875rem;
            color: var(--gray-600);
            font-weight: 500;
        }

        .pagination-container {
            background: var(--gray-50);
            padding: 1rem 1.5rem;
            border-top: 1px solid var(--gray-200);
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 1rem;
        }

        .pagination-info {
            display: flex;
            align-items: center;
            gap: 1rem;
            font-size: 0.875rem;
            color: var(--gray-700);
        }

        .pagination-info select {
            padding: 4px 8px;
            border: 1px solid var(--gray-300);
            border-radius: 4px;
            font-size: 0.875rem;
            background: white;
        }

        .pagination-controls {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .pagination-btn {
            background: white;
            border: 1px solid var(--gray-300);
            color: var(--gray-700);
            padding: 8px 12px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.875rem;
            transition: all 0.3s ease;
            min-width: 40px;
            height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .pagination-btn:hover:not(:disabled) {
            background: var(--gray-100);
            border-color: var(--gray-400);
        }

        .pagination-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .pagination-btn.active {
            background: var(--primary);
            border-color: var(--primary);
            color: white;
        }

        .pagination-numbers {
            display: flex;
            align-items: center;
            gap: 0.25rem;
        }

        .pagination-ellipsis {
            padding: 8px 4px;
            color: var(--gray-500);
            font-size: 0.875rem;
        }

        .pagination-jump {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.875rem;
            color: var(--gray-700);
        }

        .pagination-jump input {
            text-align: center;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .table-header {
                flex-direction: column;
                align-items: stretch;
            }

            .pagination-container {
                flex-direction: column;
                gap: 0.75rem;
            }

            .pagination-controls {
                justify-content: center;
                flex-wrap: wrap;
            }

            .pagination-jump {
                justify-content: center;
            }

            .pagination-info {
                justify-content: center;
            }
        }
    </style>
</head>

<body>
    <!-- Loading Overlay -->
    <div id="loadingOverlay" class="loading-overlay">
        <div style="text-align: center">
            <div class="loading-text">Conectando con la base de datos...</div>
        </div>
    </div>

    <div id="offlineAlert" class="offline-alert hidden">
        <div class="offline-content">
            <div class="offline-icon">â ï¸</div>
            <div class="offline-message">
                <div class="offline-title">Â¡SIN CONEXIÃN A LA BASE DE DATOS!</div>
                <div class="offline-text">
                    Todo lo que hagas <strong>NO se guardarÃ¡</strong>.
                    Al recargar la pÃ¡gina <strong>perderÃ¡s tu progreso</strong>.
                </div>
            </div>
            <div class="offline-actions">
                <button class="btn-reconnect" onclick="attemptReconnection()">ð Reintentar</button>
                <button class="btn-offline-close" onclick="minimizeOfflineAlert()">â Minimizar</button>
            </div>
        </div>
    </div>

    <!-- Alerta minimizada -->
    <div id="offlineMinimized" class="offline-minimized hidden" onclick="expandOfflineAlert()">
        <span class="offline-min-icon">â ï¸</span>
        <span class="offline-min-text">SIN CONEXIÃN</span>
    </div>

    <!-- Email Status -->
    <div id="emailStatus" class="email-status email-ready hidden">
        ð§ EmailJS Listo
    </div>

    <!-- Connection Status -->
    <div id="connectionStatus" class="connection-status connection-offline">
        ð´ Sin conexiÃ³n
    </div>

    <!-- Login Screen -->
    <div id="loginScreen" class="login-container">
        <div class="login-card">
            <div class="login-header">
                <div class="logo"></div>
                <h1 class="login-title">Sistema de Inventario</h1>
                <p class="login-subtitle">Liceo RÃ­os de Chile - LirquÃ©n</p>
            </div>

            <div class="user-type-grid">
                <div class="user-type-card" onclick="selectUserType('admin')" id="admin-card">
                    <span class="user-type-icon">ð¨âð¼</span>
                    <div class="user-type-title">Administrador</div>
                    <div class="user-type-desc">Acceso completo</div>
                </div>
                <div class="user-type-card" onclick="selectUserType('operator')" id="operator-card">
                    <span class="user-type-icon">ð¨âð§</span>
                    <div class="user-type-title">Operador</div>
                    <div class="user-type-desc">Acceso limitado</div>
                </div>
                <div class="user-type-card full-width" onclick="selectUserType('visitor')" id="visitor-card">
                    <span class="user-type-icon">ð¥</span>
                    <div class="user-type-title">Visitante</div>
                    <div class="user-type-desc">Solo consulta</div>
                </div>
            </div>

            <div id="credentialsForm" class="hidden">
                <div class="form-group">
                    <label class="form-label">ð§ Correo ElectrÃ³nico</label>
                    <input type="email" class="form-input" id="email" placeholder="usuario@liceoriosdechile.cl" />
                </div>
                <div class="form-group">
                    <label class="form-label">ð ContraseÃ±a</label>
                    <input type="password" class="form-input" id="password" placeholder="Ingresa tu contraseÃ±a" />
                </div>
            </div>

            <button class="btn btn-primary" onclick="login()">
                ð Ingresar al Sistema
            </button>
        </div>
    </div>

    <!-- Dashboard -->
    <div id="dashboardScreen" class="dashboard">
        <div class="header">
            <div class="header-content">
                <div class="header-left">
                    <div class="header-logo"></div>
                    <div class="header-info">
                        <h1>Bienvenido, <span id="welcomeUser">Usuario</span></h1>
                        <div class="header-subtitle">SesiÃ³n iniciada correctamente</div>
                    </div>
                </div>
                <div class="user-info">
                    <!-- Campanita de notificaciones - Solo para admin -->
                    <div id="notificationBell" class="notification-bell hidden" onclick="toggleNotifications()">
                        <span class="bell-icon">ð</span>
                        <span id="notificationCount" class="notification-count">0</span>
                    </div>
                    <span id="currentRole" class="user-badge">Rol</span>
                    <button class="logout-btn" onclick="logout()">Cerrar SesiÃ³n</button>
                </div>
            </div>
        </div>

        <!-- Notification Dropdown -->
        <div id="notificationDropdown" class="notification-dropdown">
            <div class="notification-header">
                <h4>ð Notificaciones</h4>
                <button class="clear-notifications" onclick="clearAllNotifications()">Limpiar</button>
            </div>
            <div class="notification-list" id="notificationList">
                <div class="no-notifications">
                    <div class="no-notifications-icon">ð</div>
                    <div>No hay notificaciones</div>
                </div>
            </div>
        </div>

        <div class="container">
            <nav class="navigation">
                <div class="nav-item active" onclick="showTab('dashboard')" id="tab-dashboard">
                    ð Dashboard
                </div>
                <div class="nav-item" onclick="showTab('inventory')" id="tab-inventory">
                    ð¦ Inventario
                </div>
                <div class="nav-item" onclick="showTab('management')" id="tab-management">
                    âï¸ GestiÃ³n
                </div>
                <div class="nav-item" onclick="showTab('statistics')" id="tab-statistics">
                    ð EstadÃ­sticas
                </div>
                <div class="nav-item" onclick="showTab('history')" id="tab-history">
                    ð Historial
                </div>
                <div class="nav-item" onclick="showTab('loans')" id="tab-loans">
                    ð¤ PrÃ©stamos Activos
                </div>
            </nav>

            <div class="content-card">
                <!-- Dashboard Tab -->
                <div id="content-dashboard" class="tab-content">
                    <!-- Welcome Banner -->
                    <div class="welcome-banner">
                        <div class="welcome-content">
                            <h1 class="welcome-title">Â¡Bienvenido al Sistema!</h1>
                            <p class="welcome-subtitle">
                                Gestiona el inventario del Liceo RÃ­os de Chile de manera
                                eficiente
                            </p>
                        </div>
                    </div>

                    <!-- User Info Card Enhanced -->
                    <div class="user-info-card">
                        <div class="user-avatar" id="userAvatar">U</div>
                        <div class="user-details">
                            <h3 id="userTypeDisplay">USUARIO</h3>
                            <div class="user-email" id="userEmailDisplay">
                                usuario@liceo.cl
                            </div>
                            <span class="permissions-label">Permisos disponibles:</span>
                            <div class="permissions-grid" id="permissionsDisplay">
                                <!-- Permisos se llenan dinÃ¡micamente -->
                            </div>
                        </div>
                        <div class="user-actions">
                            <div class="user-status">ð¢ Activo</div>
                            <div class="session-time" id="sessionTime">SesiÃ³n iniciada</div>
                        </div>
                    </div>

                    <!-- Dashboard Navigation Cards -->
                    <div class="dashboard-navigation">
                        <h2 class="nav-title">ð Acceso RÃ¡pido</h2>
                        <div class="dashboard-cards">
                            <div class="dashboard-card" onclick="showTab('inventory')">
                                <div class="dashboard-card-icon">ð¦</div>
                                <div class="dashboard-card-title">Ver Inventario</div>
                                <div class="dashboard-card-desc">
                                    Consulta todos los productos disponibles, su estado actual y
                                    ubicaciÃ³n en el almacÃ©n
                                </div>
                            </div>
                            <div class="dashboard-card" onclick="showTab('management')" id="managementCard">
                                <div class="dashboard-card-icon">âï¸</div>
                                <div class="dashboard-card-title">GestiÃ³n de Inventario</div>
                                <div class="dashboard-card-desc">
                                    Administra productos: ingresar, prestar, devolver y dar de
                                    baja elementos del sistema
                                </div>
                            </div>
                            <div class="dashboard-card" onclick="showTab('statistics')" id="statisticsCard">
                                <div class="dashboard-card-icon">ð</div>
                                <div class="dashboard-card-title">EstadÃ­sticas Avanzadas</div>
                                <div class="dashboard-card-desc">
                                    Visualiza mÃ©tricas detalladas, anÃ¡lisis de tendencias e
                                    insights del inventario
                                </div>
                            </div>
                            <div class="dashboard-card" onclick="showTab('history')" id="historyCard">
                                <div class="dashboard-card-icon">ð</div>
                                <div class="dashboard-card-title">
                                    Historial de Operaciones
                                </div>
                                <div class="dashboard-card-desc">
                                    Revisa el registro completo de todas las actividades y
                                    movimientos realizados
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Export Section for Admin -->
                    <div id="adminExportSection" class="export-section hidden">
                        <button class="btn btn-success" onclick="exportData('excel')">
                            ð Exportar Excel
                        </button>
                        <button class="btn btn-danger" onclick="exportData('pdf')">
                            ð Exportar PDF
                        </button>
                    </div>

                    <!-- Quick Stats -->
                    <div class="quick-stats-section">
                        <h2 class="section-title">ð Resumen General</h2>
                        <div class="stats-grid">
                            <div class="stat-card">
                                <div class="stat-icon">ð¦</div>
                                <div class="stat-value" id="totalProducts">0</div>
                                <div class="stat-label">Total Productos</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-icon">ð</div>
                                <div class="stat-value" id="totalStock">0</div>
                                <div class="stat-label">Stock Total</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-icon">ð¤</div>
                                <div class="stat-value" id="activeLends">0</div>
                                <div class="stat-label">PrÃ©stamos Activos</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Inventory Tab -->
                <div id="content-inventory" class="tab-content hidden">
                    <h2 class="content-title">ð¦ Inventario General</h2>
                    <p style="margin: 0 0 1.5rem 0; opacity: 0.9; font-size: 0.95rem;">
                        Como visitante, puedes enviar una solicitud para productos disponibles en nuestro inventario
                    </p>
                    <button class="btn btn-primary" onclick="openRequestModal()"
                        style="width: auto; padding: 0.8rem 1.5rem;">
                        ð Solicitar Producto
                    </button>

                    <div class="table-container">
                        <div class="table-header">
                            <div class="table-header-left">
                                <input type="text" class="search-input" id="searchInventory"
                                    placeholder="ð Buscar productos, cÃ³digos, categorÃ­as..."
                                    onkeyup="filterInventory()" />
                            </div>
                            <div class="table-header-right">
                                <div class="inventory-info">
                                    <span id="inventoryCount">Mostrando 0 productos</span>
                                </div>
                            </div>
                        </div>

                        <table>
                            <thead>
                                <tr>
                                    <th>ð·ï¸ CÃ³digo</th>
                                    <th>ð Nombre</th>
                                    <th>ð CategorÃ­a</th>
                                    <th>ð Estado</th>
                                    <th>ð Cantidad</th>
                                    <th>ð UbicaciÃ³n</th>
                                </tr>
                            </thead>
                            <tbody id="inventoryBody"></tbody>
                        </table>

                        <!-- Controles de paginaciÃ³n -->
                        <div class="pagination-container" id="paginationContainer">
                            <div class="pagination-info">
                                <span id="paginationInfo">PÃ¡gina 1 de 1</span>
                                <select id="itemsPerPage" onchange="changeItemsPerPage()">
                                    <option value="20">20 por pÃ¡gina</option>
                                    <option value="40" selected>40 por pÃ¡gina</option>
                                    <option value="60">60 por pÃ¡gina</option>
                                    <option value="100">100 por pÃ¡gina</option>
                                </select>
                            </div>

                            <div class="pagination-controls">
                                <button class="pagination-btn" id="firstPageBtn" onclick="goToPage(1)"
                                    title="Primera pÃ¡gina">
                                    â®ï¸
                                </button>
                                <button class="pagination-btn" id="prevPageBtn" onclick="goToPreviousPage()"
                                    title="PÃ¡gina anterior">
                                    â¬ï¸
                                </button>

                                <div class="pagination-numbers" id="paginationNumbers">
                                    <!-- Los nÃºmeros se generan dinÃ¡micamente -->
                                </div>

                                <button class="pagination-btn" id="nextPageBtn" onclick="goToNextPage()"
                                    title="PÃ¡gina siguiente">
                                    â¡ï¸
                                </button>
                                <button class="pagination-btn" id="lastPageBtn" onclick="goToLastPage()"
                                    title="Ãltima pÃ¡gina">
                                    â­ï¸
                                </button>
                            </div>

                            <div class="pagination-jump">
                                <span>Ir a pÃ¡gina:</span>
                                <input type="number" id="jumpToPage" min="1" onkeypress="jumpToPageOnEnter(event)"
                                    style="width: 60px; padding: 4px; border: 1px solid var(--gray-300); border-radius: 4px;">
                                <button class="pagination-btn" onclick="jumpToSpecificPage()">Ir</button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Management Tab -->
                <div id="content-management" class="tab-content hidden">
                    <div class="management-header">
                        <h2 class="management-title">
                            âï¸ Centro de GestiÃ³n de Inventario
                        </h2>
                        <p class="management-subtitle">
                            Administra todos los aspectos del inventario desde un solo
                            lugar. Realiza operaciones de manera segura y eficiente.
                        </p>
                    </div>

                    <!-- Quick Info Cards -->
                    <div class="management-info">
                        <div class="info-card">
                            <span class="info-number" id="mgmtTotalProducts">0</span>
                            <div class="info-label">Productos Registrados</div>
                        </div>
                        <div class="info-card">
                            <span class="info-number" id="mgmtAvailableProducts">0</span>
                            <div class="info-label">Disponibles</div>
                        </div>
                        <div class="info-card">
                            <span class="info-number" id="mgmtActiveLoans">0</span>
                            <div class="info-label">PrÃ©stamos Activos</div>
                        </div>
                        <div class="info-card">
                            <span class="info-number" id="mgmtMaintenanceProducts">0</span>
                            <div class="info-label">En Mantenimiento</div>
                        </div>
                    </div>

                    <div class="action-grid">
                        <div class="action-card primary" onclick="openModal('addProduct')">
                            <div class="action-icon">â</div>
                            <div class="action-title">Ingresar Producto Nuevo</div>
                            <div class="action-desc">
                                Agrega nuevos productos al sistema con toda su informaciÃ³n
                                detallada
                            </div>
                            <ul class="action-features">
                                <li>Registro completo</li>
                                <li>CategorizaciÃ³n automÃ¡tica</li>
                                <li>AsignaciÃ³n de ubicaciÃ³n</li>
                            </ul>
                        </div>

                        <div class="action-card" onclick="openModal('updateStock')">
                            <div class="action-icon">ð</div>
                            <div class="action-title">Aumentar Stock</div>
                            <div class="action-desc">
                                Incrementa la cantidad de productos existentes cuando recibas
                                nuevas unidades
                            </div>
                            <ul class="action-features">
                                <li>VerificaciÃ³n automÃ¡tica</li>
                                <li>ActualizaciÃ³n en tiempo real</li>
                                <li>Historial de cambios</li>
                            </ul>
                        </div>

                        <div class="action-card" onclick="openModal('lendProduct')">
                            <div class="action-icon">ð¤</div>
                            <div class="action-title">Registrar PrÃ©stamo</div>
                            <div class="action-desc">
                                Gestiona prÃ©stamos de productos a estudiantes, profesores o
                                personal del liceo
                            </div>
                            <ul class="action-features">
                                <li>Control de fechas</li>
                                <li>Datos del solicitante</li>
                                <li>EnvÃ­o automÃ¡tico de correo</li>
                            </ul>
                        </div>

                        <div class="action-card" onclick="openModal('returnProduct')">
                            <div class="action-icon">â©ï¸</div>
                            <div class="action-title">Procesar DevoluciÃ³n</div>
                            <div class="action-desc">
                                Registra la devoluciÃ³n de productos prestados y actualiza su
                                estado
                            </div>
                            <ul class="action-features">
                                <li>VerificaciÃ³n de estado</li>
                                <li>Observaciones detalladas</li>
                                <li>Reintegro automÃ¡tico</li>
                            </ul>
                        </div>

                        <div class="action-card warning" onclick="openModal('removeProduct')">
                            <div class="action-icon">â ï¸</div>
                            <div class="action-title">Dar de Baja</div>
                            <div class="action-desc">
                                Retira productos del inventario por daÃ±o, pÃ©rdida u
                                obsolescencia
                            </div>
                            <ul class="action-features">
                                <li>Motivo obligatorio</li>
                                <li>ReducciÃ³n de stock</li>
                                <li>Trazabilidad completa</li>
                            </ul>
                        </div>

                        <div class="action-card danger" onclick="openModal('deleteProduct')">
                            <div class="action-icon">ðï¸</div>
                            <div class="action-title">Eliminar Producto Completo</div>
                            <div class="action-desc">
                                Elimina completamente un producto del sistema de inventario
                            </div>
                            <ul class="action-features">
                                <li>EliminaciÃ³n total</li>
                                <li>ConfirmaciÃ³n requerida</li>
                                <li>AcciÃ³n irreversible</li>
                            </ul>
                        </div>
                    </div>

                    <div class="operation-result-container">
                        <div id="operationResult"></div>
                    </div>
                </div>

                <!-- Statistics Tab -->
                <div id="content-statistics" class="tab-content hidden">
                    <div class="stats-header">
                        <h2>ð AnÃ¡lisis del Sistema</h2>
                        <p>
                            Dashboard completo de estadÃ­sticas y mÃ©tricas del inventario
                        </p>
                    </div>

                    <div class="stats-overview">
                        <div class="overview-card">
                            <div class="overview-icon">ð¯</div>
                            <div class="overview-number" id="uniqueProducts">0</div>
                            <div class="overview-label">Productos Ãnicos</div>
                        </div>
                        <div class="overview-card">
                            <div class="overview-icon">ð¦</div>
                            <div class="overview-number" id="totalStockStats">0</div>
                            <div class="overview-label">Stock Total</div>
                        </div>
                        <div class="overview-card">
                            <div class="overview-icon">ð°</div>
                            <div class="overview-number" id="totalValue">$0</div>
                            <div class="overview-label">Valor Estimado</div>
                        </div>
                        <div class="overview-card">
                            <div class="overview-icon">ð</div>
                            <div class="overview-number" id="activeLoansStats">0</div>
                            <div class="overview-label">PrÃ©stamos Activos</div>
                        </div>
                    </div>

                    <div class="charts-grid">
                        <div class="chart-card">
                            <div class="chart-title">ð Estado de Productos</div>
                            <div class="status-chart">
                                <div class="status-item">
                                    <div class="status-info">
                                        <div class="status-dot status-available"></div>
                                        <span>Disponibles</span>
                                    </div>
                                    <div class="status-count" id="availableProducts">0</div>
                                </div>
                                <div class="status-item">
                                    <div class="status-info">
                                        <div class="status-dot status-in-use"></div>
                                        <span>En Uso</span>
                                    </div>
                                    <div class="status-count" id="inUseProducts">0</div>
                                </div>
                                <div class="status-item">
                                    <div class="status-info">
                                        <div class="status-dot status-maintenance"></div>
                                        <span>Mantenimiento</span>
                                    </div>
                                    <div class="status-count" id="maintenanceProducts">0</div>
                                </div>
                                <div class="status-item">
                                    <div class="status-info">
                                        <div class="status-dot status-unavailable"></div>
                                        <span>No Disponibles</span>
                                    </div>
                                    <div class="status-count" id="unavailableProducts">0</div>
                                </div>
                            </div>
                        </div>

                        <div class="chart-card">
                            <div class="chart-title">ð DistribuciÃ³n por CategorÃ­as</div>
                            <div class="category-chart" id="categoryChart">
                                <!-- Las barras de categorÃ­as se llenan dinÃ¡micamente -->
                            </div>
                        </div>
                    </div>

                    <div class="insights-section">
                        <div class="insights-title">ð¡ Insights y Recomendaciones</div>
                        <div id="insightsContainer">
                            <!-- Los insights se generan dinÃ¡micamente -->
                        </div>
                    </div>
                </div>

                <!-- History Tab -->
                <div id="content-history" class="tab-content hidden">
                    <div
                        style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">
                        <h2 class="content-title">ð Historial de Operaciones</h2>
                        <button id="deleteHistoryBtn" class="btn btn-danger hidden" onclick="requestDeleteHistory()"
                            style="margin: 0;">
                            ðï¸ Eliminar Historial Completo
                        </button>
                    </div>

                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th>ð Fecha</th>
                                    <th>ð¤ Usuario</th>
                                    <th>ð OperaciÃ³n</th>
                                    <th>ð¦ Producto</th>
                                    <th>ð Detalles</th>
                                </tr>
                            </thead>
                            <tbody id="historyBody"></tbody>
                        </table>
                    </div>
                </div>

                <!-- Active Loans Tab -->
                <div id="content-loans" class="tab-content hidden">
                    <div
                        style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem; flex-wrap: wrap; gap: 1rem;">
                        <h2 class="content-title">ð¤ PrÃ©stamos Activos</h2>
                        <div class="bulk-reminder-buttons">
                            <button class="btn btn-warning bulk-reminder-btn" onclick="sendBulkReminders('upcoming')">
                                â° Recordatorios Por Vencer
                            </button>
                            <button class="btn btn-danger bulk-reminder-btn" onclick="sendBulkReminders('overdue')">
                                ð¨ Recordatorios Vencidos
                            </button>
                        </div>
                    </div>

                    <!-- Summary Cards -->
                    <div class="loans-summary-cards">
                        <div class="loans-summary-card">
                            <span class="loans-summary-number loans-summary-total" id="totalActiveLoans">0</span>
                            <div class="loans-summary-label">Total Activos</div>
                        </div>
                        <div class="loans-summary-card">
                            <span class="loans-summary-number loans-summary-upcoming" id="upcomingDueLoans">0</span>
                            <div class="loans-summary-label">Por Vencer (3 dÃ­as)</div>
                        </div>
                        <div class="loans-summary-card">
                            <span class="loans-summary-number loans-summary-overdue" id="overdueLoans">0</span>
                            <div class="loans-summary-label">Vencidos</div>
                        </div>
                        <div class="loans-summary-card">
                            <span class="loans-summary-number loans-summary-ontime" id="onTimeLoans">0</span>
                            <div class="loans-summary-label">A Tiempo</div>
                        </div>
                    </div>

                    <div class="table-container">
                        <div class="table-header">
                            <input type="text" class="search-input" id="searchLoans"
                                placeholder="ð Buscar prÃ©stamos por solicitante, producto, cÃ³digo..."
                                onkeyup="filterActiveLoans()" />
                        </div>
                        <table>
                            <thead>
                                <tr>
                                    <th style="width: 20%;">ð¦ Producto</th>
                                    <th style="width: 15%;">ð¤ Solicitante</th>
                                    <th style="width: 18%;">ð§ Correo ElectrÃ³nico</th>
                                    <th style="width: 8%;">ð Cant.</th>
                                    <th style="width: 12%;">ð F. PrÃ©stamo</th>
                                    <th style="width: 12%;">ð F. DevoluciÃ³n</th>
                                    <th style="width: 15%;">â° Estado Actual</th>
                                </tr>
                            </thead>
                            <tbody id="activeLoansBody"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal -->
    <div id="operationModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title" id="modalTitle">OperaciÃ³n</h3>
                <button class="close-btn" onclick="closeModal()">&times;</button>
            </div>
            <div id="modalContent"></div>
        </div>
    </div>

    <!-- Modal de Solicitud de Producto -->
    <div id="requestModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">ð Solicitar Productos</h3>
                <button class="close-btn" onclick="confirmCloseRequestModal()">&times;</button>
            </div>
            <div id="requestModalContent">
                <div class="alert alert-info">
                    <span>â¹ï¸</span>
                    <div>
                        <strong>Importante:</strong> Tu solicitud serÃ¡ revisada por un administrador.
                        RecibirÃ¡s una respuesta por correo electrÃ³nico. <strong>MÃ­nimo 48 horas de aviso.</strong>
                    </div>
                </div>

                <form id="requestForm" onsubmit="submitMultipleProductRequest(event)">
                    <!-- Datos del Solicitante -->
                    <h4
                        style="margin: 1.5rem 0 1rem 0; color: var(--primary); border-bottom: 2px solid var(--primary); padding-bottom: 0.5rem;">
                        ð¤ Datos del Solicitante
                    </h4>

                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">ð¤ Nombre Completo *</label>
                            <input type="text" class="form-input" id="requesterName" placeholder="Juan PÃ©rez GarcÃ­a"
                                required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">ð RUT *</label>
                            <input type="text" class="form-input" id="requesterRut" placeholder="12.345.678-9" required>
                        </div>
                    </div>

                    <div class="form-group">
                        <label class="form-label">ð§ Correo ElectrÃ³nico *</label>
                        <input type="email" class="form-input" id="requesterEmail" placeholder="juan.perez@email.com"
                            required>
                    </div>

                    <!-- Fechas -->
                    <h4
                        style="margin: 1.5rem 0 1rem 0; color: var(--primary); border-bottom: 2px solid var(--primary); padding-bottom: 0.5rem;">
                        ð Fechas del PrÃ©stamo
                    </h4>

                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">ð Fecha Necesaria (MÃ­nimo 48h de aviso) *</label>
                            <input type="date" class="form-input" id="requestedDate" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">ð Fecha de DevoluciÃ³n *</label>
                            <input type="date" class="form-input" id="returnDate" required>
                        </div>
                    </div>

                    <!-- Productos -->
                    <h4
                        style="margin: 1.5rem 0 1rem 0; color: var(--primary); border-bottom: 2px solid var(--primary); padding-bottom: 0.5rem;">
                        ð¦ Productos Solicitados
                    </h4>

                    <!-- Agregar Producto -->
                    <div style="background: var(--gray-50); padding: 1.5rem; border-radius: 1rem; margin-bottom: 1rem;">
                        <div class="form-row">
                            <div class="form-group">
                                <label class="form-label">ð¦ Producto (Nombre o CÃ³digo)</label>
                                <input type="text" class="form-input" id="newProductInput"
                                    placeholder="Ej: Calculadora CientÃ­fica o 001-CAL-001" onblur="verifyNewProduct()">
                                <div id="newProductVerification" class="hidden"></div>
                            </div>
                            <div class="form-group">
                                <label class="form-label">ð Cantidad (mÃ¡x. 40)</label>
                                <input type="number" class="form-input" id="newQuantityInput" min="1" max="40"
                                    placeholder="1">
                            </div>
                        </div>
                        <button type="button" class="btn btn-primary" onclick="addProductToList()"
                            style="width: 100%; margin-top: 1rem;">
                            â Agregar Producto a la Solicitud
                        </button>
                    </div>

                    <!-- Lista de Productos -->
                    <div id="productsList" class="hidden" style="margin-bottom: 1.5rem;">
                        <h5 style="color: var(--gray-700); margin-bottom: 1rem;">ð Productos en tu solicitud:</h5>
                        <div id="productsListContainer" style="max-height: 300px; overflow-y: auto;"></div>
                        <div
                            style="background: var(--primary); color: white; padding: 1rem; border-radius: 0.5rem; margin-top: 1rem; text-align: center;">
                            <strong>Total de productos: <span id="totalProducts">0</span></strong>
                        </div>
                    </div>

                    <!-- Motivo -->
                    <div class="form-group">
                        <label class="form-label">ð Motivo/Uso (Opcional)</label>
                        <textarea class="form-input" id="requestReason" rows="3"
                            placeholder="Describe brevemente para quÃ© necesitas los productos..."></textarea>
                    </div>

                    <button type="submit" class="btn btn-primary" id="submitRequestBtn" disabled>
                        ð¤ Enviar Solicitud Completa
                    </button>
                </form>
            </div>
        </div>
    </div>

    <!-- Info Modal -->
    <div id="infoModal" class="info-modal">
        <div class="info-modal-content">
            <div class="info-modal-header">
                <h3 class="info-modal-title" id="infoModalTitle">InformaciÃ³n</h3>
                <button class="info-modal-close" onclick="closeInfoModal()">
                    &times;
                </button>
            </div>
            <div class="info-modal-body" id="infoModalBody">
                <!-- Content will be populated dynamically -->
            </div>
        </div>
    </div>

    <!-- Firebase Scripts -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

    <!-- EmailJS Scripts -->
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>

    <script>
        // CONFIGURACIÃN DE FIREBASE
        // â ï¸ IMPORTANTE: Debes reemplazar esta configuraciÃ³n con la tuya
        const firebaseConfig = {
            apiKey: "AIzaSyAkAEVAXWOraWw5vR8bHu-A4wZ7u8LdaWc",
            authDomain: "inventario-liceo-rios-chile.firebaseapp.com",
            projectId: "inventario-liceo-rios-chile",
            storageBucket: "inventario-liceo-rios-chile.firebasestorage.app",
            messagingSenderId: "922200736252",
            appId: "1:922200736252:web:696a087534a6a429127279",
            measurementId: "G-RDWSD93J0E",
        };

        // CONFIGURACIÃN DE EMAILJS
        // â ï¸ IMPORTANTE: Debes reemplazar estos valores con los tuyos de EmailJS
        const emailjsConfig = {
            publicKey: "0PJJEx0CPSrz56KPR", // Reemplaza con tu public key
            serviceId: "service_tobcijr", // Reemplaza con tu service ID  
            templateId: "template_56uy9yy", // Reemplaza con tu template ID
            approvalTemplateId: "template_e9qjbvh"
        };

        // Variables globales para EmailJS
        let isEmailJSReady = false;

        // Inicializar Firebase
        let db = null;
        let isFirebaseReady = false;

        try {
            firebase.initializeApp(firebaseConfig);
            db = firebase.firestore();

            // Probar conexiÃ³n inicial
            db.collection("products").limit(1).get().then(() => {
                isFirebaseReady = true;
                console.log("â Firebase conectado correctamente");
                updateConnectionStatus("online");
            }).catch((error) => {
                console.error("â Error inicial de Firebase:", error);
                isFirebaseReady = false;
                updateConnectionStatus("offline");
            });

        } catch (error) {
            console.error("â Error configurando Firebase:", error);
            isFirebaseReady = false;
            updateConnectionStatus("offline");
        }

        // Monitorear estado de conexiÃ³n
        if (typeof window !== 'undefined') {
            window.addEventListener('online', () => {
                console.log('ð ConexiÃ³n a internet restaurada');
                if (isFirebaseReady) {
                    attemptReconnection();
                }
            });

            window.addEventListener('offline', () => {
                console.log('ð ConexiÃ³n a internet perdida');
                updateConnectionStatus("offline");
            });
        }

        // Inicializar EmailJS
        function initializeEmailJS() {
            try {
                // Inicializar EmailJS con tu public key
                emailjs.init(emailjsConfig.publicKey);
                isEmailJSReady = true;
                updateEmailStatus("ready");
                console.log("â EmailJS inicializado correctamente");
            } catch (error) {
                console.error("â Error inicializando EmailJS:", error);
                updateEmailStatus("error");
                isEmailJSReady = false;
            }
        }

        // FunciÃ³n para enviar correo de prÃ©stamo
        async function sendLoanEmail(loanData) {
            if (!isEmailJSReady) {
                console.warn("â ï¸ EmailJS no estÃ¡ disponible");
                return false;
            }

            updateEmailStatus("sending");

            const templateParams = {
                to_name: loanData.borrower,
                to_email: loanData.borrowerEmail,
                product_name: loanData.productName,
                product_code: loanData.productCode,
                quantity: loanData.quantity,
                loan_date: loanData.loanDate,
                return_date: loanData.returnDate,
                borrower_name: loanData.borrower,
                borrower_rut: loanData.borrowerRut,
                liceo_name: "Liceo RÃ­os de Chile - LirquÃ©n",
                contact_email: "victor.mulchi@liceoriosdechile.cl",
                system_name: "Sistema de Inventario"
            };

            try {
                const response = await emailjs.send(
                    emailjsConfig.serviceId,
                    emailjsConfig.loanTemplateId,  // â CAMBIO AQUÃ
                    templateParams
                );

                console.log('â Correo enviado exitosamente:', response.status, response.text);
                updateEmailStatus("ready");
                return true;

            } catch (error) {
                console.error('â Error enviando correo:', error);
                updateEmailStatus("error");

                // Mostrar error especÃ­fico pero no bloquear la operaciÃ³n
                setTimeout(() => {
                    alert(`â ï¸ El prÃ©stamo se registrÃ³ correctamente, pero hubo un problema enviando el correo:\n${error.text || error.message || 'Error desconocido'}`);
                }, 500);

                return false;
            }
        }

        // FunciÃ³n para enviar correo de aprobaciÃ³n
        async function sendApprovalEmail(approvalData) {
            if (!isEmailJSReady) {
                console.warn("â ï¸ EmailJS no estÃ¡ disponible");
                return false;
            }

            updateEmailStatus("sending");

            const templateParams = {
                requester_name: approvalData.requesterName,
                requester_rut: approvalData.requesterRut,
                requester_email: approvalData.requesterEmail,
                product_name: approvalData.productName,
                assigned_codes: approvalData.assignedCodes || approvalData.productCode || 'CÃ³digo asignado automÃ¡ticamente',
                approved_quantity: approvalData.approvedQuantity || approvalData.quantity,
                loan_date: approvalData.loanDate,
                return_date: approvalData.returnDate,
                approved_by: approvalData.approvedBy
            };

            try {
                const response = await emailjs.send(
                    emailjsConfig.serviceId,
                    emailjsConfig.approvalTemplateId,
                    templateParams
                );

                console.log('â Correo de aprobaciÃ³n enviado:', response.status);
                updateEmailStatus("ready");
                return true;

            } catch (error) {
                console.error('â Error enviando correo de aprobaciÃ³n:', error);
                updateEmailStatus("error");

                // Mostrar error pero no bloquear la operaciÃ³n
                setTimeout(() => {
                    alert(`â ï¸ La aprobaciÃ³n se procesÃ³ correctamente, pero hubo un problema enviando el correo:\n${error.text || error.message || 'Error desconocido'}`);
                }, 500);

                return false;
            }
        }

        // Actualizar estado del email
        function updateEmailStatus(status) {
            const statusEl = document.getElementById("emailStatus");
            statusEl.className = `email-status email-${status}`;

            switch (status) {
                case "ready":
                    statusEl.innerHTML = "ð§ EmailJS Listo";
                    statusEl.classList.remove("hidden");
                    break;
                case "sending":
                    statusEl.innerHTML = "ð¤ Enviando correo...";
                    statusEl.classList.remove("hidden");
                    break;
                case "error":
                    statusEl.innerHTML = "â Email sin servicio";
                    statusEl.classList.remove("hidden");
                    setTimeout(() => {
                        statusEl.classList.add("hidden");
                    }, 5000);
                    break;
            }
        }

        // Global variables
        let currentUser = null;
        let currentRole = null;
        let selectedUserType = null;
        let products = [];
        let loans = [];
        let history = [];
        let productRequests = [];
        let unsubscribeProducts = null;
        let unsubscribeLoans = null;
        let unsubscribeHistory = null;
        let currentPage = 1;
        let itemsPerPage = 40;
        let filteredProducts = []; // Productos despuÃ©s del filtro de bÃºsqueda
        let totalPages = 1;

        // User credentials
        const users = {
            admin: {
                email: "victor.mulchi@liceoriosdechile.cl",
                password: "AdminLiceo2025!",
            },
            operator: { email: "operador.la@gmail.com", password: "Admi2025" },
        };

        // Connection status
        function updateConnectionStatus(status) {
            const statusEl = document.getElementById("connectionStatus");
            const offlineAlert = document.getElementById("offlineAlert");
            const offlineMinimized = document.getElementById("offlineMinimized");

            statusEl.className = `connection-status connection-${status}`;

            switch (status) {
                case "online":
                    statusEl.innerHTML = "ð¢ Conectado";
                    // Ocultar alertas de desconexiÃ³n
                    offlineAlert.classList.add("hidden");
                    offlineMinimized.classList.add("hidden");
                    document.body.classList.remove("body-with-offline-alert");
                    break;
                case "offline":
                    statusEl.innerHTML = "ð´ Sin conexiÃ³n";
                    // Mostrar alerta de desconexiÃ³n
                    showOfflineAlert();
                    break;
                case "syncing":
                    statusEl.innerHTML = "ð¡ Sincronizando";
                    break;
            }
        }

        // Mostrar alerta de desconexiÃ³n
        function showOfflineAlert() {
            const offlineAlert = document.getElementById("offlineAlert");
            const offlineMinimized = document.getElementById("offlineMinimized");

            offlineAlert.classList.remove("hidden");
            offlineMinimized.classList.add("hidden");
            document.body.classList.add("body-with-offline-alert");
        }

        // Minimizar alerta de desconexiÃ³n
        function minimizeOfflineAlert() {
            const offlineAlert = document.getElementById("offlineAlert");
            const offlineMinimized = document.getElementById("offlineMinimized");

            offlineAlert.classList.add("hidden");
            offlineMinimized.classList.remove("hidden");
            document.body.classList.remove("body-with-offline-alert");
        }

        // Expandir alerta de desconexiÃ³n
        function expandOfflineAlert() {
            showOfflineAlert();
        }

        // Intentar reconexiÃ³n
        async function attemptReconnection() {
            const reconnectBtn = document.querySelector('.btn-reconnect');
            reconnectBtn.innerHTML = 'ð Reconectando...';
            reconnectBtn.disabled = true;

            try {
                updateConnectionStatus("syncing");

                // Intentar una operaciÃ³n simple para probar la conexiÃ³n
                if (isFirebaseReady) {
                    await db.collection("products").limit(1).get();
                    updateConnectionStatus("online");

                    // Mostrar mensaje de Ã©xito temporal
                    reconnectBtn.innerHTML = 'â Reconectado';
                    setTimeout(() => {
                        reconnectBtn.innerHTML = 'ð Reintentar';
                        reconnectBtn.disabled = false;
                    }, 2000);
                } else {
                    throw new Error("Firebase no estÃ¡ disponible");
                }

            } catch (error) {
                console.error("Error en reconexiÃ³n:", error);
                updateConnectionStatus("offline");

                reconnectBtn.innerHTML = 'â Error';
                setTimeout(() => {
                    reconnectBtn.innerHTML = 'ð Reintentar';
                    reconnectBtn.disabled = false;
                }, 2000);
            }
        }

        function checkConnectionBeforeOperation(operationName) {
            if (!isFirebaseReady || !navigator.onLine) {
                const confirmed = confirm(`â ï¸ SIN CONEXIÃN A LA BASE DE DATOS

La operaciÃ³n "${operationName}" NO se guardarÃ¡ permanentemente.

Â¿Deseas continuar de todas formas?
- â SÃ: La operaciÃ³n se harÃ¡ solo localmente
- â NO: Cancelar hasta tener conexiÃ³n`);

                if (!confirmed) {
                    throw new Error("OperaciÃ³n cancelada por falta de conexiÃ³n");
                }

                // Mostrar alerta si estÃ¡ oculta
                if (document.getElementById("offlineAlert").classList.contains("hidden")) {
                    showOfflineAlert();
                }
            }
            return true;
        }

        // Initialize Firebase listeners
        function initializeFirebaseListeners() {
            if (!isFirebaseReady) return;

            // Listener para productos
            unsubscribeProducts = db.collection("products").onSnapshot(
                (snapshot) => {
                    updateConnectionStatus("syncing");
                    products = [];
                    snapshot.forEach((doc) => {
                        products.push({ id: doc.id, ...doc.data() });
                    });
                    updateConnectionStatus("online");

                    // Actualizar UI inmediatamente
                    updateDashboard();
                    updateManagementInfo();

                    // Actualizar UI si estamos en la pestaÃ±a correcta
                    const activeTab = document
                        .querySelector(".nav-item.active")
                        ?.id.replace("tab-", "");
                    if (activeTab === "inventory" || activeTab === "dashboard") {
                        updateUI();
                    }
                },
                (error) => {
                    console.error("Error en listener de productos:", error);
                    updateConnectionStatus("offline");
                }
            );

            // Listener para prÃ©stamos
            unsubscribeLoans = db.collection("loans").onSnapshot(
                (snapshot) => {
                    loans = [];
                    snapshot.forEach((doc) => {
                        loans.push({ id: doc.id, ...doc.data() });
                    });

                    // Actualizar dashboard inmediatamente
                    updateDashboard();
                    updateManagementInfo();

                    // Actualizar UI si estamos en dashboard
                    const activeTab = document
                        .querySelector(".nav-item.active")
                        ?.id.replace("tab-", "");
                    if (activeTab === "dashboard") {
                        updateDashboard();
                    }
                },
                (error) => {
                    console.error("Error en listener de prÃ©stamos:", error);
                }
            );

            // Listener para historial
            unsubscribeHistory = db
                .collection("history")
                .orderBy("timestamp", "desc")
                .onSnapshot(
                    (snapshot) => {
                        history = [];
                        snapshot.forEach((doc) => {
                            history.push({ id: doc.id, ...doc.data() });
                        });

                        // Actualizar UI si estamos en historial
                        const activeTab = document
                            .querySelector(".nav-item.active")
                            .id.replace("tab-", "");
                        if (activeTab === "history") {
                            updateHistory();
                        }
                    },
                    (error) => {
                        console.error("Error en listener de historial:", error);
                    }
                );

            const unsubscribeRequests = db.collection("productRequests").onSnapshot(
                (snapshot) => {
                    productRequests = [];
                    snapshot.forEach((doc) => {
                        productRequests.push({ id: doc.id, ...doc.data() });
                    });

                    console.log(`ð ${productRequests.length} solicitudes cargadas desde Firebase`);

                    // Actualizar notificaciones si es admin
                    if (currentRole === 'admin') {
                        updateNotifications();
                    }
                },
                (error) => {
                    console.error("Error en listener de solicitudes:", error);
                }
            );
        }

        // Initialize sample data (solo si Firebase no estÃ¡ disponible)
        async function initSampleData() {
            // FunciÃ³n vacÃ­a - sin productos de ejemplo
            console.log("â Sistema inicializado sin datos de ejemplo");
        }

        // User type selection
        function selectUserType(type) {
            selectedUserType = type;

            document.querySelectorAll(".user-type-card").forEach((card) => {
                card.classList.remove("active");
            });

            document.getElementById(`${type}-card`).classList.add("active");

            if (type === "visitor") {
                document.getElementById("credentialsForm").classList.add("hidden");
            } else {
                document.getElementById("credentialsForm").classList.remove("hidden");
            }
        }

        // Login function
        function login() {
            if (!selectedUserType) {
                alert("â ï¸ Por favor selecciona un tipo de usuario");
                return;
            }

            if (selectedUserType === "visitor") {
                loginUser("Visitante", "visitor");
                return;
            }

            const email = document.getElementById("email").value;
            const password = document.getElementById("password").value;

            if (!email || !password) {
                alert("â ï¸ Por favor completa todos los campos");
                return;
            }

            if (
                selectedUserType === "admin" &&
                email === users.admin.email &&
                password === users.admin.password
            ) {
                loginUser("Administrador", "admin");
            } else if (
                selectedUserType === "operator" &&
                email === users.operator.email &&
                password === users.operator.password
            ) {
                loginUser("Operador", "operator");
            } else {
                alert("â Credenciales incorrectas");
            }
        }

        async function loginUser(user, role) {
            currentUser = user;
            currentRole = role;

            document.getElementById("loginScreen").style.display = "none";
            document.getElementById("dashboardScreen").style.display = "block";

            // Actualizar informaciÃ³n en el header
            document.getElementById("welcomeUser").textContent = user;
            document.getElementById("currentRole").textContent = role;

            // Actualizar informaciÃ³n en la tarjeta de usuario
            document.getElementById("userTypeDisplay").textContent = role.toUpperCase();

            // Actualizar avatar con inicial del usuario
            const userAvatar = document.getElementById("userAvatar");
            if (userAvatar) {
                userAvatar.textContent = user.charAt(0).toUpperCase();
            }

            // Actualizar tiempo de sesiÃ³n
            const sessionTime = document.getElementById("sessionTime");
            if (sessionTime) {
                sessionTime.textContent = `SesiÃ³n iniciada: ${new Date().toLocaleTimeString(
                    "es-CL"
                )}`;
            }

            // Actualizar email basado en el rol
            let email = "";
            if (role === "admin") {
                email = "victor.mulchi@liceoriosdechile.cl";
            } else if (role === "operator") {
                email = "operador.la@gmail.com";
            } else {
                email = "visitante@liceo.cl";
            }
            document.getElementById("userEmailDisplay").textContent = email;

            // Actualizar permisos
            updatePermissionsDisplay(role);

            // Mostrar campanita solo para admin
            if (role === "admin") {
                document.getElementById("notificationBell").classList.remove("hidden");
            } else {
                document.getElementById("notificationBell").classList.add("hidden");
            }

            setupUserPermissions();

            // Redireccionar segÃºn el rol al iniciar sesiÃ³n
            if (currentRole === 'admin') {
                showTab('dashboard');
            } else {
                // Admin y visitor van al dashboard por defecto
                showTab('inventory');
            }

            // Inicializar datos y listeners
            await initSampleData();
            initializeFirebaseListeners();

            // Forzar actualizaciÃ³n de nÃºmeros despuÃ©s del login
            setTimeout(() => {
                updateDashboard();
                updateManagementInfo();
            }, 300);

            updateDashboard();
            hideLoading();
            setTimeout(() => {
                window.scrollTo(0, 0);
            }, 500);
        }

        function updateDashboard() {
            // Update alerts - Ahora se manejan en la campanita de notificaciones
            updateNotifications();

            // Calculate stats
            const totalProducts = products.length;
            const totalStock = products.reduce((sum, p) => sum + p.quantity, 0);
            const activeLends = loans.filter((l) => l.status === "Activo").length;

            // Update all dashboard elements with a delay to ensure DOM is ready
            setTimeout(() => {
                // Update main dashboard stats (Resumen General)
                const totalProductsEl = document.getElementById("totalProducts");
                const totalStockEl = document.getElementById("totalStock");
                const activeLendsEl = document.getElementById("activeLends");

                if (totalProductsEl) totalProductsEl.textContent = totalProducts;
                if (totalStockEl) totalStockEl.textContent = totalStock;
                if (activeLendsEl) activeLendsEl.textContent = activeLends;

                // Update management info cards
                updateManagementInfo();
            }, 100);
        }

        function updateManagementInfo() {
            const totalProducts = products.length;
            const availableProducts = products.filter(
                (p) => p.status === "Disponible"
            ).length;
            const activeLoans = loans.filter((l) => l.status === "Activo").length;
            const maintenanceProducts = products.filter(
                (p) => p.status === "Mantenimiento"
            ).length;

            const mgmtTotalEl = document.getElementById("mgmtTotalProducts");
            const mgmtAvailableEl = document.getElementById(
                "mgmtAvailableProducts"
            );
            const mgmtLoansEl = document.getElementById("mgmtActiveLoans");
            const mgmtMaintenanceEl = document.getElementById(
                "mgmtMaintenanceProducts"
            );

            if (mgmtTotalEl) mgmtTotalEl.textContent = totalProducts;
            if (mgmtAvailableEl) mgmtAvailableEl.textContent = availableProducts;
            if (mgmtLoansEl) mgmtLoansEl.textContent = activeLoans;
            if (mgmtMaintenanceEl)
                mgmtMaintenanceEl.textContent = maintenanceProducts;
        }

        function updatePermissionsDisplay(role) {
            const permissionsDiv = document.getElementById("permissionsDisplay");
            let permissions = [];

            if (role === "admin") {
                permissions = [
                    "Ver",
                    "Ingresar",
                    "Editar",
                    "Aumentar",
                    "Prestar",
                    "Devolver",
                    "Baja",
                    "Gestionar_usuarios",
                ];
            } else if (role === "operator") {
                permissions = ["Ver", "Ingresar"];
            } else {
                permissions = ["Ver"];
            }

            permissionsDiv.innerHTML = permissions
                .map(
                    (permission) =>
                        `<span class="permission-badge">${permission}</span>`
                )
                .join("");
        }

        function logout() {
            // Limpiar listeners de Firebase
            if (unsubscribeProducts) unsubscribeProducts();
            if (unsubscribeLoans) unsubscribeLoans();
            if (unsubscribeHistory) unsubscribeHistory();

            currentUser = null;
            currentRole = null;
            selectedUserType = null;

            // Limpiar UI completamente
            document.getElementById("loginScreen").style.display = "block";
            document.getElementById("dashboardScreen").style.display = "none";

            // Reset form
            document.getElementById("email").value = "";
            document.getElementById("password").value = "";
            document.getElementById("credentialsForm").classList.add("hidden");

            // Limpiar selecciÃ³n de user types
            document.querySelectorAll(".user-type-card").forEach((card) => {
                card.classList.remove("active");
            });

            // Resetear pestaÃ±as a estado inicial
            document
                .querySelectorAll(".tab-content")
                .forEach((tab) => tab.classList.add("hidden"));
            document
                .querySelectorAll(".nav-item")
                .forEach((tab) => tab.classList.remove("active"));

            // Activar dashboard tab por defecto
            document.getElementById("content-dashboard").classList.remove("hidden");
            document.getElementById("tab-dashboard").classList.add("active");

            // Limpiar contenido dinÃ¡mico
            document.getElementById("operationResult").innerHTML = "";
            // Ocultar elementos exclusivos del admin
            document.getElementById("adminExportSection").classList.add("hidden");
            document.getElementById("deleteHistoryBtn").classList.add("hidden");
            document.getElementById("notificationBell").classList.add("hidden");
            document.getElementById("notificationDropdown").classList.remove("active");
            document.body.style.overflow = ""; // Restaurar scroll

            // Forzar re-centrado del login container
            const loginContainer = document.querySelector(".login-container");
            if (loginContainer) {
                loginContainer.style.display = "flex";
                loginContainer.style.alignItems = "center";
                loginContainer.style.justifyContent = "center";
            }

            // Resetear estilos del body que podrÃ­an estar afectando
            document.body.style.overflow = "";

            // Forzar reflow para asegurar estilos correctos
            setTimeout(() => {
                const loginCard = document.querySelector(".login-card");
                if (loginCard) {
                    loginCard.style.transform = "";
                    loginCard.style.margin = "";
                }
            }, 100);
        }

        function setupUserPermissions() {
            const tabs = [
                "dashboard",
                "inventory",
                "management",
                "statistics",
                "history",
                "loans",
            ];

            tabs.forEach((tab) => {
                const tabElement = document.getElementById(`tab-${tab}`);

                if (currentRole === "visitor") {
                    if (tab === "inventory") {
                        tabElement.style.display = "flex";
                    } else {
                        tabElement.style.display = "none";
                    }
                } else if (currentRole === "operator") {
                    if (["inventory", "management"].includes(tab)) {
                        tabElement.style.display = "flex";
                    } else {
                        tabElement.style.display = "none";
                    }
                } else {
                    tabElement.style.display = "flex";
                }
            });

            // Configurar visibilidad de tarjetas del dashboard
            const managementCard = document.getElementById("managementCard");
            const statisticsCard = document.getElementById("statisticsCard");
            const historyCard = document.getElementById("historyCard");

            if (currentRole === "visitor") {
                managementCard.style.display = "none";
                statisticsCard.style.display = "none";
                historyCard.style.display = "none";
            } else if (currentRole === "operator") {
                managementCard.style.display = "block";
                statisticsCard.style.display = "none";
                historyCard.style.display = "none";
            } else {
                managementCard.style.display = "block";
                statisticsCard.style.display = "block";
                historyCard.style.display = "block";
            }

            if (currentRole === "admin") {
                document
                    .getElementById("adminExportSection")
                    .classList.remove("hidden");
                document
                    .getElementById("deleteHistoryBtn")
                    .classList.remove("hidden")
            }

            if (currentRole === "visitor") {
                showTab("inventory");
            }

            // Mostrar secciÃ³n de solicitudes solo para visitantes
            const visitorRequestSection = document.getElementById("visitorRequestSection");
            if (visitorRequestSection) {
                if (currentRole === "visitor") {
                    visitorRequestSection.style.display = "block";
                } else {
                    visitorRequestSection.style.display = "none";
                }
            }
        }

        function showTab(tabName) {
            document
                .querySelectorAll(".tab-content")
                .forEach((tab) => tab.classList.add("hidden"));
            document
                .querySelectorAll(".nav-item")
                .forEach((tab) => tab.classList.remove("active"));

            document
                .getElementById(`content-${tabName}`)
                .classList.remove("hidden");
            document.getElementById(`tab-${tabName}`).classList.add("active");

            // Force update dashboard numbers when switching to dashboard
            if (tabName === "dashboard") {
                setTimeout(() => {
                    updateDashboard();
                }, 150);
            }

            updateUI();
            window.scrollTo(0, 0);
        }

        function updateUI() {
            const activeTab = document
                .querySelector(".nav-item.active")
                .id.replace("tab-", "");

            switch (activeTab) {
                case "dashboard":
                    updateDashboard();
                    break;
                case "inventory":
                    updateInventory();
                    break;
                case "management":
                    updateManagementInfo();
                    break;
                case "statistics":
                    updateStatistics();
                    break;
                case "history":
                    updateHistory();
                    break;
                case "loans":
                    updateActiveLoans();
                    break
            }
        }

        function updateInventory() {
            // Si no hay filtro de bÃºsqueda, usar todos los productos
            if (!document.getElementById("searchInventory").value.trim()) {
                filteredProducts = [...products];
            }

            renderInventoryPage();
            updatePaginationControls();
            updateInventoryCount();
        }

        // Renderizar productos de la pÃ¡gina actual
        function renderInventoryPage() {
            const tbody = document.getElementById("inventoryBody");
            tbody.innerHTML = "";

            // Calcular rango de productos para la pÃ¡gina actual
            const startIndex = (currentPage - 1) * itemsPerPage;
            const endIndex = startIndex + itemsPerPage;
            const pageProducts = filteredProducts.slice(startIndex, endIndex);

            pageProducts.forEach((product) => {
                const row = document.createElement("tr");
                const locationStr = `
            <div style="font-size: 0.85rem; line-height: 1.4;">
                <div><strong>ð EstanterÃ­a:</strong> ${product.location.shelf}</div>
                <div><strong>ð¦ Rack:</strong> ${product.location.rack}</div>
                <div><strong>ð¢ Nivel:</strong> ${product.location.level}</div>
            </div>
        `;
                const statusClass = `status-${product.status
                    .toLowerCase()
                    .replace(" ", "-")}`;

                row.innerHTML = `
            <td><strong>${product.code}</strong></td>
            <td>${product.name}</td>
            <td>${product.category}</td>
            <td><span class="status-badge ${statusClass}">${product.status}</span></td>
            <td><strong>${product.quantity}</strong></td>
            <td>${locationStr}</td>
        `;
                tbody.appendChild(row);
            });

            // Si no hay productos en esta pÃ¡gina
            if (pageProducts.length === 0) {
                const row = document.createElement("tr");
                row.innerHTML = `
            <td colspan="6" style="text-align: center; padding: 2rem; color: var(--gray-500);">
                ${filteredProducts.length === 0 ? "No se encontraron productos" : "No hay productos en esta pÃ¡gina"}
            </td>
        `;
                tbody.appendChild(row);
            }
        }

        // Actualizar controles de paginaciÃ³n
        function updatePaginationControls() {
            totalPages = Math.ceil(filteredProducts.length / itemsPerPage);

            // Actualizar informaciÃ³n de pÃ¡gina
            document.getElementById("paginationInfo").textContent =
                `PÃ¡gina ${currentPage} de ${totalPages}`;

            // Actualizar botones de navegaciÃ³n
            document.getElementById("firstPageBtn").disabled = currentPage === 1;
            document.getElementById("prevPageBtn").disabled = currentPage === 1;
            document.getElementById("nextPageBtn").disabled = currentPage === totalPages;
            document.getElementById("lastPageBtn").disabled = currentPage === totalPages;

            // Actualizar input de salto de pÃ¡gina
            document.getElementById("jumpToPage").max = totalPages;
            document.getElementById("jumpToPage").value = currentPage;

            // Generar nÃºmeros de pÃ¡gina
            generatePageNumbers();

            // Mostrar/ocultar paginaciÃ³n si es necesaria
            const paginationContainer = document.getElementById("paginationContainer");
            if (totalPages <= 1) {
                paginationContainer.style.display = "none";
            } else {
                paginationContainer.style.display = "flex";
            }
        }

        // Generar nÃºmeros de pÃ¡gina
        function generatePageNumbers() {
            const numbersContainer = document.getElementById("paginationNumbers");
            numbersContainer.innerHTML = "";

            let startPage = Math.max(1, currentPage - 2);
            let endPage = Math.min(totalPages, currentPage + 2);

            // Ajustar rango si estamos cerca del inicio o final
            if (currentPage <= 3) {
                endPage = Math.min(5, totalPages);
            }
            if (currentPage > totalPages - 3) {
                startPage = Math.max(1, totalPages - 4);
            }

            // BotÃ³n de primera pÃ¡gina si no estÃ¡ visible
            if (startPage > 1) {
                const firstBtn = createPageButton(1);
                numbersContainer.appendChild(firstBtn);

                if (startPage > 2) {
                    const ellipsis = document.createElement("span");
                    ellipsis.className = "pagination-ellipsis";
                    ellipsis.textContent = "...";
                    numbersContainer.appendChild(ellipsis);
                }
            }

            // Generar botones de pÃ¡gina
            for (let i = startPage; i <= endPage; i++) {
                const pageBtn = createPageButton(i);
                if (i === currentPage) {
                    pageBtn.classList.add("active");
                }
                numbersContainer.appendChild(pageBtn);
            }

            // BotÃ³n de Ãºltima pÃ¡gina si no estÃ¡ visible
            if (endPage < totalPages) {
                if (endPage < totalPages - 1) {
                    const ellipsis = document.createElement("span");
                    ellipsis.className = "pagination-ellipsis";
                    ellipsis.textContent = "...";
                    numbersContainer.appendChild(ellipsis);
                }

                const lastBtn = createPageButton(totalPages);
                numbersContainer.appendChild(lastBtn);
            }
        }

        // Crear botÃ³n de pÃ¡gina
        function createPageButton(pageNumber) {
            const button = document.createElement("button");
            button.className = "pagination-btn";
            button.textContent = pageNumber;
            button.onclick = () => goToPage(pageNumber);
            return button;
        }

        // Actualizar contador de inventario
        function updateInventoryCount() {
            const startIndex = (currentPage - 1) * itemsPerPage;
            const endIndex = Math.min(startIndex + itemsPerPage, filteredProducts.length);
            const showing = filteredProducts.length === 0 ? 0 : endIndex - startIndex;

            document.getElementById("inventoryCount").textContent =
                `Mostrando ${showing} de ${filteredProducts.length} productos`;
        }

        function goToPage(page) {
            if (page >= 1 && page <= totalPages) {
                currentPage = page;
                renderInventoryPage();
                updatePaginationControls();
                updateInventoryCount();

                // Scroll al inicio de la tabla
                document.getElementById("inventoryBody").scrollIntoView({
                    behavior: 'smooth',
                    block: 'start'
                });
            }
        }

        function goToPreviousPage() {
            goToPage(currentPage - 1);
        }

        function goToNextPage() {
            goToPage(currentPage + 1);
        }

        function goToFirstPage() {
            goToPage(1);
        }

        function goToLastPage() {
            goToPage(totalPages);
        }

        function jumpToSpecificPage() {
            const jumpInput = document.getElementById("jumpToPage");
            const page = parseInt(jumpInput.value);
            if (page && page >= 1 && page <= totalPages) {
                goToPage(page);
            } else {
                alert(`â Ingresa un nÃºmero entre 1 y ${totalPages}`);
                jumpInput.value = currentPage;
            }
        }

        function jumpToPageOnEnter(event) {
            if (event.key === 'Enter') {
                jumpToSpecificPage();
            }
        }

        function changeItemsPerPage() {
            const newItemsPerPage = parseInt(document.getElementById("itemsPerPage").value);

            // Calcular en quÃ© pÃ¡gina deberÃ­a estar el primer elemento visible actualmente
            const currentFirstItem = (currentPage - 1) * itemsPerPage;

            itemsPerPage = newItemsPerPage;
            currentPage = Math.floor(currentFirstItem / itemsPerPage) + 1;

            renderInventoryPage();
            updatePaginationControls();
            updateInventoryCount();
        }

        function filterInventory() {
            const searchTerm = document.getElementById("searchInventory").value.toLowerCase();

            // Filtrar productos
            if (searchTerm.trim() === "") {
                filteredProducts = [...products];
            } else {
                filteredProducts = products.filter(product => {
                    const codeMatch = product.code && product.code.toLowerCase().includes(searchTerm);
                    const nameMatch = product.name && product.name.toLowerCase().includes(searchTerm);
                    const categoryMatch = product.category && product.category.toLowerCase().includes(searchTerm);
                    const statusMatch = product.status && product.status.toLowerCase().includes(searchTerm);

                    return codeMatch || nameMatch || categoryMatch || statusMatch;
                });
            }

            // Resetear a pÃ¡gina 1 despuÃ©s de filtrar
            currentPage = 1;

            // Actualizar vista
            renderInventoryPage();
            updatePaginationControls();
            updateInventoryCount();
        }

        function updateStatistics() {
            // Actualizar nÃºmeros principales
            const totalProducts = products.length;
            const totalStock = products.reduce((sum, p) => sum + p.quantity, 0);
            const availableCount = products.filter(
                (p) => p.status === "Disponible"
            ).length;
            const inUseCount = products.filter((p) => p.status === "En uso").length;
            const maintenanceCount = products.filter(
                (p) => p.status === "Mantenimiento"
            ).length;
            const unavailableCount = products.filter(
                (p) => p.status === "No disponible"
            ).length;
            const activeLoansCount = loans.filter(
                (l) => l.status === "Activo"
            ).length;

            // Verificar que los elementos existen antes de actualizar
            const uniqueProductsEl = document.getElementById("uniqueProducts");
            const totalStockStatsEl = document.getElementById("totalStockStats");
            const totalValueEl = document.getElementById("totalValue");
            const activeLoansStatsEl = document.getElementById("activeLoansStats");
            const availableProductsEl =
                document.getElementById("availableProducts");
            const inUseProductsEl = document.getElementById("inUseProducts");
            const maintenanceProductsEl = document.getElementById(
                "maintenanceProducts"
            );
            const unavailableProductsEl = document.getElementById(
                "unavailableProducts"
            );

            if (uniqueProductsEl) uniqueProductsEl.textContent = totalProducts;
            if (totalStockStatsEl) totalStockStatsEl.textContent = totalStock;
            if (totalValueEl)
                totalValueEl.textContent = `${(totalStock * 50000).toLocaleString()}`;
            if (activeLoansStatsEl)
                activeLoansStatsEl.textContent = activeLoansCount;
            if (availableProductsEl)
                availableProductsEl.textContent = availableCount;
            if (inUseProductsEl) inUseProductsEl.textContent = inUseCount;
            if (maintenanceProductsEl)
                maintenanceProductsEl.textContent = maintenanceCount;
            if (unavailableProductsEl)
                unavailableProductsEl.textContent = unavailableCount;

            // Actualizar grÃ¡fico de categorÃ­as
            const categories = {};
            products.forEach((product) => {
                categories[product.category] =
                    (categories[product.category] || 0) + 1;
            });

            const categoryChart = document.getElementById("categoryChart");
            if (categoryChart) {
                categoryChart.innerHTML = "";

                Object.entries(categories).forEach(([category, count]) => {
                    const percentage =
                        totalProducts > 0
                            ? ((count / totalProducts) * 100).toFixed(1)
                            : 0;

                    const categoryBar = document.createElement("div");
                    categoryBar.className = "category-bar";
                    categoryBar.innerHTML = `
                        <div class="category-info">
                            <span class="category-name">${category}</span>
                            <span class="category-percentage">${percentage}%</span>
                        </div>
                        <div class="progress-bar">
                            <div class="progress-fill" style="width: ${percentage}%"></div>
                        </div>
                    `;
                    categoryChart.appendChild(categoryBar);
                });
            }

            // Generar insights automÃ¡ticos
            generateInsights(
                totalProducts,
                totalStock,
                availableCount,
                maintenanceCount,
                activeLoansCount,
                categories
            );
        }

        function generateInsights(
            totalProducts,
            totalStock,
            availableCount,
            maintenanceCount,
            activeLoansCount,
            categories
        ) {
            const insightsContainer = document.getElementById("insightsContainer");
            insightsContainer.innerHTML = "";

            const insights = [];

            // Insight sobre disponibilidad
            const availabilityRate =
                totalProducts > 0
                    ? ((availableCount / totalProducts) * 100).toFixed(1)
                    : 0;
            if (availabilityRate < 70) {
                insights.push({
                    icon: "â ï¸",
                    title: "Baja Disponibilidad",
                    text: `Solo el ${availabilityRate}% de productos estÃ¡n disponibles. Considera revisar productos en mantenimiento.`,
                });
            } else if (availabilityRate > 90) {
                insights.push({
                    icon: "â",
                    title: "Excelente Disponibilidad",
                    text: `El ${availabilityRate}% de productos estÃ¡n disponibles. El inventario estÃ¡ en Ã³ptimas condiciones.`,
                });
            }

            // Insight sobre mantenimiento
            if (maintenanceCount > 0) {
                insights.push({
                    icon: "ð§",
                    title: "Productos en Mantenimiento",
                    text: `Hay ${maintenanceCount} productos que requieren atenciÃ³n. Programa revisiones periÃ³dicas.`,
                });
            }

            // Insight sobre prÃ©stamos
            if (activeLoansCount > totalStock * 0.3) {
                insights.push({
                    icon: "ð",
                    title: "Alta Demanda de PrÃ©stamos",
                    text: `Hay ${activeLoansCount} prÃ©stamos activos. Considera aumentar el stock de productos populares.`,
                });
            }

            // Insight sobre categorÃ­as
            const topCategory = Object.entries(categories).sort(
                (a, b) => b[1] - a[1]
            )[0];
            if (topCategory) {
                const categoryPercentage = (
                    (topCategory[1] / totalProducts) *
                    100
                ).toFixed(1);
                insights.push({
                    icon: "ð",
                    title: "CategorÃ­a Dominante",
                    text: `${topCategory[0]} representa el ${categoryPercentage}% del inventario con ${topCategory[1]} productos.`,
                });
            }

            // Insight de eficiencia
            const efficiencyRate =
                totalProducts > 0
                    ? (
                        ((totalProducts - maintenanceCount) / totalProducts) *
                        100
                    ).toFixed(1)
                    : 0;
            insights.push({
                icon: "â¡",
                title: "Eficiencia del Sistema",
                text: `El sistema opera al ${efficiencyRate}% de eficiencia con ${totalStock} unidades totales en inventario.`,
            });

            // Renderizar insights
            insights.forEach((insight) => {
                const insightElement = document.createElement("div");
                insightElement.className = "insight-item";
                insightElement.innerHTML = `
                    <div class="insight-icon">${insight.icon}</div>
                    <div class="insight-content">
                        <h4>${insight.title}</h4>
                        <p>${insight.text}</p>
                    </div>
                `;
                insightsContainer.appendChild(insightElement);
            });
        }

        function updateHistory() {
            const tbody = document.getElementById("historyBody");
            tbody.innerHTML = "";

            history.forEach((record) => {
                const row = document.createElement("tr");
                row.innerHTML = `
                    <td>${record.date}</td>
                    <td><strong>${record.user}</strong></td>
                    <td>${record.operation}</td>
                    <td>${record.product}</td>
                    <td>${record.details}</td>
                `;
                tbody.appendChild(row);
            });
        }

        // FunciÃ³n para actualizar prÃ©stamos activos - Optimizada
        // FunciÃ³n mejorada para prevenir duplicaciÃ³n
        function updateActiveLoans() {
            const tbody = document.getElementById("activeLoansBody");
            if (!tbody) {
                console.error("No se encontrÃ³ el elemento activeLoansBody");
                return;
            }

            // Verificar si ya se estÃ¡ ejecutando
            if (tbody.dataset.updating === 'true') {
                console.log('â¸ï¸ updateActiveLoans ya se estÃ¡ ejecutando, saltando...');
                return;
            }

            // Marcar como en proceso
            tbody.dataset.updating = 'true';

            try {
                // Limpiar completamente
                tbody.innerHTML = "";

                const activeLoans = loans.filter(loan => loan.status === "Activo");
                const today = new Date();
                const threeDaysFromNow = new Date(today.getTime() + 3 * 24 * 60 * 60 * 1000);

                let totalActive = 0;
                let upcoming = 0;
                let overdue = 0;
                let onTime = 0;

                // Crear un Set para evitar duplicados por ID
                const processedLoans = new Set();

                activeLoans.forEach((loan) => {
                    // Evitar duplicados por ID
                    if (processedLoans.has(loan.id)) {
                        console.warn('â ï¸ PrÃ©stamo duplicado detectado y omitido:', loan.id);
                        return;
                    }
                    processedLoans.add(loan.id);

                    const returnDate = new Date(loan.returnDate);
                    let status = "";
                    let statusClass = "";
                    let statusIcon = "";

                    totalActive++;

                    if (returnDate < today) {
                        status = "VENCIDO";
                        statusClass = "status-unavailable status-overdue";
                        statusIcon = "ð¨";
                        overdue++;
                    } else if (returnDate <= threeDaysFromNow) {
                        status = "POR VENCER";
                        statusClass = "status-maintenance";
                        statusIcon = "â°";
                        upcoming++;
                    } else {
                        status = "A TIEMPO";
                        statusClass = "status-available";
                        statusIcon = "â";
                        onTime++;
                    }

                    const daysDiff = Math.ceil((returnDate - today) / (1000 * 60 * 60 * 24));
                    const daysText = daysDiff < 0 ? `${Math.abs(daysDiff)} dÃ­as vencido` :
                        daysDiff === 0 ? "Vence hoy" :
                            `${daysDiff} dÃ­as restantes`;

                    // InformaciÃ³n del producto (diferente para prÃ©stamos grupales)
                    let productInfo = '';
                    if (loan.bulkLoan) {
                        const returnedCount = loan.returnedCodes ? loan.returnedCodes.length : 0;
                        const totalCodes = loan.individualCodes ? loan.individualCodes.length : loan.quantity;
                        const pendingCount = totalCodes - returnedCount;

                        productInfo = `
                    <div style="font-weight: bold; margin-bottom: 0.2rem; font-size: 0.9rem;">${loan.productName} ð¦</div>
                    <div style="font-size: 0.75rem; color: var(--gray-600); line-height: 1.3;">
                        ð·ï¸ PrÃ©stamo grupal<br>
                        ð ${pendingCount}/${totalCodes} pendientes<br>
                        ð¼ ${loan.individualCodes.slice(0, 2).join(', ')}${totalCodes > 2 ? '...' : ''}
                    </div>
                `;
                    } else {
                        productInfo = `
                    <div style="font-weight: bold; margin-bottom: 0.2rem; font-size: 0.9rem;">${loan.productName}</div>
                    <div style="font-size: 0.75rem; color: var(--gray-600);">${loan.productCode}</div>
                `;
                    }

                    const row = document.createElement("tr");
                    row.innerHTML = `
                <td class="loan-product-cell">${productInfo}</td>
                <td class="loan-borrower-cell">
                    <div style="font-weight: bold; margin-bottom: 0.2rem; font-size: 0.9rem;">${loan.borrower}</div>
                    <div style="font-size: 0.75rem; color: var(--gray-600);">${loan.borrowerRut || ''}</div>
                </td>
                <td class="loan-email-cell">
                    <div style="font-size: 0.8rem; color: var(--gray-700);">${loan.borrowerEmail}</div>
                </td>
                <td class="loan-quantity-cell">${loan.bulkLoan ? (loan.individualCodes ? loan.individualCodes.length - (loan.returnedCodes ? loan.returnedCodes.length : 0) : loan.quantity) : loan.quantity}</td>
                <td class="loan-date-cell">${loan.loanDate}</td>
                <td class="loan-date-cell">${loan.returnDate}</td>
                <td class="loan-status-cell">
                    <div style="font-weight: bold; font-size: 0.9rem; color: ${daysDiff < 0 ? '#e74c3c' : daysDiff <= 3 ? '#f39c12' : '#27ae60'}">${status}</div>
                    <div style="font-size: 0.8rem; color: ${daysDiff < 0 ? '#e74c3c' : daysDiff <= 3 ? '#f39c12' : '#27ae60'}">${daysText}</div>
                </td>
            `;
                    tbody.appendChild(row);
                });

                // Actualizar resumen con verificaciÃ³n de elementos
                const totalActiveEl = document.getElementById("totalActiveLoans");
                const upcomingDueEl = document.getElementById("upcomingDueLoans");
                const overdueEl = document.getElementById("overdueLoans");
                const onTimeEl = document.getElementById("onTimeLoans");

                if (totalActiveEl) totalActiveEl.textContent = totalActive;
                if (upcomingDueEl) upcomingDueEl.textContent = upcoming;
                if (overdueEl) overdueEl.textContent = overdue;
                if (onTimeEl) onTimeEl.textContent = onTime;

                console.log('â PrÃ©stamos renderizados exitosamente:', totalActive, 'prÃ©stamos activos');

            } catch (error) {
                console.error('â Error en updateActiveLoans:', error);
            } finally {
                // Desmarcar como en proceso
                tbody.dataset.updating = 'false';
            }
        }

        // FunciÃ³n para filtrar prÃ©stamos activos
        function filterActiveLoans() {
            const searchTerm = document.getElementById("searchLoans").value.toLowerCase();
            const rows = document.querySelectorAll("#activeLoansBody tr");

            rows.forEach((row) => {
                const text = row.textContent.toLowerCase();
                row.style.display = text.includes(searchTerm) ? "" : "none";
            });
        }

        // FunciÃ³n para enviar recordatorios masivos
        async function sendBulkReminders(type) {
            if (!isEmailJSReady) {
                alert("â ï¸ El servicio de correo no estÃ¡ disponible en este momento");
                return;
            }

            const today = new Date();
            const threeDaysFromNow = new Date(today.getTime() + 3 * 24 * 60 * 60 * 1000);

            let targetLoans = [];
            let actionDescription = "";

            if (type === 'upcoming') {
                targetLoans = loans.filter(loan => {
                    if (loan.status !== "Activo") return false;
                    const returnDate = new Date(loan.returnDate);
                    return returnDate > today && returnDate <= threeDaysFromNow;
                });
                actionDescription = "prÃ©stamos que vencen en los prÃ³ximos 3 dÃ­as";
            } else if (type === 'overdue') {
                targetLoans = loans.filter(loan => {
                    if (loan.status !== "Activo") return false;
                    const returnDate = new Date(loan.returnDate);
                    return returnDate < today;
                });
                actionDescription = "prÃ©stamos vencidos";
            }

            if (targetLoans.length === 0) {
                alert(`â¹ï¸ No hay ${actionDescription} para enviar recordatorios.`);
                return;
            }

            const confirmed = confirm(`ð§ Â¿Enviar recordatorios a ${targetLoans.length} ${actionDescription}?

Lista de destinatarios:
${targetLoans.map(loan => `â¢ ${loan.borrower} - ${loan.productName}`).join('\n')}

Â¿Continuar?`);

            if (!confirmed) return;

            let successCount = 0;
            let errorCount = 0;

            updateEmailStatus("sending");

            for (const loan of targetLoans) {
                try {
                    const returnDate = new Date(loan.returnDate);
                    const daysDiff = Math.ceil((returnDate - today) / (1000 * 60 * 60 * 24));
                    const isOverdue = returnDate < today;

                    let subject, urgencyLevel, message;

                    if (type === 'overdue' || isOverdue) {
                        subject = `ð¨ URGENTE: DevoluciÃ³n vencida - ${loan.productName}`;
                        urgencyLevel = "URGENTE - VENCIDO";
                        message = `Tu prÃ©stamo venciÃ³ hace ${Math.abs(daysDiff)} dÃ­a(s). Favor devolver inmediatamente.`;
                    } else {
                        subject = `â° Recordatorio: DevoluciÃ³n prÃ³xima - ${loan.productName}`;
                        urgencyLevel = "RECORDATORIO";
                        message = daysDiff === 0 ? "Tu prÃ©stamo vence HOY" : `Tu prÃ©stamo vence en ${daysDiff} dÃ­a(s)`;
                    }

                    const templateParams = {
                        to_name: loan.borrower,
                        to_email: loan.borrowerEmail,
                        product_name: loan.productName,
                        product_code: loan.productCode,
                        quantity: loan.quantity,
                        loan_date: loan.loanDate,
                        return_date: loan.returnDate,
                        borrower_name: loan.borrower,
                        borrower_rut: loan.borrowerRut,
                        urgency_level: urgencyLevel,
                        days_info: message,
                        subject: subject,
                        liceo_name: "Liceo RÃ­os de Chile - LirquÃ©n",
                        contact_email: "victor.mulchi@liceoriosdechile.cl",
                        system_name: "Sistema de Inventario"
                    };

                    const response = await emailjs.send(
                        emailjsConfig.serviceId,
                        emailjsConfig.templateId,
                        templateParams
                    );

                    console.log('â Recordatorio enviado a:', loan.borrower);
                    successCount++;

                    // Registrar en historial
                    await addToHistory(
                        `Recordatorio ${type === 'overdue' ? 'urgente' : 'normal'} enviado`,
                        loan.productName,
                        `Enviado a: ${loan.borrower} (${loan.borrowerEmail})`
                    );

                    // PequeÃ±a pausa entre envÃ­os para evitar lÃ­mites
                    await new Promise(resolve => setTimeout(resolve, 1000));

                } catch (error) {
                    console.error(`Error enviando a ${loan.borrower}:`, error);
                    errorCount++;
                }
            }

            updateEmailStatus("ready");

            alert(`ð Proceso completado:

â Enviados exitosamente: ${successCount}
â Errores: ${errorCount}
ð§ Total procesados: ${targetLoans.length}

${errorCount > 0 ? 'Revisa la consola para detalles de los errores.' : 'Todos los recordatorios fueron enviados correctamente.'}`);

            // Registrar resumen en historial
            await addToHistory(
                `Recordatorios masivos ${type}`,
                "Sistema de prÃ©stamos",
                `Enviados: ${successCount}, Errores: ${errorCount}, Total: ${targetLoans.length}`
            );
        }

        // FUNCIONES DE NOTIFICACIONES
        function updateNotifications() {
            if (currentRole !== 'admin') return;

            const now = new Date();
            const threeDaysFromNow = new Date(now.getTime() + 3 * 24 * 60 * 60 * 1000);
            const notificationList = document.getElementById("notificationList");
            const notificationCount = document.getElementById("notificationCount");

            let notifications = [];

            // EVITAR DUPLICADOS - Filtrar prÃ©stamos Ãºnicos
            const uniqueActiveLoans = [];
            const seenLoans = new Set();

            loans
                .filter((loan) => loan.status === "Activo")
                .forEach((loan) => {
                    const loanKey = `${loan.productCode}-${loan.borrowerRut}`;
                    if (!seenLoans.has(loanKey)) {
                        seenLoans.add(loanKey);
                        const productExists = products.find((p) => p.code === loan.productCode);
                        if (productExists) {
                            uniqueActiveLoans.push(loan);
                        }
                    }
                });

            uniqueActiveLoans.forEach((loan) => {
                const returnDate = new Date(loan.returnDate);

                if (returnDate < now) {
                    const daysPastDue = Math.floor((now - returnDate) / (1000 * 60 * 60 * 24));
                    notifications.push({
                        type: 'overdue',
                        icon: 'ð¨',
                        title: 'Â¡PRÃSTAMO VENCIDO!',
                        message: `El prÃ©stamo de "${loan.productName}" a ${loan.borrower} venciÃ³ el ${loan.returnDate}`,
                        time: `Vencido hace ${daysPastDue} dÃ­a${daysPastDue > 1 ? 's' : ''}`
                    });
                } else if (returnDate <= threeDaysFromNow) {
                    const daysUntilDue = Math.ceil((returnDate - now) / (1000 * 60 * 60 * 24));
                    notifications.push({
                        type: 'warning',
                        icon: 'â°',
                        title: 'PrÃ³ximo a vencer',
                        message: `El prÃ©stamo de "${loan.productName}" a ${loan.borrower} vence el ${loan.returnDate}`,
                        time: daysUntilDue === 0 ? 'Vence hoy' : `Vence en ${daysUntilDue} dÃ­a${daysUntilDue > 1 ? 's' : ''}`
                    });
                }
            });

            // Notificaciones de solicitudes pendientes
            const pendingRequests = productRequests.filter(req => req.status === 'Pendiente');

            // Crear grupos por usuario y producto
            const requestGroups = {};
            pendingRequests.forEach(request => {
                const groupKey = `${request.requesterRut}_${request.productName}`;

                if (!requestGroups[groupKey]) {
                    requestGroups[groupKey] = {
                        requesterName: request.requesterName,
                        requesterRut: request.requesterRut,
                        requesterEmail: request.requesterEmail,
                        productName: request.productName,
                        requestedDate: request.requestedDate,
                        returnDate: request.returnDate,
                        requests: [],
                        totalQuantity: 0,
                        requestDate: request.requestDate,
                        requestReason: request.requestReason || 'No especificado'
                    };
                }

                requestGroups[groupKey].requests.push(request);
                requestGroups[groupKey].totalQuantity += (request.requestedQuantity || 1);
            });

            // Crear notificaciones agrupadas
            Object.values(requestGroups).forEach((group) => {
                const requestDate = new Date(group.requestDate);
                const hoursAgo = Math.floor((now - requestDate) / (1000 * 60 * 60));
                const timeAgo = hoursAgo < 1 ? 'Hace unos minutos' :
                    hoursAgo === 1 ? 'Hace 1 hora' :
                        `Hace ${hoursAgo} horas`;

                notifications.push({
                    type: 'request',
                    icon: 'ð',
                    title: `Solicitud ${group.requests.length > 1 ? 'MÃºltiple' : 'de Producto'}`,
                    message: `${group.requesterName} solicita "${group.productName}" (${group.totalQuantity} unidades${group.requests.length > 1 ? ` en ${group.requests.length} cÃ³digos` : ''})`,
                    time: timeAgo,
                    requestGroup: group,
                    isBulkRequest: group.requests.length > 1
                });
            });

            // Actualizar contador
            if (notifications.length > 0) {
                notificationCount.textContent = notifications.length;
                notificationCount.classList.remove("hidden");
            } else {
                notificationCount.classList.add("hidden");
            }

            // Actualizar lista
            if (notifications.length === 0) {
                notificationList.innerHTML = `
            <div class="no-notifications">
                <div class="no-notifications-icon">ð</div>
                <div class="no-notifications-text">No hay notificaciones</div>
            </div>
        `;
            } else {
                notificationList.innerHTML = notifications.map(notification => {
                    if (notification.type === 'request') {
                        if (notification.isBulkRequest) {
                            return `
            <div class="notification-item request bulk-request">
                <span class="notification-icon">${notification.icon}</span>
                <div class="notification-content">
                    <div class="notification-title">${notification.title} â¡</div>
                    <div class="notification-message">${notification.message}</div>
                    <div class="notification-time">${notification.time}</div>
                    <div class="bulk-info">
                        <small>ð Necesario: ${new Date(notification.requestGroup.requestedDate).toLocaleDateString('es-CL')} | 
                        ð§ ${notification.requestGroup.requesterEmail}</small>
                    </div>
                    <div class="notification-actions">
                        <button class="btn btn-success btn-small" onclick="approveBulkRequest('${notification.requestGroup.requesterRut}', '${notification.requestGroup.productName}')">
                            â Aprobar Todo (${notification.requestGroup.totalQuantity})
                        </button>
                        <button class="btn btn-secondary btn-small" onclick="viewBulkRequestDetails('${notification.requestGroup.requesterRut}', '${notification.requestGroup.productName}')">
                            ðï¸ Ver Detalles
                        </button>
                        <button class="btn btn-danger btn-small" onclick="rejectBulkRequest('${notification.requestGroup.requesterRut}', '${notification.requestGroup.productName}')">
                            â Rechazar Todo
                        </button>
                    </div>
                </div>
            </div>
        `;
                        } else {
                            return `
            <div class="notification-item request">
                <span class="notification-icon">${notification.icon}</span>
                <div class="notification-content">
                    <div class="notification-title">${notification.title}</div>
                    <div class="notification-message">${notification.message}</div>
                    <div class="notification-time">${notification.time}</div>
                    <div class="notification-actions">
                        <button class="btn btn-primary btn-small" onclick="approveRequest('${notification.requestGroup.requests[0].id}')">â Aprobar</button>
                        <button class="btn btn-secondary btn-small" onclick="viewRequestDetails('${notification.requestGroup.requests[0].id}')">ðï¸ Detalles</button>
                        <button class="btn btn-secondary btn-small" onclick="rejectRequest('${notification.requestGroup.requests[0].id}')">â Rechazar</button>
                    </div>
                </div>
            </div>
        `;
                        }
                    } else {
                        return `
                <div class="notification-item ${notification.type}">
                    <span class="notification-icon">${notification.icon}</span>
                    <div class="notification-content">
                        <div class="notification-title">${notification.title}</div>
                        <div class="notification-message">${notification.message}</div>
                        <div class="notification-time">${notification.time}</div>
                    </div>
                </div>
            `;
                    }
                }).join('');
            }
        }

        function toggleNotifications() {
            const dropdown = document.getElementById("notificationDropdown");
            const isActive = dropdown.classList.contains("active");

            if (isActive) {
                dropdown.classList.remove("active");
            } else {
                dropdown.classList.add("active");
                updateNotifications();
            }
        }

        // â FUNCIÃN CORREGIDA:
        function clearAllNotifications() {
            const notificationList = document.getElementById("notificationList");
            const notificationCount = document.getElementById("notificationCount");

            notificationList.innerHTML = `
        <div class="no-notifications">
            <div class="no-notifications-icon">ð</div>
            <div class="no-notifications-text">No hay notificaciones</div>
        </div>
    `;

            notificationCount.classList.add("hidden");
            document.getElementById("notificationDropdown").classList.remove("active");
        }

        // Cerrar dropdown al hacer click fuera
        document.addEventListener('click', function (event) {
            const bell = document.getElementById('notificationBell');
            const dropdown = document.getElementById('notificationDropdown');

            if (!bell.contains(event.target) && !dropdown.contains(event.target)) {
                dropdown.classList.remove('active');
            }
        });

        function openModal(operation) {
            // Check permissions for operator
            if (
                currentRole === "operator" &&
                [
                    "updateStock",
                    "lendProduct",
                    "returnProduct",
                    "removeProduct",
                    "deleteProduct",
                ].includes(operation)
            ) {
                const adminPassword = prompt(
                    "ð Ingrese la contraseÃ±a de administrador:"
                );
                if (adminPassword !== "AdminLiceo2025!") {
                    alert("â ContraseÃ±a incorrecta");
                    return;
                }
            }

            const modal = document.getElementById("operationModal");
            const modalTitle = document.getElementById("modalTitle");
            const modalContent = document.getElementById("modalContent");

            modalTitle.textContent = getModalTitle(operation);
            modalContent.innerHTML = getModalContent(operation);
            modal.style.display = "block";
        }

        function closeModal() {
            document.getElementById("operationModal").style.display = "none";
        }

        function showInfoModal(type) {
            const modal = document.getElementById("infoModal");
            const title = document.getElementById("infoModalTitle");
            const body = document.getElementById("infoModalBody");

            const infoContent = {
                category: {
                    title: "CategorÃ­a del Producto",
                    question: "Â¿CÃ³mo seleccionar la categorÃ­a correcta?",
                    description:
                        "Selecciona el tipo de producto segÃºn su naturaleza y uso principal en el liceo.",
                    examples: [
                        "Equipo: Computadores, proyectores, tablets",
                        "Libro: Literatura, textos educativos, manuales",
                        "Material: Ãtiles escolares, papelerÃ­a, insumos",
                        "Herramienta: Instrumentos de laboratorio, herramientas de taller",
                        "Documento: Certificados, archivos importantes",
                    ],
                    usage: [
                        "Piensa en el uso principal del producto",
                        "Considera dÃ³nde se utilizarÃ¡ mÃ¡s frecuentemente",
                        'Si es tecnolÃ³gico, probablemente sea "Equipo"',
                        'Si es para leer o estudiar, selecciona "Libro"',
                    ],
                },
                brand: {
                    title: "Marca del Producto",
                    question: "Â¿QuÃ© informaciÃ³n incluir en marca?",
                    description:
                        "Indica la marca o fabricante del producto para identificaciÃ³n y seguimiento.",
                    examples: [
                        "Epson (para proyectores)",
                        "HP (para computadores)",
                        "Canon (para impresoras)",
                        "Casio (para calculadoras)",
                    ],
                    usage: [
                        "Busca la marca en el producto mismo",
                        "Si no tiene marca visible, puedes dejarlo vacÃ­o",
                        "Escribe el nombre exacto como aparece",
                        "Ayuda para garantÃ­as y soporte tÃ©cnico",
                    ],
                },
                model: {
                    title: "Modelo del Producto",
                    question: "Â¿DÃ³nde encuentro el modelo?",
                    description:
                        "El modelo especÃ­fico ayuda a identificar las caracterÃ­sticas exactas del producto.",
                    examples: [
                        "EB-X41 (modelo de proyector Epson)",
                        "LaserJet Pro M404n (modelo de impresora HP)",
                        "FX-991EX (modelo de calculadora Casio)",
                        "ThinkPad T480 (modelo de laptop Lenovo)",
                    ],
                    usage: [
                        "Busca en etiquetas del producto",
                        "Revisa la caja o documentaciÃ³n",
                        "Si no lo encuentras, dÃ©jalo vacÃ­o",
                        "Ãtil para piezas de repuesto y soporte",
                    ],
                },
                description: {
                    title: "DescripciÃ³n del Producto",
                    question: "Â¿QuÃ© informaciÃ³n incluir en la descripciÃ³n?",
                    description:
                        "Proporciona detalles adicionales sobre el producto, sus caracterÃ­sticas y uso especÃ­fico.",
                    examples: [
                        "Proyector para aulas con resoluciÃ³n Full HD",
                        "Calculadora cientÃ­fica con 417 funciones",
                        "Microscopio binocular para laboratorio de biologÃ­a",
                        "Tablet educativa con aplicaciones preinstaladas",
                    ],
                    usage: [
                        "Incluye caracterÃ­sticas tÃ©cnicas relevantes",
                        "Menciona el uso especÃ­fico en el liceo",
                        "Agrega detalles que ayuden a identificarlo",
                        "Este campo es opcional pero recomendado",
                    ],
                },
                quantity: {
                    title: "Cantidad del Producto",
                    question: "Â¿CÃ³mo determinar la cantidad correcta?",
                    description:
                        "Indica el nÃºmero exacto de unidades que se estÃ¡n ingresando al inventario.",
                    examples: [
                        "1 (para productos Ãºnicos como proyectores)",
                        "30 (para libros de texto del mismo tÃ­tulo)",
                        "15 (para calculadoras del mismo modelo)",
                        "50 (para materiales como cuadernos)",
                    ],
                    usage: [
                        "Cuenta fÃ­sicamente las unidades disponibles",
                        "Solo ingresa productos que estÃ©n fÃ­sicamente presentes",
                        "El nÃºmero debe ser mayor a 0",
                        "Puedes aumentar la cantidad mÃ¡s tarde si recibes mÃ¡s unidades",
                    ],
                },
                status: {
                    title: "Estado del Producto",
                    question: "Â¿QuÃ© estado seleccionar?",
                    description:
                        "Indica la condiciÃ³n actual del producto para un mejor control del inventario.",
                    examples: [
                        "Disponible: Producto listo para ser usado o prestado",
                        "En uso: Producto prestado a estudiantes o profesores",
                        "Mantenimiento: Producto en reparaciÃ³n o revisiÃ³n",
                        "No disponible: Producto daÃ±ado o fuera de servicio",
                    ],
                    usage: [
                        'La mayorÃ­a de productos nuevos serÃ¡n "Disponible"',
                        'Usa "En uso" solo si ya estÃ¡ prestado al ingresar',
                        'Selecciona "Mantenimiento" si necesita revisiÃ³n',
                        '"No disponible" para productos daÃ±ados o perdidos',
                    ],
                },
                stockQuantity: {
                    title: "Cantidad a Aumentar",
                    question: "Â¿CuÃ¡ntas unidades agregar?",
                    description:
                        "Especifica el nÃºmero de unidades que se sumarÃ¡n al stock actual del producto.",
                    examples: [
                        "5 (si recibiste 5 unidades nuevas)",
                        "1 (para productos Ãºnicos)",
                        "20 (para materiales como cuadernos)",
                        "10 (para libros de texto adicionales)",
                    ],
                    usage: [
                        "Solo ingresa las unidades que fÃ­sicamente agregaste",
                        "El sistema sumarÃ¡ esta cantidad al stock existente",
                        "Verifica que el producto estÃ© presente antes de agregar",
                        "El nÃºmero debe ser mayor a 0",
                    ],
                },
                lendQuantity: {
                    title: "Cantidad a Prestar",
                    question: "Â¿CuÃ¡ntas unidades prestar?",
                    description:
                        "Indica cuÃ¡ntas unidades del producto se van a prestar al solicitante.",
                    examples: [
                        "1 (para productos Ãºnicos como proyectores)",
                        "2 (para calculadoras si el estudiante necesita mÃ¡s)",
                        "5 (para libros si es un grupo de estudio)",
                        "3 (para materiales de laboratorio)",
                    ],
                    usage: [
                        "No puede exceder el stock disponible",
                        "Considera cuÃ¡nto realmente necesita el solicitante",
                        "Para productos valiosos, presta solo lo necesario",
                        "El stock se reducirÃ¡ automÃ¡ticamente",
                    ],
                },
                borrowerInfo: {
                    title: "InformaciÃ³n del Solicitante",
                    question: "Â¿QuÃ© datos del solicitante registrar?",
                    description:
                        "Datos necesarios para identificar y contactar a la persona que solicita el prÃ©stamo.",
                    examples: [
                        "Juan PÃ©rez SÃ¡nchez (nombre completo)",
                        "MarÃ­a GonzÃ¡lez LÃ³pez (estudiante)",
                        "Carlos RodrÃ­guez (profesor)",
                        "Ana Torres (personal administrativo)",
                    ],
                    usage: [
                        "Solicita nombre completo para evitar confusiones",
                        "Verifica la identidad antes de registrar",
                        "Incluye apellidos para mayor precisiÃ³n",
                        "MantÃ©n registros claros para seguimiento",
                    ],
                },
                borrowerRut: {
                    title: "RUT del Solicitante",
                    question: "Â¿CÃ³mo ingresar el RUT correctamente?",
                    description:
                        "NÃºmero de identificaciÃ³n Ãºnico para validar la identidad del solicitante.",
                    examples: [
                        "12.345.678-9 (con puntos y guiÃ³n)",
                        "20.123.456-K (dÃ­gito verificador K)",
                        "15.987.654-0 (estudiante)",
                        "8.765.432-1 (profesor)",
                    ],
                    usage: [
                        "Incluye puntos y guiÃ³n para mayor claridad",
                        "Verifica que coincida con documento de identidad",
                        "El dÃ­gito verificador es obligatorio",
                        "Ãtil para registros oficiales y seguimiento",
                    ],
                },
                borrowerEmail: {
                    title: "Correo del Solicitante",
                    question: "Â¿Para quÃ© sirve el correo electrÃ³nico?",
                    description:
                        "Email de contacto para enviar recordatorios y notificaciones sobre el prÃ©stamo.",
                    examples: [
                        "juan.perez@estudiante.com (estudiante)",
                        "maria.gonzalez@liceorios.cl (profesora)",
                        "carlos.admin@liceorios.cl (personal)",
                        "ana.torres@outlook.com (externo)",
                    ],
                    usage: [
                        "Verifica que el email estÃ© activo",
                        "Prefiere emails institucionales cuando sea posible",
                        "Se usarÃ¡ para recordatorios de devoluciÃ³n",
                        "Permite comunicaciÃ³n directa sobre el prÃ©stamo",
                    ],
                },
                returnDate: {
                    title: "Fecha de DevoluciÃ³n",
                    question: "Â¿CÃ³mo establecer la fecha lÃ­mite?",
                    description:
                        "Fecha en la que el producto debe ser devuelto al inventario.",
                    examples: [
                        "Una semana para equipos tecnolÃ³gicos",
                        "Un mes para libros de estudio",
                        "Mismo dÃ­a para materiales de clase",
                        "Fin de semestre para proyectos largos",
                    ],
                    usage: [
                        "Considera el tipo de producto y su demanda",
                        "Establece fechas realistas segÃºn el uso",
                        "El sistema alertarÃ¡ 3 dÃ­as antes del vencimiento",
                        "Puedes extender el plazo si es necesario",
                    ],
                },
                bookAuthor: {
                    title: "Autor del Libro",
                    question: "Â¿CÃ³mo registrar correctamente el autor?",
                    description:
                        "Nombre completo del autor principal del libro, siguiendo las convenciones bibliogrÃ¡ficas.",
                    examples: [
                        "Gabriel GarcÃ­a MÃ¡rquez",
                        "Isabel Allende",
                        "Mario Vargas Llosa",
                        "Pablo Neruda",
                    ],
                    usage: [
                        "Escribe nombre y apellido completos",
                        "Si hay mÃºltiples autores, ingresa el principal",
                        "Usa la forma como aparece en la portada del libro",
                        "Evita abreviaciones innecesarias",
                    ],
                },
                bookPublisher: {
                    title: "Editorial del Libro",
                    question: "Â¿QuÃ© editorial registrar?",
                    description:
                        "Casa editorial o sello que publicÃ³ esta ediciÃ³n especÃ­fica del libro.",
                    examples: [
                        "Planeta",
                        "Sudamericana",
                        "Alfaguara",
                        "Editorial Universitaria",
                    ],
                    usage: [
                        "Busca en la pÃ¡gina de crÃ©ditos del libro",
                        "Usa el nombre exacto como aparece",
                        "Importante para identificar ediciones",
                        "Ãtil para contactar por reposiciones",
                    ],
                },
                bookYear: {
                    title: "AÃ±o de PublicaciÃ³n",
                    question: "Â¿QuÃ© aÃ±o registrar?",
                    description:
                        "AÃ±o en que se publicÃ³ esta ediciÃ³n especÃ­fica del libro.",
                    examples: [
                        "2024 (ediciÃ³n mÃ¡s reciente)",
                        "2020 (ediciÃ³n utilizada en clases)",
                        "1967 (primera ediciÃ³n histÃ³rica)",
                        "2022 (reediciÃ³n actualizada)",
                    ],
                    usage: [
                        "Busca en la pÃ¡gina de crÃ©ditos",
                        "Usa el aÃ±o de la ediciÃ³n que tienes fÃ­sicamente",
                        "No confundir con el aÃ±o de primera publicaciÃ³n",
                        "Importante para identificar versiones actualizadas",
                    ],
                },
                bookISBN: {
                    title: "CÃ³digo ISBN",
                    question: "Â¿DÃ³nde encuentro el ISBN?",
                    description:
                        "CÃ³digo internacional Ãºnico de 13 dÃ­gitos que identifica especÃ­ficamente esta ediciÃ³n.",
                    examples: [
                        "978-956-200-123-4",
                        "978-84-376-0494-7",
                        "978-987-1144-25-6",
                        "978-956-16-0123-9",
                    ],
                    usage: [
                        "Busca en la contraportada o pÃ¡gina de crÃ©ditos",
                        "Incluye los guiones para mayor claridad",
                        "Es Ãºnico para cada ediciÃ³n del libro",
                        "Ãtil para pedidos y catalogaciÃ³n",
                    ],
                },
                bookSynopsis: {
                    title: "Sinopsis del Libro",
                    question: "Â¿QuÃ© incluir en la sinopsis?",
                    description:
                        "Resumen breve del contenido, tema principal o propÃ³sito educativo del libro.",
                    examples: [
                        "Novela sobre el realismo mÃ¡gico en Macondo",
                        "Manual de matemÃ¡ticas para enseÃ±anza media",
                        "Historia de Chile desde la independencia",
                        "GuÃ­a de experimentos de quÃ­mica bÃ¡sica",
                    ],
                    usage: [
                        "MantÃ©n el resumen breve pero descriptivo",
                        "Incluye el gÃ©nero o Ã¡rea temÃ¡tica",
                        "Menciona si es texto de estudio o literatura",
                        "Este campo es opcional pero recomendado",
                    ],
                },
                bookQuantity: {
                    title: "Ejemplares del Libro",
                    question: "Â¿CuÃ¡ntos ejemplares ingresar?",
                    description:
                        "NÃºmero total de copias idÃ©nticas del mismo libro que se estÃ¡n agregando al inventario.",
                    examples: [
                        "30 (para un curso completo)",
                        "1 (libro de consulta Ãºnico)",
                        "15 (para medio curso)",
                        "50 (libro muy solicitado)",
                    ],
                    usage: [
                        "Cuenta fÃ­sicamente todos los ejemplares idÃ©nticos",
                        "Solo incluye libros en buenas condiciones",
                        "Considera la demanda esperada",
                        "Puedes agregar mÃ¡s ejemplares posteriormente",
                    ],
                },
                bookStatus: {
                    title: "Estado del Libro",
                    question: "Â¿QuÃ© estado asignar al libro?",
                    description:
                        "CondiciÃ³n actual del libro para control de disponibilidad y prÃ©stamos.",
                    examples: [
                        "Disponible: Libros listos para prÃ©stamo",
                        "En uso: Libros prestados a estudiantes",
                        "Mantenimiento: Libros que necesitan reparaciÃ³n",
                        "No disponible: Libros daÃ±ados o perdidos",
                    ],
                    usage: [
                        'La mayorÃ­a de libros nuevos serÃ¡n "Disponible"',
                        "Revisa el estado fÃ­sico antes de decidir",
                        "Considera si necesita reparaciÃ³n de pÃ¡ginas o pasta",
                        'Los libros daÃ±ados deben marcarse como "No disponible"',
                    ],
                },
                returnBorrowerRut: {
                    title: "RUT del Solicitante (DevoluciÃ³n)",
                    question: "Â¿Por quÃ© necesito el RUT para la devoluciÃ³n?",
                    description:
                        "El RUT permite identificar exactamente quÃ© prÃ©stamo se estÃ¡ devolviendo, evitando confusiones cuando hay mÃºltiples prÃ©stamos del mismo producto.",
                    examples: [
                        "12.345.678-9 (con puntos y guiÃ³n)",
                        "20.123.456-K (dÃ­gito verificador K)",
                        "15.987.654-0 (estudiante)",
                        "8.765.432-1 (profesor)",
                    ],
                    usage: [
                        "Debe coincidir exactamente con el RUT usado en el prÃ©stamo",
                        "El sistema verificarÃ¡ que exista un prÃ©stamo activo para este RUT",
                        "Incluye puntos y guiÃ³n para mayor claridad",
                        "Si no encuentra el prÃ©stamo, verifica que el RUT y cÃ³digo sean correctos",
                    ],
                },
                title: "Cantidad a Devolver",
                question: "Â¿CuÃ¡ntas unidades se estÃ¡n devolviendo?",
                description:
                    "NÃºmero de unidades del producto que el solicitante estÃ¡ regresando al inventario.",
                examples: [
                    "1 (para productos Ãºnicos como proyectores)",
                    "2 (si prestÃ³ mÃºltiples calculadoras)",
                    "5 (libros para grupo de estudio)",
                    "3 (materiales de laboratorio)",
                ],
                usage: [
                    "Debe coincidir con lo que fÃ­sicamente se estÃ¡ devolviendo",
                    "No puede exceder la cantidad originalmente prestada",
                    "Verifica que todas las unidades estÃ©n presentes",
                    "El stock se actualizarÃ¡ automÃ¡ticamente",
                ],

                returnObservation: {
                    title: "ObservaciÃ³n de DevoluciÃ³n",
                    question: "Â¿QuÃ© observaciones registrar?",
                    description:
                        "Comentarios sobre el estado del producto devuelto y cualquier incidencia durante el prÃ©stamo.",
                    examples: [
                        "Producto en perfecto estado",
                        "Pantalla rayada en esquina inferior",
                        "Falta cable de alimentaciÃ³n",
                        "Funcionando correctamente, sin problemas",
                    ],
                    usage: [
                        "Documenta cualquier daÃ±o o problema encontrado",
                        "Incluye detalles especÃ­ficos para futuras referencias",
                        "Si hay daÃ±os, considera cambiar el estado del producto",
                        "Campo opcional pero recomendado para trazabilidad",
                    ],
                },
                removeQuantity: {
                    title: "Cantidad a Dar de Baja",
                    question: "Â¿CuÃ¡ntas unidades dar de baja?",
                    description:
                        "NÃºmero de unidades que se retirarÃ¡n del inventario por el motivo especificado.",
                    examples: [
                        "1 (producto Ãºnico daÃ±ado)",
                        "3 (calculadoras rotas)",
                        "10 (libros deteriorados por uso)",
                        "2 (equipos obsoletos)",
                    ],
                    usage: [
                        "Solo incluye unidades que realmente necesitan baja",
                        "No puede exceder el stock actual disponible",
                        "El stock se reducirÃ¡ permanentemente",
                        "Documenta bien el motivo para auditorÃ­as",
                    ],
                },
                removeReason: {
                    title: "Motivo de la Baja",
                    question: "Â¿Por quÃ© dar de baja el producto?",
                    description:
                        "RazÃ³n especÃ­fica por la cual se retira el producto del inventario activo.",
                    examples: [
                        "Equipo daÃ±ado irreparablemente",
                        "Producto obsoleto, reemplazado por nueva tecnologÃ­a",
                        "PÃ©rdida durante transporte",
                        "Desgaste normal por uso intensivo",
                    ],
                    usage: [
                        "SÃ© especÃ­fico y detallado en la explicaciÃ³n",
                        "Incluye fecha del incidente si aplica",
                        "InformaciÃ³n importante para seguros y auditorÃ­as",
                        "Ayuda a identificar patrones de problemas",
                    ],
                },
                deleteReason: {
                    title: "Motivo de EliminaciÃ³n Completa",
                    question: "Â¿Por quÃ© eliminar completamente del sistema?",
                    description:
                        "RazÃ³n por la cual se debe borrar totalmente el registro del producto del sistema.",
                    examples: [
                        "Error en el registro inicial",
                        "Producto registrado por duplicado",
                        "Nunca se recibiÃ³ fÃ­sicamente",
                        "Transferido a otra instituciÃ³n",
                    ],
                    usage: [
                        "Ãsalo solo cuando sea absolutamente necesario",
                        "Esta acciÃ³n no se puede deshacer",
                        "Documenta detalladamente el motivo",
                        'Diferente a "dar de baja" - esto elimina todo rastro',
                    ],
                },
                deleteConfirmation: {
                    title: "ConfirmaciÃ³n de EliminaciÃ³n",
                    question: "Â¿CÃ³mo confirmar la eliminaciÃ³n?",
                    description:
                        "Medida de seguridad para evitar eliminaciones accidentales del sistema.",
                    examples: [
                        "CONFIRMAR (exactamente como se muestra)",
                        'No funcionan variaciones como "confirmar" o "Confirmar"',
                        "Debe ser en mayÃºsculas y completo",
                        "Sin espacios adicionales antes o despuÃ©s",
                    ],
                    usage: [
                        'Escribe exactamente "CONFIRMAR" sin comillas',
                        "Verifica dos veces antes de confirmar",
                        "Esta acciÃ³n eliminarÃ¡ permanentemente el producto",
                        "No hay forma de recuperar la informaciÃ³n despuÃ©s",
                    ],
                },
                barcode: {
                    title: "CÃ³digo de Barra del Producto",
                    question: "Â¿QuÃ© es el cÃ³digo de barra?",
                    description:
                        "Es un identificador Ãºnico para cada producto en el sistema. Puede ser un cÃ³digo de barras tradicional o cualquier cÃ³digo alfanumÃ©rico.",
                    examples: [
                        "123456789012 (cÃ³digo numÃ©rico)",
                        "LIB-001-2024 (cÃ³digo personalizado)",
                        "EQ-COMP-001 (cÃ³digo de equipo)",
                        "ISBN-9780123456789 (para libros)",
                    ],
                    usage: [
                        "Usa un lector de cÃ³digo de barras para escanear directamente",
                        "O escribe el cÃ³digo manualmente",
                        "El sistema verificarÃ¡ automÃ¡ticamente si el cÃ³digo ya existe",
                        "Para productos nuevos, el cÃ³digo debe ser Ãºnico",
                    ],
                },
                productName: {
                    title: "Nombre del Producto",
                    question: "Â¿CÃ³mo nombrar el producto?",
                    description:
                        "Escribe un nombre descriptivo y claro que identifique fÃ¡cilmente el producto.",
                    examples: [
                        "Proyector Epson EB-X41",
                        "Calculadora CientÃ­fica Casio FX-991EX",
                        "Libro: Cien aÃ±os de soledad",
                        "Microscopio Ãptico 400x",
                    ],
                    usage: [
                        "Incluye marca y modelo cuando sea relevante",
                        "Usa tÃ©rminos especÃ­ficos y descriptivos",
                        "Evita abreviaciones confusas",
                        "MantÃ©n consistencia en la nomenclatura",
                    ],
                },
                location: {
                    title: "UbicaciÃ³n en el AlmacÃ©n",
                    question: "Â¿CÃ³mo funciona el sistema de ubicaciÃ³n?",
                    description:
                        "El sistema usa un cÃ³digo de tres partes para localizar exactamente donde estÃ¡ cada producto.",
                    examples: [
                        "EstanterÃ­a: Materiales - Rack: A1 - Nivel: 3",
                        "EstanterÃ­a: Biblioteca - Rack: B2 - Nivel: 1",
                        "EstanterÃ­a: Equipos - Rack: Principal - Nivel: 2",
                        "EstanterÃ­a: A - Rack: 5 - Nivel: 1",
                    ],
                    usage: [
                        "EstanterÃ­a: Cualquier nombre o cÃ³digo (A, B, Materiales, Biblioteca, etc.)",
                        "Rack: NÃºmero o cÃ³digo de la secciÃ³n (1, 2, A1, Principal, etc.)",
                        "Nivel: Altura o piso - mÃ¡ximo 3 caracteres (1, 2, 3, etc.)",
                        "La ubicaciÃ³n se muestra como: ð Est. X â¢ ð¦ Rack Y â¢ ð¢ Nivel Z",
                    ],
                },
            };

            const info = infoContent[type];
            if (info) {
                title.textContent = info.title;
                body.innerHTML = `
                    <div class="info-question">${info.question}</div>
                    <div class="info-description">${info.description}</div>
                    <div class="info-examples">
                        <h4>Ejemplos vÃ¡lidos:</h4>
                        <ul class="example-list">
                            ${info.examples
                        .map((example) => `<li>${example}</li>`)
                        .join("")}
                        </ul>
                    </div>
                    <div class="info-usage">
                        <h4>Â¿CÃ³mo usarlo?</h4>
                        <ul class="usage-list">
                            ${info.usage
                        .map((usage) => `<li>${usage}</li>`)
                        .join("")}
                        </ul>
                    </div>
                `;
                modal.style.display = "block";
            }
        }

        function closeInfoModal() {
            document.getElementById("infoModal").style.display = "none";
        }

        function updateLocationPreview() {
            const shelf = document.getElementById("productShelf")?.value || "";
            const rack = document.getElementById("productRack")?.value || "";
            const level = document.getElementById("productLevel")?.value || "";

            const preview = document.getElementById("locationPreview");
            if (preview) {
                if (shelf && rack && level) {
                    preview.textContent = `ð Est. ${shelf} â¢ ð¦ Rack ${rack} â¢ ð¢ Nivel ${level}`;
                    preview.style.color = "var(--primary)";
                } else {
                    preview.textContent =
                        "ð Est. Materiales â¢ ð¦ Rack A1 â¢ ð¢ Nivel 3";
                    preview.style.color = "var(--gray-500)";
                }
            }
        }

        function updateBookLocationPreview() {
            const shelf = document.getElementById("bookShelf")?.value || "";
            const rack = document.getElementById("bookRack")?.value || "";
            const level = document.getElementById("bookLevel")?.value || "";

            const preview = document.getElementById("bookLocationPreview");
            if (preview) {
                if (shelf && rack && level) {
                    preview.textContent = `ð Est. ${shelf} â¢ ð¦ Rack ${rack} â¢ ð¢ Nivel ${level}`;
                    preview.style.color = "var(--primary)";
                } else {
                    preview.textContent =
                        "ð Est. Biblioteca â¢ ð¦ Rack A1 â¢ ð¢ Nivel 1";
                    preview.style.color = "var(--gray-500)";
                }
            }
        }

        function getModalTitle(operation) {
            const titles = {
                addProduct: "â Ingresar Producto Nuevo",
                updateStock: "ð Aumentar Stock",
                lendProduct: "ð¤ Registrar PrÃ©stamo",
                returnProduct: "â©ï¸ Procesar DevoluciÃ³n",
                removeProduct: "â Dar de Baja Producto",
                deleteProduct: "ðï¸ Eliminar Producto Completo",
            };
            return titles[operation] || "OperaciÃ³n";
        }

        function getModalContent(operation) {
            switch (operation) {
                case "addProduct":
                    return `
                        <form onsubmit="addProduct(event)">
                            <div class="form-group">
                                <label class="form-label">
                                    ð CategorÃ­a *
                                    <button class="help-icon" onclick="showInfoModal('category')" type="button">?</button>
                                </label>
                                <select class="form-input" id="productCategory" onchange="toggleProductFields()" required>
                                    <option value="">Seleccionar categorÃ­a...</option>
                                    <option value="Equipo">ð¥ï¸ Equipo</option>
                                    <option value="Libro">ð Libro</option>
                                    <option value="Documento">ð Documento</option>
                                    <option value="Material">ð Material</option>
                                    <option value="Herramienta">ð§ Herramienta</option>
                                </select>
                            </div>
                            
                            <div id="generalFields" class="hidden">
                                <div class="form-row">
                                    <div class="form-group">
                                        <label class="form-label">
                                            ð·ï¸ CÃ³digo de Barra *
                                            <button class="help-icon" onclick="showInfoModal('barcode')" type="button">?</button>
                                        </label>
                                        <input type="text" class="form-input" id="productCode" placeholder="001-EQ-001">
                                    </div>
                                    <div class="form-group">
                                        <label class="form-label">
                                            ð Nombre del Producto *
                                            <button class="help-icon" onclick="showInfoModal('productName')" type="button">?</button>
                                        </label>
                                        <input type="text" class="form-input" id="productName" placeholder="Nombre del producto">
                                    </div>
                                </div>
                                <div class="form-row">
                                    <div class="form-group">
                                        <label class="form-label">
                                            ð¢ Marca
                                            <button class="help-icon" onclick="showInfoModal('brand')" type="button">?</button>
                                        </label>
                                        <input type="text" class="form-input" id="productBrand" placeholder="Marca">
                                    </div>
                                    <div class="form-group">
                                        <label class="form-label">
                                            ð·ï¸ Modelo
                                            <button class="help-icon" onclick="showInfoModal('model')" type="button">?</button>
                                        </label>
                                        <input type="text" class="form-input" id="productModel" placeholder="Modelo">
                                    </div>
                                </div>
                                <div class="form-group">
                                    <label class="form-label">
                                        ð DescripciÃ³n
                                        <button class="help-icon" onclick="showInfoModal('description')" type="button">?</button>
                                    </label>
                                    <textarea class="form-input" id="productDescription" placeholder="DescripciÃ³n del producto" rows="3"></textarea>
                                </div>
                                <div class="form-row">
                                    <div class="form-group">
                                        <label class="form-label">
                                            ð Cantidad *
                                            <button class="help-icon" onclick="showInfoModal('quantity')" type="button">?</button>
                                        </label>
                                        <input type="number" class="form-input" id="productQuantity" min="1" placeholder="1">
                                    </div>
                                    <div class="form-group">
                                        <label class="form-label">
                                            ð Estado *
                                            <button class="help-icon" onclick="showInfoModal('status')" type="button">?</button>
                                        </label>
                                        <select class="form-input" id="productStatus">
                                            <option value="Disponible">â Disponible</option>
                                            <option value="En uso">ð En uso</option>
                                            <option value="Mantenimiento">ð§ Mantenimiento</option>
                                            <option value="No disponible">â No disponible</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="form-group">
                                    <label class="form-label">
                                        ð UbicaciÃ³n en el AlmacÃ©n *
                                        <button class="help-icon" onclick="showInfoModal('location')" type="button">?</button>
                                    </label>
                                    <div class="location-grid">
                                        <div class="location-field">
                                            <label>ð EstanterÃ­a:</label>
                                            <input type="text" class="location-input" id="productShelf" placeholder="Materiales" onkeyup="updateLocationPreview()">
                                        </div>
                                        <div class="location-field">
                                            <label>ð¦ Rack:</label>
                                            <input type="text" class="location-input" id="productRack" placeholder="A1" onkeyup="updateLocationPreview()">
                                        </div>
                                        <div class="location-field">
                                            <label>ð¢ Nivel:</label>
                                            <input type="text" class="location-input" id="productLevel" placeholder="3" maxlength="3" onkeyup="updateLocationPreview()">
                                        </div>
                                    </div>
                                    <div class="location-preview">
                                        <div class="location-preview-value" id="locationPreview">ð Est. Materiales â¢ ð¦ Rack A1 â¢ ð¢ Nivel 3</div>
                                    </div>
                                </div>
                            </div>
                            
                            <div id="bookFields" class="hidden">
                                <div class="form-row">
                                    <div class="form-group">
                                        <label class="form-label">
                                            ð·ï¸ CÃ³digo de Barra *
                                            <button class="help-icon" onclick="showInfoModal('barcode')" type="button">?</button>
                                        </label>
                                        <input type="text" class="form-input" id="bookCode" placeholder="002-LIB-001">
                                    </div>
                                    <div class="form-group">
                                        <label class="form-label">
                                            ð TÃ­tulo del Libro *
                                            <button class="help-icon" onclick="showInfoModal('productName')" type="button">?</button>
                                        </label>
                                        <input type="text" class="form-input" id="bookTitle" placeholder="TÃ­tulo del libro">
                                    </div>
                                </div>
                                <h4 style="margin: 1.5rem 0; color: var(--gray-700);">ð InformaciÃ³n EspecÃ­fica del Libro</h4>
                                <div class="form-row">
                                    <div class="form-group">
                                        <label class="form-label">
                                            âï¸ Autor *
                                            <button class="help-icon" onclick="showInfoModal('bookAuthor')" type="button">?</button>
                                        </label>
                                        <input type="text" class="form-input" id="bookAuthor" placeholder="Nombre del autor">
                                    </div>
                                    <div class="form-group">
                                        <label class="form-label">
                                            ð¢ Editorial *
                                            <button class="help-icon" onclick="showInfoModal('bookPublisher')" type="button">?</button>
                                        </label>
                                        <input type="text" class="form-input" id="bookPublisher" placeholder="Editorial">
                                    </div>
                                </div>
                                <div class="form-row">
                                    <div class="form-group">
                                        <label class="form-label">
                                            ð AÃ±o de PublicaciÃ³n *
                                            <button class="help-icon" onclick="showInfoModal('bookYear')" type="button">?</button>
                                        </label>
                                        <input type="number" class="form-input" id="bookYear" min="1000" max="2025" placeholder="2024">
                                    </div>
                                    <div class="form-group">
                                        <label class="form-label">
                                            ð¢ ISBN *
                                            <button class="help-icon" onclick="showInfoModal('bookISBN')" type="button">?</button>
                                        </label>
                                        <input type="text" class="form-input" id="bookISBN" placeholder="978-XXX-XXX-XXX-X">
                                    </div>
                                </div>
                                <div class="form-group">
                                    <label class="form-label">
                                        ð Sinopsis/DescripciÃ³n
                                        <button class="help-icon" onclick="showInfoModal('bookSynopsis')" type="button">?</button>
                                    </label>
                                    <textarea class="form-input" id="bookSynopsis" placeholder="DescripciÃ³n del contenido del libro" rows="3"></textarea>
                                </div>
                                <div class="form-row">
                                    <div class="form-group">
                                        <label class="form-label">
                                            ð Ejemplares *
                                            <button class="help-icon" onclick="showInfoModal('bookQuantity')" type="button">?</button>
                                        </label>
                                        <input type="number" class="form-input" id="bookQuantity" min="1" placeholder="1">
                                    </div>
                                    <div class="form-group">
                                        <label class="form-label">
                                            ð Estado *
                                            <button class="help-icon" onclick="showInfoModal('bookStatus')" type="button">?</button>
                                        </label>
                                        <select class="form-input" id="bookStatus">
                                            <option value="Disponible">â Disponible</option>
                                            <option value="En uso">ð En uso</option>
                                            <option value="Mantenimiento">ð§ Mantenimiento</option>
                                            <option value="No disponible">â No disponible</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="form-group">
                                    <label class="form-label">
                                        ð UbicaciÃ³n en el AlmacÃ©n *
                                        <button class="help-icon" onclick="showInfoModal('location')" type="button">?</button>
                                    </label>
                                    <div class="location-grid">
                                        <div class="location-field">
                                            <label>ð EstanterÃ­a:</label>
                                            <input type="text" class="location-input" id="bookShelf" placeholder="Biblioteca" onkeyup="updateBookLocationPreview()">
                                        </div>
                                        <div class="location-field">
                                            <label>ð¦ Rack:</label>
                                            <input type="text" class="location-input" id="bookRack" placeholder="A1" onkeyup="updateBookLocationPreview()">
                                        </div>
                                        <div class="location-field">
                                            <label>ð¢ Nivel:</label>
                                            <input type="text" class="location-input" id="bookLevel" placeholder="1" maxlength="3" onkeyup="updateBookLocationPreview()">
                                        </div>
                                    </div>
                                    <div class="location-preview">
                                        <div class="location-preview-value" id="bookLocationPreview">ð Est. Biblioteca â¢ ð¦ Rack A1 â¢ ð¢ Nivel 1</div>
                                    </div>
                                </div>
                            </div>
                            
                            <button type="submit" class="btn btn-primary" style="margin-top: 1.5rem;">
                                â Ejecutar OperaciÃ³n
                            </button>
                        </form>
                    `;

                case "updateStock":
                    return `
                        <form onsubmit="updateStock(event)">
                            <div class="form-group">
                                <label class="form-label">
                                    ð·ï¸ CÃ³digo de Barra *
                                    <button class="help-icon" onclick="showInfoModal('barcode')" type="button">?</button>
                                </label>
                                <input type="text" class="form-input" id="stockCode" onblur="verifyProduct('stock')" placeholder="001-EQ-001" required>
                            </div>
                            <div id="stockProductInfo"></div>
                            <div class="form-group">
                                <label class="form-label">
                                    ð Cantidad a Aumentar *
                                    <button class="help-icon" onclick="showInfoModal('stockQuantity')" type="button">?</button>
                                </label>
                                <input type="number" class="form-input" id="stockQuantity" min="1" placeholder="1" required>
                            </div>
                            <button type="submit" class="btn btn-primary">â Ejecutar OperaciÃ³n</button>
                        </form>
                    `;

                case "lendProduct":
                    return `
                        <form onsubmit="lendProduct(event)">
                            <div class="form-group">
                                <label class="form-label">
                                    ð·ï¸ CÃ³digo de Barra *
                                    <button class="help-icon" onclick="showInfoModal('barcode')" type="button">?</button>
                                </label>
                                <input type="text" class="form-input" id="lendCode" onblur="verifyProduct('lend')" placeholder="001-EQ-001" required>
                            </div>
                            <div id="lendProductInfo"></div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label class="form-label">
                                        ð Cantidad *
                                        <button class="help-icon" onclick="showInfoModal('lendQuantity')" type="button">?</button>
                                    </label>
                                    <input type="number" class="form-input" id="lendQuantity" min="1" placeholder="1" required>
                                </div>
                                <div class="form-group">
                                    <label class="form-label">
                                        ð¤ Nombre del Solicitante *
                                        <button class="help-icon" onclick="showInfoModal('borrowerInfo')" type="button">?</button>
                                    </label>
                                    <input type="text" class="form-input" id="borrowerName" placeholder="Juan PÃ©rez" required>
                                </div>
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label class="form-label">
                                        ð RUT del Solicitante *
                                        <button class="help-icon" onclick="showInfoModal('borrowerRut')" type="button">?</button>
                                    </label>
                                    <input type="text" class="form-input" id="borrowerRut" placeholder="12.345.678-9" required>
                                </div>
                                <div class="form-group">
                                    <label class="form-label">
                                        ð§ Correo del Solicitante *
                                        <button class="help-icon" onclick="showInfoModal('borrowerEmail')" type="button">?</button>
                                    </label>
                                    <input type="email" class="form-input" id="borrowerEmail" placeholder="juan@estudiante.com" required>
                                </div>
                            </div>
                            <div class="form-group">
                                <label class="form-label">
                                    ð Fecha de DevoluciÃ³n *
                                    <button class="help-icon" onclick="showInfoModal('returnDate')" type="button">?</button>
                                </label>
                                <input type="date" class="form-input" id="returnDate" required>
                            </div>
                            <button type="submit" class="btn btn-primary">â Ejecutar OperaciÃ³n</button>
                        </form>
                    `;

                case "returnProduct":
                    return `
                        <form onsubmit="returnProduct(event)">
                            <div class="form-group">
                                <label class="form-label">
                                    ð·ï¸ CÃ³digo de Barra *
                                    <button class="help-icon" onclick="showInfoModal('barcode')" type="button">?</button>
                                </label>
                                <input type="text" class="form-input" id="returnCode" onblur="verifyProduct('return')" placeholder="001-EQ-001" required>
                            </div>
                            <div id="returnProductInfo"></div>
                            <div class="form-group">
                                <label class="form-label">
                                    ð RUT del Solicitante *
                                    <button class="help-icon" onclick="showInfoModal('returnBorrowerRut')" type="button">?</button>
                                </label>
                                <input type="text" class="form-input" id="returnBorrowerRut" onblur="verifyActiveLoan()" placeholder="12.345.678-9" required>
                            </div>
                            <div id="activeLoanInfo"></div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label class="form-label">
                                        ð Cantidad *
                                        <button class="help-icon" onclick="showInfoModal('returnQuantity')" type="button">?</button>
                                    </label>
                                    <input type="number" class="form-input" id="returnQuantity" min="1" placeholder="1" required>
                                </div>
                                <div class="form-group">
                                    <label class="form-label">
                                        ð ObservaciÃ³n
                                        <button class="help-icon" onclick="showInfoModal('returnObservation')" type="button">?</button>
                                    </label>
                                    <textarea class="form-input" id="returnObservation" placeholder="Estado del producto devuelto..." rows="3"></textarea>
                                </div>
                            </div>
                            <button type="submit" class="btn btn-primary">â Ejecutar OperaciÃ³n</button>
                        </form>
                    `;

                case "removeProduct":
                    return `
                        <form onsubmit="removeProduct(event)">
                            <div class="form-group">
                                <label class="form-label">
                                    ð·ï¸ CÃ³digo de Barra *
                                    <button class="help-icon" onclick="showInfoModal('barcode')" type="button">?</button>
                                </label>
                                <input type="text" class="form-input" id="removeCode" onblur="verifyProduct('remove')" placeholder="001-EQ-001" required>
                            </div>
                            <div id="removeProductInfo"></div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label class="form-label">
                                        ð Cantidad *
                                        <button class="help-icon" onclick="showInfoModal('removeQuantity')" type="button">?</button>
                                    </label>
                                    <input type="number" class="form-input" id="removeQuantity" min="1" placeholder="1" required>
                                </div>
                                <div class="form-group">
                                    <label class="form-label">
                                        ð Motivo de la Baja *
                                        <button class="help-icon" onclick="showInfoModal('removeReason')" type="button">?</button>
                                    </label>
                                    <textarea class="form-input" id="removeReason" placeholder="Explicar motivo de la baja..." rows="3" required></textarea>
                                </div>
                            </div>
                            <button type="submit" class="btn btn-danger">â Ejecutar OperaciÃ³n</button>
                        </form>
                    `;

                case "deleteProduct":
                    return `
                        <form onsubmit="deleteProduct(event)">
                            <div class="alert alert-danger">
                                <span>â ï¸</span>
                                <div>
                                    <strong>Â¡ATENCIÃN!</strong> Esta acciÃ³n eliminarÃ¡ completamente el producto del sistema.
                                    Esta operaciÃ³n NO se puede deshacer.
                                </div>
                            </div>
                            <div class="form-group">
                                <label class="form-label">
                                    ð·ï¸ CÃ³digo de Barra *
                                    <button class="help-icon" onclick="showInfoModal('barcode')" type="button">?</button>
                                </label>
                                <input type="text" class="form-input" id="deleteCode" onblur="verifyProduct('delete')" placeholder="001-EQ-001" required>
                            </div>
                            <div id="deleteProductInfo"></div>
                            <div class="form-group">
                                <label class="form-label">
                                    ð Motivo de la EliminaciÃ³n *
                                    <button class="help-icon" onclick="showInfoModal('deleteReason')" type="button">?</button>
                                </label>
                                <textarea class="form-input" id="deleteReason" placeholder="Explicar motivo de la eliminaciÃ³n completa..." rows="3" required></textarea>
                            </div>
                            <div class="form-group">
                                <label class="form-label">
                                    âï¸ ConfirmaciÃ³n *
                                    <button class="help-icon" onclick="showInfoModal('deleteConfirmation')" type="button">?</button>
                                </label>
                                <input type="text" class="form-input" id="deleteConfirmation" placeholder="Escribe CONFIRMAR para continuar" required>
                            </div>
                            <button type="submit" class="btn btn-danger">ðï¸ Eliminar Producto Completo</button>
                        </form>
                    `;
                default:
                    return "<p>OperaciÃ³n no disponible</p>";
            }
        }

        function toggleProductFields() {
            const category = document.getElementById("productCategory").value;
            const generalFields = document.getElementById("generalFields");
            const bookFields = document.getElementById("bookFields");

            generalFields.classList.add("hidden");
            bookFields.classList.add("hidden");

            if (category === "Libro") {
                bookFields.classList.remove("hidden");
            } else if (category && category !== "") {
                generalFields.classList.remove("hidden");
            }
        }

        function verifyProduct(operation) {
            const codeField = document.getElementById(`${operation}Code`);
            const infoDiv = document.getElementById(`${operation}ProductInfo`);
            const code = codeField.value.trim();

            if (!code) return;

            const product = products.find((p) => p.code === code);
            if (product) {
                infoDiv.innerHTML = `
                    <div class="alert alert-success">
                        <span>â</span>
                        <div>
                            <strong>Producto encontrado:</strong> ${product.name} (${product.category})
                            <br><strong>ð Stock actual:</strong> ${product.quantity}
                        </div>
                    </div>
                `;
            } else {
                infoDiv.innerHTML = `
                    <div class="alert alert-danger">
                        <span>â</span>
                        <div>
                            <strong>Producto no encontrado</strong> con el cÃ³digo: ${code}
                        </div>
                    </div>
                `;
            }
        }

        function verifyActiveLoan() {
            const rutField = document.getElementById("returnBorrowerRut");
            const codeField = document.getElementById("returnCode");
            const infoDiv = document.getElementById("activeLoanInfo");

            if (!rutField || !codeField) return;

            const rut = rutField.value.trim();
            const code = codeField.value.trim();

            if (!rut || !code) return;

            // Buscar prÃ©stamos activos para este RUT
            const userLoans = loans.filter(loan =>
                loan.status === "Activo" && loan.borrowerRut === rut
            );

            if (userLoans.length === 0) {
                infoDiv.innerHTML = `
            <div class="alert alert-danger">
                <span>â</span>
                <div>
                    <strong>No se encontraron prÃ©stamos activos</strong><br>
                    Para el RUT: ${rut}<br>
                    Verifica que el RUT sea correcto.
                </div>
            </div>
        `;
                return;
            }

            // Buscar prÃ©stamo especÃ­fico por cÃ³digo
            let matchingLoan = null;
            let isGroupLoan = false;
            let availableCodes = [];

            // Buscar en prÃ©stamos individuales
            matchingLoan = userLoans.find(loan => loan.productCode === code);

            if (!matchingLoan) {
                // Buscar en prÃ©stamos grupales
                matchingLoan = userLoans.find(loan =>
                    loan.bulkLoan &&
                    loan.individualCodes &&
                    loan.individualCodes.includes(code)
                );

                if (matchingLoan) {
                    isGroupLoan = true;
                    availableCodes = matchingLoan.individualCodes;
                }
            }

            if (!matchingLoan) {
                // Mostrar prÃ©stamos disponibles para ayudar al usuario
                const loansList = userLoans.map(loan => {
                    if (loan.bulkLoan) {
                        return `â¢ ${loan.productName} (${loan.quantity} unidades) - CÃ³digos: ${loan.individualCodes.slice(0, 3).join(', ')}${loan.individualCodes.length > 3 ? '...' : ''}`;
                    } else {
                        return `â¢ ${loan.productName} - CÃ³digo: ${loan.productCode}`;
                    }
                }).join('<br>');

                infoDiv.innerHTML = `
            <div class="alert alert-danger">
                <span>â</span>
                <div>
                    <strong>CÃ³digo no encontrado en prÃ©stamos activos</strong><br>
                    CÃ³digo buscado: ${code}<br><br>
                    <strong>PrÃ©stamos activos para ${rut}:</strong><br>
                    ${loansList}
                </div>
            </div>
        `;
                return;
            }

            // Mostrar informaciÃ³n del prÃ©stamo encontrado
            if (isGroupLoan) {
                const remainingCodes = matchingLoan.individualCodes.length;
                const returnedCodes = matchingLoan.returnedCodes ? matchingLoan.returnedCodes.length : 0;

                infoDiv.innerHTML = `
            <div class="alert alert-success">
                <span>â</span>
                <div>
                    <strong>PrÃ©stamo grupal encontrado:</strong><br>
                    ð¤ <strong>Solicitante:</strong> ${matchingLoan.borrower}<br>
                    ð¦ <strong>Producto:</strong> ${matchingLoan.productName}<br>
                    ð <strong>Cantidad original:</strong> ${matchingLoan.quantity} unidades<br>
                    ð <strong>Pendientes:</strong> ${remainingCodes - returnedCodes} unidades<br>
                    ð·ï¸ <strong>CÃ³digo seleccionado:</strong> ${code}<br>
                    ð <strong>Fecha prÃ©stamo:</strong> ${matchingLoan.loanDate}<br>
                    ð <strong>Fecha devoluciÃ³n:</strong> ${matchingLoan.returnDate}<br><br>
                    
                    <div style="background: rgba(52, 152, 219, 0.1); padding: 1rem; border-radius: 0.5rem; margin-top: 1rem;">
                        <strong>ð¯ Opciones de devoluciÃ³n:</strong><br>
                        â¢ <strong>DevoluciÃ³n individual:</strong> Solo este cÃ³digo (${code})<br>
                        â¢ <strong>DevoluciÃ³n completa:</strong> Todos los productos del prÃ©stamo
                    </div>
                </div>
            </div>
            
            <div style="margin-top: 1rem;">
                <label style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 1rem;">
                    <input type="radio" name="returnType" value="individual" checked onchange="updateReturnType()">
                    <span>ð§ Devolver solo este cÃ³digo (1 unidad)</span>
                </label>
                <label style="display: flex; align-items: center; gap: 0.5rem;">
                    <input type="radio" name="returnType" value="complete" onchange="updateReturnType()">
                    <span>ð¦ Devolver todos los productos del prÃ©stamo (${remainingCodes - returnedCodes} unidades)</span>
                </label>
            </div>
        `;

                // Auto-configurar cantidad
                const quantityField = document.getElementById("returnQuantity");
                if (quantityField) {
                    quantityField.value = 1;
                    quantityField.max = remainingCodes - returnedCodes;
                }

            } else {
                // PrÃ©stamo individual normal
                infoDiv.innerHTML = `
            <div class="alert alert-success">
                <span>â</span>
                <div>
                    <strong>PrÃ©stamo individual encontrado:</strong><br>
                    ð¤ <strong>Solicitante:</strong> ${matchingLoan.borrower}<br>
                    ð¦ <strong>Producto:</strong> ${matchingLoan.productName}<br>
                    ð <strong>Cantidad prestada:</strong> ${matchingLoan.quantity}<br>
                    ð <strong>Fecha prÃ©stamo:</strong> ${matchingLoan.loanDate}<br>
                    ð <strong>Fecha devoluciÃ³n:</strong> ${matchingLoan.returnDate}
                </div>
            </div>
        `;

                const quantityField = document.getElementById("returnQuantity");
                if (quantityField) {
                    quantityField.value = matchingLoan.quantity;
                    quantityField.max = matchingLoan.quantity;
                }
            }

            // Guardar informaciÃ³n del prÃ©stamo para usar en la devoluciÃ³n
            window.currentLoanInfo = {
                loan: matchingLoan,
                isGroupLoan: isGroupLoan,
                selectedCode: code,
                availableCodes: availableCodes
            };
        }

        async function deleteProduct(event) {
            event.preventDefault();

            const code = document.getElementById("deleteCode").value.trim();
            const reason = document.getElementById("deleteReason").value.trim();
            const confirmation = document
                .getElementById("deleteConfirmation")
                .value.trim();

            if (confirmation !== "CONFIRMAR") {
                alert('â Debes escribir "CONFIRMAR" para autorizar la eliminaciÃ³n');
                return;
            }

            const product = products.find((p) => p.code === code);
            if (product) {
                if (
                    confirm(
                        `Â¿EstÃ¡s seguro de eliminar completamente "${product.name}"? Esta acciÃ³n NO se puede deshacer.`
                    )
                ) {
                    try {
                        if (isFirebaseReady) {
                            await db.collection("products").doc(product.id).delete();
                        } else {
                            const index = products.findIndex((p) => p.code === code);
                            if (index > -1) {
                                products.splice(index, 1);
                            }
                        }

                        await addToHistory(
                            "EliminaciÃ³n completa",
                            product.name,
                            `Motivo: ${reason}`
                        );
                        showOperationSuccess(
                            "Producto eliminado completamente del sistema"
                        );
                    } catch (error) {
                        console.error("Error eliminando producto:", error);
                        alert("â Error eliminando producto. Intenta nuevamente.");
                    }
                }
            } else {
                alert("â Producto no encontrado");
            }
        }

        async function addProduct(event) {
            event.preventDefault();

            const category = document.getElementById("productCategory").value;

            if (!category) {
                alert("â Por favor selecciona una categorÃ­a");
                return;
            }

            let newProduct;

            if (category === "Libro") {
                const bookCode = document.getElementById("bookCode").value.trim();
                const bookTitle = document.getElementById("bookTitle").value.trim();
                const bookAuthor = document.getElementById("bookAuthor").value.trim();
                const bookPublisher = document
                    .getElementById("bookPublisher")
                    .value.trim();
                const bookYear = document.getElementById("bookYear").value;
                const bookISBN = document.getElementById("bookISBN").value.trim();
                const bookQuantity = document.getElementById("bookQuantity").value;
                const bookStatus = document.getElementById("bookStatus").value;
                const bookShelf = document.getElementById("bookShelf").value.trim();
                const bookRack = document.getElementById("bookRack").value.trim();
                const bookLevel = document.getElementById("bookLevel").value.trim();

                if (
                    !bookCode ||
                    !bookTitle ||
                    !bookAuthor ||
                    !bookPublisher ||
                    !bookYear ||
                    !bookISBN ||
                    !bookQuantity ||
                    !bookShelf ||
                    !bookRack ||
                    !bookLevel
                ) {
                    alert("â Por favor completa todos los campos obligatorios (*)");
                    return;
                }

                if (products.find((p) => p.code === bookCode)) {
                    alert("â Ya existe un producto con ese cÃ³digo");
                    return;
                }

                newProduct = {
                    code: bookCode,
                    name: bookTitle,
                    category: "Libro",
                    author: bookAuthor,
                    publisher: bookPublisher,
                    year: bookYear,
                    isbn: bookISBN,
                    synopsis: document.getElementById("bookSynopsis").value,
                    quantity: parseInt(bookQuantity),
                    status: bookStatus,
                    location: {
                        shelf: bookShelf,
                        rack: bookRack,
                        level: bookLevel,
                    },
                    createdAt: isFirebaseReady
                        ? firebase.firestore.FieldValue.serverTimestamp()
                        : new Date().toISOString(),
                };
            } else {
                const productCode = document
                    .getElementById("productCode")
                    .value.trim();
                const productName = document
                    .getElementById("productName")
                    .value.trim();
                const productQuantity =
                    document.getElementById("productQuantity").value;
                const productStatus = document.getElementById("productStatus").value;
                const productShelf = document
                    .getElementById("productShelf")
                    .value.trim();
                const productRack = document
                    .getElementById("productRack")
                    .value.trim();
                const productLevel = document
                    .getElementById("productLevel")
                    .value.trim();

                if (
                    !productCode ||
                    !productName ||
                    !productQuantity ||
                    !productShelf ||
                    !productRack ||
                    !productLevel
                ) {
                    alert("â Por favor completa todos los campos obligatorios (*)");
                    return;
                }

                if (products.find((p) => p.code === productCode)) {
                    alert("â Ya existe un producto con ese cÃ³digo");
                    return;
                }

                newProduct = {
                    code: productCode,
                    name: productName,
                    category: category,
                    brand: document.getElementById("productBrand").value,
                    model: document.getElementById("productModel").value,
                    description: document.getElementById("productDescription").value,
                    quantity: parseInt(productQuantity),
                    status: productStatus,
                    location: {
                        shelf: productShelf,
                        rack: productRack,
                        level: productLevel,
                    },
                    createdAt: isFirebaseReady
                        ? firebase.firestore.FieldValue.serverTimestamp()
                        : new Date().toISOString(),
                };
            }

            try {
                if (isFirebaseReady) {
                    await db.collection("products").add(newProduct);
                } else {
                    newProduct.id = products.length + 1;
                    products.push(newProduct);
                }

                await addToHistory(
                    "Ingreso de producto",
                    newProduct.name,
                    `CategorÃ­a: ${newProduct.category}, Cantidad: ${newProduct.quantity}`
                );
                showOperationSuccess("Â¡Producto agregado exitosamente!");
            } catch (error) {
                console.error("Error agregando producto:", error);
                alert("â Error agregando producto. Intenta nuevamente.");
            }
        }

        // Restore core functionality - ensuring all management functions work
        async function updateStock(event) {
            event.preventDefault();

            const code = document.getElementById("stockCode").value.trim();
            const quantity = parseInt(
                document.getElementById("stockQuantity").value
            );

            if (!code || !quantity || quantity <= 0) {
                alert("â Por favor completa todos los campos correctamente");
                return;
            }

            const product = products.find((p) => p.code === code);
            if (product) {
                try {
                    if (isFirebaseReady) {
                        const productRef = db.collection("products").doc(product.id);
                        await productRef.update({
                            quantity: firebase.firestore.FieldValue.increment(quantity),
                        });
                    } else {
                        product.quantity += quantity;
                    }

                    await addToHistory(
                        "Aumento de stock",
                        product.name,
                        `Cantidad agregada: ${quantity}, Nuevo stock: ${product.quantity + (isFirebaseReady ? 0 : 0)
                        }`
                    );
                    showOperationSuccess("Stock actualizado exitosamente");
                } catch (error) {
                    console.error("Error actualizando stock:", error);
                    alert("â Error actualizando stock. Intenta nuevamente.");
                }
            } else {
                alert("â Producto no encontrado");
            }
        }

        async function lendProduct(event) {
            event.preventDefault();

            const code = document.getElementById("lendCode").value.trim();
            const quantity = parseInt(
                document.getElementById("lendQuantity").value
            );
            const borrowerName = document
                .getElementById("borrowerName")
                .value.trim();
            const borrowerRut = document.getElementById("borrowerRut").value.trim();
            const borrowerEmail = document
                .getElementById("borrowerEmail")
                .value.trim();
            const returnDate = document.getElementById("returnDate").value;

            if (
                !code ||
                !quantity ||
                !borrowerName ||
                !borrowerRut ||
                !borrowerEmail ||
                !returnDate
            ) {
                alert("â Por favor completa todos los campos");
                return;
            }

            const product = products.find((p) => p.code === code);
            if (product && product.quantity >= quantity) {
                try {
                    const loan = {
                        productCode: code,
                        productName: product.name,
                        quantity: quantity,
                        borrower: borrowerName,
                        borrowerRut: borrowerRut,
                        borrowerEmail: borrowerEmail,
                        loanDate: new Date().toISOString().split("T")[0],
                        returnDate: returnDate,
                        status: "Activo",
                        createdAt: isFirebaseReady
                            ? firebase.firestore.FieldValue.serverTimestamp()
                            : new Date().toISOString(),
                    };

                    if (isFirebaseReady) {
                        await db.collection("loans").add(loan);
                        const productRef = db.collection("products").doc(product.id);
                        await productRef.update({
                            quantity: firebase.firestore.FieldValue.increment(-quantity),
                        });
                    } else {
                        loan.id = loans.length + 1;
                        loans.push(loan);
                        product.quantity -= quantity;
                    }

                    await addToHistory(
                        "PrÃ©stamo registrado",
                        product.name,
                        `Cantidad: ${quantity}, Solicitante: ${borrowerName}, Vence: ${returnDate}`
                    );

                    // Intentar enviar correo
                    const emailSent = await sendLoanEmail(loan);

                    if (emailSent) {
                        showOperationSuccess("Â¡PrÃ©stamo registrado exitosamente! Se enviÃ³ confirmaciÃ³n por correo electrÃ³nico.");
                    } else {
                        showOperationSuccess("PrÃ©stamo registrado exitosamente");
                    }

                } catch (error) {
                    console.error("Error registrando prÃ©stamo:", error);
                    alert("â Error registrando prÃ©stamo. Intenta nuevamente.");
                }
            } else if (!product) {
                alert("â Producto no encontrado");
            } else {
                alert(
                    `â Stock insuficiente. Stock disponible: ${product.quantity}, Solicitado: ${quantity}`
                );
            }
        }

        async function returnProduct(event) {
            event.preventDefault();

            const code = document.getElementById("returnCode").value.trim();
            const borrowerRut = document.getElementById("returnBorrowerRut").value.trim();
            const quantity = parseInt(document.getElementById("returnQuantity").value);
            const observation = document.getElementById("returnObservation").value;

            if (!code || !borrowerRut || !quantity) {
                alert("â Por favor completa todos los campos obligatorios");
                return;
            }

            if (!window.currentLoanInfo) {
                alert("â Error: InformaciÃ³n del prÃ©stamo no encontrada. Verifica los datos nuevamente.");
                return;
            }

            const { loan, isGroupLoan, selectedCode } = window.currentLoanInfo;
            const returnType = document.querySelector('input[name="returnType"]:checked')?.value || 'individual';

            try {
                if (isGroupLoan) {
                    await processGroupLoanReturn(loan, selectedCode, quantity, returnType, observation, borrowerRut);
                } else {
                    await processIndividualLoanReturn(loan, quantity, observation, borrowerRut);
                }

            } catch (error) {
                console.error("Error procesando devoluciÃ³n:", error);
                alert("â Error procesando devoluciÃ³n. Intenta nuevamente.");
            }
        }

        // Procesar devoluciÃ³n de prÃ©stamo grupal
        async function processGroupLoanReturn(loan, selectedCode, quantity, returnType, observation, borrowerRut) {
            const returnedCodes = loan.returnedCodes || [];
            const pendingCodes = loan.individualCodes.filter(code => !returnedCodes.includes(code));

            if (returnType === 'individual') {
                // DevoluciÃ³n individual de un cÃ³digo
                if (returnedCodes.includes(selectedCode)) {
                    alert("â Este cÃ³digo ya fue devuelto anteriormente");
                    return;
                }

                // Actualizar stock del producto especÃ­fico
                const product = products.find(p => p.code === selectedCode);
                if (product) {
                    if (isFirebaseReady) {
                        const productRef = db.collection("products").doc(product.id);
                        await productRef.update({
                            quantity: firebase.firestore.FieldValue.increment(1),
                        });
                    } else {
                        product.quantity += 1;
                    }
                }

                // Actualizar el prÃ©stamo grupal
                const newReturnedCodes = [...returnedCodes, selectedCode];
                const isComplete = newReturnedCodes.length >= loan.individualCodes.length;

                if (isFirebaseReady) {
                    const loanRef = db.collection("loans").doc(loan.id);
                    await loanRef.update({
                        returnedCodes: newReturnedCodes,
                        status: isComplete ? "Devuelto" : "Parcialmente devuelto",
                        lastReturnDate: new Date().toISOString().split("T")[0],
                        lastReturnObservation: observation || "Sin observaciones",
                        processedBy: currentUser
                    });
                } else {
                    loan.returnedCodes = newReturnedCodes;
                    loan.status = isComplete ? "Devuelto" : "Parcialmente devuelto";
                    loan.lastReturnDate = new Date().toISOString().split("T")[0];
                    loan.lastReturnObservation = observation || "Sin observaciones";
                    loan.processedBy = currentUser;
                }

                await addToHistory(
                    "DevoluciÃ³n parcial grupal",
                    loan.productName,
                    `${loan.borrower}: CÃ³digo ${selectedCode} devuelto. Restantes: ${pendingCodes.length - 1}/${loan.individualCodes.length}`
                );

                showOperationSuccess(`â DevoluciÃ³n individual procesada

ð¦ Producto: ${loan.productName}
ð·ï¸ CÃ³digo devuelto: ${selectedCode}
ð¤ Solicitante: ${loan.borrower}
ð Progreso: ${newReturnedCodes.length}/${loan.individualCodes.length} devueltos
${isComplete ? 'ð Â¡PrÃ©stamo completamente devuelto!' : `â³ Pendientes: ${loan.individualCodes.length - newReturnedCodes.length} cÃ³digos`}`);

            } else if (returnType === 'complete') {
                // DevoluciÃ³n completa de todos los cÃ³digos pendientes

                // Actualizar stock de todos los productos pendientes
                for (const codeToReturn of pendingCodes) {
                    const product = products.find(p => p.code === codeToReturn);
                    if (product) {
                        if (isFirebaseReady) {
                            const productRef = db.collection("products").doc(product.id);
                            await productRef.update({
                                quantity: firebase.firestore.FieldValue.increment(1),
                            });
                        } else {
                            product.quantity += 1;
                        }
                    }
                }

                // Marcar prÃ©stamo como completamente devuelto
                if (isFirebaseReady) {
                    const loanRef = db.collection("loans").doc(loan.id);
                    await loanRef.update({
                        status: "Devuelto",
                        returnedDate: new Date().toISOString().split("T")[0],
                        returnedCodes: loan.individualCodes,
                        bulkReturnObservation: observation || "DevoluciÃ³n completa sin observaciones",
                        processedBy: currentUser
                    });
                } else {
                    loan.status = "Devuelto";
                    loan.returnedDate = new Date().toISOString().split("T")[0];
                    loan.returnedCodes = loan.individualCodes;
                    loan.bulkReturnObservation = observation || "DevoluciÃ³n completa sin observaciones";
                    loan.processedBy = currentUser;
                }

                await addToHistory(
                    "DevoluciÃ³n completa grupal",
                    loan.productName,
                    `${loan.borrower}: Todos los cÃ³digos devueltos (${pendingCodes.length} unidades)`
                );

                showOperationSuccess(`DevoluciÃ³n completa procesada

ð¦ Producto: ${loan.productName}
ð¤ Solicitante: ${loan.borrower}
ð CÃ³digos devueltos: ${pendingCodes.length}
ð·ï¸ CÃ³digos: ${pendingCodes.join(', ')}
ð PrÃ©stamo completamente cerrado`);
            }
        }

        // Procesar devoluciÃ³n de prÃ©stamo individual (funciÃ³n original)
        async function processIndividualLoanReturn(loan, quantity, observation, borrowerRut) {
            if (quantity > loan.quantity) {
                alert(`â No puedes devolver mÃ¡s cantidad de la prestada.\nPrestado: ${loan.quantity}, Intentando devolver: ${quantity}`);
                return;
            }

            const product = products.find(p => p.code === loan.productCode);
            if (!product) {
                alert("â Producto no encontrado en el inventario");
                return;
            }

            // Aumentar el stock del producto
            if (isFirebaseReady) {
                const productRef = db.collection("products").doc(product.id);
                await productRef.update({
                    quantity: firebase.firestore.FieldValue.increment(quantity),
                });
            } else {
                product.quantity += quantity;
            }

            // Marcar el prÃ©stamo como devuelto
            if (isFirebaseReady) {
                const loanRef = db.collection("loans").doc(loan.id);
                await loanRef.update({
                    status: "Devuelto",
                    returnedDate: new Date().toISOString().split("T")[0],
                    returnedQuantity: quantity,
                    observation: observation || "Sin observaciones",
                    processedBy: currentUser
                });
            } else {
                loan.status = "Devuelto";
                loan.returnedDate = new Date().toISOString().split("T")[0];
                loan.returnedQuantity = quantity;
                loan.observation = observation || "Sin observaciones";
                loan.processedBy = currentUser;
            }

            await addToHistory(
                "DevoluciÃ³n individual",
                product.name,
                `${loan.borrower}: ${quantity} unidades devueltas`
            );

            showOperationSuccess(`DevoluciÃ³n individual procesada

ð¦ Producto: ${product.name}
ð¤ Solicitante: ${loan.borrower}
ð Cantidad devuelta: ${quantity}
ð Fecha: ${new Date().toLocaleDateString("es-CL")}`);
        }

        async function removeProduct(event) {
            event.preventDefault();

            const code = document.getElementById("removeCode").value.trim();
            const quantity = parseInt(
                document.getElementById("removeQuantity").value
            );
            const reason = document.getElementById("removeReason").value.trim();

            if (!code || !quantity || !reason) {
                alert("â Por favor completa todos los campos");
                return;
            }

            const product = products.find((p) => p.code === code);
            if (product && product.quantity >= quantity) {
                try {
                    if (isFirebaseReady) {
                        const productRef = db.collection("products").doc(product.id);
                        await productRef.update({
                            quantity: firebase.firestore.FieldValue.increment(-quantity),
                        });
                    } else {
                        product.quantity -= quantity;
                    }

                    await addToHistory(
                        "Baja de producto",
                        product.name,
                        `Cantidad: ${quantity}, Motivo: ${reason}`
                    );
                    showOperationSuccess("Producto dado de baja exitosamente");
                } catch (error) {
                    console.error("Error dando de baja:", error);
                    alert("â Error dando de baja producto. Intenta nuevamente.");
                }
            } else if (!product) {
                alert("â Producto no encontrado");
            } else {
                alert(
                    `â Stock insuficiente. Stock disponible: ${product.quantity}, Solicitado: ${quantity}`
                );
            }
        }

        async function addToHistory(operation, product, details) {
            const historyEntry = {
                date: new Date().toLocaleString("es-CL"),
                user: currentUser || "Usuario",
                operation: operation || "OperaciÃ³n",
                product: product || "Producto no especificado",
                details: details || "Sin detalles",
                timestamp: isFirebaseReady
                    ? firebase.firestore.FieldValue.serverTimestamp()
                    : new Date().toISOString(),
            };

            try {
                if (isFirebaseReady) {
                    await db.collection("history").add(historyEntry);
                } else {
                    history.unshift(historyEntry);
                }
            } catch (error) {
                console.error("Error agregando al historial:", error);
            }
        }

        function showOperationSuccess(message) {
            closeModal();
            const resultDiv = document.getElementById("operationResult");
            resultDiv.innerHTML = `
        <div class="alert alert-success">
            <span>â</span>
            <div>${message}</div>
        </div>
    `;

            // Force update all numbers immediately
            updateDashboard();
            updateManagementInfo();

            setTimeout(() => {
                resultDiv.innerHTML = "";

                // Redireccionar segÃºn el rol
                if (currentRole === "admin") {
                    showTab("dashboard");
                    setTimeout(() => {
                        updateDashboard();
                    }, 100);
                } else if (currentRole === "operator") {
                    showTab("inventory");
                }

                // Scroll al top
                window.scrollTo(0, 0);
            }, 3000);
        }

        // FunciÃ³n para solicitar eliminaciÃ³n del historial (solo admin)
        function requestDeleteHistory() {
            if (currentRole !== "admin") {
                alert("â Solo el administrador puede eliminar el historial");
                return;
            }

            // Mostrar advertencia inicial
            const confirmAction = confirm(`â ï¸ ADVERTENCIA CRÃTICA â ï¸

Â¿EstÃ¡s seguro de que deseas ELIMINAR COMPLETAMENTE todo el historial?

ð InformaciÃ³n que se perderÃ¡:
- Registro de todas las operaciones realizadas
- Fechas y usuarios que ejecutaron acciones
- Historial de prÃ©stamos, devoluciones y bajas
- Toda la trazabilidad del sistema

ð¨ ESTA ACCIÃN NO SE PUEDE DESHACER ð¨

Â¿Deseas continuar?`);

            if (!confirmAction) {
                return;
            }

            // Solicitar contraseÃ±a de administrador
            const adminPassword = prompt(`ð Para continuar, ingresa la contraseÃ±a de administrador:

â ï¸ ÃLTIMA ADVERTENCIA:
Esta acciÃ³n eliminarÃ¡ PERMANENTEMENTE todo el historial del sistema.

ContraseÃ±a de administrador:`);

            if (adminPassword === "AdminLiceo2025!") {
                // ConfirmaciÃ³n final
                const finalConfirmation = prompt(`âï¸ Para confirmar la eliminaciÃ³n completa del historial, escribe exactamente:

ELIMINAR HISTORIAL

(Debe ser exactamente como se muestra, respetando mayÃºsculas)`);

                if (finalConfirmation === "ELIMINAR HISTORIAL") {
                    deleteCompleteHistory();
                } else {
                    alert("â ConfirmaciÃ³n incorrecta. OperaciÃ³n cancelada por seguridad.");
                }
            } else {
                alert("â ContraseÃ±a incorrecta. OperaciÃ³n cancelada.");
            }
        }

        // FunciÃ³n para eliminar todo el historial
        async function deleteCompleteHistory() {
            try {
                updateConnectionStatus("syncing");

                if (isFirebaseReady) {
                    // Obtener todos los documentos del historial
                    const snapshot = await db.collection("history").get();

                    // Crear un batch para eliminar todos los documentos
                    const batch = db.batch();
                    snapshot.docs.forEach((doc) => {
                        batch.delete(doc.ref);
                    });

                    // Ejecutar la eliminaciÃ³n en batch
                    await batch.commit();
                    console.log("â Historial eliminado de Firebase");
                }

                // Limpiar array local
                history.length = 0;

                // Actualizar UI inmediatamente
                updateHistory();
                updateConnectionStatus("online");

                // Registrar la acciÃ³n de eliminaciÃ³n del historial
                await addToHistory(
                    "EliminaciÃ³n de historial",
                    "Sistema completo",
                    `Historial eliminado completamente por: ${currentUser}`
                );

                alert(`â HISTORIAL ELIMINADO EXITOSAMENTE

ð Se ha eliminado completamente todo el historial del sistema.
ð¤ OperaciÃ³n realizada por: ${currentUser}
ð Fecha: ${new Date().toLocaleString("es-CL")}

El sistema continuarÃ¡ registrando nuevas operaciones a partir de este momento.`);

                // Refrescar la vista del historial
                setTimeout(() => {
                    if (document.querySelector(".nav-item.active").id === "tab-history") {
                        updateHistory();
                    }
                }, 1000);

            } catch (error) {
                console.error("â Error eliminando historial:", error);
                updateConnectionStatus("offline");
                alert(`â Error eliminando el historial: ${error.message}

Por favor intenta nuevamente o contacta al soporte tÃ©cnico.`);
            }
        }

        function exportData(format) {
            if (format === "excel") {
                // Crear contenido con formato CSV correcto para Excel
                let csvContent =
                    "CÃ³digo;Nombre;CategorÃ­a;Estado;Cantidad;EstanterÃ­a;Rack;Nivel\n";

                products.forEach((product) => {
                    csvContent += `"${product.code}";"${product.name}";"${product.category}";"${product.status}";"${product.quantity}";"${product.location.shelf}";"${product.location.rack}";"${product.location.level}"\n`;
                });

                // Crear y descargar archivo
                const blob = new Blob(["\uFEFF" + csvContent], {
                    type: "text/csv;charset=utf-8;",
                });
                const link = document.createElement("a");
                link.href = URL.createObjectURL(blob);
                link.download = "Inventario_Liceo_Rios_Chile.csv";
                link.style.display = "none";
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);

                alert("ð Â¡Archivo Excel descargado exitosamente!");
            } else if (format === "pdf") {
                // Configurar estilos para impresiÃ³n PDF
                const originalTitle = document.title;
                document.title = "Inventario Liceo RÃ­os de Chile";

                // Crear ventana de impresiÃ³n con datos del inventario
                const printWindow = window.open("", "_blank");
                printWindow.document.write(`
            <!DOCTYPE html>
            <html>
            <head>
                <title>Inventario Liceo RÃ­os de Chile</title>
                <style>
                    @media print {
                        body { -webkit-print-color-adjust: exact !important; color-adjust: exact !important; }
                    }
                    body { 
                        font-family: Arial, sans-serif; 
                        margin: 20px; 
                        color: #000;
                        -webkit-print-color-adjust: exact;
                        color-adjust: exact;
                    }
                    .header-info { 
                        text-align: center; 
                        margin-bottom: 30px; 
                        border-bottom: 3px solid #1e7e34;
                        padding-bottom: 20px;
                    }
                    .logo { 
                        width: 70px; 
                        height: 70px; 
                        margin: 0 auto 20px; 
                        display: block;
                        padding: 5px;
                    }
                    h1 { 
                        color: #1e7e34 !important; 
                        margin-bottom: 10px; 
                        font-size: 2rem;
                        font-weight: bold;
                    }
                    h2 { 
                        color: #666 !important; 
                        margin-bottom: 20px; 
                        font-size: 1.2rem; 
                    }
                    table { 
                        width: 100%; 
                        border-collapse: collapse; 
                        margin-top: 20px; 
                        border: 2px solid #1e7e34;
                    }
                    th { 
                        border: 1px solid #000 !important; 
                        padding: 12px 8px; 
                        text-align: left; 
                        font-size: 11px; 
                        background-color: #1e7e34 !important; 
                        color: white !important; 
                        font-weight: bold;
                        -webkit-print-color-adjust: exact;
                        color-adjust: exact;
                    }
                    td { 
                        border: 1px solid #000 !important; 
                        padding: 8px; 
                        text-align: left; 
                        font-size: 10px; 
                    }
                    tr:nth-child(even) { 
                        background-color: #f5f5f5 !important;
                        -webkit-print-color-adjust: exact;
                        color-adjust: exact;
                    }
                    .export-date { 
                        text-align: right; 
                        font-size: 12px; 
                        color: #666; 
                        margin-bottom: 20px; 
                    }
                    .footer { 
                        margin-top: 30px; 
                        text-align: center; 
                        font-size: 12px; 
                        color: #666; 
                        border-top: 2px solid #1e7e34; 
                        padding-top: 20px; 
                    }
                    .code-cell { font-weight: bold !important; }
                    .quantity-cell { font-weight: bold !important; text-align: center; }
                </style>
            </head>
            <body>
                <div class="header-info">
                    <img src="LRC.png" alt="Logo" class="logo" onerror="this.style.display='none'">
                    <h1>INVENTARIO GENERAL</h1>
                    <h2>Liceo RÃ­os de Chile - LirquÃ©n</h2>
                    <div class="export-date">ð Exportado el: ${new Date().toLocaleString(
                    "es-CL"
                )}</div>
                </div>
                <table>
                    <thead>
                        <tr>
                            <th>CÃDIGO</th>
                            <th>NOMBRE</th>
                            <th>CATEGORÃA</th>
                            <th>ESTADO</th>
                            <th>CANTIDAD</th>
                            <th>ESTANTERÃA</th>
                            <th>RACK</th>
                            <th>NIVEL</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${products
                        .map(
                            (product) => `
                            <tr>
                                <td class="code-cell">${product.code}</td>
                                <td>${product.name}</td>
                                <td>${product.category}</td>
                                <td>${product.status}</td>
                                <td class="quantity-cell">${product.quantity}</td>
                                <td>${product.location.shelf}</td>
                                <td>${product.location.rack}</td>
                                <td>${product.location.level}</td>
                            </tr>
                        `
                        )
                        .join("")}
                    </tbody>
                </table>
                <div class="footer">
                    <p><strong>ð RESUMEN:</strong> ${products.length
                    } productos registrados | ${products.reduce(
                        (sum, p) => sum + p.quantity,
                        0
                    )} unidades en stock</p>
                    <p><strong>Sistema de Inventario - Liceo RÃ­os de Chile</strong></p>
                    <p style="margin-top: 15px; font-size: 10px; color: #999;">Documento generado automÃ¡ticamente el ${new Date().toLocaleDateString(
                        "es-CL"
                    )} a las ${new Date().toLocaleTimeString("es-CL")}</p>
                </div>
            </body>
            </html>
        `);
                printWindow.document.close();

                // Esperar a que cargue y luego imprimir
                setTimeout(() => {
                    printWindow.print();
                }, 500);

                document.title = originalTitle;
                alert("ð Â¡Preparando archivo PDF para descarga!");
            }
        }

        function hideLoading() {
            document.getElementById("loadingOverlay").style.display = "none";
        }

        // Event listeners
        window.onclick = function (event) {
            const modal = document.getElementById("operationModal");
            const infoModal = document.getElementById("infoModal");
            const requestModal = document.getElementById("requestModal");

            if (event.target === modal) {
                closeModal();
            }
            if (event.target === infoModal) {
                closeInfoModal();
            }
        };

        // Initialize
        document.addEventListener("DOMContentLoaded", function () {
            // Inicializar EmailJS al cargar la pÃ¡gina
            initializeEmailJS();

            // Hide loading after a short delay to show the Firebase connection process
            setTimeout(() => {
                if (document.getElementById("loginScreen").style.display !== "none") {
                    hideLoading();
                }
            }, 2000);

            // Establecer fecha mÃ­nima para prÃ©stamos (hoy)
            const today = new Date().toISOString().split('T')[0];
            const returnDateInput = document.getElementById("returnDate");
            if (returnDateInput) {
                returnDateInput.min = today;
            }
        });

        // Funciones adicionales para manejo de fechas en prÃ©stamos
        function setDefaultReturnDate() {
            const returnDateInput = document.getElementById("returnDate");
            if (returnDateInput) {
                // Establecer fecha por defecto a una semana desde hoy
                const nextWeek = new Date();
                nextWeek.setDate(nextWeek.getDate() + 7);
                returnDateInput.value = nextWeek.toISOString().split('T')[0];
            }
        }

        // FunciÃ³n para validar email del solicitante
        function validateBorrowerEmail(email) {
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            return emailRegex.test(email);
        }

        // FunciÃ³n para formatear RUT automÃ¡ticamente
        function formatRUT(rut) {
            // Remover todos los caracteres que no sean nÃºmeros o K
            rut = rut.replace(/[^0-9kK]/g, '');

            // Convertir a mayÃºsculas
            rut = rut.toUpperCase();

            // Validar longitud
            if (rut.length < 2) return rut;

            // Separar nÃºmero y dÃ­gito verificador
            const body = rut.slice(0, -1);
            const dv = rut.slice(-1);

            // Formatear el cuerpo del RUT con puntos
            let formattedBody = '';
            for (let i = body.length - 1; i >= 0; i--) {
                if ((body.length - i) % 3 === 1 && i !== body.length - 1) {
                    formattedBody = '.' + formattedBody;
                }
                formattedBody = body[i] + formattedBody;
            }

            return formattedBody + '-' + dv;
        }

        // Agregar event listeners para formateo automÃ¡tico de RUT
        document.addEventListener('input', function (e) {
            if (e.target.id === 'borrowerRut' || e.target.id === 'returnBorrowerRut' || e.target.id === 'requesterRut') {
                e.target.value = formatRUT(e.target.value);
            }
        });

        // FunciÃ³n para verificar si EmailJS estÃ¡ configurado
        function checkEmailJSConfiguration() {
            if (!isEmailJSReady) {
                console.warn("â ï¸ EmailJS no estÃ¡ configurado correctamente");
                return false;
            }

            if (emailjsConfig.publicKey === "TU_PUBLIC_KEY_AQUI" ||
                emailjsConfig.serviceId === "TU_SERVICE_ID_AQUI" ||
                emailjsConfig.templateId === "TU_TEMPLATE_ID_AQUI") {
                console.warn("â ï¸ EmailJS necesita configuraciÃ³n personalizada");
                updateEmailStatus("error");
                return false;
            }

            return true;
        }

        // FunciÃ³n para mostrar informaciÃ³n sobre configuraciÃ³n de EmailJS
        function showEmailJSSetupInfo() {
            if (!checkEmailJSConfiguration()) {
                alert(`ð§ Para enviar correos automÃ¡ticos de prÃ©stamos:

1. Crea una cuenta en EmailJS (https://emailjs.com)
2. Configura un servicio de email (Gmail, Outlook, etc.)
3. Crea un template de email para prÃ©stamos
4. Reemplaza en el cÃ³digo:
   - TU_PUBLIC_KEY_AQUI
   - TU_SERVICE_ID_AQUI  
   - TU_TEMPLATE_ID_AQUI

Mientras tanto, el sistema funcionarÃ¡ sin envÃ­o de correos.`);
            }
        }

        // FunciÃ³n mejorada para manejar errores de EmailJS
        function handleEmailError(error) {
            console.error("Error de EmailJS:", error);

            let userMessage = "Hubo un problema enviando el correo de confirmaciÃ³n.";

            if (error.text) {
                if (error.text.includes("not found")) {
                    userMessage += " Verifica la configuraciÃ³n del servicio.";
                } else if (error.text.includes("limit")) {
                    userMessage += " Se alcanzÃ³ el lÃ­mite de correos del mes.";
                } else if (error.text.includes("invalid")) {
                    userMessage += " Los datos del correo son invÃ¡lidos.";
                }
            }

            return userMessage;
        }

        // Template de ejemplo para EmailJS
        const emailTemplateExample = `
        Hola {{to_name}},

        Se ha registrado un prÃ©stamo a tu nombre en el {{liceo_name}}.

        ð¦ Producto: {{product_name}}
        ð·ï¸ CÃ³digo: {{product_code}}
        ð Cantidad: {{quantity}}
        ð Fecha de prÃ©stamo: {{loan_date}}
        ð Fecha de devoluciÃ³n: {{return_date}}
        
        ð¤ Solicitante: {{borrower_name}}
        ð RUT: {{borrower_rut}}

        Por favor, devuelve el producto en la fecha indicada.

        Para consultas, contacta: {{contact_email}}

        Saludos,
        {{system_name}}
        `;

        // FunciÃ³n para descargar template de ejemplo
        function downloadEmailTemplate() {
            const blob = new Blob([emailTemplateExample], { type: 'text/plain' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = 'template_emailjs_prestamo.txt';
            link.click();
        }

        // Agregar funcionalidad para auto-completar fecha de retorno basada en categorÃ­a
        function setReturnDateByCategory() {
            const lendCodeInput = document.getElementById('lendCode');
            const returnDateInput = document.getElementById('returnDate');

            if (lendCodeInput && returnDateInput && lendCodeInput.value) {
                const product = products.find(p => p.code === lendCodeInput.value.trim());
                if (product) {
                    const today = new Date();
                    let daysToAdd = 7; // Default: 1 semana

                    // Ajustar dÃ­as segÃºn categorÃ­a
                    switch (product.category) {
                        case 'Equipo':
                            daysToAdd = 7; // 1 semana para equipos
                            break;
                        case 'Libro':
                            daysToAdd = 21; // 3 semanas para libros
                            break;
                        case 'Material':
                            daysToAdd = 3; // 3 dÃ­as para materiales
                            break;
                        case 'Herramienta':
                            daysToAdd = 7; // 1 semana para herramientas
                            break;
                        case 'Documento':
                            daysToAdd = 1; // 1 dÃ­a para documentos
                            break;
                    }

                    today.setDate(today.getDate() + daysToAdd);
                    returnDateInput.value = today.toISOString().split('T')[0];
                }
            }
        }

        // Event listener para auto-completar fecha cuando se verifica un producto
        document.addEventListener('blur', function (e) {
            if (e.target.id === 'lendCode') {
                setTimeout(setReturnDateByCategory, 500); // Delay para que se ejecute despuÃ©s de verifyProduct
            } else if (e.target.id === 'returnBorrowerRut' || e.target.id === 'returnCode') {
                setTimeout(verifyActiveLoan, 300); // Verificar prÃ©stamo activo al cambiar RUT o cÃ³digo
            }
        });

        // FunciÃ³n para validar que la fecha de retorno no sea en el pasado
        function validateReturnDate(dateString) {
            const returnDate = new Date(dateString);
            const today = new Date();
            today.setHours(0, 0, 0, 0); // Resetear horas para comparaciÃ³n solo de fecha

            return returnDate >= today;
        }

        // Mejorar validaciÃ³n en el formulario de prÃ©stamo
        function validateLoanForm() {
            const borrowerEmail = document.getElementById('borrowerEmail').value;
            const returnDate = document.getElementById('returnDate').value;
            const borrowerRut = document.getElementById('borrowerRut').value;

            if (!validateBorrowerEmail(borrowerEmail)) {
                alert('â Por favor ingresa un correo electrÃ³nico vÃ¡lido');
                return false;
            }

            if (!validateReturnDate(returnDate)) {
                alert('â La fecha de devoluciÃ³n no puede ser en el pasado');
                return false;
            }

            if (borrowerRut.length < 11) { // RUT mÃ­nimo formateado: 1.111.111-1
                alert('â Por favor ingresa un RUT vÃ¡lido con el formato correcto');
                return false;
            }

            return true;
        }

        // FunciÃ³n para mostrar estadÃ­sticas de prÃ©stamos por correo (solo admin)
        function showLoanEmailStats() {
            if (currentRole !== 'admin') return;

            const totalLoans = loans.length;
            const activeLoans = loans.filter(l => l.status === 'Activo').length;
            const overdueLoans = loans.filter(l => {
                if (l.status !== 'Activo') return false;
                const returnDate = new Date(l.returnDate);
                const today = new Date();
                return returnDate < today;
            }).length;

            console.log(`ð EstadÃ­sticas de prÃ©stamos:
- Total: ${totalLoans}
- Activos: ${activeLoans}  
- Vencidos: ${overdueLoans}`);
        }

        // Agregar funciÃ³n para recordatorios automÃ¡ticos (concepto para futuras mejoras)
        function setupLoanReminders() {
            // Esta funciÃ³n podrÃ­a expandirse para enviar recordatorios automÃ¡ticos
            // usando un servicio como EmailJS con scheduled sends o webhooks
            console.log('ð Sistema de recordatorios configurado');
        }

        // FunciÃ³n de utilidad para logging de operaciones de email
        function logEmailOperation(operation, status, details = '') {
            const logEntry = {
                timestamp: new Date().toISOString(),
                operation: operation,
                status: status,
                details: details,
                user: currentUser || 'Sistema'
            };

            console.log('ð§ Email Log:', logEntry);

            // En una implementaciÃ³n completa, esto podrÃ­a guardarse en Firebase
            // para auditorÃ­a de correos enviados
        }

        // FUNCIONES PARA SISTEMA DE SOLICITUDES

        // Abrir modal de solicitud
        function openRequestModal() {
            const modal = document.getElementById('requestModal');
            modal.style.display = 'block';

            // Establecer fecha mÃ­nima (hoy)
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('requestedDate').min = today;

            // Establecer fecha por defecto (maÃ±ana)
            const tomorrow = new Date();
            tomorrow.setDate(tomorrow.getDate() + 1);
            document.getElementById('requestedDate').value = tomorrow.toISOString().split('T')[0];

            // Limpiar verificaciÃ³n previa
            document.getElementById('productVerification').classList.add('hidden');
        }

        // Cerrar modal de solicitud
        function closeRequestModal() {
            document.getElementById('requestModal').style.display = 'none';
            document.getElementById('requestForm').reset();
            document.getElementById('productVerification').classList.add('hidden');
        }

        async function approveRequest(requestId) {
            const request = productRequests.find(r => r.id === requestId);
            if (!request) {
                alert('â Solicitud no encontrada');
                return;
            }

            const confirmed = confirm(`Â¿Aprobar solicitud y crear prÃ©stamo automÃ¡tico?

ð Detalles:
- Solicitante: ${request.requesterName}
- Producto: ${request.productName} 
- Cantidad: ${request.requestedQuantity}

Se crearÃ¡ el prÃ©stamo automÃ¡ticamente.`);

            if (confirmed) {
                try {
                    // Crear prÃ©stamo automÃ¡ticamente
                    const loan = {
                        productCode: request.productCode,
                        productName: request.productName,
                        quantity: request.requestedQuantity,
                        borrower: request.requesterName,
                        borrowerRut: request.requesterRut,
                        borrowerEmail: request.requesterEmail,
                        loanDate: new Date().toISOString().split("T")[0],
                        returnDate: request.requestedDate,
                        status: "Activo",
                        origin: "Solicitud aprobada",
                        createdAt: isFirebaseReady
                            ? firebase.firestore.FieldValue.serverTimestamp()
                            : new Date().toISOString(),
                    };

                    // Encontrar el producto y reducir stock
                    const product = products.find(p => p.code === request.productCode);
                    if (product && product.quantity >= request.requestedQuantity) {
                        // Guardar prÃ©stamo
                        if (isFirebaseReady) {
                            await db.collection("loans").add(loan);
                            const productRef = db.collection("products").doc(product.id);
                            await productRef.update({
                                quantity: firebase.firestore.FieldValue.increment(-request.requestedQuantity),
                            });
                        } else {
                            loan.id = loans.length + 1;
                            loans.push(loan);
                            product.quantity -= request.requestedQuantity;
                        }

                        // Marcar solicitud como aprobada
                        request.status = 'Aprobada';
                        request.approvedDate = new Date().toISOString();
                        request.approvedBy = currentUser;
                        if (isFirebaseReady) {
                            // Buscar el documento por contenido en lugar de por ID
                            const querySnapshot = await db.collection('productRequests')
                                .where('requesterRut', '==', request.requesterRut)
                                .where('productCode', '==', request.productCode)
                                .where('status', '==', 'Pendiente')
                                .limit(1)
                                .get();

                            if (!querySnapshot.empty) {
                                const doc = querySnapshot.docs[0];
                                await doc.ref.update({
                                    status: 'Aprobada',
                                    approvedDate: firebase.firestore.FieldValue.serverTimestamp(),
                                    approvedBy: currentUser
                                });
                                // Actualizar el request local con el ID correcto
                                request.id = doc.id;
                            }
                        }

                        // Registrar en historial
                        await addToHistory(
                            'Solicitud aprobada',
                            request.productName,
                            `Solicitante: ${request.requesterName}, PrÃ©stamo creado automÃ¡ticamente`
                        );

                        alert('â Solicitud aprobada y prÃ©stamo creado exitosamente');
                        const approvalEmailData = {
                            requesterName: request.requesterName,
                            requesterRut: request.requesterRut,
                            requesterEmail: request.requesterEmail,
                            productName: request.productName,
                            productCode: request.productCode,
                            quantity: request.requestedQuantity,
                            loanDate: new Date().toLocaleDateString('es-CL'),
                            returnDate: new Date(request.requestedDate).toLocaleDateString('es-CL'),
                            approvedBy: currentUser
                        };
                        updateNotifications();
                        updateDashboard();
                    } else {
                        alert('â Stock insuficiente para aprobar la solicitud');
                    }
                } catch (error) {
                    console.error('Error aprobando solicitud:', error);
                    alert('â Error aprobando solicitud. Intenta nuevamente.');
                }
            }
        }

        async function rejectRequest(requestId) {
            const request = productRequests.find(r => r.id === requestId);
            if (!request) {
                alert('â Solicitud no encontrada');
                return;
            }

            const reason = prompt(`Motivo del rechazo para ${request.requesterName}:`);

            if (reason && reason.trim()) {
                // Marcar solicitud como rechazada
                request.status = 'Rechazada';
                request.rejectedDate = new Date().toISOString();
                request.rejectionReason = reason.trim();
                if (isFirebaseReady) {
                    // Buscar el documento por contenido en lugar de por ID
                    const querySnapshot = await db.collection('productRequests')
                        .where('requesterRut', '==', request.requesterRut)
                        .where('productCode', '==', request.productCode)
                        .where('status', '==', 'Pendiente')
                        .limit(1)
                        .get();

                    if (!querySnapshot.empty) {
                        const doc = querySnapshot.docs[0];
                        await doc.ref.update({
                            status: 'Rechazada',
                            rejectedDate: firebase.firestore.FieldValue.serverTimestamp(),
                            rejectedBy: currentUser,
                            rejectionReason: reason.trim()
                        });
                        // Actualizar el request local con el ID correcto
                        request.id = doc.id;
                    }
                }

                // Registrar en historial
                await addToHistory(
                    'Solicitud rechazada',
                    request.productName,
                    `Solicitante: ${request.requesterName}, Motivo: ${reason.trim()}`
                );

                alert(`â Solicitud rechazada. Motivo: ${reason}`);
                updateNotifications();
            }
        }

        function viewRequestDetails(requestId) {
            const request = productRequests.find(r => r.id === requestId);
            if (!request) {
                alert('â Solicitud no encontrada');
                return;
            }

            const details = `ð DETALLES DE LA SOLICITUD

ð¤ Solicitante: ${request.requesterName}
ð RUT: ${request.requesterRut}
ð§ Email: ${request.requesterEmail}

ð¦ Producto: ${request.productName}
ð·ï¸ CÃ³digo: ${request.productCode}
ð Cantidad: ${request.requestedQuantity} unidades
ð Fecha necesaria: ${new Date(request.requestedDate).toLocaleDateString('es-CL')}

ð Motivo: ${request.requestReason || 'No especificado'}

ð Fecha de solicitud: ${new Date(request.requestDate).toLocaleString('es-CL')}
ð Estado: ${request.status}`;

            alert(details);
        }

        // Variables para solicitudes mÃºltiples
        let requestedProducts = [];
        let currentVerifiedProduct = null;

        // Configurar fechas mÃ­nimas al abrir modal
        function openRequestModal() {
            const modal = document.getElementById('requestModal');
            modal.style.display = 'block';

            // Establecer fecha mÃ­nima (48 horas desde ahora)
            const twoDaysFromNow = new Date();
            twoDaysFromNow.setDate(twoDaysFromNow.getDate() + 2);
            const minDate = twoDaysFromNow.toISOString().split('T')[0];

            document.getElementById('requestedDate').min = minDate;
            document.getElementById('returnDate').min = minDate;

            // Establecer fechas por defecto
            const threeDaysFromNow = new Date();
            threeDaysFromNow.setDate(threeDaysFromNow.getDate() + 3);
            document.getElementById('requestedDate').value = threeDaysFromNow.toISOString().split('T')[0];

            const oneWeekFromNow = new Date();
            oneWeekFromNow.setDate(oneWeekFromNow.getDate() + 7);
            document.getElementById('returnDate').value = oneWeekFromNow.toISOString().split('T')[0];

            // Limpiar lista de productos
            requestedProducts = [];
            updateProductsList();
            updateSubmitButton();

            // Agregar validaciÃ³n de fechas
            document.getElementById('requestedDate').addEventListener('change', validateDates);
            document.getElementById('returnDate').addEventListener('change', validateDates);
        }

        // Confirmar cierre del modal
        function confirmCloseRequestModal() {
            if (requestedProducts.length > 0 ||
                document.getElementById('requesterName').value.trim() ||
                document.getElementById('requesterEmail').value.trim()) {

                const confirmed = confirm('â ï¸ Â¿EstÃ¡s seguro de cerrar?\n\nPerderÃ¡s todo el progreso de tu solicitud.');
                if (confirmed) {
                    closeRequestModal();
                }
                return confirmed
            } else {
                closeRequestModal();
                return true;
            }
        }

        // Cerrar modal
        function closeRequestModal() {
            document.getElementById('requestModal').style.display = 'none';
            document.getElementById('requestForm').reset();
            requestedProducts = [];
            currentVerifiedProduct = null;
            updateProductsList();
            document.getElementById('newProductVerification').classList.add('hidden');
        }

        // Verificar nuevo producto
        function verifyNewProduct() {
            const input = document.getElementById('newProductInput');
            const verification = document.getElementById('newProductVerification');
            const query = input.value.trim().toLowerCase();

            if (!query) {
                verification.classList.add('hidden');
                currentVerifiedProduct = null;
                return;
            }

            verification.classList.remove('hidden');
            verification.className = 'product-verification product-searching';
            verification.innerHTML = 'ð Buscando productos...';

            setTimeout(() => {
                // Buscar productos que coincidan por cÃ³digo o nombre
                console.log('ð Buscando productos con query:', query);
                console.log('ð¦ Total productos en sistema:', products.length);

                // Buscar productos que coincidan por cÃ³digo o nombre (bÃºsqueda mÃ¡s flexible)
                const matchingProducts = products.filter(p => {
                    if (!p || p.status !== 'Disponible') return false;

                    const productCode = (p.code || '').toLowerCase();
                    const productName = (p.name || '').toLowerCase();

                    // BÃºsqueda por cÃ³digo exacto o parcial
                    const codeMatch = productCode.includes(query);

                    // BÃºsqueda por nombre exacto o por palabras clave
                    const nameExactMatch = productName === query;
                    const namePartialMatch = productName.includes(query);

                    // Si la query es corta (menos de 3 caracteres), solo bÃºsqueda exacta
                    if (query.length < 3) {
                        return codeMatch || nameExactMatch;
                    }

                    // Para queries mÃ¡s largas, bÃºsqueda mÃ¡s flexible
                    return codeMatch || nameExactMatch || namePartialMatch;
                });

                console.log('â Productos encontrados:', matchingProducts.length);
                console.log('ð Lista de productos encontrados:', matchingProducts.map(p => ({
                    codigo: p.code,
                    nombre: p.name,
                    cantidad: p.quantity,
                    estado: p.status
                })));

                if (matchingProducts.length === 0) {
                    verification.className = 'product-verification product-not-found';
                    verification.innerHTML = `
                <div><strong>â Producto no encontrado</strong></div>
                <div>No se encontrÃ³ ningÃºn producto disponible con ese nombre o cÃ³digo.</div>
            `;
                    currentVerifiedProduct = null;
                    return;
                }

                // Agrupar productos por nombre para mostrar stock total
                const productGroups = {};
                matchingProducts.forEach(product => {
                    // Usar el nombre exacto como key (sin convertir a minÃºsculas para preservar formato)
                    const key = product.name.toLowerCase().trim();
                    const displayName = product.name.trim();

                    if (!productGroups[key]) {
                        productGroups[key] = {
                            name: displayName,
                            category: product.category,
                            codes: [],
                            totalStock: 0,
                            totalUnits: 0,
                            sampleProduct: product
                        };
                    }

                    // Agregar cada cÃ³digo individual
                    productGroups[key].codes.push({
                        code: product.code,
                        quantity: product.quantity,
                        location: product.location,
                        id: product.id
                    });

                    // Sumar stock (cada producto individual contribuye con su cantidad)
                    productGroups[key].totalStock += (product.quantity || 1);
                    productGroups[key].totalUnits += 1; // Contar unidades fÃ­sicas
                });

                console.log('ð Grupos creados:', Object.keys(productGroups).length);
                Object.values(productGroups).forEach(group => {
                    console.log(`ð·ï¸ ${group.name}: ${group.totalStock} unidades en ${group.codes.length} cÃ³digos`);
                });

                // Mostrar resultados agrupados
                const groupNames = Object.keys(productGroups);

                if (groupNames.length === 1) {
                    // Un solo tipo de producto encontrado
                    const group = productGroups[groupNames[0]];

                    // Verificar si ya estÃ¡ en la lista
                    const alreadyAdded = requestedProducts.find(rp =>
                        rp.name.toLowerCase() === group.name.toLowerCase()
                    );

                    if (alreadyAdded) {
                        verification.className = 'product-verification product-not-found';
                        verification.innerHTML = `
                    <div><strong>â ï¸ Producto ya agregado</strong></div>
                    <div>Este producto ya estÃ¡ en tu lista de solicitudes.</div>
                `;
                        currentVerifiedProduct = null;
                    } else {
                        verification.className = 'product-verification product-found';
                        verification.innerHTML = `
    <div><strong>â Producto encontrado:</strong></div>
    <div><strong>ð¦ Nombre:</strong> ${group.name}</div>
    <div><strong>ð CategorÃ­a:</strong> ${group.category}</div>
    <div><strong>ð Stock total disponible:</strong> ${group.totalStock} unidades</div>
    <div><strong>ð·ï¸ CÃ³digos disponibles:</strong> ${group.codes.length} cÃ³digos individuales</div>
    <div style="margin-top: 0.5rem; padding: 0.5rem; background: rgba(52, 152, 219, 0.1); border-radius: 0.5rem; font-size: 0.85rem;">
        <strong>ð Detalle de cÃ³digos:</strong><br>
        ${group.codes.slice(0, 5).map(c => `â¢ ${c.code} (${c.quantity} und.)`).join('<br>')}
        ${group.codes.length > 5 ? `<br>... y ${group.codes.length - 5} cÃ³digos mÃ¡s` : ''}
    </div>
    <div style="margin-top: 0.5rem; padding: 0.5rem; background: rgba(30, 126, 52, 0.1); border-radius: 0.5rem; font-size: 0.85rem;">
        ð¡ <strong>Tip:</strong> Puedes solicitar hasta ${Math.min(group.totalStock, 40)} unidades y el sistema asignarÃ¡ automÃ¡ticamente los cÃ³digos disponibles.
    </div>
`;
                        currentVerifiedProduct = {
                            name: group.name,
                            category: group.category,
                            totalStock: group.totalStock,
                            availableCodes: group.codes,
                            isGrouped: true
                        };

                        // Establecer cantidad mÃ¡xima
                        const quantityInput = document.getElementById('newQuantityInput');
                        const maxQuantity = Math.min(group.totalStock, 40);
                        quantityInput.max = maxQuantity;

                        if (parseInt(quantityInput.value) > maxQuantity) {
                            quantityInput.value = Math.min(maxQuantity, 1);
                        }
                    }
                } else {
                    // MÃºltiples tipos de productos encontrados
                    verification.className = 'product-verification product-found';
                    let html = `<div><strong>â Se encontraron ${groupNames.length} tipos de productos:</strong></div>`;

                    Object.values(productGroups).forEach(group => {
                        html += `
                    <div style="margin: 0.5rem 0; padding: 0.5rem; border: 1px solid var(--gray-300); border-radius: 0.5rem; cursor: pointer;" 
                         onclick="selectSpecificProduct('${group.name}')">
                        <div><strong>ð¦ ${group.name}</strong></div>
                        <div style="font-size: 0.85rem; color: var(--gray-600);">
                            ð ${group.totalStock} unidades disponibles | ð ${group.category}
                        </div>
                    </div>
                `;
                    });

                    html += `<div style="margin-top: 0.5rem; font-size: 0.85rem; color: var(--gray-600);">
                ð Haz clic en el producto que deseas solicitar
            </div>`;

                    verification.innerHTML = html;
                    currentVerifiedProduct = null;
                }
            }, 500);
        }

        // Agregar producto a la lista
        function addProductToList() {
            if (!currentVerifiedProduct) {
                alert('â Primero debes buscar y verificar un producto vÃ¡lido');
                return;
            }

            const quantity = parseInt(document.getElementById('newQuantityInput').value) || 1;

            if (quantity < 1 || quantity > 40) {
                alert('â La cantidad debe estar entre 1 y 40');
                return;
            }

            let totalAvailable;
            if (currentVerifiedProduct.isGrouped) {
                totalAvailable = currentVerifiedProduct.totalStock;
            } else {
                totalAvailable = currentVerifiedProduct.quantity;
            }

            if (quantity > totalAvailable) {
                alert(`â No hay suficiente stock. Disponible: ${totalAvailable} unidades`);
                return;
            }

            // Agregar a la lista
            const productToAdd = {
                name: currentVerifiedProduct.name,
                quantity: quantity,
                category: currentVerifiedProduct.category,
                availableStock: totalAvailable,
                isGrouped: currentVerifiedProduct.isGrouped || false
            };

            // Si es un producto agrupado, agregar informaciÃ³n de cÃ³digos
            if (currentVerifiedProduct.isGrouped) {
                productToAdd.availableCodes = currentVerifiedProduct.availableCodes;
                productToAdd.codesNeeded = quantity;
            } else {
                productToAdd.code = currentVerifiedProduct.code;
            }

            requestedProducts.push(productToAdd);

            // Limpiar campos
            document.getElementById('newProductInput').value = '';
            document.getElementById('newQuantityInput').value = '1';
            document.getElementById('newProductVerification').classList.add('hidden');
            currentVerifiedProduct = null;

            // Actualizar UI
            updateProductsList();
            updateSubmitButton();

            // Mostrar mensaje de Ã©xito
            const verification = document.getElementById('newProductVerification');
            verification.classList.remove('hidden');
            verification.className = 'product-verification product-found';
            verification.innerHTML = `â ${quantity} unidad${quantity > 1 ? 'es' : ''} de "${productToAdd.name}" agregada${quantity > 1 ? 's' : ''} a tu solicitud`;

            setTimeout(() => {
                verification.classList.add('hidden');
            }, 2000);
        }

        // Actualizar lista de productos
        function updateProductsList() {
            const container = document.getElementById('productsListContainer');
            const listDiv = document.getElementById('productsList');
            const totalSpan = document.getElementById('totalProducts');

            if (requestedProducts.length === 0) {
                listDiv.classList.add('hidden');
                return;
            }

            listDiv.classList.remove('hidden');
            totalSpan.textContent = requestedProducts.length;

            container.innerHTML = requestedProducts.map((product, index) => {
                let codeInfo = '';
                if (product.isGrouped) {
                    codeInfo = `<span>ð·ï¸ CÃ³digos: Se asignarÃ¡n automÃ¡ticamente (${product.quantity} unidades)</span>`;
                } else {
                    codeInfo = `<span>ð·ï¸ CÃ³digo: ${product.code}</span>`;
                }

                return `
            <div class="product-item">
                <div class="product-item-info">
                    <div class="product-item-name">${product.name}</div>
                    <div class="product-item-details">
                        ${codeInfo}
                        <span>ð Cantidad: ${product.quantity}</span>
                        <span>ð CategorÃ­a: ${product.category}</span>
                        <span>ð¦ Stock disponible: ${product.availableStock}</span>
                    </div>
                </div>
                <button type="button" class="product-item-remove" onclick="removeProductFromList(${index})" title="Eliminar producto">
                    â
                </button>
            </div>
        `;
            }).join('');
        }

        // Remover producto de la lista
        function removeProductFromList(index) {
            const product = requestedProducts[index];
            const confirmed = confirm(`Â¿Eliminar "${product.name}" de tu solicitud?`);

            if (confirmed) {
                requestedProducts.splice(index, 1);
                updateProductsList();
                updateSubmitButton();
            }
        }

        // Actualizar botÃ³n de envÃ­o
        function updateSubmitButton() {
            const submitBtn = document.getElementById('submitRequestBtn');

            if (requestedProducts.length > 0) {
                submitBtn.disabled = false;
                submitBtn.textContent = `ð¤ Enviar Solicitud (${requestedProducts.length} productos)`;
            } else {
                submitBtn.disabled = true;
                submitBtn.textContent = 'ð¤ Enviar Solicitud Completa';
            }
        }

        // Validar fechas
        function validateDates() {
            const requestedDate = new Date(document.getElementById('requestedDate').value);
            const returnDate = new Date(document.getElementById('returnDate').value);
            const now = new Date();
            const twoDaysFromNow = new Date();
            twoDaysFromNow.setDate(twoDaysFromNow.getDate() + 2);

            // Validar fecha de solicitud (mÃ­nimo 48 horas)
            if (requestedDate < twoDaysFromNow) {
                showDateWarning('requestedDate', 'â ï¸ La fecha debe ser al menos 48 horas despuÃ©s de hoy');
                return false;
            }

            // Validar que fecha de devoluciÃ³n sea despuÃ©s de solicitud
            if (returnDate <= requestedDate) {
                showDateWarning('returnDate', 'â ï¸ La fecha de devoluciÃ³n debe ser posterior a la fecha solicitada');
                return false;
            }

            // Mostrar confirmaciÃ³n si todo estÃ¡ bien
            showDateSuccess();
            return true;
        }

        function showDateWarning(fieldId, message) {
            const field = document.getElementById(fieldId);
            let warning = field.parentNode.querySelector('.date-warning');

            if (warning) {
                warning.remove();
            }

            warning = document.createElement('div');
            warning.className = 'date-warning';
            warning.innerHTML = message;
            field.parentNode.appendChild(warning);
        }

        function showDateSuccess() {
            // Remover warnings previos
            document.querySelectorAll('.date-warning').forEach(w => w.remove());

            const requestedField = document.getElementById('requestedDate');
            let success = requestedField.parentNode.querySelector('.date-valid');

            if (!success) {
                success = document.createElement('div');
                success.className = 'date-valid';
                success.innerHTML = 'â Fechas vÃ¡lidas - Cumple con el aviso de 48 horas';
                requestedField.parentNode.appendChild(success);
            }
        }

        // Validar que todos los productos tengan cÃ³digos vÃ¡lidos
        function validateProductCodes() {
            for (const product of requestedProducts) {
                if (product.isGrouped) {
                    if (!product.availableCodes || product.availableCodes.length === 0) {
                        console.error('Producto agrupado sin cÃ³digos disponibles:', product);
                        return false;
                    }
                    if (product.quantity > product.availableCodes.length) {
                        alert(`â Error: Se solicitan ${product.quantity} unidades de "${product.name}" pero solo hay ${product.availableCodes.length} cÃ³digos disponibles.`);
                        return false;
                    }
                } else {
                    if (!product.code) {
                        console.error('Producto individual sin cÃ³digo:', product);
                        return false;
                    }
                }
            }
            return true;
        }

        // Enviar solicitud mÃºltiple
        async function submitMultipleProductRequest(event) {
            event.preventDefault();

            // Validaciones
            if (requestedProducts.length === 0) {
                alert('â Debes agregar al menos un producto a tu solicitud');
                return;
            }

            if (!validateDates()) {
                alert('â Por favor corrige las fechas antes de enviar');
                return;
            }

            if (!validateProductCodes()) {
                alert('â Error en la validaciÃ³n de productos. Por favor intenta nuevamente.');
                return;
            }

            const formData = {
                requesterName: document.getElementById('requesterName').value.trim(),
                requesterRut: document.getElementById('requesterRut').value.trim(),
                requesterEmail: document.getElementById('requesterEmail').value.trim(),
                requestedDate: document.getElementById('requestedDate').value,
                returnDate: document.getElementById('returnDate').value,
                requestReason: document.getElementById('requestReason').value.trim(),
                products: requestedProducts,
                requestDateTime: new Date().toLocaleString('es-CL'),
                status: 'Pendiente',
                totalProducts: requestedProducts.length,
                requestDate: new Date().toISOString()
            };

            // Validar email
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            if (!emailRegex.test(formData.requesterEmail)) {
                alert('â Por favor ingresa un correo electrÃ³nico vÃ¡lido');
                return;
            }

            try {
                // Guardar cada producto como solicitud separada (para compatibilidad)
                for (const product of requestedProducts) {
                    if (product.isGrouped) {
                        // Para productos agrupados, crear solicitudes individuales por cada cÃ³digo necesario
                        const codesNeeded = Math.min(product.quantity, product.availableCodes.length);
                        const selectedCodes = product.availableCodes.slice(0, codesNeeded);

                        for (let i = 0; i < codesNeeded; i++) {
                            const codeInfo = selectedCodes[i];
                            const singleRequest = {
                                ...formData,
                                requestedProduct: product.name,
                                productCode: codeInfo.code,
                                productName: product.name,
                                requestedQuantity: 1, // Cada cÃ³digo individual es 1 unidad
                                originalGroupQuantity: product.quantity,
                                isFromGroupedRequest: true,
                                groupIndex: i + 1,
                                totalInGroup: codesNeeded,
                                multipleRequestId: Date.now().toString() + '_' + Math.random().toString(36).substr(2, 9)
                            };

                            if (isFirebaseReady) {
                                const docRef = await db.collection('productRequests').add(singleRequest);
                                console.log('â Producto agrupado guardado:', product.name, 'CÃ³digo:', codeInfo.code, 'ID:', docRef.id);
                            } else {
                                singleRequest.id = Date.now().toString() + Math.random();
                                productRequests.push(singleRequest);
                            }
                        }

                        // Registrar en historial para el grupo completo
                        await addToHistory(
                            'Solicitud mÃºltiple (agrupada)',
                            product.name,
                            `Solicitante: ${formData.requesterName}, Cantidad: ${product.quantity} (${codesNeeded} cÃ³digos asignados), Total productos en solicitud: ${requestedProducts.length}`
                        );

                    } else {
                        // Para productos individuales (no agrupados)
                        const singleRequest = {
                            ...formData,
                            requestedProduct: product.name,
                            productCode: product.code || 'SIN_CODIGO',
                            productName: product.name,
                            requestedQuantity: product.quantity,
                            isFromGroupedRequest: false,
                            multipleRequestId: Date.now().toString() + '_' + Math.random().toString(36).substr(2, 9)
                        };

                        if (isFirebaseReady) {
                            const docRef = await db.collection('productRequests').add(singleRequest);
                            console.log('â Producto individual guardado:', product.name, 'ID:', docRef.id);
                        } else {
                            singleRequest.id = Date.now().toString() + Math.random();
                            productRequests.push(singleRequest);
                        }

                        // Registrar en historial para producto individual
                        await addToHistory(
                            'Solicitud mÃºltiple',
                            product.name,
                            `Solicitante: ${formData.requesterName}, Cantidad: ${product.quantity}, Total productos en solicitud: ${requestedProducts.length}`
                        );
                    }
                }

                // Mostrar confirmaciÃ³n
                const totalUnits = requestedProducts.reduce((sum, p) => sum + p.quantity, 0);

                // Crear resumen detallado
                const productSummary = requestedProducts.map(p => {
                    if (p.isGrouped) {
                        const codesAssigned = Math.min(p.quantity, p.availableCodes.length);
                        return `â¢ ${p.name}: ${p.quantity} unidades solicitadas (${codesAssigned} cÃ³digos asignados)`;
                    } else {
                        return `â¢ ${p.name}: ${p.quantity} unidades (CÃ³digo: ${p.code || 'N/A'})`;
                    }
                }).join('\n');

                // Mostrar confirmaciÃ³n
                alert(`â Â¡Solicitud mÃºltiple enviada exitosamente!

ð Resumen:
- Productos diferentes: ${requestedProducts.length}
- Unidades totales: ${totalUnits}
- Fecha necesaria: ${new Date(formData.requestedDate).toLocaleDateString('es-CL')}
- Fecha de devoluciÃ³n: ${new Date(formData.returnDate).toLocaleDateString('es-CL')}

Productos solicitados:
${productSummary}

Un administrador revisarÃ¡ tu solicitud y te contactarÃ¡ por correo electrÃ³nico.`);

                closeRequestModal();

                // Actualizar notificaciones del admin si corresponde
                if (currentRole === 'admin') {
                    setTimeout(updateNotifications, 1000);
                }

            } catch (error) {
                console.error('Error enviando solicitud mÃºltiple:', error);
                alert('â Error enviando la solicitud. Por favor intenta nuevamente.');
            }
        }

        // Interceptar clicks en el modal para evitar cierre accidental
        document.addEventListener('click', function (event) {
            const modal = document.getElementById('requestModal');
            const modalContent = modal?.querySelector('.modal-content');

            // Solo ejecutar si se hace click exactamente en el fondo del modal (no en el contenido)
            if (event.target === modal && modalContent && modal.style.display === 'block') {
                // Verificar si hay contenido en el formulario
                const hasContent = requestedProducts.length > 0 ||
                    document.getElementById('requesterName')?.value.trim() ||
                    document.getElementById('requesterEmail')?.value.trim();

                if (hasContent) {
                    const confirmed = confirm('â ï¸ Â¿Cerrar solicitud?\n\nPerderÃ¡s todo el progreso si continÃºas.');
                    if (confirmed) {
                        closeRequestModal();
                    }
                    // Si no confirma, no hacer nada (el modal permanece abierto)
                } else {
                    closeRequestModal();
                }

                // Prevenir que el evento se propague
                event.stopPropagation();
            }
        });

        // Prevenir cierre accidental cuando se hace click dentro del contenido del modal
        function preventModalClose(event) {
            event.stopPropagation();
        }

        // Agregar el event listener al contenido del modal cuando se inicializa
        document.addEventListener('DOMContentLoaded', function () {
            const modalContent = document.querySelector('#requestModal .modal-content');
            if (modalContent) {
                modalContent.addEventListener('click', preventModalClose);
            }
        });

        function selectSpecificProduct(productName) {
            document.getElementById('newProductInput').value = productName;
            verifyNewProduct();
        }

        // Aprobar solicitudes en lote
        async function approveBulkRequest(requesterRut, productName) {
            // Buscar todas las solicitudes pendientes del usuario para este producto
            const bulkRequests = productRequests.filter(req =>
                req.status === 'Pendiente' &&
                req.requesterRut === requesterRut &&
                req.productName === productName
            );

            if (bulkRequests.length === 0) {
                alert('â No se encontraron solicitudes pendientes para procesar');
                return;
            }

            const firstRequest = bulkRequests[0];
            const totalQuantity = bulkRequests.reduce((sum, req) => sum + (req.requestedQuantity || 1), 0);

            const confirmed = confirm(`Â¿Aprobar TODAS las solicitudes en lote?

ð¤ Solicitante: ${firstRequest.requesterName}
ð¦ Producto: ${productName}
ð Cantidad total: ${totalQuantity} unidades
ð·ï¸ CÃ³digos involucrados: ${bulkRequests.length}
ð Fecha necesaria: ${new Date(firstRequest.requestedDate).toLocaleDateString('es-CL')}
ð Fecha devoluciÃ³n: ${new Date(firstRequest.returnDate).toLocaleDateString('es-CL')}

Se crearÃ¡ UN prÃ©stamo grupal con mÃºltiples cÃ³digos.`);

            if (!confirmed) return;

            try {
                // Verificar que todos los productos estÃ¡n disponibles
                const productCodes = bulkRequests.map(req => req.productCode);
                const availableProducts = products.filter(p =>
                    productCodes.includes(p.code) &&
                    p.status === 'Disponible' &&
                    p.quantity >= 1
                );

                if (availableProducts.length !== bulkRequests.length) {
                    alert(`â Error: Solo ${availableProducts.length} de ${bulkRequests.length} productos estÃ¡n disponibles actualmente.`);
                    return;
                }

                // Crear prÃ©stamo grupal
                const bulkLoan = {
                    productCode: productCodes.join(','), // CÃ³digos separados por coma
                    productName: productName,
                    quantity: totalQuantity,
                    borrower: firstRequest.requesterName,
                    borrowerRut: firstRequest.requesterRut,
                    borrowerEmail: firstRequest.requesterEmail,
                    loanDate: new Date().toISOString().split("T")[0],
                    returnDate: firstRequest.returnDate,
                    status: "Activo",
                    origin: "Solicitud aprobada en lote",
                    bulkLoan: true,
                    individualCodes: productCodes,
                    createdAt: isFirebaseReady ? firebase.firestore.FieldValue.serverTimestamp() : new Date().toISOString(),
                };

                // Guardar prÃ©stamo
                if (isFirebaseReady) {
                    await db.collection("loans").add(bulkLoan);
                } else {
                    bulkLoan.id = loans.length + 1;
                    loans.push(bulkLoan);
                }

                // Reducir stock de todos los productos
                for (const request of bulkRequests) {
                    const product = products.find(p => p.code === request.productCode);
                    if (product) {
                        if (isFirebaseReady) {
                            const productRef = db.collection("products").doc(product.id);
                            await productRef.update({
                                quantity: firebase.firestore.FieldValue.increment(-1),
                            });
                        } else {
                            product.quantity -= 1;
                        }
                    }
                }

                // Marcar todas las solicitudes como aprobadas
                for (const request of bulkRequests) {
                    request.status = 'Aprobada';
                    request.approvedDate = new Date().toISOString();
                    request.approvedBy = currentUser;
                    request.bulkApproval = true;

                    if (isFirebaseReady && request.id) {
                        try {
                            await db.collection('productRequests').doc(request.id).update({
                                status: 'Aprobada',
                                approvedDate: firebase.firestore.FieldValue.serverTimestamp(),
                                approvedBy: currentUser,
                                bulkApproval: true
                            });
                        } catch (error) {
                            console.warn('Error actualizando solicitud individual:', error);
                        }
                    }
                }

                // Registrar en historial
                await addToHistory(
                    'AprobaciÃ³n en lote',
                    productName,
                    `${firstRequest.requesterName}: ${totalQuantity} unidades, ${bulkRequests.length} cÃ³digos aprobados simultÃ¡neamente`
                );

                alert(`â Â¡AprobaciÃ³n en lote exitosa!

ð¦ Producto: ${productName}
ð¤ Solicitante: ${firstRequest.requesterName}
ð Total aprobado: ${totalQuantity} unidades
ð·ï¸ CÃ³digos procesados: ${bulkRequests.length}

Se creÃ³ un prÃ©stamo grupal con todos los cÃ³digos solicitados.`);
                const bulkApprovalEmailData = {
                    requesterName: firstRequest.requesterName,
                    requesterRut: firstRequest.requesterRut,
                    requesterEmail: firstRequest.requesterEmail,
                    productName: productName,
                    assignedCodes: productCodes.slice(0, 10).join(', ') + (productCodes.length > 10 ? `... y ${productCodes.length - 10} cÃ³digos mÃ¡s` : ''),
                    approvedQuantity: totalQuantity,
                    loanDate: new Date().toLocaleDateString('es-CL'),
                    returnDate: new Date(firstRequest.returnDate).toLocaleDateString('es-CL'),
                    approvedBy: currentUser
                };

                sendApprovalEmail(bulkApprovalEmailData);

                updateNotifications();
                updateDashboard();

            } catch (error) {
                console.error('Error en aprobaciÃ³n en lote:', error);
                alert('â Error procesando aprobaciÃ³n en lote. Intenta nuevamente.');
            }
        }

        // Rechazar solicitudes en lote
        async function rejectBulkRequest(requesterRut, productName) {
            const bulkRequests = productRequests.filter(req =>
                req.status === 'Pendiente' &&
                req.requesterRut === requesterRut &&
                req.productName === productName
            );

            if (bulkRequests.length === 0) {
                alert('â No se encontraron solicitudes pendientes para procesar');
                return;
            }

            const firstRequest = bulkRequests[0];
            const totalQuantity = bulkRequests.reduce((sum, req) => sum + (req.requestedQuantity || 1), 0);

            const reason = prompt(`Motivo del rechazo en lote para:

ð¤ ${firstRequest.requesterName}
ð¦ ${productName} (${totalQuantity} unidades)
ð·ï¸ ${bulkRequests.length} cÃ³digos

Ingresa el motivo:`);

            if (!reason || !reason.trim()) {
                return;
            }

            try {
                // Marcar todas las solicitudes como rechazadas
                for (const request of bulkRequests) {
                    request.status = 'Rechazada';
                    request.rejectedDate = new Date().toISOString();
                    request.rejectionReason = reason.trim();
                    request.rejectedBy = currentUser;
                    request.bulkRejection = true;

                    if (isFirebaseReady && request.id) {
                        try {
                            await db.collection('productRequests').doc(request.id).update({
                                status: 'Rechazada',
                                rejectedDate: firebase.firestore.FieldValue.serverTimestamp(),
                                rejectedBy: currentUser,
                                rejectionReason: reason.trim(),
                                bulkRejection: true
                            });
                        } catch (error) {
                            console.warn('Error actualizando solicitud individual:', error);
                        }
                    }
                }

                // Registrar en historial
                await addToHistory(
                    'Rechazo en lote',
                    productName,
                    `${firstRequest.requesterName}: ${totalQuantity} unidades rechazadas. Motivo: ${reason.trim()}`
                );

                alert(`â Rechazo en lote procesado

ð¦ Producto: ${productName}
ð¤ Solicitante: ${firstRequest.requesterName}
ð Total rechazado: ${totalQuantity} unidades
ð Motivo: ${reason.trim()}`);

                updateNotifications();

            } catch (error) {
                console.error('Error en rechazo en lote:', error);
                alert('â Error procesando rechazo en lote. Intenta nuevamente.');
            }
        }

        // Ver detalles de solicitud en lote
        function viewBulkRequestDetails(requesterRut, productName) {
            const bulkRequests = productRequests.filter(req =>
                req.status === 'Pendiente' &&
                req.requesterRut === requesterRut &&
                req.productName === productName
            );

            if (bulkRequests.length === 0) {
                alert('â No se encontraron solicitudes para mostrar');
                return;
            }

            const firstRequest = bulkRequests[0];
            const totalQuantity = bulkRequests.reduce((sum, req) => sum + (req.requestedQuantity || 1), 0);
            const codes = bulkRequests.map(req => req.productCode).join(', ');

            const details = `ð DETALLES DE SOLICITUD EN LOTE

ð¤ Solicitante: ${firstRequest.requesterName}
ð RUT: ${firstRequest.requesterRut}
ð§ Email: ${firstRequest.requesterEmail}

ð¦ Producto: ${productName}
ð Cantidad total: ${totalQuantity} unidades
ð·ï¸ CÃ³digos involucrados: ${bulkRequests.length}
ð CÃ³digos especÃ­ficos: ${codes}

ð Fecha necesaria: ${new Date(firstRequest.requestedDate).toLocaleDateString('es-CL')}
ð Fecha devoluciÃ³n: ${new Date(firstRequest.returnDate).toLocaleDateString('es-CL')}
ð Motivo: ${firstRequest.requestReason || 'No especificado'}

â° Fecha de solicitud: ${new Date(firstRequest.requestDate).toLocaleString('es-CL')}
ð Estado: ${firstRequest.status}`;

            alert(details);
        }

        // Actualizar tipo de devoluciÃ³n segÃºn selecciÃ³n
        function updateReturnType() {
            const returnType = document.querySelector('input[name="returnType"]:checked')?.value;
            const quantityField = document.getElementById("returnQuantity");

            if (!window.currentLoanInfo || !quantityField) return;

            const { loan, isGroupLoan } = window.currentLoanInfo;

            if (isGroupLoan) {
                const remainingCodes = loan.individualCodes.length;
                const returnedCodes = loan.returnedCodes ? loan.returnedCodes.length : 0;
                const pendingUnits = remainingCodes - returnedCodes;

                if (returnType === 'individual') {
                    quantityField.value = 1;
                    quantityField.max = 1;
                    quantityField.disabled = true;
                } else if (returnType === 'complete') {
                    quantityField.value = pendingUnits;
                    quantityField.max = pendingUnits;
                    quantityField.disabled = false;
                }
            }
        }

        // InicializaciÃ³n final del sistema
        console.log(`â Sistema de Inventario Liceo RÃ­os de Chile v4.0
ð§ EmailJS: ${isEmailJSReady ? 'Configurado' : 'Requiere configuraciÃ³n'}
ð¥ Firebase: ${isFirebaseReady ? 'Conectado' : 'Modo offline'}
ð¥ Usuarios soportados: Admin, Operador, Visitante`);
    </script>
</body>

</html>