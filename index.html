<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Sistema de Inventario - Liceo Ríos de Chile</title>
    <style>
        @import url("https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap");

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary: #1e7e34;
            --primary-dark: #155724;
            --primary-light: #28a745;
            --secondary: #2d5a3d;
            --accent: #34995e;
            --success: #28a745;
            --warning: #f39c12;
            --danger: #e74c3c;
            --info: #3498db;
            --dark: #2c3e50;
            --light: #ecf0f1;
            --white: #ffffff;
            --gray-100: #f8f9fa;
            --gray-200: #e9ecef;
            --gray-300: #dee2e6;
            --gray-400: #ced4da;
            --gray-500: #adb5bd;
            --gray-600: #6c757d;
            --gray-700: #495057;
            --gray-800: #343a40;
            --gray-900: #212529;
        }

        body {
            font-family: "Inter", -apple-system, BlinkMacSystemFont, sans-serif;
            background: linear-gradient(135deg,
                    var(--primary) 0%,
                    var(--primary-dark) 100%);
            min-height: 100vh;
            color: var(--gray-800);
            line-height: 1.6;
        }

        /* Loading Spinner */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.9);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        .loading-text {
            margin-top: 1rem;
            color: var(--gray-600);
            font-weight: 500;
        }

        /* Connection Status */
        .connection-status {
            position: fixed;
            bottom: 20px;
            right: 20px;
            padding: 0.5rem 1rem;
            border-radius: 2rem;
            font-size: 0.75rem;
            font-weight: 600;
            z-index: 1000;
            transition: all 0.3s ease;
        }

        .connection-online {
            background: rgba(39, 174, 96, 0.9);
            color: white;
        }

        .connection-offline {
            background: rgba(231, 76, 60, 0.9);
            color: white;
        }

        .connection-syncing {
            background: rgba(243, 156, 18, 0.9);
            color: white;
        }

        /* Email Status */
        .email-status {
            position: fixed;
            bottom: 70px;
            right: 20px;
            padding: 0.5rem 1rem;
            border-radius: 2rem;
            font-size: 0.75rem;
            font-weight: 600;
            z-index: 1000;
            transition: all 0.3s ease;
        }

        .email-ready {
            background: rgba(39, 174, 96, 0.9);
            color: white;
        }

        .email-sending {
            background: rgba(243, 156, 18, 0.9);
            color: white;
        }

        .email-error {
            background: rgba(231, 76, 60, 0.9);
            color: white;
        }

        /* Utility Classes */
        .shadow-sm {
            box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1),
                0 1px 2px 0 rgba(0, 0, 0, 0.06);
        }

        .shadow {
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1),
                0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }

        .shadow-lg {
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1),
                0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }

        .shadow-xl {
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1),
                0 10px 10px -5px rgba(0, 0, 0, 0.04);
        }

        .rounded {
            border-radius: 0.375rem;
        }

        .rounded-lg {
            border-radius: 0.5rem;
        }

        .rounded-xl {
            border-radius: 0.75rem;
        }

        .rounded-2xl {
            border-radius: 1rem;
        }

        .hidden {
            display: none !important;
        }

        /* Login Screen */
        .login-container {
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 2rem;
            position: relative;
            overflow: hidden;
        }

        .login-container::before {
            content: "";
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: radial-gradient(circle at 20% 50%,
                    rgba(255, 255, 255, 0.1) 0%,
                    transparent 50%),
                radial-gradient(circle at 80% 20%,
                    rgba(255, 255, 255, 0.1) 0%,
                    transparent 50%),
                radial-gradient(circle at 40% 80%,
                    rgba(255, 255, 255, 0.1) 0%,
                    transparent 50%);
            pointer-events: none;
        }

        .login-card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            border-radius: 1.5rem;
            padding: 3rem;
            width: 100%;
            max-width: 480px;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
            border: 1px solid rgba(255, 255, 255, 0.2);
            position: relative;
            animation: slideUp 0.6s ease-out;
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .login-header {
            text-align: center;
            margin-bottom: 2.5rem;
        }

        .logo {
            width: 80px;
            height: 80px;
            margin: 0 auto 1.5rem;
            background: url("LRC.png") center/contain no-repeat;
            background-color: white;
            padding: 8px;
            box-shadow: 0 4px 12px rgba(30, 126, 52, 0.2);
            animation: logoFloat 3s ease-in-out infinite;
        }

        @keyframes logoFloat {

            0%,
            100% {
                transform: translateY(0px);
            }

            50% {
                transform: translateY(-5px);
            }
        }

        .login-title {
            font-size: 1.875rem;
            font-weight: 800;
            color: var(--gray-800);
            margin-bottom: 0.5rem;
        }

        .login-subtitle {
            color: var(--gray-600);
            font-size: 0.875rem;
            font-weight: 500;
        }

        .user-type-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
            margin-bottom: 2rem;
        }

        .user-type-card {
            background: var(--gray-100);
            border: 2px solid transparent;
            border-radius: 1rem;
            padding: 1.5rem;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .user-type-card:hover {
            background: var(--gray-200);
            transform: translateY(-2px);
        }

        .user-type-card.active {
            background: var(--primary);
            color: white;
            border-color: var(--primary-dark);
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(30, 126, 52, 0.3);
        }

        .user-type-card.full-width {
            grid-column: 1 / -1;
        }

        .user-type-icon {
            font-size: 2rem;
            margin-bottom: 0.75rem;
            display: block;
        }

        .user-type-title {
            font-weight: 600;
            margin-bottom: 0.25rem;
        }

        .user-type-desc {
            font-size: 0.75rem;
            opacity: 0.8;
        }

        .form-group {
            margin-bottom: 1.5rem;
        }

        .form-label {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-bottom: 0.75rem;
            font-weight: 600;
            color: var(--gray-700);
            font-size: 0.875rem;
            flex-wrap: wrap;
        }

        .help-icon {
            width: 24px;
            height: 24px;
            background: var(--primary);
            color: white;
            border-radius: 50%;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            font-weight: bold;
            cursor: pointer;
            position: relative;
            transition: all 0.3s ease;
            border: none;
            margin-left: 8px;
            flex-shrink: 0;
            vertical-align: middle;
        }

        .help-icon:hover {
            background: var(--primary-dark);
            transform: scale(1.1);
            z-index: 10;
        }

        /* Info Modal Styles */
        .info-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            z-index: 2500;
            animation: modalFadeIn 0.3s ease-out;
        }

        .info-modal-content {
            background: white;
            border-radius: 1rem;
            margin: 2% auto;
            padding: 0;
            width: 90%;
            max-width: 600px;
            max-height: 90vh;
            overflow-y: auto;
            position: relative;
            animation: modalSlideUp 0.3s ease-out;
            box-shadow: 0 25px 50px rgba(0, 0, 0, 0.3);
        }

        .info-modal-header {
            background: var(--primary);
            color: white;
            padding: 1.5rem;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .info-modal-title {
            font-size: 1.25rem;
            font-weight: 700;
            margin: 0;
        }

        .info-modal-close {
            background: none;
            border: none;
            color: white;
            font-size: 1.5rem;
            cursor: pointer;
            padding: 0.5rem;
            border-radius: 0.375rem;
            transition: background 0.3s ease;
        }

        .info-modal-close:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        .info-modal-body {
            padding: 2rem;
            max-height: 70vh;
            overflow-y: auto;
        }

        .info-question {
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--gray-800);
            margin-bottom: 1rem;
        }

        .info-description {
            color: var(--gray-600);
            line-height: 1.6;
            margin-bottom: 1.5rem;
        }

        .info-examples {
            margin-bottom: 1.5rem;
        }

        .info-examples h4 {
            font-weight: 600;
            color: var(--gray-800);
            margin-bottom: 1rem;
        }

        .example-list {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .example-list li {
            background: var(--gray-50);
            padding: 0.75rem 1rem;
            border-radius: 0.5rem;
            margin-bottom: 0.5rem;
            font-family: "Courier New", monospace;
            font-size: 0.9rem;
            border-left: 4px solid var(--primary);
        }

        .info-usage {
            background: var(--gray-50);
            border-radius: 0.75rem;
            padding: 1.5rem;
        }

        .info-usage h4 {
            font-weight: 600;
            color: var(--gray-800);
            margin-bottom: 1rem;
        }

        .usage-list {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .usage-list li {
            display: flex;
            align-items: flex-start;
            gap: 0.75rem;
            margin-bottom: 0.75rem;
            color: var(--gray-700);
            line-height: 1.5;
        }

        .usage-list li::before {
            content: "•";
            color: var(--primary);
            font-weight: bold;
            font-size: 1.2rem;
        }

        /* Location Input Enhanced */
        .location-grid {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 1rem;
            margin-bottom: 1rem;
        }

        .location-field {
            position: relative;
        }

        .location-field label {
            display: block;
            font-weight: 600;
            color: var(--gray-700);
            margin-bottom: 0.5rem;
            font-size: 0.875rem;
        }

        .location-input {
            width: 100%;
            padding: 0.875rem 1rem;
            border: 2px solid var(--gray-300);
            border-radius: 0.75rem;
            font-size: 1rem;
            transition: all 0.3s ease;
            background: white;
            text-align: center;
            font-weight: 600;
        }

        .location-input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(30, 126, 52, 0.1);
        }

        .location-preview {
            background: var(--gray-50);
            border: 2px dashed var(--gray-300);
            border-radius: 0.75rem;
            padding: 1rem;
            text-align: center;
            margin-top: 1rem;
        }

        .location-preview-value {
            font-size: 1rem;
            font-weight: 600;
            color: var(--primary);
            font-family: "Inter", sans-serif;
        }

        .form-input {
            width: 100%;
            padding: 0.875rem 1rem;
            border: 2px solid var(--gray-300);
            border-radius: 0.75rem;
            font-size: 1rem;
            transition: all 0.3s ease;
            background: white;
        }

        .form-input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(30, 126, 52, 0.1);
        }

        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            padding: 0.875rem 1.5rem;
            font-size: 1rem;
            font-weight: 600;
            border: none;
            border-radius: 0.75rem;
            cursor: pointer;
            transition: all 0.3s ease;
            text-decoration: none;
            position: relative;
            overflow: hidden;
        }

        .btn-primary {
            background: var(--primary);
            color: white;
            width: 100%;
        }

        .btn-primary:hover {
            background: var(--primary-dark);
            transform: translateY(-1px);
            box-shadow: 0 10px 25px rgba(30, 126, 52, 0.3);
        }

        .btn-secondary {
            background: var(--gray-600);
            color: white;
        }

        .btn-secondary:hover {
            background: var(--gray-700);
        }

        .btn-success {
            background: var(--success);
            color: white;
        }

        .btn-success:hover {
            background: #229954;
        }

        .btn-danger {
            background: var(--danger);
            color: white;
        }

        .btn-danger:hover {
            background: #c0392b;
        }

        .btn-warning {
            background: var(--warning);
            color: white;
        }

        .btn-warning:hover {
            background: #d68910;
        }

        /* Dashboard */
        .dashboard {
            display: none;
            min-height: 100vh;
            animation: fadeIn 0.5s ease-out;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
            }

            to {
                opacity: 1;
            }
        }

        .header {
            background: white;
            color: var(--gray-800);
            padding: 1.5rem 2rem;
            position: sticky;
            top: 0;
            z-index: 50;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            border-bottom: 3px solid var(--primary);
        }

        .header-content {
            max-width: 1400px;
            margin: 0 auto;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 1.5rem;
        }

        .header-logo {
            width: 60px;
            height: 60px;
            background: url("LRC.png") center/contain no-repeat;
            background-color: white;
            padding: 8px;
            box-shadow: 0 4px 12px rgba(30, 126, 52, 0.2);
        }

        .header-info h1 {
            font-size: 1.75rem;
            font-weight: 700;
            color: var(--gray-800);
            margin-bottom: 0.25rem;
        }

        .header-subtitle {
            font-size: 0.9rem;
            color: var(--primary);
            font-weight: 500;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 1.5rem;
            position: relative;
        }

        .user-badge {
            background: var(--primary);
            color: white;
            padding: 0.6rem 1.2rem;
            border-radius: 2rem;
            font-size: 0.875rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .logout-btn {
            background: var(--gray-600);
            color: white;
            padding: 0.6rem 1.2rem;
            border: none;
            border-radius: 0.5rem;
            font-size: 0.875rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .logout-btn:hover {
            background: var(--gray-700);
            transform: translateY(-1px);
        }

        /* Notification Bell Styles */
        .notification-bell {
            position: relative;
            background: var(--primary);
            color: white;
            padding: 0.6rem;
            border-radius: 50%;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            width: 45px;
            height: 45px;
            margin-right: 1rem;
        }

        .notification-bell:hover {
            background: var(--primary-dark);
            transform: scale(1.05);
        }

        .bell-icon {
            font-size: 1.2rem;
        }

        .notification-count {
            position: absolute;
            top: -5px;
            right: -5px;
            background: var(--danger);
            color: white;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            font-size: 0.7rem;
            font-weight: bold;
            display: flex;
            align-items: center;
            justify-content: center;
            min-width: 20px;
            border: 2px solid white;
        }

        .notification-count.hidden {
            display: none;
        }

        /* Notification Dropdown */
        .notification-dropdown {
            position: fixed;
            top: 70px;
            right: 0;
            background: white;
            border-radius: 1rem;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.15);
            width: 420px;
            max-height: 500px;
            overflow: hidden;
            z-index: 1000;
            border: 1px solid #e2e8f0;
            transform: translateY(-10px);
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
        }

        .notification-dropdown.active {
            transform: translateY(0);
            opacity: 1;
            visibility: visible;
        }

        .notification-header {
            background: var(--primary);
            color: white;
            padding: 1rem 1.5rem;
            border-radius: 1rem 1rem 0 0;
            font-weight: 600;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .notification-header h4 {
            margin: 0;
            font-size: 1rem;
        }

        .clear-notifications {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: white;
            padding: 0.3rem 0.6rem;
            border-radius: 0.5rem;
            font-size: 0.8rem;
            cursor: pointer;
            transition: background 0.3s ease;
        }

        .clear-notifications:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        .notification-list {
            max-height: 400px;
            overflow-y: auto;
        }

        .notification-item {
            padding: 1rem 1.5rem;
            border-bottom: 1px solid var(--gray-100);
            transition: background 0.3s ease;
        }

        .notification-item:hover {
            background: var(--gray-50);
        }

        .notification-item:last-child {
            border-bottom: none;
        }

        .notification-item.overdue {
            border-left: 4px solid var(--danger);
            background: rgba(231, 76, 60, 0.02);
        }

        .notification-item.warning {
            border-left: 4px solid var(--warning);
            background: rgba(243, 156, 18, 0.02);
        }

        .notification-icon {
            font-size: 1.2rem;
            margin-right: 0.8rem;
        }

        .notification-content {
            flex: 1;
        }

        .notification-title {
            font-weight: 600;
            color: var(--gray-800);
            margin-bottom: 0.3rem;
            font-size: 0.9rem;
        }

        .notification-message {
            color: var(--gray-600);
            font-size: 0.85rem;
            line-height: 1.4;
        }

        .notification-time {
            color: var(--gray-500);
            font-size: 0.75rem;
            margin-top: 0.3rem;
        }

        .no-notifications {
            padding: 2rem 1.5rem;
            text-align: center;
            color: var(--gray-500);
        }

        .no-notifications-icon {
            font-size: 3rem;
            margin-bottom: 1rem;
            opacity: 0.5;
        }

        .welcome-banner {
            background: linear-gradient(135deg,
                    var(--primary) 0%,
                    var(--primary-dark) 100%);
            color: white;
            padding: 3rem 2rem;
            border-radius: 1.5rem;
            margin-bottom: 2rem;
            text-align: center;
            position: relative;
            overflow: hidden;
        }

        .welcome-banner::before {
            content: "";
            position: absolute;
            top: -50%;
            right: -20%;
            width: 300px;
            height: 300px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 50%;
        }

        .welcome-banner::after {
            content: "";
            position: absolute;
            bottom: -30%;
            left: -10%;
            width: 200px;
            height: 200px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 50%;
        }

        .welcome-content {
            position: relative;
            z-index: 2;
        }

        .welcome-title {
            font-size: 2.5rem;
            font-weight: 800;
            margin-bottom: 0.5rem;
        }

        .welcome-subtitle {
            font-size: 1.1rem;
            opacity: 0.9;
        }

        /* User Info Card Enhanced */
        .user-info-card {
            background: white;
            border-radius: 1.5rem;
            padding: 2rem;
            margin-bottom: 2rem;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            border: 1px solid var(--gray-100);
            display: grid;
            grid-template-columns: auto 1fr auto;
            align-items: center;
            gap: 2rem;
        }

        .user-avatar {
            width: 80px;
            height: 80px;
            background: linear-gradient(135deg,
                    var(--primary) 0%,
                    var(--primary-light) 100%);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2rem;
            color: white;
            font-weight: 800;
        }

        .user-details {
            flex: 1;
        }

        .user-details h3 {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--gray-800);
            margin-bottom: 0.25rem;
        }

        .user-details .user-email {
            color: var(--gray-600);
            margin-bottom: 1rem;
            font-size: 0.95rem;
        }

        .permissions-label {
            font-weight: 600;
            color: var(--gray-700);
            margin-bottom: 0.75rem;
            display: block;
            font-size: 0.875rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .permissions-grid {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
        }

        .permission-badge {
            background: var(--primary);
            color: white;
            padding: 0.4rem 0.8rem;
            border-radius: 1.5rem;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.3px;
        }

        .user-actions {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
            align-items: end;
        }

        .user-status {
            background: var(--success);
            color: white;
            padding: 0.4rem 1rem;
            border-radius: 1.5rem;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
        }

        .session-time {
            color: var(--gray-500);
            font-size: 0.75rem;
        }

        /* Dashboard Navigation Cards */
        .dashboard-navigation {
            margin-bottom: 3rem;
        }

        .nav-title {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--gray-800);
            margin-bottom: 1.5rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .dashboard-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 1.5rem;
        }

        .dashboard-card {
            background: white;
            border-radius: 1.5rem;
            padding: 2.5rem;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.08);
            border: 2px solid var(--gray-100);
            position: relative;
            overflow: hidden;
        }

        .dashboard-card::before {
            content: "";
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: var(--primary);
            transform: scaleX(0);
            transition: transform 0.3s ease;
        }

        .dashboard-card:hover::before {
            transform: scaleX(1);
        }

        .dashboard-card:hover {
            transform: translateY(-8px);
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.15);
            border-color: var(--primary);
        }

        .dashboard-card-icon {
            width: 80px;
            height: 80px;
            background: linear-gradient(135deg,
                    var(--primary) 0%,
                    var(--primary-light) 100%);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 1.5rem;
            font-size: 2rem;
            color: white;
            transition: transform 0.3s ease;
        }

        .dashboard-card:hover .dashboard-card-icon {
            transform: scale(1.1);
        }

        .dashboard-card-title {
            font-size: 1.25rem;
            font-weight: 700;
            color: var(--gray-800);
            margin-bottom: 0.75rem;
        }

        .dashboard-card-desc {
            color: var(--gray-600);
            font-size: 0.95rem;
            line-height: 1.5;
        }

        /* Quick Stats Section */
        .quick-stats-section {
            margin-top: 2rem;
        }

        .section-title {
            font-size: 1.25rem;
            font-weight: 700;
            color: var(--gray-800);
            margin-bottom: 1.5rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1.5rem;
        }

        .stat-card {
            background: linear-gradient(135deg,
                    var(--primary) 0%,
                    var(--primary-dark) 100%);
            color: white;
            padding: 2rem;
            border-radius: 1rem;
            position: relative;
            overflow: hidden;
            transition: transform 0.3s ease;
        }

        .stat-card:hover {
            transform: translateY(-4px);
        }

        .stat-card::before {
            content: "";
            position: absolute;
            top: 0;
            right: 0;
            width: 100px;
            height: 100px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 50%;
            transform: translate(30px, -30px);
        }

        .stat-icon {
            font-size: 2.5rem;
            margin-bottom: 1rem;
            opacity: 0.9;
        }

        .stat-value {
            font-size: 2.5rem;
            font-weight: 800;
            margin-bottom: 0.5rem;
        }

        .stat-label {
            font-size: 0.875rem;
            font-weight: 500;
            opacity: 0.9;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 2rem;
        }

        .navigation {
            background: white;
            border-radius: 1rem;
            padding: 0.5rem;
            margin-bottom: 2rem;
            display: flex;
            gap: 0.5rem;
            box-shadow: var(--shadow);
            overflow-x: auto;
        }

        .nav-item {
            padding: 0.875rem 1.5rem;
            border-radius: 0.75rem;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
            white-space: nowrap;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .nav-item:hover {
            background: var(--gray-100);
        }

        .nav-item.active {
            background: var(--primary);
            color: white;
            box-shadow: 0 4px 12px rgba(30, 126, 52, 0.3);
        }

        .content-card {
            background: white;
            border-radius: 1rem;
            padding: 2rem;
            box-shadow: var(--shadow);
            min-height: 500px;
        }

        .content-title {
            font-size: 1.875rem;
            font-weight: 800;
            color: var(--gray-800);
            margin-bottom: 2rem;
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        /* Table */
        .table-container {
            background: white;
            border-radius: 1rem;
            overflow: hidden;
            box-shadow: var(--shadow);
        }

        .table-header {
            background: var(--gray-50);
            padding: 1.5rem;
            border-bottom: 1px solid var(--gray-200);
        }

        .search-input {
            width: 100%;
            max-width: 400px;
            padding: 0.75rem 1rem;
            border: 1px solid var(--gray-300);
            border-radius: 0.5rem;
            font-size: 0.875rem;
        }

        .search-input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(30, 126, 52, 0.1);
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th,
        td {
            padding: 1rem 1.5rem;
            text-align: left;
            border-bottom: 1px solid var(--gray-200);
        }

        th {
            background: var(--gray-50);
            font-weight: 600;
            color: var(--gray-700);
            font-size: 0.875rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        tr:hover {
            background: var(--gray-50);
        }

        .status-badge {
            padding: 0.25rem 0.75rem;
            border-radius: 9999px;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .status-available {
            background: rgba(39, 174, 96, 0.1);
            color: var(--success);
        }

        .status-in-use {
            background: rgba(52, 152, 219, 0.1);
            color: #3498db;
        }

        .status-maintenance {
            background: rgba(243, 156, 18, 0.1);
            color: var(--warning);
        }

        .status-unavailable {
            background: rgba(231, 76, 60, 0.1);
            color: var(--danger);
        }

        /* Management Section - Compact Design */
        .management-header {
            background: white;
            border-radius: 1rem;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.08);
            text-align: center;
            border: 1px solid var(--gray-100);
        }

        .management-title {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--gray-800);
            margin-bottom: 0.5rem;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
        }

        .management-subtitle {
            color: var(--gray-600);
            font-size: 0.9rem;
            line-height: 1.5;
        }

        /* Management Info Cards - Compact */
        .management-info {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 1.5rem;
        }

        .info-card {
            background: white;
            border-radius: 0.75rem;
            padding: 1rem;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
            border: 1px solid var(--gray-100);
            text-align: center;
        }

        .info-number {
            font-size: 1.5rem;
            font-weight: 800;
            color: var(--primary);
            display: block;
            margin-bottom: 0.25rem;
        }

        .info-label {
            color: var(--gray-600);
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.3px;
        }

        /* Action Grid - Compact */
        .action-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 1.2rem;
            margin-bottom: 2rem;
        }

        .action-card {
            background: white;
            border-radius: 1rem;
            padding: 1.5rem;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.08);
            border: 2px solid var(--gray-100);
            position: relative;
            overflow: hidden;
        }

        .action-card::before {
            content: "";
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: linear-gradient(90deg,
                    var(--primary) 0%,
                    var(--primary-light) 100%);
            transform: scaleX(0);
            transition: transform 0.3s ease;
        }

        .action-card:hover::before {
            transform: scaleX(1);
        }

        .action-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 30px rgba(0, 0, 0, 0.12);
            border-color: var(--primary);
        }

        .action-icon {
            width: 60px;
            height: 60px;
            background: linear-gradient(135deg,
                    var(--primary) 0%,
                    var(--primary-light) 100%);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 1rem;
            font-size: 1.8rem;
            color: white;
            transition: all 0.3s ease;
        }

        .action-card:hover .action-icon {
            transform: scale(1.1);
            box-shadow: 0 8px 20px rgba(30, 126, 52, 0.3);
        }

        .action-title {
            font-size: 1.1rem;
            font-weight: 700;
            margin-bottom: 0.5rem;
            color: var(--gray-800);
        }

        .action-desc {
            font-size: 0.85rem;
            color: var(--gray-600);
            line-height: 1.4;
            margin-bottom: 1rem;
        }

        .action-features {
            list-style: none;
            padding: 0;
            margin: 0;
            display: flex;
            flex-direction: column;
            gap: 0.3rem;
        }

        .action-features li {
            color: var(--gray-500);
            font-size: 0.75rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .action-features li::before {
            content: "✓";
            color: var(--primary);
            font-weight: bold;
        }

        /* Operation Result - Compact */
        .operation-result-container {
            margin-top: 1.5rem;
        }

        .result-card {
            background: white;
            border-radius: 1rem;
            padding: 1.5rem;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.08);
            border-left: 4px solid var(--primary);
        }

        /* Special Action Cards */
        .action-card.primary {
            border-color: var(--primary);
            background: linear-gradient(145deg,
                    rgba(30, 126, 52, 0.02) 0%,
                    rgba(30, 126, 52, 0.05) 100%);
        }

        .action-card.warning {
            border-color: var(--warning);
        }

        .action-card.warning .action-icon {
            background: linear-gradient(135deg, var(--warning) 0%, #e67e22 100%);
        }

        .action-card.danger {
            border-color: var(--danger);
        }

        .action-card.danger .action-icon {
            background: linear-gradient(135deg, var(--danger) 0%, #c0392b 100%);
        }

        /* Alerts */
        .alert {
            padding: 1rem 1.5rem;
            border-radius: 0.75rem;
            margin-bottom: 1.5rem;
            display: flex;
            align-items: flex-start;
            gap: 0.75rem;
        }

        .alert-warning {
            background: rgba(243, 156, 18, 0.1);
            border: 1px solid rgba(243, 156, 18, 0.2);
            color: #b7791f;
        }

        .alert-success {
            background: rgba(39, 174, 96, 0.1);
            border: 1px solid rgba(39, 174, 96, 0.2);
            color: #196f3d;
        }

        .alert-danger {
            background: rgba(231, 76, 60, 0.1);
            border: 1px solid rgba(231, 76, 60, 0.2);
            color: #922b21;
        }

        .alert-info {
            background: rgba(52, 152, 219, 0.1);
            border: 1px solid rgba(52, 152, 219, 0.2);
            color: #1b4f72;
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1500;
            animation: modalFadeIn 0.3s ease-out;
        }

        @keyframes modalFadeIn {
            from {
                opacity: 0;
            }

            to {
                opacity: 1;
            }
        }

        .modal-content {
            background: white;
            border-radius: 1rem;
            margin: 5% auto;
            padding: 2rem;
            width: 90%;
            max-width: 600px;
            max-height: 80vh;
            overflow-y: auto;
            position: relative;
            animation: modalSlideUp 0.3s ease-out;
        }

        @keyframes modalSlideUp {
            from {
                opacity: 0;
                transform: translateY(50px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .modal-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 1.5rem;
        }

        .modal-title {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--gray-800);
        }

        .close-btn {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: var(--gray-500);
            padding: 0.5rem;
            border-radius: 0.375rem;
            transition: all 0.3s ease;
        }

        .close-btn:hover {
            background: var(--gray-100);
            color: var(--gray-700);
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
        }

        /* Export Section */
        .export-section {
            background: var(--gray-50);
            border-radius: 1rem;
            padding: 1.5rem;
            margin-bottom: 2rem;
            display: flex;
            gap: 1rem;
        }

        /* Advanced Statistics Styles */
        .stats-header {
            background: linear-gradient(135deg,
                    var(--primary) 0%,
                    var(--primary-dark) 100%);
            color: white;
            padding: 2rem;
            border-radius: 1rem;
            margin-bottom: 2rem;
            text-align: center;
        }

        .stats-header h2 {
            font-size: 2.5rem;
            font-weight: 800;
            margin-bottom: 0.5rem;
        }

        .stats-header p {
            font-size: 1.1rem;
            opacity: 0.9;
        }

        .stats-overview {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1.5rem;
            margin-bottom: 3rem;
        }

        .overview-card {
            background: white;
            border-radius: 1rem;
            padding: 2rem;
            text-align: center;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
            border: 1px solid var(--gray-200);
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .overview-card::before {
            content: "";
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: var(--primary);
        }

        .overview-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.15);
        }

        .overview-icon {
            width: 60px;
            height: 60px;
            background: var(--primary);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 1rem;
            font-size: 1.5rem;
            color: white;
        }

        .overview-number {
            font-size: 2.5rem;
            font-weight: 800;
            color: var(--gray-800);
            margin-bottom: 0.5rem;
        }

        .overview-label {
            color: var(--gray-600);
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            font-size: 0.875rem;
        }

        .charts-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 2rem;
            margin-bottom: 2rem;
        }

        .chart-card {
            background: white;
            border-radius: 1rem;
            padding: 2rem;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
        }

        .chart-title {
            font-size: 1.25rem;
            font-weight: 700;
            color: var(--gray-800);
            margin-bottom: 1.5rem;
            text-align: center;
        }

        .status-chart {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .status-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 1rem;
            border-radius: 0.5rem;
            background: var(--gray-50);
        }

        .status-info {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .status-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
        }

        .status-available {
            background: var(--success);
        }

        .status-in-use {
            background: var(--info);
        }

        .status-maintenance {
            background: var(--warning);
        }

        .status-unavailable {
            background: var(--danger);
        }

        .status-count {
            font-weight: 700;
            font-size: 1.1rem;
            color: var(--gray-800);
        }

        .category-chart {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .category-bar {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .category-info {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .category-name {
            font-weight: 600;
            color: var(--gray-700);
        }

        .category-percentage {
            font-weight: 700;
            color: var(--primary);
        }

        .progress-bar {
            height: 8px;
            background: var(--gray-200);
            border-radius: 4px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg,
                    var(--primary) 0%,
                    var(--primary-light) 100%);
            border-radius: 4px;
            transition: width 1s ease-in-out;
        }

        .insights-section {
            background: white;
            border-radius: 1rem;
            padding: 2rem;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
        }

        .insights-title {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--gray-800);
            margin-bottom: 1.5rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .insight-item {
            display: flex;
            align-items: flex-start;
            gap: 1rem;
            padding: 1rem;
            border-radius: 0.5rem;
            margin-bottom: 1rem;
            background: var(--gray-50);
        }

        .insight-icon {
            width: 40px;
            height: 40px;
            background: var(--primary);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 1.2rem;
            flex-shrink: 0;
        }

        .insight-content h4 {
            font-weight: 600;
            color: var(--gray-800);
            margin-bottom: 0.25rem;
        }

        .insight-content p {
            color: var(--gray-600);
            font-size: 0.9rem;
            line-height: 1.4;
        }

        /* PRÉSTAMOS ACTIVOS - SECCIÓN OPTIMIZADA AL 90% */

        /* Contenedor principal reducido al 90% */
        #content-loans {
            max-width: 95%;
            margin: 0 auto;
            padding: 0 0.5rem;
        }

        /* Header de préstamos activos */
        #content-loans .content-title {
            font-size: 1.6rem;
            font-weight: 700;
            margin-bottom: 1.5rem;
            color: var(--gray-800);
        }

        /* Botones de recordatorios masivos - Compactos */
        .bulk-reminder-buttons {
            display: flex;
            gap: 1rem;
            flex-wrap: wrap;
            align-items: center;
            margin-bottom: 1.5rem;
        }

        .bulk-reminder-btn {
            padding: 0.7rem 1.3rem !important;
            font-size: 0.9rem !important;
            font-weight: 600 !important;
            border-radius: 0.7rem !important;
            white-space: nowrap;
            transition: all 0.3s ease;
            border: none;
            cursor: pointer;
        }

        .bulk-reminder-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 15px rgba(0, 0, 0, 0.15);
        }

        /* Cards de resumen - Más compactas */
        .loans-summary-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 1rem;
            margin-bottom: 2rem;
        }

        .loans-summary-card {
            background: white;
            border-radius: 1rem;
            padding: 1.3rem;
            text-align: center;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.08);
            border: 1px solid var(--gray-100);
            transition: all 0.3s ease;
        }

        .loans-summary-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.12);
        }

        .loans-summary-number {
            font-size: 1.8rem;
            font-weight: 800;
            margin-bottom: 0.4rem;
            display: block;
            line-height: 1;
        }

        .loans-summary-label {
            color: var(--gray-600);
            font-size: 0.8rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.3px;
            line-height: 1.3;
        }

        .loans-summary-total {
            color: var(--primary);
        }

        .loans-summary-upcoming {
            color: var(--warning);
        }

        .loans-summary-overdue {
            color: var(--danger);
        }

        .loans-summary-ontime {
            color: var(--success);
        }

        /* Tabla de préstamos activos - Optimizada */
        #content-loans .table-container {
            background: white;
            border-radius: 1rem;
            overflow-x: auto;
            overflow-y: visible;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.08);
            margin-bottom: 2rem;
        }

        #content-loans .table-container table {
            min-width: 1200px;
            width: 100%;
        }

        #content-loans .table-header {
            background: var(--gray-50);
            padding: 1.2rem;
            border-bottom: 1px solid var(--gray-200);
        }

        #activeLoansBody {
            font-size: 0.9rem;
        }

        #activeLoansBody tr {
            transition: background-color 0.2s ease;
        }

        #activeLoansBody tr:hover {
            background-color: var(--gray-50);
        }

        /* Celdas específicas de la tabla - Compactas */
        .loan-product-cell {
            min-width: 200px;
            max-width: 250px;
            padding: 0.8rem !important;
            width: 20%;
        }

        .loan-borrower-cell {
            min-width: 150px;
            max-width: 180px;
            padding: 0.8rem !important;
            width: 15%;
        }

        .loan-email-cell {
            min-width: 200px;
            max-width: 250px;
            padding: 0.8rem !important;
            word-break: break-word;
            font-size: 0.85rem;
            width: 18%;
        }

        .loan-quantity-cell {
            text-align: center;
            font-weight: bold;
            min-width: 80px;
            max-width: 100px;
            padding: 0.8rem !important;
            width: 8%;
        }

        .loan-date-cell {
            min-width: 110px;
            max-width: 130px;
            font-size: 0.85rem;
            padding: 0.8rem !important;
            width: 12%;
        }

        .loan-status-cell {
            min-width: 160px;
            max-width: 200px;
            text-align: center;
            padding: 0.8rem !important;
            width: 15%;
        }

        /* Estados de préstamos mejorados */
        .status-overdue {
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% {
                opacity: 1;
            }

            50% {
                opacity: 0.7;
            }

            100% {
                opacity: 1;
            }
        }

        .status-info-text {
            font-size: 0.72rem;
            font-weight: 500;
            margin-top: 0.2rem;
            display: block;
            line-height: 1.2;
        }

        /* Responsive mejorado */
        @media (max-width: 768px) {
            .container {
                padding: 1rem;
            }

            .login-card {
                padding: 2rem;
                margin: 1rem;
            }

            .user-type-grid {
                grid-template-columns: 1fr;
            }

            .header-content {
                flex-direction: column;
                gap: 1rem;
                text-align: center;
            }

            .header-left {
                flex-direction: column;
                text-align: center;
            }

            .navigation {
                overflow-x: auto;
            }

            .stats-grid {
                grid-template-columns: 1fr;
            }

            .stats-overview {
                grid-template-columns: repeat(2, 1fr);
            }

            .charts-grid {
                grid-template-columns: 1fr;
            }

            .action-grid {
                grid-template-columns: 1fr;
            }

            .dashboard-cards {
                grid-template-columns: 1fr;
            }

            .permissions-grid {
                justify-content: center;
            }

            .form-row {
                grid-template-columns: 1fr;
            }

            .modal-content {
                margin: 5% 1rem;
                width: auto;
            }

            .export-section {
                flex-direction: column;
            }

            .stats-header h2 {
                font-size: 2rem;
            }

            .overview-number {
                font-size: 2rem;
            }

            /* Mobile Dashboard */
            .welcome-banner {
                padding: 2rem 1rem;
            }

            .welcome-title {
                font-size: 2rem;
            }

            .user-info-card {
                grid-template-columns: 1fr;
                text-align: center;
                gap: 1.5rem;
            }

            .user-actions {
                align-items: center;
            }

            /* Mobile Notifications */
            .notification-bell {
                width: 40px;
                height: 40px;
                margin-right: 0.5rem;
            }

            .notification-dropdown {
                width: 95vw;
                max-width: 400px;
                max-height: 70vh;
            }

            .notification-item {
                padding: 0.8rem 1rem;
            }

            .notification-message {
                font-size: 0.8rem;
            }

            /* Mobile Management */
            .management-header {
                padding: 1.5rem 1rem;
            }

            .management-title {
                font-size: 1.3rem;
                flex-direction: column;
                gap: 0.3rem;
            }

            .management-info {
                grid-template-columns: repeat(2, 1fr);
            }

            .action-grid {
                grid-template-columns: 1fr;
            }

            .action-card {
                padding: 1.2rem;
            }

            .action-icon {
                width: 50px;
                height: 50px;
                font-size: 1.5rem;
            }

            /* Modals en móvil */
            .info-modal-content {
                margin: 5% 1rem;
                width: auto;
            }

            .location-grid {
                grid-template-columns: 1fr;
                gap: 1rem;
            }

            .location-input {
                text-align: left;
            }

            /* Tabla en móvil */
            .table-container {
                overflow-x: auto;
            }

            .table-container table {
                font-size: 0.75rem;
                min-width: 800px;
            }

            .table-container th,
            .table-container td {
                padding: 0.5rem 0.3rem;
                vertical-align: top;
            }

            /* PRÉSTAMOS ACTIVOS EN MÓVIL */
            #content-loans {
                max-width: 95%;
            }

            #content-loans .content-title {
                font-size: 1.3rem;
            }

            .loans-summary-cards {
                grid-template-columns: repeat(2, 1fr);
                gap: 0.6rem;
            }

            .loans-summary-card {
                padding: 1rem;
            }

            .loans-summary-number {
                font-size: 1.5rem;
            }

            .loans-summary-label {
                font-size: 0.75rem;
            }

            .bulk-reminder-buttons {
                flex-direction: column;
                gap: 0.5rem;
                width: 100%;
            }

            .bulk-reminder-btn {
                padding: 0.6rem 1rem !important;
                font-size: 0.8rem !important;
                width: 100%;
            }
        }

        /* Tablets */
        @media (max-width: 1024px) and (min-width: 769px) {
            #content-loans {
                max-width: 92%;
            }

            .table-container table {
                font-size: 0.85rem;
            }

            .bulk-reminder-btn {
                padding: 0.65rem 1.2rem !important;
                font-size: 0.85rem !important;
            }
        }

        /* Sistema de Solicitudes para Visitantes */
        .visitor-request-section {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%);
            color: white;
            padding: 2rem;
            border-radius: 1rem;
            text-align: center;
            margin-bottom: 2rem;
            animation: slideInFromTop 0.6s ease-out;
        }

        @keyframes slideInFromTop {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .visitor-request-section h3 {
            color: white !important;
            margin: 0 0 1rem 0;
            font-size: 1.3rem;
        }

        .visitor-request-section p {
            margin: 0 0 1.5rem 0;
            opacity: 0.9;
            font-size: 0.95rem;
            line-height: 1.4;
        }

        /* Verificación de producto en modal */
        .product-verification {
            margin-top: 1rem;
            padding: 1rem;
            border-radius: 0.5rem;
            border: 2px dashed var(--gray-300);
            font-size: 0.9rem;
            line-height: 1.4;
        }

        .product-found {
            background: rgba(39, 174, 96, 0.1);
            border-color: var(--success);
            color: var(--success);
        }

        .product-not-found {
            background: rgba(231, 76, 60, 0.1);
            border-color: var(--danger);
            color: var(--danger);
        }

        .product-searching {
            background: rgba(243, 156, 18, 0.1);
            border-color: var(--warning);
            color: var(--warning);
        }

        /* Notificaciones de solicitudes */
        .notification-item.request {
            border-left: 4px solid var(--warning);
            background: rgba(243, 156, 18, 0.03);
        }

        .notification-actions {
            margin-top: 1rem;
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
        }

        .btn-small {
            padding: 0.4rem 0.8rem;
            font-size: 0.8rem;
            border-radius: 0.4rem;
        }

        /* Responsive para solicitudes */
        @media (max-width: 768px) {
            .visitor-request-section {
                padding: 1.5rem 1rem;
                margin-bottom: 1.5rem;
            }

            .notification-actions {
                flex-direction: column;
            }

            .btn-small {
                width: 100%;
                justify-content: center;
            }
        }

        /* Estilos para solicitudes múltiples */
        .product-item {
            background: white;
            border: 1px solid var(--gray-200);
            border-radius: 0.75rem;
            padding: 1rem;
            margin-bottom: 0.75rem;
            display: flex;
            align-items: center;
            justify-content: space-between;
            transition: all 0.3s ease;
        }

        .product-item:hover {
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            border-color: var(--primary);
        }

        .product-item-info {
            flex: 1;
            margin-right: 1rem;
        }

        .product-item-name {
            font-weight: 700;
            color: var(--gray-800);
            margin-bottom: 0.25rem;
        }

        .product-item-details {
            font-size: 0.85rem;
            color: var(--gray-600);
            display: flex;
            gap: 1rem;
            flex-wrap: wrap;
        }

        .product-item-remove {
            background: var(--danger);
            color: white;
            border: none;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .product-item-remove:hover {
            background: #c0392b;
            transform: scale(1.1);
        }

        .date-warning {
            background: rgba(243, 156, 18, 0.1);
            border: 1px solid var(--warning);
            color: #b7791f;
            padding: 0.75rem;
            border-radius: 0.5rem;
            margin-top: 0.5rem;
            font-size: 0.85rem;
        }

        .date-valid {
            background: rgba(39, 174, 96, 0.1);
            border: 1px solid var(--success);
            color: #196f3d;
            padding: 0.75rem;
            border-radius: 0.5rem;
            margin-top: 0.5rem;
            font-size: 0.85rem;
        }

        /* Solución simple para alineación de fechas */
        .form-row .form-group {
            vertical-align: top;
        }

        .form-row .form-group .form-label {
            min-height: 2.8rem;
            display: flex;
            align-items: flex-end;
            padding-bottom: 0.2rem;
        }

        .form-row .form-group .form-input[type="date"] {
            height: 3rem;
            vertical-align: top;
        }

        /* Específico para las fechas del modal de solicitud */
        #requestedDate,
        #returnDate {
            height: 3rem !important;
            padding: 0.875rem 1rem !important;
            margin-top: 0 !important;
        }

        /* Estilos para selección de múltiples productos */
        .product-selection-item {
            margin: 0.5rem 0;
            padding: 0.75rem;
            border: 1px solid var(--gray-300);
            border-radius: 0.5rem;
            cursor: pointer;
            transition: all 0.3s ease;
            background: white;
        }

        .product-selection-item:hover {
            border-color: var(--primary);
            background: rgba(30, 126, 52, 0.05);
            transform: translateY(-1px);
        }

        .product-selection-item:active {
            transform: translateY(0);
        }

        .product-selection-name {
            font-weight: 600;
            color: var(--gray-800);
            margin-bottom: 0.25rem;
        }

        .product-selection-details {
            font-size: 0.85rem;
            color: var(--gray-600);
        }

        .search-tip {
            background: rgba(30, 126, 52, 0.1);
            border: 1px solid var(--primary);
            border-radius: 0.5rem;
            padding: 0.75rem;
            margin-top: 0.5rem;
            font-size: 0.85rem;
            color: var(--primary);
        }

        /* Estilos para solicitudes en lote */
        .bulk-request {
            border-left: 4px solid var(--primary) !important;
            background: rgba(30, 126, 52, 0.02) !important;
        }

        .bulk-info {
            margin: 0.5rem 0;
            padding: 0.5rem;
            background: rgba(30, 126, 52, 0.1);
            border-radius: 0.375rem;
            font-size: 0.8rem;
            color: var(--primary);
        }

        .bulk-request .notification-title {
            color: var(--primary) !important;
            font-weight: 700;
        }

        .notification-actions {
            margin-top: 1rem;
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
        }

        .notification-actions .btn-small {
            font-size: 0.75rem;
            padding: 0.4rem 0.6rem;
            white-space: nowrap;
        }

        @media (max-width: 1200px) {
            #content-loans {
                max-width: 98%;
            }

            #content-loans .table-container {
                overflow-x: scroll;
                -webkit-overflow-scrolling: touch;
            }

            #content-loans .table-container table {
                min-width: 1000px;
            }
        }

        @media (max-width: 768px) {
            #content-loans .table-container table {
                font-size: 0.8rem;
                min-width: 900px;
            }

            .loan-status-cell div {
                font-size: 0.75rem !important;
                line-height: 1.2;
            }

            .loans-summary-cards {
                grid-template-columns: repeat(2, 1fr);
                gap: 0.5rem;
            }
        }

        /* Alerta de desconexión persistente */
        .offline-alert {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            background: linear-gradient(135deg, #dc3545 0%, #c82333 100%);
            color: white;
            padding: 15px 20px;
            box-shadow: 0 4px 15px rgba(220, 53, 69, 0.4);
            z-index: 9998;
            border-bottom: 3px solid #a71e2a;
            animation: slideDownAlert 0.5s ease-out;
        }

        @keyframes slideDownAlert {
            from {
                transform: translateY(-100%);
                opacity: 0;
            }

            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .offline-content {
            max-width: 1200px;
            margin: 0 auto;
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .offline-icon {
            font-size: 2rem;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {

            0%,
            100% {
                transform: scale(1);
            }

            50% {
                transform: scale(1.1);
            }
        }

        .offline-message {
            flex: 1;
        }

        .offline-title {
            font-size: 1.1rem;
            font-weight: bold;
            margin-bottom: 5px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .offline-text {
            font-size: 0.9rem;
            opacity: 0.95;
            line-height: 1.4;
        }

        .offline-actions {
            display: flex;
            gap: 10px;
        }

        .btn-reconnect {
            background: rgba(255, 255, 255, 0.2);
            color: white;
            border: 2px solid rgba(255, 255, 255, 0.3);
            padding: 8px 15px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.85rem;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .btn-reconnect:hover {
            background: rgba(255, 255, 255, 0.3);
            border-color: rgba(255, 255, 255, 0.5);
            transform: translateY(-1px);
        }

        .btn-offline-close {
            background: transparent;
            color: white;
            border: 2px solid rgba(255, 255, 255, 0.3);
            padding: 8px 12px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.85rem;
            transition: all 0.3s ease;
        }

        .btn-offline-close:hover {
            background: rgba(255, 255, 255, 0.1);
            border-color: rgba(255, 255, 255, 0.5);
        }

        /* Alerta minimizada */
        .offline-minimized {
            position: fixed;
            top: 20px;
            right: 20px;
            background: #dc3545;
            color: white;
            padding: 10px 15px;
            border-radius: 25px;
            cursor: pointer;
            z-index: 9999;
            box-shadow: 0 4px 15px rgba(220, 53, 69, 0.4);
            transition: all 0.3s ease;
            font-size: 0.85rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .offline-minimized:hover {
            transform: scale(1.05);
            box-shadow: 0 6px 20px rgba(220, 53, 69, 0.5);
        }

        .offline-min-icon {
            animation: pulse 2s infinite;
        }

        /* Ajustar el header cuando hay alerta */
        .body-with-offline-alert .header {
            margin-top: 80px;
        }

        .body-with-offline-alert .login-container {
            padding-top: 100px;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .offline-alert {
                padding: 12px 15px;
            }

            .offline-content {
                flex-direction: column;
                text-align: center;
                gap: 10px;
            }

            .offline-actions {
                justify-content: center;
                width: 100%;
            }

            .offline-title {
                font-size: 1rem;
            }

            .offline-text {
                font-size: 0.8rem;
            }

            .offline-minimized {
                top: 10px;
                right: 10px;
                padding: 8px 12px;
            }
        }

        .table-header {
            background: var(--gray-50);
            padding: 1.5rem;
            border-bottom: 1px solid var(--gray-200);
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 1rem;
        }

        .table-header-left {
            flex: 1;
            min-width: 250px;
        }

        .table-header-right {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .inventory-info {
            font-size: 0.875rem;
            color: var(--gray-600);
            font-weight: 500;
        }

        .pagination-container {
            background: var(--gray-50);
            padding: 1rem 1.5rem;
            border-top: 1px solid var(--gray-200);
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 1rem;
        }

        .pagination-info {
            display: flex;
            align-items: center;
            gap: 1rem;
            font-size: 0.875rem;
            color: var(--gray-700);
        }

        .pagination-info select {
            padding: 4px 8px;
            border: 1px solid var(--gray-300);
            border-radius: 4px;
            font-size: 0.875rem;
            background: white;
        }

        .pagination-controls {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .pagination-btn {
            background: white;
            border: 1px solid var(--gray-300);
            color: var(--gray-700);
            padding: 8px 12px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.875rem;
            transition: all 0.3s ease;
            min-width: 40px;
            height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .pagination-btn:hover:not(:disabled) {
            background: var(--gray-100);
            border-color: var(--gray-400);
        }

        .pagination-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .pagination-btn.active {
            background: var(--primary);
            border-color: var(--primary);
            color: white;
        }

        .pagination-numbers {
            display: flex;
            align-items: center;
            gap: 0.25rem;
        }

        .pagination-ellipsis {
            padding: 8px 4px;
            color: var(--gray-500);
            font-size: 0.875rem;
        }

        .pagination-jump {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.875rem;
            color: var(--gray-700);
        }

        .pagination-jump input {
            text-align: center;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .table-header {
                flex-direction: column;
                align-items: stretch;
            }

            .pagination-container {
                flex-direction: column;
                gap: 0.75rem;
            }

            .pagination-controls {
                justify-content: center;
                flex-wrap: wrap;
            }

            .pagination-jump {
                justify-content: center;
            }

            .pagination-info {
                justify-content: center;
            }
        }
    </style>
</head>

<body>
    <!-- Loading Overlay -->
    <div id="loadingOverlay" class="loading-overlay">
        <div style="text-align: center">
            <div class="loading-text">Conectando con la base de datos...</div>
        </div>
    </div>

    <div id="offlineAlert" class="offline-alert hidden">
        <div class="offline-content">
            <div class="offline-icon">⚠️</div>
            <div class="offline-message">
                <div class="offline-title">¡SIN CONEXIÓN A LA BASE DE DATOS!</div>
                <div class="offline-text">
                    Todo lo que hagas <strong>NO se guardará</strong>.
                    Al recargar la página <strong>perderás tu progreso</strong>.
                </div>
            </div>
            <div class="offline-actions">
                <button class="btn-reconnect" onclick="attemptReconnection()">🔄 Reintentar</button>
                <button class="btn-offline-close" onclick="minimizeOfflineAlert()">➖ Minimizar</button>
            </div>
        </div>
    </div>

    <!-- Alerta minimizada -->
    <div id="offlineMinimized" class="offline-minimized hidden" onclick="expandOfflineAlert()">
        <span class="offline-min-icon">⚠️</span>
        <span class="offline-min-text">SIN CONEXIÓN</span>
    </div>

    <!-- Email Status -->
    <div id="emailStatus" class="email-status email-ready hidden">
        📧 EmailJS Listo
    </div>

    <!-- Connection Status -->
    <div id="connectionStatus" class="connection-status connection-offline">
        🔴 Sin conexión
    </div>

    <!-- Login Screen -->
    <div id="loginScreen" class="login-container">
        <div class="login-card">
            <div class="login-header">
                <div class="logo"></div>
                <h1 class="login-title">Sistema de Inventario</h1>
                <p class="login-subtitle">Liceo Ríos de Chile - Lirquén</p>
            </div>

            <div class="user-type-grid">
                <div class="user-type-card" onclick="selectUserType('admin')" id="admin-card">
                    <span class="user-type-icon">👨‍💼</span>
                    <div class="user-type-title">Administrador</div>
                    <div class="user-type-desc">Acceso completo</div>
                </div>
                <div class="user-type-card" onclick="selectUserType('operator')" id="operator-card">
                    <span class="user-type-icon">👨‍🔧</span>
                    <div class="user-type-title">Operador</div>
                    <div class="user-type-desc">Acceso limitado</div>
                </div>
                <div class="user-type-card full-width" onclick="selectUserType('visitor')" id="visitor-card">
                    <span class="user-type-icon">👥</span>
                    <div class="user-type-title">Visitante</div>
                    <div class="user-type-desc">Solo consulta</div>
                </div>
            </div>

            <div id="credentialsForm" class="hidden">
                <div class="form-group">
                    <label class="form-label">📧 Correo Electrónico</label>
                    <input type="email" class="form-input" id="email" placeholder="usuario@liceoriosdechile.cl" />
                </div>
                <div class="form-group">
                    <label class="form-label">🔑 Contraseña</label>
                    <input type="password" class="form-input" id="password" placeholder="Ingresa tu contraseña" />
                </div>
            </div>

            <button class="btn btn-primary" onclick="login()">
                🚀 Ingresar al Sistema
            </button>
        </div>
    </div>

    <!-- Dashboard -->
    <div id="dashboardScreen" class="dashboard">
        <div class="header">
            <div class="header-content">
                <div class="header-left">
                    <div class="header-logo"></div>
                    <div class="header-info">
                        <h1>Bienvenido, <span id="welcomeUser">Usuario</span></h1>
                        <div class="header-subtitle">Sesión iniciada correctamente</div>
                    </div>
                </div>
                <div class="user-info">
                    <!-- Campanita de notificaciones - Solo para admin -->
                    <div id="notificationBell" class="notification-bell hidden" onclick="toggleNotifications()">
                        <span class="bell-icon">🔔</span>
                        <span id="notificationCount" class="notification-count">0</span>
                    </div>
                    <span id="currentRole" class="user-badge">Rol</span>
                    <button class="logout-btn" onclick="logout()">Cerrar Sesión</button>
                </div>
            </div>
        </div>

        <!-- Notification Dropdown -->
        <div id="notificationDropdown" class="notification-dropdown">
            <div class="notification-header">
                <h4>🔔 Notificaciones</h4>
                <button class="clear-notifications" onclick="clearAllNotifications()">Limpiar</button>
            </div>
            <div class="notification-list" id="notificationList">
                <div class="no-notifications">
                    <div class="no-notifications-icon">🔕</div>
                    <div>No hay notificaciones</div>
                </div>
            </div>
        </div>

        <div class="container">
            <nav class="navigation">
                <div class="nav-item active" onclick="showTab('dashboard')" id="tab-dashboard">
                    📊 Dashboard
                </div>
                <div class="nav-item" onclick="showTab('inventory')" id="tab-inventory">
                    📦 Inventario
                </div>
                <div class="nav-item" onclick="showTab('management')" id="tab-management">
                    ⚙️ Gestión
                </div>
                <div class="nav-item" onclick="showTab('statistics')" id="tab-statistics">
                    📈 Estadísticas
                </div>
                <div class="nav-item" onclick="showTab('history')" id="tab-history">
                    📋 Historial
                </div>
                <div class="nav-item" onclick="showTab('loans')" id="tab-loans">
                    🤝 Préstamos Activos
                </div>
            </nav>

            <div class="content-card">
                <!-- Dashboard Tab -->
                <div id="content-dashboard" class="tab-content">
                    <!-- Welcome Banner -->
                    <div class="welcome-banner">
                        <div class="welcome-content">
                            <h1 class="welcome-title">¡Bienvenido al Sistema!</h1>
                            <p class="welcome-subtitle">
                                Gestiona el inventario del Liceo Ríos de Chile de manera
                                eficiente
                            </p>
                        </div>
                    </div>

                    <!-- User Info Card Enhanced -->
                    <div class="user-info-card">
                        <div class="user-avatar" id="userAvatar">U</div>
                        <div class="user-details">
                            <h3 id="userTypeDisplay">USUARIO</h3>
                            <div class="user-email" id="userEmailDisplay">
                                usuario@liceo.cl
                            </div>
                            <span class="permissions-label">Permisos disponibles:</span>
                            <div class="permissions-grid" id="permissionsDisplay">
                                <!-- Permisos se llenan dinámicamente -->
                            </div>
                        </div>
                        <div class="user-actions">
                            <div class="user-status">🟢 Activo</div>
                            <div class="session-time" id="sessionTime">Sesión iniciada</div>
                        </div>
                    </div>

                    <!-- Dashboard Navigation Cards -->
                    <div class="dashboard-navigation">
                        <h2 class="nav-title">🚀 Acceso Rápido</h2>
                        <div class="dashboard-cards">
                            <div class="dashboard-card" onclick="showTab('inventory')">
                                <div class="dashboard-card-icon">📦</div>
                                <div class="dashboard-card-title">Ver Inventario</div>
                                <div class="dashboard-card-desc">
                                    Consulta todos los productos disponibles, su estado actual y
                                    ubicación en el almacén
                                </div>
                            </div>
                            <div class="dashboard-card" onclick="showTab('management')" id="managementCard">
                                <div class="dashboard-card-icon">⚙️</div>
                                <div class="dashboard-card-title">Gestión de Inventario</div>
                                <div class="dashboard-card-desc">
                                    Administra productos: ingresar, prestar, devolver y dar de
                                    baja elementos del sistema
                                </div>
                            </div>
                            <div class="dashboard-card" onclick="showTab('statistics')" id="statisticsCard">
                                <div class="dashboard-card-icon">📊</div>
                                <div class="dashboard-card-title">Estadísticas Avanzadas</div>
                                <div class="dashboard-card-desc">
                                    Visualiza métricas detalladas, análisis de tendencias e
                                    insights del inventario
                                </div>
                            </div>
                            <div class="dashboard-card" onclick="showTab('history')" id="historyCard">
                                <div class="dashboard-card-icon">📋</div>
                                <div class="dashboard-card-title">
                                    Historial de Operaciones
                                </div>
                                <div class="dashboard-card-desc">
                                    Revisa el registro completo de todas las actividades y
                                    movimientos realizados
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Export Section for Admin -->
                    <div id="adminExportSection" class="export-section hidden">
                        <button class="btn btn-success" onclick="exportData('excel')">
                            📄 Exportar Excel
                        </button>
                        <button class="btn btn-danger" onclick="exportData('pdf')">
                            📑 Exportar PDF
                        </button>
                    </div>

                    <!-- Quick Stats -->
                    <div class="quick-stats-section">
                        <h2 class="section-title">📈 Resumen General</h2>
                        <div class="stats-grid">
                            <div class="stat-card">
                                <div class="stat-icon">📦</div>
                                <div class="stat-value" id="totalProducts">0</div>
                                <div class="stat-label">Total Productos</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-icon">📊</div>
                                <div class="stat-value" id="totalStock">0</div>
                                <div class="stat-label">Stock Total</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-icon">🤝</div>
                                <div class="stat-value" id="activeLends">0</div>
                                <div class="stat-label">Préstamos Activos</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Inventory Tab -->
                <div id="content-inventory" class="tab-content hidden">
                    <h2 class="content-title">📦 Inventario General</h2>
                    <p style="margin: 0 0 1.5rem 0; opacity: 0.9; font-size: 0.95rem;">
                        Como visitante, puedes enviar una solicitud para productos disponibles en nuestro inventario
                    </p>
                    <button class="btn btn-primary" onclick="openRequestModal()"
                        style="width: auto; padding: 0.8rem 1.5rem;">
                        📝 Solicitar Producto
                    </button>

                    <div class="table-container">
                        <div class="table-header">
                            <div class="table-header-left">
                                <input type="text" class="search-input" id="searchInventory"
                                    placeholder="🔍 Buscar productos, códigos, categorías..."
                                    onkeyup="filterInventory()" />
                            </div>
                            <div class="table-header-right">
                                <div class="inventory-info">
                                    <span id="inventoryCount">Mostrando 0 productos</span>
                                </div>
                            </div>
                        </div>

                        <table>
                            <thead>
                                <tr>
                                    <th>🏷️ Código</th>
                                    <th>📝 Nombre</th>
                                    <th>📂 Categoría</th>
                                    <th>🔄 Estado</th>
                                    <th>📊 Cantidad</th>
                                    <th>📍 Ubicación</th>
                                </tr>
                            </thead>
                            <tbody id="inventoryBody"></tbody>
                        </table>

                        <!-- Controles de paginación -->
                        <div class="pagination-container" id="paginationContainer">
                            <div class="pagination-info">
                                <span id="paginationInfo">Página 1 de 1</span>
                                <select id="itemsPerPage" onchange="changeItemsPerPage()">
                                    <option value="20">20 por página</option>
                                    <option value="40" selected>40 por página</option>
                                    <option value="60">60 por página</option>
                                    <option value="100">100 por página</option>
                                </select>
                            </div>

                            <div class="pagination-controls">
                                <button class="pagination-btn" id="firstPageBtn" onclick="goToPage(1)"
                                    title="Primera página">
                                    ⏮️
                                </button>
                                <button class="pagination-btn" id="prevPageBtn" onclick="goToPreviousPage()"
                                    title="Página anterior">
                                    ⬅️
                                </button>

                                <div class="pagination-numbers" id="paginationNumbers">
                                    <!-- Los números se generan dinámicamente -->
                                </div>

                                <button class="pagination-btn" id="nextPageBtn" onclick="goToNextPage()"
                                    title="Página siguiente">
                                    ➡️
                                </button>
                                <button class="pagination-btn" id="lastPageBtn" onclick="goToLastPage()"
                                    title="Última página">
                                    ⏭️
                                </button>
                            </div>

                            <div class="pagination-jump">
                                <span>Ir a página:</span>
                                <input type="number" id="jumpToPage" min="1" onkeypress="jumpToPageOnEnter(event)"
                                    style="width: 60px; padding: 4px; border: 1px solid var(--gray-300); border-radius: 4px;">
                                <button class="pagination-btn" onclick="jumpToSpecificPage()">Ir</button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Management Tab -->
                <div id="content-management" class="tab-content hidden">
                    <div class="management-header">
                        <h2 class="management-title">
                            ⚙️ Centro de Gestión de Inventario
                        </h2>
                        <p class="management-subtitle">
                            Administra todos los aspectos del inventario desde un solo
                            lugar. Realiza operaciones de manera segura y eficiente.
                        </p>
                    </div>

                    <!-- Quick Info Cards -->
                    <div class="management-info">
                        <div class="info-card">
                            <span class="info-number" id="mgmtTotalProducts">0</span>
                            <div class="info-label">Productos Registrados</div>
                        </div>
                        <div class="info-card">
                            <span class="info-number" id="mgmtAvailableProducts">0</span>
                            <div class="info-label">Disponibles</div>
                        </div>
                        <div class="info-card">
                            <span class="info-number" id="mgmtActiveLoans">0</span>
                            <div class="info-label">Préstamos Activos</div>
                        </div>
                        <div class="info-card">
                            <span class="info-number" id="mgmtMaintenanceProducts">0</span>
                            <div class="info-label">En Mantenimiento</div>
                        </div>
                    </div>

                    <div class="action-grid">
                        <div class="action-card primary" onclick="openModal('addProduct')">
                            <div class="action-icon">➕</div>
                            <div class="action-title">Ingresar Producto Nuevo</div>
                            <div class="action-desc">
                                Agrega nuevos productos al sistema con toda su información
                                detallada
                            </div>
                            <ul class="action-features">
                                <li>Registro completo</li>
                                <li>Categorización automática</li>
                                <li>Asignación de ubicación</li>
                            </ul>
                        </div>

                        <div class="action-card" onclick="openModal('updateStock')">
                            <div class="action-icon">📈</div>
                            <div class="action-title">Aumentar Stock</div>
                            <div class="action-desc">
                                Incrementa la cantidad de productos existentes cuando recibas
                                nuevas unidades
                            </div>
                            <ul class="action-features">
                                <li>Verificación automática</li>
                                <li>Actualización en tiempo real</li>
                                <li>Historial de cambios</li>
                            </ul>
                        </div>

                        <div class="action-card" onclick="openModal('lendProduct')">
                            <div class="action-icon">🤝</div>
                            <div class="action-title">Registrar Préstamo</div>
                            <div class="action-desc">
                                Gestiona préstamos de productos a estudiantes, profesores o
                                personal del liceo
                            </div>
                            <ul class="action-features">
                                <li>Control de fechas</li>
                                <li>Datos del solicitante</li>
                                <li>Envío automático de correo</li>
                            </ul>
                        </div>

                        <div class="action-card" onclick="openModal('returnProduct')">
                            <div class="action-icon">↩️</div>
                            <div class="action-title">Procesar Devolución</div>
                            <div class="action-desc">
                                Registra la devolución de productos prestados y actualiza su
                                estado
                            </div>
                            <ul class="action-features">
                                <li>Verificación de estado</li>
                                <li>Observaciones detalladas</li>
                                <li>Reintegro automático</li>
                            </ul>
                        </div>

                        <div class="action-card warning" onclick="openModal('removeProduct')">
                            <div class="action-icon">⚠️</div>
                            <div class="action-title">Dar de Baja</div>
                            <div class="action-desc">
                                Retira productos del inventario por daño, pérdida u
                                obsolescencia
                            </div>
                            <ul class="action-features">
                                <li>Motivo obligatorio</li>
                                <li>Reducción de stock</li>
                                <li>Trazabilidad completa</li>
                            </ul>
                        </div>

                        <div class="action-card danger" onclick="openModal('deleteProduct')">
                            <div class="action-icon">🗑️</div>
                            <div class="action-title">Eliminar Producto Completo</div>
                            <div class="action-desc">
                                Elimina completamente un producto del sistema de inventario
                            </div>
                            <ul class="action-features">
                                <li>Eliminación total</li>
                                <li>Confirmación requerida</li>
                                <li>Acción irreversible</li>
                            </ul>
                        </div>
                    </div>

                    <div class="operation-result-container">
                        <div id="operationResult"></div>
                    </div>
                </div>

                <!-- Statistics Tab -->
                <div id="content-statistics" class="tab-content hidden">
                    <div class="stats-header">
                        <h2>📊 Análisis del Sistema</h2>
                        <p>
                            Dashboard completo de estadísticas y métricas del inventario
                        </p>
                    </div>

                    <div class="stats-overview">
                        <div class="overview-card">
                            <div class="overview-icon">🎯</div>
                            <div class="overview-number" id="uniqueProducts">0</div>
                            <div class="overview-label">Productos Únicos</div>
                        </div>
                        <div class="overview-card">
                            <div class="overview-icon">📦</div>
                            <div class="overview-number" id="totalStockStats">0</div>
                            <div class="overview-label">Stock Total</div>
                        </div>
                        <div class="overview-card">
                            <div class="overview-icon">💰</div>
                            <div class="overview-number" id="totalValue">$0</div>
                            <div class="overview-label">Valor Estimado</div>
                        </div>
                        <div class="overview-card">
                            <div class="overview-icon">🔄</div>
                            <div class="overview-number" id="activeLoansStats">0</div>
                            <div class="overview-label">Préstamos Activos</div>
                        </div>
                    </div>

                    <div class="charts-grid">
                        <div class="chart-card">
                            <div class="chart-title">📈 Estado de Productos</div>
                            <div class="status-chart">
                                <div class="status-item">
                                    <div class="status-info">
                                        <div class="status-dot status-available"></div>
                                        <span>Disponibles</span>
                                    </div>
                                    <div class="status-count" id="availableProducts">0</div>
                                </div>
                                <div class="status-item">
                                    <div class="status-info">
                                        <div class="status-dot status-in-use"></div>
                                        <span>En Uso</span>
                                    </div>
                                    <div class="status-count" id="inUseProducts">0</div>
                                </div>
                                <div class="status-item">
                                    <div class="status-info">
                                        <div class="status-dot status-maintenance"></div>
                                        <span>Mantenimiento</span>
                                    </div>
                                    <div class="status-count" id="maintenanceProducts">0</div>
                                </div>
                                <div class="status-item">
                                    <div class="status-info">
                                        <div class="status-dot status-unavailable"></div>
                                        <span>No Disponibles</span>
                                    </div>
                                    <div class="status-count" id="unavailableProducts">0</div>
                                </div>
                            </div>
                        </div>

                        <div class="chart-card">
                            <div class="chart-title">📊 Distribución por Categorías</div>
                            <div class="category-chart" id="categoryChart">
                                <!-- Las barras de categorías se llenan dinámicamente -->
                            </div>
                        </div>
                    </div>

                    <div class="insights-section">
                        <div class="insights-title">💡 Insights y Recomendaciones</div>
                        <div id="insightsContainer">
                            <!-- Los insights se generan dinámicamente -->
                        </div>
                    </div>
                </div>

                <!-- History Tab -->
                <div id="content-history" class="tab-content hidden">
                    <div
                        style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">
                        <h2 class="content-title">📋 Historial de Operaciones</h2>
                        <button id="deleteHistoryBtn" class="btn btn-danger hidden" onclick="requestDeleteHistory()"
                            style="margin: 0;">
                            🗑️ Eliminar Historial Completo
                        </button>
                    </div>

                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th>📅 Fecha</th>
                                    <th>👤 Usuario</th>
                                    <th>🔄 Operación</th>
                                    <th>📦 Producto</th>
                                    <th>📝 Detalles</th>
                                </tr>
                            </thead>
                            <tbody id="historyBody"></tbody>
                        </table>
                    </div>
                </div>

                <!-- Active Loans Tab -->
                <div id="content-loans" class="tab-content hidden">
                    <div
                        style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem; flex-wrap: wrap; gap: 1rem;">
                        <h2 class="content-title">🤝 Préstamos Activos</h2>
                        <div class="bulk-reminder-buttons">
                            <button class="btn btn-warning bulk-reminder-btn" onclick="sendBulkReminders('upcoming')">
                                ⏰ Recordatorios Por Vencer
                            </button>
                            <button class="btn btn-danger bulk-reminder-btn" onclick="sendBulkReminders('overdue')">
                                🚨 Recordatorios Vencidos
                            </button>
                        </div>
                    </div>

                    <!-- Summary Cards -->
                    <div class="loans-summary-cards">
                        <div class="loans-summary-card">
                            <span class="loans-summary-number loans-summary-total" id="totalActiveLoans">0</span>
                            <div class="loans-summary-label">Total Activos</div>
                        </div>
                        <div class="loans-summary-card">
                            <span class="loans-summary-number loans-summary-upcoming" id="upcomingDueLoans">0</span>
                            <div class="loans-summary-label">Por Vencer (3 días)</div>
                        </div>
                        <div class="loans-summary-card">
                            <span class="loans-summary-number loans-summary-overdue" id="overdueLoans">0</span>
                            <div class="loans-summary-label">Vencidos</div>
                        </div>
                        <div class="loans-summary-card">
                            <span class="loans-summary-number loans-summary-ontime" id="onTimeLoans">0</span>
                            <div class="loans-summary-label">A Tiempo</div>
                        </div>
                    </div>

                    <div class="table-container">
                        <div class="table-header">
                            <input type="text" class="search-input" id="searchLoans"
                                placeholder="🔍 Buscar préstamos por solicitante, producto, código..."
                                onkeyup="filterActiveLoans()" />
                        </div>
                        <table>
                            <thead>
                                <tr>
                                    <th style="width: 20%;">📦 Producto</th>
                                    <th style="width: 15%;">👤 Solicitante</th>
                                    <th style="width: 18%;">📧 Correo Electrónico</th>
                                    <th style="width: 8%;">📊 Cant.</th>
                                    <th style="width: 12%;">📅 F. Préstamo</th>
                                    <th style="width: 12%;">📅 F. Devolución</th>
                                    <th style="width: 15%;">⏰ Estado Actual</th>
                                </tr>
                            </thead>
                            <tbody id="activeLoansBody"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal -->
    <div id="operationModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title" id="modalTitle">Operación</h3>
                <button class="close-btn" onclick="closeModal()">&times;</button>
            </div>
            <div id="modalContent"></div>
        </div>
    </div>

    <!-- Modal de Solicitud de Producto -->
    <div id="requestModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">📝 Solicitar Productos</h3>
                <button class="close-btn" onclick="confirmCloseRequestModal()">&times;</button>
            </div>
            <div id="requestModalContent">
                <div class="alert alert-info">
                    <span>ℹ️</span>
                    <div>
                        <strong>Importante:</strong> Tu solicitud será revisada por un administrador.
                        Recibirás una respuesta por correo electrónico. <strong>Mínimo 48 horas de aviso.</strong>
                    </div>
                </div>

                <form id="requestForm" onsubmit="submitMultipleProductRequest(event)">
                    <!-- Datos del Solicitante -->
                    <h4
                        style="margin: 1.5rem 0 1rem 0; color: var(--primary); border-bottom: 2px solid var(--primary); padding-bottom: 0.5rem;">
                        👤 Datos del Solicitante
                    </h4>

                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">👤 Nombre Completo *</label>
                            <input type="text" class="form-input" id="requesterName" placeholder="Juan Pérez García"
                                required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">🆔 RUT *</label>
                            <input type="text" class="form-input" id="requesterRut" placeholder="12.345.678-9" required>
                        </div>
                    </div>

                    <div class="form-group">
                        <label class="form-label">📧 Correo Electrónico *</label>
                        <input type="email" class="form-input" id="requesterEmail" placeholder="juan.perez@email.com"
                            required>
                    </div>

                    <!-- Fechas -->
                    <h4
                        style="margin: 1.5rem 0 1rem 0; color: var(--primary); border-bottom: 2px solid var(--primary); padding-bottom: 0.5rem;">
                        📅 Fechas del Préstamo
                    </h4>

                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">📅 Fecha Necesaria (Mínimo 48h de aviso) *</label>
                            <input type="date" class="form-input" id="requestedDate" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">📅 Fecha de Devolución *</label>
                            <input type="date" class="form-input" id="returnDate" required>
                        </div>
                    </div>

                    <!-- Productos -->
                    <h4
                        style="margin: 1.5rem 0 1rem 0; color: var(--primary); border-bottom: 2px solid var(--primary); padding-bottom: 0.5rem;">
                        📦 Productos Solicitados
                    </h4>

                    <!-- Agregar Producto -->
                    <div style="background: var(--gray-50); padding: 1.5rem; border-radius: 1rem; margin-bottom: 1rem;">
                        <div class="form-row">
                            <div class="form-group">
                                <label class="form-label">📦 Producto (Nombre o Código)</label>
                                <input type="text" class="form-input" id="newProductInput"
                                    placeholder="Ej: Calculadora Científica o 001-CAL-001" onblur="verifyNewProduct()">
                                <div id="newProductVerification" class="hidden"></div>
                            </div>
                            <div class="form-group">
                                <label class="form-label">📊 Cantidad (máx. 40)</label>
                                <input type="number" class="form-input" id="newQuantityInput" min="1" max="40"
                                    placeholder="1">
                            </div>
                        </div>
                        <button type="button" class="btn btn-primary" onclick="addProductToList()"
                            style="width: 100%; margin-top: 1rem;">
                            ➕ Agregar Producto a la Solicitud
                        </button>
                    </div>

                    <!-- Lista de Productos -->
                    <div id="productsList" class="hidden" style="margin-bottom: 1.5rem;">
                        <h5 style="color: var(--gray-700); margin-bottom: 1rem;">📋 Productos en tu solicitud:</h5>
                        <div id="productsListContainer" style="max-height: 300px; overflow-y: auto;"></div>
                        <div
                            style="background: var(--primary); color: white; padding: 1rem; border-radius: 0.5rem; margin-top: 1rem; text-align: center;">
                            <strong>Total de productos: <span id="totalProducts">0</span></strong>
                        </div>
                    </div>

                    <!-- Motivo -->
                    <div class="form-group">
                        <label class="form-label">📝 Motivo/Uso (Opcional)</label>
                        <textarea class="form-input" id="requestReason" rows="3"
                            placeholder="Describe brevemente para qué necesitas los productos..."></textarea>
                    </div>

                    <button type="submit" class="btn btn-primary" id="submitRequestBtn" disabled>
                        📤 Enviar Solicitud Completa
                    </button>
                </form>
            </div>
        </div>
    </div>

    <!-- Info Modal -->
    <div id="infoModal" class="info-modal">
        <div class="info-modal-content">
            <div class="info-modal-header">
                <h3 class="info-modal-title" id="infoModalTitle">Información</h3>
                <button class="info-modal-close" onclick="closeInfoModal()">
                    &times;
                </button>
            </div>
            <div class="info-modal-body" id="infoModalBody">
                <!-- Content will be populated dynamically -->
            </div>
        </div>
    </div>

    <!-- Firebase Scripts -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

    <!-- EmailJS Scripts -->
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>

    <script>
        // CONFIGURACIÓN DE FIREBASE
        // ⚠️ IMPORTANTE: Debes reemplazar esta configuración con la tuya
        const firebaseConfig = {
            apiKey: "AIzaSyAkAEVAXWOraWw5vR8bHu-A4wZ7u8LdaWc",
            authDomain: "inventario-liceo-rios-chile.firebaseapp.com",
            projectId: "inventario-liceo-rios-chile",
            storageBucket: "inventario-liceo-rios-chile.firebasestorage.app",
            messagingSenderId: "922200736252",
            appId: "1:922200736252:web:696a087534a6a429127279",
            measurementId: "G-RDWSD93J0E",
        };

        // CONFIGURACIÓN DE EMAILJS
        // ⚠️ IMPORTANTE: Debes reemplazar estos valores con los tuyos de EmailJS
        const emailjsConfig = {
            publicKey: "0PJJEx0CPSrz56KPR", // Reemplaza con tu public key
            serviceId: "service_tobcijr", // Reemplaza con tu service ID  
            templateId: "template_56uy9yy", // Reemplaza con tu template ID
            approvalTemplateId: "template_e9qjbvh"
        };

        // Variables globales para EmailJS
        let isEmailJSReady = false;

        // Inicializar Firebase
        let db = null;
        let isFirebaseReady = false;

        try {
            firebase.initializeApp(firebaseConfig);
            db = firebase.firestore();

            // Probar conexión inicial
            db.collection("products").limit(1).get().then(() => {
                isFirebaseReady = true;
                console.log("✅ Firebase conectado correctamente");
                updateConnectionStatus("online");
            }).catch((error) => {
                console.error("❌ Error inicial de Firebase:", error);
                isFirebaseReady = false;
                updateConnectionStatus("offline");
            });

        } catch (error) {
            console.error("❌ Error configurando Firebase:", error);
            isFirebaseReady = false;
            updateConnectionStatus("offline");
        }

        // Monitorear estado de conexión
        if (typeof window !== 'undefined') {
            window.addEventListener('online', () => {
                console.log('🌐 Conexión a internet restaurada');
                if (isFirebaseReady) {
                    attemptReconnection();
                }
            });

            window.addEventListener('offline', () => {
                console.log('🌐 Conexión a internet perdida');
                updateConnectionStatus("offline");
            });
        }

        // Inicializar EmailJS
        function initializeEmailJS() {
            try {
                // Inicializar EmailJS con tu public key
                emailjs.init(emailjsConfig.publicKey);
                isEmailJSReady = true;
                updateEmailStatus("ready");
                console.log("✅ EmailJS inicializado correctamente");
            } catch (error) {
                console.error("❌ Error inicializando EmailJS:", error);
                updateEmailStatus("error");
                isEmailJSReady = false;
            }
        }

        // Función para enviar correo de préstamo
        async function sendLoanEmail(loanData) {
            if (!isEmailJSReady) {
                console.warn("⚠️ EmailJS no está disponible");
                return false;
            }

            updateEmailStatus("sending");

            const templateParams = {
                to_name: loanData.borrower,
                to_email: loanData.borrowerEmail,
                product_name: loanData.productName,
                product_code: loanData.productCode,
                quantity: loanData.quantity,
                loan_date: loanData.loanDate,
                return_date: loanData.returnDate,
                borrower_name: loanData.borrower,
                borrower_rut: loanData.borrowerRut,
                liceo_name: "Liceo Ríos de Chile - Lirquén",
                contact_email: "victor.mulchi@liceoriosdechile.cl",
                system_name: "Sistema de Inventario"
            };

            try {
                const response = await emailjs.send(
                    emailjsConfig.serviceId,
                    emailjsConfig.loanTemplateId,  // ← CAMBIO AQUÍ
                    templateParams
                );

                console.log('✅ Correo enviado exitosamente:', response.status, response.text);
                updateEmailStatus("ready");
                return true;

            } catch (error) {
                console.error('❌ Error enviando correo:', error);
                updateEmailStatus("error");

                // Mostrar error específico pero no bloquear la operación
                setTimeout(() => {
                    alert(`⚠️ El préstamo se registró correctamente, pero hubo un problema enviando el correo:\n${error.text || error.message || 'Error desconocido'}`);
                }, 500);

                return false;
            }
        }

        // Función para enviar correo de aprobación
        async function sendApprovalEmail(approvalData) {
            if (!isEmailJSReady) {
                console.warn("⚠️ EmailJS no está disponible");
                return false;
            }

            updateEmailStatus("sending");

            const templateParams = {
                requester_name: approvalData.requesterName,
                requester_rut: approvalData.requesterRut,
                requester_email: approvalData.requesterEmail,
                product_name: approvalData.productName,
                assigned_codes: approvalData.assignedCodes || approvalData.productCode || 'Código asignado automáticamente',
                approved_quantity: approvalData.approvedQuantity || approvalData.quantity,
                loan_date: approvalData.loanDate,
                return_date: approvalData.returnDate,
                approved_by: approvalData.approvedBy
            };

            try {
                const response = await emailjs.send(
                    emailjsConfig.serviceId,
                    emailjsConfig.approvalTemplateId,
                    templateParams
                );

                console.log('✅ Correo de aprobación enviado:', response.status);
                updateEmailStatus("ready");
                return true;

            } catch (error) {
                console.error('❌ Error enviando correo de aprobación:', error);
                updateEmailStatus("error");

                // Mostrar error pero no bloquear la operación
                setTimeout(() => {
                    alert(`⚠️ La aprobación se procesó correctamente, pero hubo un problema enviando el correo:\n${error.text || error.message || 'Error desconocido'}`);
                }, 500);

                return false;
            }
        }

        // Actualizar estado del email
        function updateEmailStatus(status) {
            const statusEl = document.getElementById("emailStatus");
            statusEl.className = `email-status email-${status}`;

            switch (status) {
                case "ready":
                    statusEl.innerHTML = "📧 EmailJS Listo";
                    statusEl.classList.remove("hidden");
                    break;
                case "sending":
                    statusEl.innerHTML = "📤 Enviando correo...";
                    statusEl.classList.remove("hidden");
                    break;
                case "error":
                    statusEl.innerHTML = "❌ Email sin servicio";
                    statusEl.classList.remove("hidden");
                    setTimeout(() => {
                        statusEl.classList.add("hidden");
                    }, 5000);
                    break;
            }
        }

        // Global variables
        let currentUser = null;
        let currentRole = null;
        let selectedUserType = null;
        let products = [];
        let loans = [];
        let history = [];
        let productRequests = [];
        let unsubscribeProducts = null;
        let unsubscribeLoans = null;
        let unsubscribeHistory = null;
        let currentPage = 1;
        let itemsPerPage = 40;
        let filteredProducts = []; // Productos después del filtro de búsqueda
        let totalPages = 1;

        // User credentials
        const users = {
            admin: {
                email: "victor.mulchi@liceoriosdechile.cl",
                password: "AdminLiceo2025!",
            },
            operator: { email: "operador.la@gmail.com", password: "Admi2025" },
        };

        // Connection status
        function updateConnectionStatus(status) {
            const statusEl = document.getElementById("connectionStatus");
            const offlineAlert = document.getElementById("offlineAlert");
            const offlineMinimized = document.getElementById("offlineMinimized");

            statusEl.className = `connection-status connection-${status}`;

            switch (status) {
                case "online":
                    statusEl.innerHTML = "🟢 Conectado";
                    // Ocultar alertas de desconexión
                    offlineAlert.classList.add("hidden");
                    offlineMinimized.classList.add("hidden");
                    document.body.classList.remove("body-with-offline-alert");
                    break;
                case "offline":
                    statusEl.innerHTML = "🔴 Sin conexión";
                    // Mostrar alerta de desconexión
                    showOfflineAlert();
                    break;
                case "syncing":
                    statusEl.innerHTML = "🟡 Sincronizando";
                    break;
            }
        }

        // Mostrar alerta de desconexión
        function showOfflineAlert() {
            const offlineAlert = document.getElementById("offlineAlert");
            const offlineMinimized = document.getElementById("offlineMinimized");

            offlineAlert.classList.remove("hidden");
            offlineMinimized.classList.add("hidden");
            document.body.classList.add("body-with-offline-alert");
        }

        // Minimizar alerta de desconexión
        function minimizeOfflineAlert() {
            const offlineAlert = document.getElementById("offlineAlert");
            const offlineMinimized = document.getElementById("offlineMinimized");

            offlineAlert.classList.add("hidden");
            offlineMinimized.classList.remove("hidden");
            document.body.classList.remove("body-with-offline-alert");
        }

        // Expandir alerta de desconexión
        function expandOfflineAlert() {
            showOfflineAlert();
        }

        // Intentar reconexión
        async function attemptReconnection() {
            const reconnectBtn = document.querySelector('.btn-reconnect');
            reconnectBtn.innerHTML = '🔄 Reconectando...';
            reconnectBtn.disabled = true;

            try {
                updateConnectionStatus("syncing");

                // Intentar una operación simple para probar la conexión
                if (isFirebaseReady) {
                    await db.collection("products").limit(1).get();
                    updateConnectionStatus("online");

                    // Mostrar mensaje de éxito temporal
                    reconnectBtn.innerHTML = '✅ Reconectado';
                    setTimeout(() => {
                        reconnectBtn.innerHTML = '🔄 Reintentar';
                        reconnectBtn.disabled = false;
                    }, 2000);
                } else {
                    throw new Error("Firebase no está disponible");
                }

            } catch (error) {
                console.error("Error en reconexión:", error);
                updateConnectionStatus("offline");

                reconnectBtn.innerHTML = '❌ Error';
                setTimeout(() => {
                    reconnectBtn.innerHTML = '🔄 Reintentar';
                    reconnectBtn.disabled = false;
                }, 2000);
            }
        }

        function checkConnectionBeforeOperation(operationName) {
            if (!isFirebaseReady || !navigator.onLine) {
                const confirmed = confirm(`⚠️ SIN CONEXIÓN A LA BASE DE DATOS

La operación "${operationName}" NO se guardará permanentemente.

¿Deseas continuar de todas formas?
- ✅ SÍ: La operación se hará solo localmente
- ❌ NO: Cancelar hasta tener conexión`);

                if (!confirmed) {
                    throw new Error("Operación cancelada por falta de conexión");
                }

                // Mostrar alerta si está oculta
                if (document.getElementById("offlineAlert").classList.contains("hidden")) {
                    showOfflineAlert();
                }
            }
            return true;
        }

        // Initialize Firebase listeners
        function initializeFirebaseListeners() {
            if (!isFirebaseReady) return;

            // Listener para productos
            unsubscribeProducts = db.collection("products").onSnapshot(
                (snapshot) => {
                    updateConnectionStatus("syncing");
                    products = [];
                    snapshot.forEach((doc) => {
                        products.push({ id: doc.id, ...doc.data() });
                    });
                    updateConnectionStatus("online");

                    // Actualizar UI inmediatamente
                    updateDashboard();
                    updateManagementInfo();

                    // Actualizar UI si estamos en la pestaña correcta
                    const activeTab = document
                        .querySelector(".nav-item.active")
                        ?.id.replace("tab-", "");
                    if (activeTab === "inventory" || activeTab === "dashboard") {
                        updateUI();
                    }
                },
                (error) => {
                    console.error("Error en listener de productos:", error);
                    updateConnectionStatus("offline");
                }
            );

            // Listener para préstamos
            unsubscribeLoans = db.collection("loans").onSnapshot(
                (snapshot) => {
                    loans = [];
                    snapshot.forEach((doc) => {
                        loans.push({ id: doc.id, ...doc.data() });
                    });

                    // Actualizar dashboard inmediatamente
                    updateDashboard();
                    updateManagementInfo();

                    // Actualizar UI si estamos en dashboard
                    const activeTab = document
                        .querySelector(".nav-item.active")
                        ?.id.replace("tab-", "");
                    if (activeTab === "dashboard") {
                        updateDashboard();
                    }
                },
                (error) => {
                    console.error("Error en listener de préstamos:", error);
                }
            );

            // Listener para historial
            unsubscribeHistory = db
                .collection("history")
                .orderBy("timestamp", "desc")
                .onSnapshot(
                    (snapshot) => {
                        history = [];
                        snapshot.forEach((doc) => {
                            history.push({ id: doc.id, ...doc.data() });
                        });

                        // Actualizar UI si estamos en historial
                        const activeTab = document
                            .querySelector(".nav-item.active")
                            .id.replace("tab-", "");
                        if (activeTab === "history") {
                            updateHistory();
                        }
                    },
                    (error) => {
                        console.error("Error en listener de historial:", error);
                    }
                );

            const unsubscribeRequests = db.collection("productRequests").onSnapshot(
                (snapshot) => {
                    productRequests = [];
                    snapshot.forEach((doc) => {
                        productRequests.push({ id: doc.id, ...doc.data() });
                    });

                    console.log(`📋 ${productRequests.length} solicitudes cargadas desde Firebase`);

                    // Actualizar notificaciones si es admin
                    if (currentRole === 'admin') {
                        updateNotifications();
                    }
                },
                (error) => {
                    console.error("Error en listener de solicitudes:", error);
                }
            );
        }

        // Initialize sample data (solo si Firebase no está disponible)
        async function initSampleData() {
            // Función vacía - sin productos de ejemplo
            console.log("✅ Sistema inicializado sin datos de ejemplo");
        }

        // User type selection
        function selectUserType(type) {
            selectedUserType = type;

            document.querySelectorAll(".user-type-card").forEach((card) => {
                card.classList.remove("active");
            });

            document.getElementById(`${type}-card`).classList.add("active");

            if (type === "visitor") {
                document.getElementById("credentialsForm").classList.add("hidden");
            } else {
                document.getElementById("credentialsForm").classList.remove("hidden");
            }
        }

        // Login function
        function login() {
            if (!selectedUserType) {
                alert("⚠️ Por favor selecciona un tipo de usuario");
                return;
            }

            if (selectedUserType === "visitor") {
                loginUser("Visitante", "visitor");
                return;
            }

            const email = document.getElementById("email").value;
            const password = document.getElementById("password").value;

            if (!email || !password) {
                alert("⚠️ Por favor completa todos los campos");
                return;
            }

            if (
                selectedUserType === "admin" &&
                email === users.admin.email &&
                password === users.admin.password
            ) {
                loginUser("Administrador", "admin");
            } else if (
                selectedUserType === "operator" &&
                email === users.operator.email &&
                password === users.operator.password
            ) {
                loginUser("Operador", "operator");
            } else {
                alert("❌ Credenciales incorrectas");
            }
        }

        async function loginUser(user, role) {
            currentUser = user;
            currentRole = role;

            document.getElementById("loginScreen").style.display = "none";
            document.getElementById("dashboardScreen").style.display = "block";

            // Actualizar información en el header
            document.getElementById("welcomeUser").textContent = user;
            document.getElementById("currentRole").textContent = role;

            // Actualizar información en la tarjeta de usuario
            document.getElementById("userTypeDisplay").textContent = role.toUpperCase();

            // Actualizar avatar con inicial del usuario
            const userAvatar = document.getElementById("userAvatar");
            if (userAvatar) {
                userAvatar.textContent = user.charAt(0).toUpperCase();
            }

            // Actualizar tiempo de sesión
            const sessionTime = document.getElementById("sessionTime");
            if (sessionTime) {
                sessionTime.textContent = `Sesión iniciada: ${new Date().toLocaleTimeString(
                    "es-CL"
                )}`;
            }

            // Actualizar email basado en el rol
            let email = "";
            if (role === "admin") {
                email = "victor.mulchi@liceoriosdechile.cl";
            } else if (role === "operator") {
                email = "operador.la@gmail.com";
            } else {
                email = "visitante@liceo.cl";
            }
            document.getElementById("userEmailDisplay").textContent = email;

            // Actualizar permisos
            updatePermissionsDisplay(role);

            // Mostrar campanita solo para admin
            if (role === "admin") {
                document.getElementById("notificationBell").classList.remove("hidden");
            } else {
                document.getElementById("notificationBell").classList.add("hidden");
            }

            setupUserPermissions();

            // Redireccionar según el rol al iniciar sesión
            if (currentRole === 'admin') {
                showTab('dashboard');
            } else {
                // Admin y visitor van al dashboard por defecto
                showTab('inventory');
            }

            // Inicializar datos y listeners
            await initSampleData();
            initializeFirebaseListeners();

            // Forzar actualización de números después del login
            setTimeout(() => {
                updateDashboard();
                updateManagementInfo();
            }, 300);

            updateDashboard();
            hideLoading();
            setTimeout(() => {
                window.scrollTo(0, 0);
            }, 500);
        }

        function updateDashboard() {
            // Update alerts - Ahora se manejan en la campanita de notificaciones
            updateNotifications();

            // Calculate stats
            const totalProducts = products.length;
            const totalStock = products.reduce((sum, p) => sum + p.quantity, 0);
            const activeLends = loans.filter((l) => l.status === "Activo").length;

            // Update all dashboard elements with a delay to ensure DOM is ready
            setTimeout(() => {
                // Update main dashboard stats (Resumen General)
                const totalProductsEl = document.getElementById("totalProducts");
                const totalStockEl = document.getElementById("totalStock");
                const activeLendsEl = document.getElementById("activeLends");

                if (totalProductsEl) totalProductsEl.textContent = totalProducts;
                if (totalStockEl) totalStockEl.textContent = totalStock;
                if (activeLendsEl) activeLendsEl.textContent = activeLends;

                // Update management info cards
                updateManagementInfo();
            }, 100);
        }

        function updateManagementInfo() {
            const totalProducts = products.length;
            const availableProducts = products.filter(
                (p) => p.status === "Disponible"
            ).length;
            const activeLoans = loans.filter((l) => l.status === "Activo").length;
            const maintenanceProducts = products.filter(
                (p) => p.status === "Mantenimiento"
            ).length;

            const mgmtTotalEl = document.getElementById("mgmtTotalProducts");
            const mgmtAvailableEl = document.getElementById(
                "mgmtAvailableProducts"
            );
            const mgmtLoansEl = document.getElementById("mgmtActiveLoans");
            const mgmtMaintenanceEl = document.getElementById(
                "mgmtMaintenanceProducts"
            );

            if (mgmtTotalEl) mgmtTotalEl.textContent = totalProducts;
            if (mgmtAvailableEl) mgmtAvailableEl.textContent = availableProducts;
            if (mgmtLoansEl) mgmtLoansEl.textContent = activeLoans;
            if (mgmtMaintenanceEl)
                mgmtMaintenanceEl.textContent = maintenanceProducts;
        }

        function updatePermissionsDisplay(role) {
            const permissionsDiv = document.getElementById("permissionsDisplay");
            let permissions = [];

            if (role === "admin") {
                permissions = [
                    "Ver",
                    "Ingresar",
                    "Editar",
                    "Aumentar",
                    "Prestar",
                    "Devolver",
                    "Baja",
                    "Gestionar_usuarios",
                ];
            } else if (role === "operator") {
                permissions = ["Ver", "Ingresar"];
            } else {
                permissions = ["Ver"];
            }

            permissionsDiv.innerHTML = permissions
                .map(
                    (permission) =>
                        `<span class="permission-badge">${permission}</span>`
                )
                .join("");
        }

        function logout() {
            // Limpiar listeners de Firebase
            if (unsubscribeProducts) unsubscribeProducts();
            if (unsubscribeLoans) unsubscribeLoans();
            if (unsubscribeHistory) unsubscribeHistory();

            currentUser = null;
            currentRole = null;
            selectedUserType = null;

            // Limpiar UI completamente
            document.getElementById("loginScreen").style.display = "block";
            document.getElementById("dashboardScreen").style.display = "none";

            // Reset form
            document.getElementById("email").value = "";
            document.getElementById("password").value = "";
            document.getElementById("credentialsForm").classList.add("hidden");

            // Limpiar selección de user types
            document.querySelectorAll(".user-type-card").forEach((card) => {
                card.classList.remove("active");
            });

            // Resetear pestañas a estado inicial
            document
                .querySelectorAll(".tab-content")
                .forEach((tab) => tab.classList.add("hidden"));
            document
                .querySelectorAll(".nav-item")
                .forEach((tab) => tab.classList.remove("active"));

            // Activar dashboard tab por defecto
            document.getElementById("content-dashboard").classList.remove("hidden");
            document.getElementById("tab-dashboard").classList.add("active");

            // Limpiar contenido dinámico
            document.getElementById("operationResult").innerHTML = "";
            // Ocultar elementos exclusivos del admin
            document.getElementById("adminExportSection").classList.add("hidden");
            document.getElementById("deleteHistoryBtn").classList.add("hidden");
            document.getElementById("notificationBell").classList.add("hidden");
            document.getElementById("notificationDropdown").classList.remove("active");
            document.body.style.overflow = ""; // Restaurar scroll

            // Forzar re-centrado del login container
            const loginContainer = document.querySelector(".login-container");
            if (loginContainer) {
                loginContainer.style.display = "flex";
                loginContainer.style.alignItems = "center";
                loginContainer.style.justifyContent = "center";
            }

            // Resetear estilos del body que podrían estar afectando
            document.body.style.overflow = "";

            // Forzar reflow para asegurar estilos correctos
            setTimeout(() => {
                const loginCard = document.querySelector(".login-card");
                if (loginCard) {
                    loginCard.style.transform = "";
                    loginCard.style.margin = "";
                }
            }, 100);
        }

        function setupUserPermissions() {
            const tabs = [
                "dashboard",
                "inventory",
                "management",
                "statistics",
                "history",
                "loans",
            ];

            tabs.forEach((tab) => {
                const tabElement = document.getElementById(`tab-${tab}`);

                if (currentRole === "visitor") {
                    if (tab === "inventory") {
                        tabElement.style.display = "flex";
                    } else {
                        tabElement.style.display = "none";
                    }
                } else if (currentRole === "operator") {
                    if (["inventory", "management"].includes(tab)) {
                        tabElement.style.display = "flex";
                    } else {
                        tabElement.style.display = "none";
                    }
                } else {
                    tabElement.style.display = "flex";
                }
            });

            // Configurar visibilidad de tarjetas del dashboard
            const managementCard = document.getElementById("managementCard");
            const statisticsCard = document.getElementById("statisticsCard");
            const historyCard = document.getElementById("historyCard");

            if (currentRole === "visitor") {
                managementCard.style.display = "none";
                statisticsCard.style.display = "none";
                historyCard.style.display = "none";
            } else if (currentRole === "operator") {
                managementCard.style.display = "block";
                statisticsCard.style.display = "none";
                historyCard.style.display = "none";
            } else {
                managementCard.style.display = "block";
                statisticsCard.style.display = "block";
                historyCard.style.display = "block";
            }

            if (currentRole === "admin") {
                document
                    .getElementById("adminExportSection")
                    .classList.remove("hidden");
                document
                    .getElementById("deleteHistoryBtn")
                    .classList.remove("hidden")
            }

            if (currentRole === "visitor") {
                showTab("inventory");
            }

            // Mostrar sección de solicitudes solo para visitantes
            const visitorRequestSection = document.getElementById("visitorRequestSection");
            if (visitorRequestSection) {
                if (currentRole === "visitor") {
                    visitorRequestSection.style.display = "block";
                } else {
                    visitorRequestSection.style.display = "none";
                }
            }
        }

        function showTab(tabName) {
            document
                .querySelectorAll(".tab-content")
                .forEach((tab) => tab.classList.add("hidden"));
            document
                .querySelectorAll(".nav-item")
                .forEach((tab) => tab.classList.remove("active"));

            document
                .getElementById(`content-${tabName}`)
                .classList.remove("hidden");
            document.getElementById(`tab-${tabName}`).classList.add("active");

            // Force update dashboard numbers when switching to dashboard
            if (tabName === "dashboard") {
                setTimeout(() => {
                    updateDashboard();
                }, 150);
            }

            updateUI();
            window.scrollTo(0, 0);
        }

        function updateUI() {
            const activeTab = document
                .querySelector(".nav-item.active")
                .id.replace("tab-", "");

            switch (activeTab) {
                case "dashboard":
                    updateDashboard();
                    break;
                case "inventory":
                    updateInventory();
                    break;
                case "management":
                    updateManagementInfo();
                    break;
                case "statistics":
                    updateStatistics();
                    break;
                case "history":
                    updateHistory();
                    break;
                case "loans":
                    updateActiveLoans();
                    break
            }
        }

        function updateInventory() {
            // Si no hay filtro de búsqueda, usar todos los productos
            if (!document.getElementById("searchInventory").value.trim()) {
                filteredProducts = [...products];
            }

            renderInventoryPage();
            updatePaginationControls();
            updateInventoryCount();
        }

        // Renderizar productos de la página actual
        function renderInventoryPage() {
            const tbody = document.getElementById("inventoryBody");
            tbody.innerHTML = "";

            // Calcular rango de productos para la página actual
            const startIndex = (currentPage - 1) * itemsPerPage;
            const endIndex = startIndex + itemsPerPage;
            const pageProducts = filteredProducts.slice(startIndex, endIndex);

            pageProducts.forEach((product) => {
                const row = document.createElement("tr");
                const locationStr = `
            <div style="font-size: 0.85rem; line-height: 1.4;">
                <div><strong>📚 Estantería:</strong> ${product.location.shelf}</div>
                <div><strong>📦 Rack:</strong> ${product.location.rack}</div>
                <div><strong>🔢 Nivel:</strong> ${product.location.level}</div>
            </div>
        `;
                const statusClass = `status-${product.status
                    .toLowerCase()
                    .replace(" ", "-")}`;

                row.innerHTML = `
            <td><strong>${product.code}</strong></td>
            <td>${product.name}</td>
            <td>${product.category}</td>
            <td><span class="status-badge ${statusClass}">${product.status}</span></td>
            <td><strong>${product.quantity}</strong></td>
            <td>${locationStr}</td>
        `;
                tbody.appendChild(row);
            });

            // Si no hay productos en esta página
            if (pageProducts.length === 0) {
                const row = document.createElement("tr");
                row.innerHTML = `
            <td colspan="6" style="text-align: center; padding: 2rem; color: var(--gray-500);">
                ${filteredProducts.length === 0 ? "No se encontraron productos" : "No hay productos en esta página"}
            </td>
        `;
                tbody.appendChild(row);
            }
        }

        // Actualizar controles de paginación
        function updatePaginationControls() {
            totalPages = Math.ceil(filteredProducts.length / itemsPerPage);

            // Actualizar información de página
            document.getElementById("paginationInfo").textContent =
                `Página ${currentPage} de ${totalPages}`;

            // Actualizar botones de navegación
            document.getElementById("firstPageBtn").disabled = currentPage === 1;
            document.getElementById("prevPageBtn").disabled = currentPage === 1;
            document.getElementById("nextPageBtn").disabled = currentPage === totalPages;
            document.getElementById("lastPageBtn").disabled = currentPage === totalPages;

            // Actualizar input de salto de página
            document.getElementById("jumpToPage").max = totalPages;
            document.getElementById("jumpToPage").value = currentPage;

            // Generar números de página
            generatePageNumbers();

            // Mostrar/ocultar paginación si es necesaria
            const paginationContainer = document.getElementById("paginationContainer");
            if (totalPages <= 1) {
                paginationContainer.style.display = "none";
            } else {
                paginationContainer.style.display = "flex";
            }
        }

        // Generar números de página
        function generatePageNumbers() {
            const numbersContainer = document.getElementById("paginationNumbers");
            numbersContainer.innerHTML = "";

            let startPage = Math.max(1, currentPage - 2);
            let endPage = Math.min(totalPages, currentPage + 2);

            // Ajustar rango si estamos cerca del inicio o final
            if (currentPage <= 3) {
                endPage = Math.min(5, totalPages);
            }
            if (currentPage > totalPages - 3) {
                startPage = Math.max(1, totalPages - 4);
            }

            // Botón de primera página si no está visible
            if (startPage > 1) {
                const firstBtn = createPageButton(1);
                numbersContainer.appendChild(firstBtn);

                if (startPage > 2) {
                    const ellipsis = document.createElement("span");
                    ellipsis.className = "pagination-ellipsis";
                    ellipsis.textContent = "...";
                    numbersContainer.appendChild(ellipsis);
                }
            }

            // Generar botones de página
            for (let i = startPage; i <= endPage; i++) {
                const pageBtn = createPageButton(i);
                if (i === currentPage) {
                    pageBtn.classList.add("active");
                }
                numbersContainer.appendChild(pageBtn);
            }

            // Botón de última página si no está visible
            if (endPage < totalPages) {
                if (endPage < totalPages - 1) {
                    const ellipsis = document.createElement("span");
                    ellipsis.className = "pagination-ellipsis";
                    ellipsis.textContent = "...";
                    numbersContainer.appendChild(ellipsis);
                }

                const lastBtn = createPageButton(totalPages);
                numbersContainer.appendChild(lastBtn);
            }
        }

        // Crear botón de página
        function createPageButton(pageNumber) {
            const button = document.createElement("button");
            button.className = "pagination-btn";
            button.textContent = pageNumber;
            button.onclick = () => goToPage(pageNumber);
            return button;
        }

        // Actualizar contador de inventario
        function updateInventoryCount() {
            const startIndex = (currentPage - 1) * itemsPerPage;
            const endIndex = Math.min(startIndex + itemsPerPage, filteredProducts.length);
            const showing = filteredProducts.length === 0 ? 0 : endIndex - startIndex;

            document.getElementById("inventoryCount").textContent =
                `Mostrando ${showing} de ${filteredProducts.length} productos`;
        }

        function goToPage(page) {
            if (page >= 1 && page <= totalPages) {
                currentPage = page;
                renderInventoryPage();
                updatePaginationControls();
                updateInventoryCount();

                // Scroll al inicio de la tabla
                document.getElementById("inventoryBody").scrollIntoView({
                    behavior: 'smooth',
                    block: 'start'
                });
            }
        }

        function goToPreviousPage() {
            goToPage(currentPage - 1);
        }

        function goToNextPage() {
            goToPage(currentPage + 1);
        }

        function goToFirstPage() {
            goToPage(1);
        }

        function goToLastPage() {
            goToPage(totalPages);
        }

        function jumpToSpecificPage() {
            const jumpInput = document.getElementById("jumpToPage");
            const page = parseInt(jumpInput.value);
            if (page && page >= 1 && page <= totalPages) {
                goToPage(page);
            } else {
                alert(`❌ Ingresa un número entre 1 y ${totalPages}`);
                jumpInput.value = currentPage;
            }
        }

        function jumpToPageOnEnter(event) {
            if (event.key === 'Enter') {
                jumpToSpecificPage();
            }
        }

        function changeItemsPerPage() {
            const newItemsPerPage = parseInt(document.getElementById("itemsPerPage").value);

            // Calcular en qué página debería estar el primer elemento visible actualmente
            const currentFirstItem = (currentPage - 1) * itemsPerPage;

            itemsPerPage = newItemsPerPage;
            currentPage = Math.floor(currentFirstItem / itemsPerPage) + 1;

            renderInventoryPage();
            updatePaginationControls();
            updateInventoryCount();
        }

        function filterInventory() {
            const searchTerm = document.getElementById("searchInventory").value.toLowerCase();

            // Filtrar productos
            if (searchTerm.trim() === "") {
                filteredProducts = [...products];
            } else {
                filteredProducts = products.filter(product => {
                    const codeMatch = product.code && product.code.toLowerCase().includes(searchTerm);
                    const nameMatch = product.name && product.name.toLowerCase().includes(searchTerm);
                    const categoryMatch = product.category && product.category.toLowerCase().includes(searchTerm);
                    const statusMatch = product.status && product.status.toLowerCase().includes(searchTerm);

                    return codeMatch || nameMatch || categoryMatch || statusMatch;
                });
            }

            // Resetear a página 1 después de filtrar
            currentPage = 1;

            // Actualizar vista
            renderInventoryPage();
            updatePaginationControls();
            updateInventoryCount();
        }

        function updateStatistics() {
            // Actualizar números principales
            const totalProducts = products.length;
            const totalStock = products.reduce((sum, p) => sum + p.quantity, 0);
            const availableCount = products.filter(
                (p) => p.status === "Disponible"
            ).length;
            const inUseCount = products.filter((p) => p.status === "En uso").length;
            const maintenanceCount = products.filter(
                (p) => p.status === "Mantenimiento"
            ).length;
            const unavailableCount = products.filter(
                (p) => p.status === "No disponible"
            ).length;
            const activeLoansCount = loans.filter(
                (l) => l.status === "Activo"
            ).length;

            // Verificar que los elementos existen antes de actualizar
            const uniqueProductsEl = document.getElementById("uniqueProducts");
            const totalStockStatsEl = document.getElementById("totalStockStats");
            const totalValueEl = document.getElementById("totalValue");
            const activeLoansStatsEl = document.getElementById("activeLoansStats");
            const availableProductsEl =
                document.getElementById("availableProducts");
            const inUseProductsEl = document.getElementById("inUseProducts");
            const maintenanceProductsEl = document.getElementById(
                "maintenanceProducts"
            );
            const unavailableProductsEl = document.getElementById(
                "unavailableProducts"
            );

            if (uniqueProductsEl) uniqueProductsEl.textContent = totalProducts;
            if (totalStockStatsEl) totalStockStatsEl.textContent = totalStock;
            if (totalValueEl)
                totalValueEl.textContent = `${(totalStock * 50000).toLocaleString()}`;
            if (activeLoansStatsEl)
                activeLoansStatsEl.textContent = activeLoansCount;
            if (availableProductsEl)
                availableProductsEl.textContent = availableCount;
            if (inUseProductsEl) inUseProductsEl.textContent = inUseCount;
            if (maintenanceProductsEl)
                maintenanceProductsEl.textContent = maintenanceCount;
            if (unavailableProductsEl)
                unavailableProductsEl.textContent = unavailableCount;

            // Actualizar gráfico de categorías
            const categories = {};
            products.forEach((product) => {
                categories[product.category] =
                    (categories[product.category] || 0) + 1;
            });

            const categoryChart = document.getElementById("categoryChart");
            if (categoryChart) {
                categoryChart.innerHTML = "";

                Object.entries(categories).forEach(([category, count]) => {
                    const percentage =
                        totalProducts > 0
                            ? ((count / totalProducts) * 100).toFixed(1)
                            : 0;

                    const categoryBar = document.createElement("div");
                    categoryBar.className = "category-bar";
                    categoryBar.innerHTML = `
                        <div class="category-info">
                            <span class="category-name">${category}</span>
                            <span class="category-percentage">${percentage}%</span>
                        </div>
                        <div class="progress-bar">
                            <div class="progress-fill" style="width: ${percentage}%"></div>
                        </div>
                    `;
                    categoryChart.appendChild(categoryBar);
                });
            }

            // Generar insights automáticos
            generateInsights(
                totalProducts,
                totalStock,
                availableCount,
                maintenanceCount,
                activeLoansCount,
                categories
            );
        }

        function generateInsights(
            totalProducts,
            totalStock,
            availableCount,
            maintenanceCount,
            activeLoansCount,
            categories
        ) {
            const insightsContainer = document.getElementById("insightsContainer");
            insightsContainer.innerHTML = "";

            const insights = [];

            // Insight sobre disponibilidad
            const availabilityRate =
                totalProducts > 0
                    ? ((availableCount / totalProducts) * 100).toFixed(1)
                    : 0;
            if (availabilityRate < 70) {
                insights.push({
                    icon: "⚠️",
                    title: "Baja Disponibilidad",
                    text: `Solo el ${availabilityRate}% de productos están disponibles. Considera revisar productos en mantenimiento.`,
                });
            } else if (availabilityRate > 90) {
                insights.push({
                    icon: "✅",
                    title: "Excelente Disponibilidad",
                    text: `El ${availabilityRate}% de productos están disponibles. El inventario está en óptimas condiciones.`,
                });
            }

            // Insight sobre mantenimiento
            if (maintenanceCount > 0) {
                insights.push({
                    icon: "🔧",
                    title: "Productos en Mantenimiento",
                    text: `Hay ${maintenanceCount} productos que requieren atención. Programa revisiones periódicas.`,
                });
            }

            // Insight sobre préstamos
            if (activeLoansCount > totalStock * 0.3) {
                insights.push({
                    icon: "📈",
                    title: "Alta Demanda de Préstamos",
                    text: `Hay ${activeLoansCount} préstamos activos. Considera aumentar el stock de productos populares.`,
                });
            }

            // Insight sobre categorías
            const topCategory = Object.entries(categories).sort(
                (a, b) => b[1] - a[1]
            )[0];
            if (topCategory) {
                const categoryPercentage = (
                    (topCategory[1] / totalProducts) *
                    100
                ).toFixed(1);
                insights.push({
                    icon: "📊",
                    title: "Categoría Dominante",
                    text: `${topCategory[0]} representa el ${categoryPercentage}% del inventario con ${topCategory[1]} productos.`,
                });
            }

            // Insight de eficiencia
            const efficiencyRate =
                totalProducts > 0
                    ? (
                        ((totalProducts - maintenanceCount) / totalProducts) *
                        100
                    ).toFixed(1)
                    : 0;
            insights.push({
                icon: "⚡",
                title: "Eficiencia del Sistema",
                text: `El sistema opera al ${efficiencyRate}% de eficiencia con ${totalStock} unidades totales en inventario.`,
            });

            // Renderizar insights
            insights.forEach((insight) => {
                const insightElement = document.createElement("div");
                insightElement.className = "insight-item";
                insightElement.innerHTML = `
                    <div class="insight-icon">${insight.icon}</div>
                    <div class="insight-content">
                        <h4>${insight.title}</h4>
                        <p>${insight.text}</p>
                    </div>
                `;
                insightsContainer.appendChild(insightElement);
            });
        }

        function updateHistory() {
            const tbody = document.getElementById("historyBody");
            tbody.innerHTML = "";

            history.forEach((record) => {
                const row = document.createElement("tr");
                row.innerHTML = `
                    <td>${record.date}</td>
                    <td><strong>${record.user}</strong></td>
                    <td>${record.operation}</td>
                    <td>${record.product}</td>
                    <td>${record.details}</td>
                `;
                tbody.appendChild(row);
            });
        }

        // Función para actualizar préstamos activos - Optimizada
        // Función mejorada para prevenir duplicación
        function updateActiveLoans() {
            const tbody = document.getElementById("activeLoansBody");
            if (!tbody) {
                console.error("No se encontró el elemento activeLoansBody");
                return;
            }

            // Verificar si ya se está ejecutando
            if (tbody.dataset.updating === 'true') {
                console.log('⏸️ updateActiveLoans ya se está ejecutando, saltando...');
                return;
            }

            // Marcar como en proceso
            tbody.dataset.updating = 'true';

            try {
                // Limpiar completamente
                tbody.innerHTML = "";

                const activeLoans = loans.filter(loan => loan.status === "Activo");
                const today = new Date();
                const threeDaysFromNow = new Date(today.getTime() + 3 * 24 * 60 * 60 * 1000);

                let totalActive = 0;
                let upcoming = 0;
                let overdue = 0;
                let onTime = 0;

                // Crear un Set para evitar duplicados por ID
                const processedLoans = new Set();

                activeLoans.forEach((loan) => {
                    // Evitar duplicados por ID
                    if (processedLoans.has(loan.id)) {
                        console.warn('⚠️ Préstamo duplicado detectado y omitido:', loan.id);
                        return;
                    }
                    processedLoans.add(loan.id);

                    const returnDate = new Date(loan.returnDate);
                    let status = "";
                    let statusClass = "";
                    let statusIcon = "";

                    totalActive++;

                    if (returnDate < today) {
                        status = "VENCIDO";
                        statusClass = "status-unavailable status-overdue";
                        statusIcon = "🚨";
                        overdue++;
                    } else if (returnDate <= threeDaysFromNow) {
                        status = "POR VENCER";
                        statusClass = "status-maintenance";
                        statusIcon = "⏰";
                        upcoming++;
                    } else {
                        status = "A TIEMPO";
                        statusClass = "status-available";
                        statusIcon = "✅";
                        onTime++;
                    }

                    const daysDiff = Math.ceil((returnDate - today) / (1000 * 60 * 60 * 24));
                    const daysText = daysDiff < 0 ? `${Math.abs(daysDiff)} días vencido` :
                        daysDiff === 0 ? "Vence hoy" :
                            `${daysDiff} días restantes`;

                    // Información del producto (diferente para préstamos grupales)
                    let productInfo = '';
                    if (loan.bulkLoan) {
                        const returnedCount = loan.returnedCodes ? loan.returnedCodes.length : 0;
                        const totalCodes = loan.individualCodes ? loan.individualCodes.length : loan.quantity;
                        const pendingCount = totalCodes - returnedCount;

                        productInfo = `
                    <div style="font-weight: bold; margin-bottom: 0.2rem; font-size: 0.9rem;">${loan.productName} 📦</div>
                    <div style="font-size: 0.75rem; color: var(--gray-600); line-height: 1.3;">
                        🏷️ Préstamo grupal<br>
                        📊 ${pendingCount}/${totalCodes} pendientes<br>
                        💼 ${loan.individualCodes.slice(0, 2).join(', ')}${totalCodes > 2 ? '...' : ''}
                    </div>
                `;
                    } else {
                        productInfo = `
                    <div style="font-weight: bold; margin-bottom: 0.2rem; font-size: 0.9rem;">${loan.productName}</div>
                    <div style="font-size: 0.75rem; color: var(--gray-600);">${loan.productCode}</div>
                `;
                    }

                    const row = document.createElement("tr");
                    row.innerHTML = `
                <td class="loan-product-cell">${productInfo}</td>
                <td class="loan-borrower-cell">
                    <div style="font-weight: bold; margin-bottom: 0.2rem; font-size: 0.9rem;">${loan.borrower}</div>
                    <div style="font-size: 0.75rem; color: var(--gray-600);">${loan.borrowerRut || ''}</div>
                </td>
                <td class="loan-email-cell">
                    <div style="font-size: 0.8rem; color: var(--gray-700);">${loan.borrowerEmail}</div>
                </td>
                <td class="loan-quantity-cell">${loan.bulkLoan ? (loan.individualCodes ? loan.individualCodes.length - (loan.returnedCodes ? loan.returnedCodes.length : 0) : loan.quantity) : loan.quantity}</td>
                <td class="loan-date-cell">${loan.loanDate}</td>
                <td class="loan-date-cell">${loan.returnDate}</td>
                <td class="loan-status-cell">
                    <div style="font-weight: bold; font-size: 0.9rem; color: ${daysDiff < 0 ? '#e74c3c' : daysDiff <= 3 ? '#f39c12' : '#27ae60'}">${status}</div>
                    <div style="font-size: 0.8rem; color: ${daysDiff < 0 ? '#e74c3c' : daysDiff <= 3 ? '#f39c12' : '#27ae60'}">${daysText}</div>
                </td>
            `;
                    tbody.appendChild(row);
                });

                // Actualizar resumen con verificación de elementos
                const totalActiveEl = document.getElementById("totalActiveLoans");
                const upcomingDueEl = document.getElementById("upcomingDueLoans");
                const overdueEl = document.getElementById("overdueLoans");
                const onTimeEl = document.getElementById("onTimeLoans");

                if (totalActiveEl) totalActiveEl.textContent = totalActive;
                if (upcomingDueEl) upcomingDueEl.textContent = upcoming;
                if (overdueEl) overdueEl.textContent = overdue;
                if (onTimeEl) onTimeEl.textContent = onTime;

                console.log('✅ Préstamos renderizados exitosamente:', totalActive, 'préstamos activos');

            } catch (error) {
                console.error('❌ Error en updateActiveLoans:', error);
            } finally {
                // Desmarcar como en proceso
                tbody.dataset.updating = 'false';
            }
        }

        // Función para filtrar préstamos activos
        function filterActiveLoans() {
            const searchTerm = document.getElementById("searchLoans").value.toLowerCase();
            const rows = document.querySelectorAll("#activeLoansBody tr");

            rows.forEach((row) => {
                const text = row.textContent.toLowerCase();
                row.style.display = text.includes(searchTerm) ? "" : "none";
            });
        }

        // Función para enviar recordatorios masivos
        async function sendBulkReminders(type) {
            if (!isEmailJSReady) {
                alert("⚠️ El servicio de correo no está disponible en este momento");
                return;
            }

            const today = new Date();
            const threeDaysFromNow = new Date(today.getTime() + 3 * 24 * 60 * 60 * 1000);

            let targetLoans = [];
            let actionDescription = "";

            if (type === 'upcoming') {
                targetLoans = loans.filter(loan => {
                    if (loan.status !== "Activo") return false;
                    const returnDate = new Date(loan.returnDate);
                    return returnDate > today && returnDate <= threeDaysFromNow;
                });
                actionDescription = "préstamos que vencen en los próximos 3 días";
            } else if (type === 'overdue') {
                targetLoans = loans.filter(loan => {
                    if (loan.status !== "Activo") return false;
                    const returnDate = new Date(loan.returnDate);
                    return returnDate < today;
                });
                actionDescription = "préstamos vencidos";
            }

            if (targetLoans.length === 0) {
                alert(`ℹ️ No hay ${actionDescription} para enviar recordatorios.`);
                return;
            }

            const confirmed = confirm(`📧 ¿Enviar recordatorios a ${targetLoans.length} ${actionDescription}?

Lista de destinatarios:
${targetLoans.map(loan => `• ${loan.borrower} - ${loan.productName}`).join('\n')}

¿Continuar?`);

            if (!confirmed) return;

            let successCount = 0;
            let errorCount = 0;

            updateEmailStatus("sending");

            for (const loan of targetLoans) {
                try {
                    const returnDate = new Date(loan.returnDate);
                    const daysDiff = Math.ceil((returnDate - today) / (1000 * 60 * 60 * 24));
                    const isOverdue = returnDate < today;

                    let subject, urgencyLevel, message;

                    if (type === 'overdue' || isOverdue) {
                        subject = `🚨 URGENTE: Devolución vencida - ${loan.productName}`;
                        urgencyLevel = "URGENTE - VENCIDO";
                        message = `Tu préstamo venció hace ${Math.abs(daysDiff)} día(s). Favor devolver inmediatamente.`;
                    } else {
                        subject = `⏰ Recordatorio: Devolución próxima - ${loan.productName}`;
                        urgencyLevel = "RECORDATORIO";
                        message = daysDiff === 0 ? "Tu préstamo vence HOY" : `Tu préstamo vence en ${daysDiff} día(s)`;
                    }

                    const templateParams = {
                        to_name: loan.borrower,
                        to_email: loan.borrowerEmail,
                        product_name: loan.productName,
                        product_code: loan.productCode,
                        quantity: loan.quantity,
                        loan_date: loan.loanDate,
                        return_date: loan.returnDate,
                        borrower_name: loan.borrower,
                        borrower_rut: loan.borrowerRut,
                        urgency_level: urgencyLevel,
                        days_info: message,
                        subject: subject,
                        liceo_name: "Liceo Ríos de Chile - Lirquén",
                        contact_email: "victor.mulchi@liceoriosdechile.cl",
                        system_name: "Sistema de Inventario"
                    };

                    const response = await emailjs.send(
                        emailjsConfig.serviceId,
                        emailjsConfig.templateId,
                        templateParams
                    );

                    console.log('✅ Recordatorio enviado a:', loan.borrower);
                    successCount++;

                    // Registrar en historial
                    await addToHistory(
                        `Recordatorio ${type === 'overdue' ? 'urgente' : 'normal'} enviado`,
                        loan.productName,
                        `Enviado a: ${loan.borrower} (${loan.borrowerEmail})`
                    );

                    // Pequeña pausa entre envíos para evitar límites
                    await new Promise(resolve => setTimeout(resolve, 1000));

                } catch (error) {
                    console.error(`Error enviando a ${loan.borrower}:`, error);
                    errorCount++;
                }
            }

            updateEmailStatus("ready");

            alert(`📊 Proceso completado:

✅ Enviados exitosamente: ${successCount}
❌ Errores: ${errorCount}
📧 Total procesados: ${targetLoans.length}

${errorCount > 0 ? 'Revisa la consola para detalles de los errores.' : 'Todos los recordatorios fueron enviados correctamente.'}`);

            // Registrar resumen en historial
            await addToHistory(
                `Recordatorios masivos ${type}`,
                "Sistema de préstamos",
                `Enviados: ${successCount}, Errores: ${errorCount}, Total: ${targetLoans.length}`
            );
        }

        // FUNCIONES DE NOTIFICACIONES
        function updateNotifications() {
            if (currentRole !== 'admin') return;

            const now = new Date();
            const threeDaysFromNow = new Date(now.getTime() + 3 * 24 * 60 * 60 * 1000);
            const notificationList = document.getElementById("notificationList");
            const notificationCount = document.getElementById("notificationCount");

            let notifications = [];

            // EVITAR DUPLICADOS - Filtrar préstamos únicos
            const uniqueActiveLoans = [];
            const seenLoans = new Set();

            loans
                .filter((loan) => loan.status === "Activo")
                .forEach((loan) => {
                    const loanKey = `${loan.productCode}-${loan.borrowerRut}`;
                    if (!seenLoans.has(loanKey)) {
                        seenLoans.add(loanKey);
                        const productExists = products.find((p) => p.code === loan.productCode);
                        if (productExists) {
                            uniqueActiveLoans.push(loan);
                        }
                    }
                });

            uniqueActiveLoans.forEach((loan) => {
                const returnDate = new Date(loan.returnDate);

                if (returnDate < now) {
                    const daysPastDue = Math.floor((now - returnDate) / (1000 * 60 * 60 * 24));
                    notifications.push({
                        type: 'overdue',
                        icon: '🚨',
                        title: '¡PRÉSTAMO VENCIDO!',
                        message: `El préstamo de "${loan.productName}" a ${loan.borrower} venció el ${loan.returnDate}`,
                        time: `Vencido hace ${daysPastDue} día${daysPastDue > 1 ? 's' : ''}`
                    });
                } else if (returnDate <= threeDaysFromNow) {
                    const daysUntilDue = Math.ceil((returnDate - now) / (1000 * 60 * 60 * 24));
                    notifications.push({
                        type: 'warning',
                        icon: '⏰',
                        title: 'Próximo a vencer',
                        message: `El préstamo de "${loan.productName}" a ${loan.borrower} vence el ${loan.returnDate}`,
                        time: daysUntilDue === 0 ? 'Vence hoy' : `Vence en ${daysUntilDue} día${daysUntilDue > 1 ? 's' : ''}`
                    });
                }
            });

            // Notificaciones de solicitudes pendientes
            const pendingRequests = productRequests.filter(req => req.status === 'Pendiente');

            // Crear grupos por usuario y producto
            const requestGroups = {};
            pendingRequests.forEach(request => {
                const groupKey = `${request.requesterRut}_${request.productName}`;

                if (!requestGroups[groupKey]) {
                    requestGroups[groupKey] = {
                        requesterName: request.requesterName,
                        requesterRut: request.requesterRut,
                        requesterEmail: request.requesterEmail,
                        productName: request.productName,
                        requestedDate: request.requestedDate,
                        returnDate: request.returnDate,
                        requests: [],
                        totalQuantity: 0,
                        requestDate: request.requestDate,
                        requestReason: request.requestReason || 'No especificado'
                    };
                }

                requestGroups[groupKey].requests.push(request);
                requestGroups[groupKey].totalQuantity += (request.requestedQuantity || 1);
            });

            // Crear notificaciones agrupadas
            Object.values(requestGroups).forEach((group) => {
                const requestDate = new Date(group.requestDate);
                const hoursAgo = Math.floor((now - requestDate) / (1000 * 60 * 60));
                const timeAgo = hoursAgo < 1 ? 'Hace unos minutos' :
                    hoursAgo === 1 ? 'Hace 1 hora' :
                        `Hace ${hoursAgo} horas`;

                notifications.push({
                    type: 'request',
                    icon: '📋',
                    title: `Solicitud ${group.requests.length > 1 ? 'Múltiple' : 'de Producto'}`,
                    message: `${group.requesterName} solicita "${group.productName}" (${group.totalQuantity} unidades${group.requests.length > 1 ? ` en ${group.requests.length} códigos` : ''})`,
                    time: timeAgo,
                    requestGroup: group,
                    isBulkRequest: group.requests.length > 1
                });
            });

            // Actualizar contador
            if (notifications.length > 0) {
                notificationCount.textContent = notifications.length;
                notificationCount.classList.remove("hidden");
            } else {
                notificationCount.classList.add("hidden");
            }

            // Actualizar lista
            if (notifications.length === 0) {
                notificationList.innerHTML = `
            <div class="no-notifications">
                <div class="no-notifications-icon">🔕</div>
                <div class="no-notifications-text">No hay notificaciones</div>
            </div>
        `;
            } else {
                notificationList.innerHTML = notifications.map(notification => {
                    if (notification.type === 'request') {
                        if (notification.isBulkRequest) {
                            return `
            <div class="notification-item request bulk-request">
                <span class="notification-icon">${notification.icon}</span>
                <div class="notification-content">
                    <div class="notification-title">${notification.title} ⚡</div>
                    <div class="notification-message">${notification.message}</div>
                    <div class="notification-time">${notification.time}</div>
                    <div class="bulk-info">
                        <small>📅 Necesario: ${new Date(notification.requestGroup.requestedDate).toLocaleDateString('es-CL')} | 
                        📧 ${notification.requestGroup.requesterEmail}</small>
                    </div>
                    <div class="notification-actions">
                        <button class="btn btn-success btn-small" onclick="approveBulkRequest('${notification.requestGroup.requesterRut}', '${notification.requestGroup.productName}')">
                            ✅ Aprobar Todo (${notification.requestGroup.totalQuantity})
                        </button>
                        <button class="btn btn-secondary btn-small" onclick="viewBulkRequestDetails('${notification.requestGroup.requesterRut}', '${notification.requestGroup.productName}')">
                            👁️ Ver Detalles
                        </button>
                        <button class="btn btn-danger btn-small" onclick="rejectBulkRequest('${notification.requestGroup.requesterRut}', '${notification.requestGroup.productName}')">
                            ❌ Rechazar Todo
                        </button>
                    </div>
                </div>
            </div>
        `;
                        } else {
                            return `
            <div class="notification-item request">
                <span class="notification-icon">${notification.icon}</span>
                <div class="notification-content">
                    <div class="notification-title">${notification.title}</div>
                    <div class="notification-message">${notification.message}</div>
                    <div class="notification-time">${notification.time}</div>
                    <div class="notification-actions">
                        <button class="btn btn-primary btn-small" onclick="approveRequest('${notification.requestGroup.requests[0].id}')">✅ Aprobar</button>
                        <button class="btn btn-secondary btn-small" onclick="viewRequestDetails('${notification.requestGroup.requests[0].id}')">👁️ Detalles</button>
                        <button class="btn btn-secondary btn-small" onclick="rejectRequest('${notification.requestGroup.requests[0].id}')">❌ Rechazar</button>
                    </div>
                </div>
            </div>
        `;
                        }
                    } else {
                        return `
                <div class="notification-item ${notification.type}">
                    <span class="notification-icon">${notification.icon}</span>
                    <div class="notification-content">
                        <div class="notification-title">${notification.title}</div>
                        <div class="notification-message">${notification.message}</div>
                        <div class="notification-time">${notification.time}</div>
                    </div>
                </div>
            `;
                    }
                }).join('');
            }
        }

        function toggleNotifications() {
            const dropdown = document.getElementById("notificationDropdown");
            const isActive = dropdown.classList.contains("active");

            if (isActive) {
                dropdown.classList.remove("active");
            } else {
                dropdown.classList.add("active");
                updateNotifications();
            }
        }

        // ✅ FUNCIÓN CORREGIDA:
        function clearAllNotifications() {
            const notificationList = document.getElementById("notificationList");
            const notificationCount = document.getElementById("notificationCount");

            notificationList.innerHTML = `
        <div class="no-notifications">
            <div class="no-notifications-icon">🔕</div>
            <div class="no-notifications-text">No hay notificaciones</div>
        </div>
    `;

            notificationCount.classList.add("hidden");
            document.getElementById("notificationDropdown").classList.remove("active");
        }

        // Cerrar dropdown al hacer click fuera
        document.addEventListener('click', function (event) {
            const bell = document.getElementById('notificationBell');
            const dropdown = document.getElementById('notificationDropdown');

            if (!bell.contains(event.target) && !dropdown.contains(event.target)) {
                dropdown.classList.remove('active');
            }
        });

        function openModal(operation) {
            // Check permissions for operator
            if (
                currentRole === "operator" &&
                [
                    "updateStock",
                    "lendProduct",
                    "returnProduct",
                    "removeProduct",
                    "deleteProduct",
                ].includes(operation)
            ) {
                const adminPassword = prompt(
                    "🔐 Ingrese la contraseña de administrador:"
                );
                if (adminPassword !== "AdminLiceo2025!") {
                    alert("❌ Contraseña incorrecta");
                    return;
                }
            }

            const modal = document.getElementById("operationModal");
            const modalTitle = document.getElementById("modalTitle");
            const modalContent = document.getElementById("modalContent");

            modalTitle.textContent = getModalTitle(operation);
            modalContent.innerHTML = getModalContent(operation);
            modal.style.display = "block";
        }

        function closeModal() {
            document.getElementById("operationModal").style.display = "none";
        }

        function showInfoModal(type) {
            const modal = document.getElementById("infoModal");
            const title = document.getElementById("infoModalTitle");
            const body = document.getElementById("infoModalBody");

            const infoContent = {
                category: {
                    title: "Categoría del Producto",
                    question: "¿Cómo seleccionar la categoría correcta?",
                    description:
                        "Selecciona el tipo de producto según su naturaleza y uso principal en el liceo.",
                    examples: [
                        "Equipo: Computadores, proyectores, tablets",
                        "Libro: Literatura, textos educativos, manuales",
                        "Material: Útiles escolares, papelería, insumos",
                        "Herramienta: Instrumentos de laboratorio, herramientas de taller",
                        "Documento: Certificados, archivos importantes",
                    ],
                    usage: [
                        "Piensa en el uso principal del producto",
                        "Considera dónde se utilizará más frecuentemente",
                        'Si es tecnológico, probablemente sea "Equipo"',
                        'Si es para leer o estudiar, selecciona "Libro"',
                    ],
                },
                brand: {
                    title: "Marca del Producto",
                    question: "¿Qué información incluir en marca?",
                    description:
                        "Indica la marca o fabricante del producto para identificación y seguimiento.",
                    examples: [
                        "Epson (para proyectores)",
                        "HP (para computadores)",
                        "Canon (para impresoras)",
                        "Casio (para calculadoras)",
                    ],
                    usage: [
                        "Busca la marca en el producto mismo",
                        "Si no tiene marca visible, puedes dejarlo vacío",
                        "Escribe el nombre exacto como aparece",
                        "Ayuda para garantías y soporte técnico",
                    ],
                },
                model: {
                    title: "Modelo del Producto",
                    question: "¿Dónde encuentro el modelo?",
                    description:
                        "El modelo específico ayuda a identificar las características exactas del producto.",
                    examples: [
                        "EB-X41 (modelo de proyector Epson)",
                        "LaserJet Pro M404n (modelo de impresora HP)",
                        "FX-991EX (modelo de calculadora Casio)",
                        "ThinkPad T480 (modelo de laptop Lenovo)",
                    ],
                    usage: [
                        "Busca en etiquetas del producto",
                        "Revisa la caja o documentación",
                        "Si no lo encuentras, déjalo vacío",
                        "Útil para piezas de repuesto y soporte",
                    ],
                },
                description: {
                    title: "Descripción del Producto",
                    question: "¿Qué información incluir en la descripción?",
                    description:
                        "Proporciona detalles adicionales sobre el producto, sus características y uso específico.",
                    examples: [
                        "Proyector para aulas con resolución Full HD",
                        "Calculadora científica con 417 funciones",
                        "Microscopio binocular para laboratorio de biología",
                        "Tablet educativa con aplicaciones preinstaladas",
                    ],
                    usage: [
                        "Incluye características técnicas relevantes",
                        "Menciona el uso específico en el liceo",
                        "Agrega detalles que ayuden a identificarlo",
                        "Este campo es opcional pero recomendado",
                    ],
                },
                quantity: {
                    title: "Cantidad del Producto",
                    question: "¿Cómo determinar la cantidad correcta?",
                    description:
                        "Indica el número exacto de unidades que se están ingresando al inventario.",
                    examples: [
                        "1 (para productos únicos como proyectores)",
                        "30 (para libros de texto del mismo título)",
                        "15 (para calculadoras del mismo modelo)",
                        "50 (para materiales como cuadernos)",
                    ],
                    usage: [
                        "Cuenta físicamente las unidades disponibles",
                        "Solo ingresa productos que estén físicamente presentes",
                        "El número debe ser mayor a 0",
                        "Puedes aumentar la cantidad más tarde si recibes más unidades",
                    ],
                },
                status: {
                    title: "Estado del Producto",
                    question: "¿Qué estado seleccionar?",
                    description:
                        "Indica la condición actual del producto para un mejor control del inventario.",
                    examples: [
                        "Disponible: Producto listo para ser usado o prestado",
                        "En uso: Producto prestado a estudiantes o profesores",
                        "Mantenimiento: Producto en reparación o revisión",
                        "No disponible: Producto dañado o fuera de servicio",
                    ],
                    usage: [
                        'La mayoría de productos nuevos serán "Disponible"',
                        'Usa "En uso" solo si ya está prestado al ingresar',
                        'Selecciona "Mantenimiento" si necesita revisión',
                        '"No disponible" para productos dañados o perdidos',
                    ],
                },
                stockQuantity: {
                    title: "Cantidad a Aumentar",
                    question: "¿Cuántas unidades agregar?",
                    description:
                        "Especifica el número de unidades que se sumarán al stock actual del producto.",
                    examples: [
                        "5 (si recibiste 5 unidades nuevas)",
                        "1 (para productos únicos)",
                        "20 (para materiales como cuadernos)",
                        "10 (para libros de texto adicionales)",
                    ],
                    usage: [
                        "Solo ingresa las unidades que físicamente agregaste",
                        "El sistema sumará esta cantidad al stock existente",
                        "Verifica que el producto esté presente antes de agregar",
                        "El número debe ser mayor a 0",
                    ],
                },
                lendQuantity: {
                    title: "Cantidad a Prestar",
                    question: "¿Cuántas unidades prestar?",
                    description:
                        "Indica cuántas unidades del producto se van a prestar al solicitante.",
                    examples: [
                        "1 (para productos únicos como proyectores)",
                        "2 (para calculadoras si el estudiante necesita más)",
                        "5 (para libros si es un grupo de estudio)",
                        "3 (para materiales de laboratorio)",
                    ],
                    usage: [
                        "No puede exceder el stock disponible",
                        "Considera cuánto realmente necesita el solicitante",
                        "Para productos valiosos, presta solo lo necesario",
                        "El stock se reducirá automáticamente",
                    ],
                },
                borrowerInfo: {
                    title: "Información del Solicitante",
                    question: "¿Qué datos del solicitante registrar?",
                    description:
                        "Datos necesarios para identificar y contactar a la persona que solicita el préstamo.",
                    examples: [
                        "Juan Pérez Sánchez (nombre completo)",
                        "María González López (estudiante)",
                        "Carlos Rodríguez (profesor)",
                        "Ana Torres (personal administrativo)",
                    ],
                    usage: [
                        "Solicita nombre completo para evitar confusiones",
                        "Verifica la identidad antes de registrar",
                        "Incluye apellidos para mayor precisión",
                        "Mantén registros claros para seguimiento",
                    ],
                },
                borrowerRut: {
                    title: "RUT del Solicitante",
                    question: "¿Cómo ingresar el RUT correctamente?",
                    description:
                        "Número de identificación único para validar la identidad del solicitante.",
                    examples: [
                        "12.345.678-9 (con puntos y guión)",
                        "20.123.456-K (dígito verificador K)",
                        "15.987.654-0 (estudiante)",
                        "8.765.432-1 (profesor)",
                    ],
                    usage: [
                        "Incluye puntos y guión para mayor claridad",
                        "Verifica que coincida con documento de identidad",
                        "El dígito verificador es obligatorio",
                        "Útil para registros oficiales y seguimiento",
                    ],
                },
                borrowerEmail: {
                    title: "Correo del Solicitante",
                    question: "¿Para qué sirve el correo electrónico?",
                    description:
                        "Email de contacto para enviar recordatorios y notificaciones sobre el préstamo.",
                    examples: [
                        "juan.perez@estudiante.com (estudiante)",
                        "maria.gonzalez@liceorios.cl (profesora)",
                        "carlos.admin@liceorios.cl (personal)",
                        "ana.torres@outlook.com (externo)",
                    ],
                    usage: [
                        "Verifica que el email esté activo",
                        "Prefiere emails institucionales cuando sea posible",
                        "Se usará para recordatorios de devolución",
                        "Permite comunicación directa sobre el préstamo",
                    ],
                },
                returnDate: {
                    title: "Fecha de Devolución",
                    question: "¿Cómo establecer la fecha límite?",
                    description:
                        "Fecha en la que el producto debe ser devuelto al inventario.",
                    examples: [
                        "Una semana para equipos tecnológicos",
                        "Un mes para libros de estudio",
                        "Mismo día para materiales de clase",
                        "Fin de semestre para proyectos largos",
                    ],
                    usage: [
                        "Considera el tipo de producto y su demanda",
                        "Establece fechas realistas según el uso",
                        "El sistema alertará 3 días antes del vencimiento",
                        "Puedes extender el plazo si es necesario",
                    ],
                },
                bookAuthor: {
                    title: "Autor del Libro",
                    question: "¿Cómo registrar correctamente el autor?",
                    description:
                        "Nombre completo del autor principal del libro, siguiendo las convenciones bibliográficas.",
                    examples: [
                        "Gabriel García Márquez",
                        "Isabel Allende",
                        "Mario Vargas Llosa",
                        "Pablo Neruda",
                    ],
                    usage: [
                        "Escribe nombre y apellido completos",
                        "Si hay múltiples autores, ingresa el principal",
                        "Usa la forma como aparece en la portada del libro",
                        "Evita abreviaciones innecesarias",
                    ],
                },
                bookPublisher: {
                    title: "Editorial del Libro",
                    question: "¿Qué editorial registrar?",
                    description:
                        "Casa editorial o sello que publicó esta edición específica del libro.",
                    examples: [
                        "Planeta",
                        "Sudamericana",
                        "Alfaguara",
                        "Editorial Universitaria",
                    ],
                    usage: [
                        "Busca en la página de créditos del libro",
                        "Usa el nombre exacto como aparece",
                        "Importante para identificar ediciones",
                        "Útil para contactar por reposiciones",
                    ],
                },
                bookYear: {
                    title: "Año de Publicación",
                    question: "¿Qué año registrar?",
                    description:
                        "Año en que se publicó esta edición específica del libro.",
                    examples: [
                        "2024 (edición más reciente)",
                        "2020 (edición utilizada en clases)",
                        "1967 (primera edición histórica)",
                        "2022 (reedición actualizada)",
                    ],
                    usage: [
                        "Busca en la página de créditos",
                        "Usa el año de la edición que tienes físicamente",
                        "No confundir con el año de primera publicación",
                        "Importante para identificar versiones actualizadas",
                    ],
                },
                bookISBN: {
                    title: "Código ISBN",
                    question: "¿Dónde encuentro el ISBN?",
                    description:
                        "Código internacional único de 13 dígitos que identifica específicamente esta edición.",
                    examples: [
                        "978-956-200-123-4",
                        "978-84-376-0494-7",
                        "978-987-1144-25-6",
                        "978-956-16-0123-9",
                    ],
                    usage: [
                        "Busca en la contraportada o página de créditos",
                        "Incluye los guiones para mayor claridad",
                        "Es único para cada edición del libro",
                        "Útil para pedidos y catalogación",
                    ],
                },
                bookSynopsis: {
                    title: "Sinopsis del Libro",
                    question: "¿Qué incluir en la sinopsis?",
                    description:
                        "Resumen breve del contenido, tema principal o propósito educativo del libro.",
                    examples: [
                        "Novela sobre el realismo mágico en Macondo",
                        "Manual de matemáticas para enseñanza media",
                        "Historia de Chile desde la independencia",
                        "Guía de experimentos de química básica",
                    ],
                    usage: [
                        "Mantén el resumen breve pero descriptivo",
                        "Incluye el género o área temática",
                        "Menciona si es texto de estudio o literatura",
                        "Este campo es opcional pero recomendado",
                    ],
                },
                bookQuantity: {
                    title: "Ejemplares del Libro",
                    question: "¿Cuántos ejemplares ingresar?",
                    description:
                        "Número total de copias idénticas del mismo libro que se están agregando al inventario.",
                    examples: [
                        "30 (para un curso completo)",
                        "1 (libro de consulta único)",
                        "15 (para medio curso)",
                        "50 (libro muy solicitado)",
                    ],
                    usage: [
                        "Cuenta físicamente todos los ejemplares idénticos",
                        "Solo incluye libros en buenas condiciones",
                        "Considera la demanda esperada",
                        "Puedes agregar más ejemplares posteriormente",
                    ],
                },
                bookStatus: {
                    title: "Estado del Libro",
                    question: "¿Qué estado asignar al libro?",
                    description:
                        "Condición actual del libro para control de disponibilidad y préstamos.",
                    examples: [
                        "Disponible: Libros listos para préstamo",
                        "En uso: Libros prestados a estudiantes",
                        "Mantenimiento: Libros que necesitan reparación",
                        "No disponible: Libros dañados o perdidos",
                    ],
                    usage: [
                        'La mayoría de libros nuevos serán "Disponible"',
                        "Revisa el estado físico antes de decidir",
                        "Considera si necesita reparación de páginas o pasta",
                        'Los libros dañados deben marcarse como "No disponible"',
                    ],
                },
                returnBorrowerRut: {
                    title: "RUT del Solicitante (Devolución)",
                    question: "¿Por qué necesito el RUT para la devolución?",
                    description:
                        "El RUT permite identificar exactamente qué préstamo se está devolviendo, evitando confusiones cuando hay múltiples préstamos del mismo producto.",
                    examples: [
                        "12.345.678-9 (con puntos y guión)",
                        "20.123.456-K (dígito verificador K)",
                        "15.987.654-0 (estudiante)",
                        "8.765.432-1 (profesor)",
                    ],
                    usage: [
                        "Debe coincidir exactamente con el RUT usado en el préstamo",
                        "El sistema verificará que exista un préstamo activo para este RUT",
                        "Incluye puntos y guión para mayor claridad",
                        "Si no encuentra el préstamo, verifica que el RUT y código sean correctos",
                    ],
                },
                title: "Cantidad a Devolver",
                question: "¿Cuántas unidades se están devolviendo?",
                description:
                    "Número de unidades del producto que el solicitante está regresando al inventario.",
                examples: [
                    "1 (para productos únicos como proyectores)",
                    "2 (si prestó múltiples calculadoras)",
                    "5 (libros para grupo de estudio)",
                    "3 (materiales de laboratorio)",
                ],
                usage: [
                    "Debe coincidir con lo que físicamente se está devolviendo",
                    "No puede exceder la cantidad originalmente prestada",
                    "Verifica que todas las unidades estén presentes",
                    "El stock se actualizará automáticamente",
                ],

                returnObservation: {
                    title: "Observación de Devolución",
                    question: "¿Qué observaciones registrar?",
                    description:
                        "Comentarios sobre el estado del producto devuelto y cualquier incidencia durante el préstamo.",
                    examples: [
                        "Producto en perfecto estado",
                        "Pantalla rayada en esquina inferior",
                        "Falta cable de alimentación",
                        "Funcionando correctamente, sin problemas",
                    ],
                    usage: [
                        "Documenta cualquier daño o problema encontrado",
                        "Incluye detalles específicos para futuras referencias",
                        "Si hay daños, considera cambiar el estado del producto",
                        "Campo opcional pero recomendado para trazabilidad",
                    ],
                },
                removeQuantity: {
                    title: "Cantidad a Dar de Baja",
                    question: "¿Cuántas unidades dar de baja?",
                    description:
                        "Número de unidades que se retirarán del inventario por el motivo especificado.",
                    examples: [
                        "1 (producto único dañado)",
                        "3 (calculadoras rotas)",
                        "10 (libros deteriorados por uso)",
                        "2 (equipos obsoletos)",
                    ],
                    usage: [
                        "Solo incluye unidades que realmente necesitan baja",
                        "No puede exceder el stock actual disponible",
                        "El stock se reducirá permanentemente",
                        "Documenta bien el motivo para auditorías",
                    ],
                },
                removeReason: {
                    title: "Motivo de la Baja",
                    question: "¿Por qué dar de baja el producto?",
                    description:
                        "Razón específica por la cual se retira el producto del inventario activo.",
                    examples: [
                        "Equipo dañado irreparablemente",
                        "Producto obsoleto, reemplazado por nueva tecnología",
                        "Pérdida durante transporte",
                        "Desgaste normal por uso intensivo",
                    ],
                    usage: [
                        "Sé específico y detallado en la explicación",
                        "Incluye fecha del incidente si aplica",
                        "Información importante para seguros y auditorías",
                        "Ayuda a identificar patrones de problemas",
                    ],
                },
                deleteReason: {
                    title: "Motivo de Eliminación Completa",
                    question: "¿Por qué eliminar completamente del sistema?",
                    description:
                        "Razón por la cual se debe borrar totalmente el registro del producto del sistema.",
                    examples: [
                        "Error en el registro inicial",
                        "Producto registrado por duplicado",
                        "Nunca se recibió físicamente",
                        "Transferido a otra institución",
                    ],
                    usage: [
                        "Úsalo solo cuando sea absolutamente necesario",
                        "Esta acción no se puede deshacer",
                        "Documenta detalladamente el motivo",
                        'Diferente a "dar de baja" - esto elimina todo rastro',
                    ],
                },
                deleteConfirmation: {
                    title: "Confirmación de Eliminación",
                    question: "¿Cómo confirmar la eliminación?",
                    description:
                        "Medida de seguridad para evitar eliminaciones accidentales del sistema.",
                    examples: [
                        "CONFIRMAR (exactamente como se muestra)",
                        'No funcionan variaciones como "confirmar" o "Confirmar"',
                        "Debe ser en mayúsculas y completo",
                        "Sin espacios adicionales antes o después",
                    ],
                    usage: [
                        'Escribe exactamente "CONFIRMAR" sin comillas',
                        "Verifica dos veces antes de confirmar",
                        "Esta acción eliminará permanentemente el producto",
                        "No hay forma de recuperar la información después",
                    ],
                },
                barcode: {
                    title: "Código de Barra del Producto",
                    question: "¿Qué es el código de barra?",
                    description:
                        "Es un identificador único para cada producto en el sistema. Puede ser un código de barras tradicional o cualquier código alfanumérico.",
                    examples: [
                        "123456789012 (código numérico)",
                        "LIB-001-2024 (código personalizado)",
                        "EQ-COMP-001 (código de equipo)",
                        "ISBN-9780123456789 (para libros)",
                    ],
                    usage: [
                        "Usa un lector de código de barras para escanear directamente",
                        "O escribe el código manualmente",
                        "El sistema verificará automáticamente si el código ya existe",
                        "Para productos nuevos, el código debe ser único",
                    ],
                },
                productName: {
                    title: "Nombre del Producto",
                    question: "¿Cómo nombrar el producto?",
                    description:
                        "Escribe un nombre descriptivo y claro que identifique fácilmente el producto.",
                    examples: [
                        "Proyector Epson EB-X41",
                        "Calculadora Científica Casio FX-991EX",
                        "Libro: Cien años de soledad",
                        "Microscopio Óptico 400x",
                    ],
                    usage: [
                        "Incluye marca y modelo cuando sea relevante",
                        "Usa términos específicos y descriptivos",
                        "Evita abreviaciones confusas",
                        "Mantén consistencia en la nomenclatura",
                    ],
                },
                location: {
                    title: "Ubicación en el Almacén",
                    question: "¿Cómo funciona el sistema de ubicación?",
                    description:
                        "El sistema usa un código de tres partes para localizar exactamente donde está cada producto.",
                    examples: [
                        "Estantería: Materiales - Rack: A1 - Nivel: 3",
                        "Estantería: Biblioteca - Rack: B2 - Nivel: 1",
                        "Estantería: Equipos - Rack: Principal - Nivel: 2",
                        "Estantería: A - Rack: 5 - Nivel: 1",
                    ],
                    usage: [
                        "Estantería: Cualquier nombre o código (A, B, Materiales, Biblioteca, etc.)",
                        "Rack: Número o código de la sección (1, 2, A1, Principal, etc.)",
                        "Nivel: Altura o piso - máximo 3 caracteres (1, 2, 3, etc.)",
                        "La ubicación se muestra como: 📚 Est. X • 📦 Rack Y • 🔢 Nivel Z",
                    ],
                },
            };

            const info = infoContent[type];
            if (info) {
                title.textContent = info.title;
                body.innerHTML = `
                    <div class="info-question">${info.question}</div>
                    <div class="info-description">${info.description}</div>
                    <div class="info-examples">
                        <h4>Ejemplos válidos:</h4>
                        <ul class="example-list">
                            ${info.examples
                        .map((example) => `<li>${example}</li>`)
                        .join("")}
                        </ul>
                    </div>
                    <div class="info-usage">
                        <h4>¿Cómo usarlo?</h4>
                        <ul class="usage-list">
                            ${info.usage
                        .map((usage) => `<li>${usage}</li>`)
                        .join("")}
                        </ul>
                    </div>
                `;
                modal.style.display = "block";
            }
        }

        function closeInfoModal() {
            document.getElementById("infoModal").style.display = "none";
        }

        function updateLocationPreview() {
            const shelf = document.getElementById("productShelf")?.value || "";
            const rack = document.getElementById("productRack")?.value || "";
            const level = document.getElementById("productLevel")?.value || "";

            const preview = document.getElementById("locationPreview");
            if (preview) {
                if (shelf && rack && level) {
                    preview.textContent = `📚 Est. ${shelf} • 📦 Rack ${rack} • 🔢 Nivel ${level}`;
                    preview.style.color = "var(--primary)";
                } else {
                    preview.textContent =
                        "📚 Est. Materiales • 📦 Rack A1 • 🔢 Nivel 3";
                    preview.style.color = "var(--gray-500)";
                }
            }
        }

        function updateBookLocationPreview() {
            const shelf = document.getElementById("bookShelf")?.value || "";
            const rack = document.getElementById("bookRack")?.value || "";
            const level = document.getElementById("bookLevel")?.value || "";

            const preview = document.getElementById("bookLocationPreview");
            if (preview) {
                if (shelf && rack && level) {
                    preview.textContent = `📚 Est. ${shelf} • 📦 Rack ${rack} • 🔢 Nivel ${level}`;
                    preview.style.color = "var(--primary)";
                } else {
                    preview.textContent =
                        "📚 Est. Biblioteca • 📦 Rack A1 • 🔢 Nivel 1";
                    preview.style.color = "var(--gray-500)";
                }
            }
        }

        function getModalTitle(operation) {
            const titles = {
                addProduct: "➕ Ingresar Producto Nuevo",
                updateStock: "📈 Aumentar Stock",
                lendProduct: "🤝 Registrar Préstamo",
                returnProduct: "↩️ Procesar Devolución",
                removeProduct: "❌ Dar de Baja Producto",
                deleteProduct: "🗑️ Eliminar Producto Completo",
            };
            return titles[operation] || "Operación";
        }

        function getModalContent(operation) {
            switch (operation) {
                case "addProduct":
                    return `
                        <form onsubmit="addProduct(event)">
                            <div class="form-group">
                                <label class="form-label">
                                    📂 Categoría *
                                    <button class="help-icon" onclick="showInfoModal('category')" type="button">?</button>
                                </label>
                                <select class="form-input" id="productCategory" onchange="toggleProductFields()" required>
                                    <option value="">Seleccionar categoría...</option>
                                    <option value="Equipo">🖥️ Equipo</option>
                                    <option value="Libro">📚 Libro</option>
                                    <option value="Documento">📄 Documento</option>
                                    <option value="Material">📝 Material</option>
                                    <option value="Herramienta">🔧 Herramienta</option>
                                </select>
                            </div>
                            
                            <div id="generalFields" class="hidden">
                                <div class="form-row">
                                    <div class="form-group">
                                        <label class="form-label">
                                            🏷️ Código de Barra *
                                            <button class="help-icon" onclick="showInfoModal('barcode')" type="button">?</button>
                                        </label>
                                        <input type="text" class="form-input" id="productCode" placeholder="001-EQ-001">
                                    </div>
                                    <div class="form-group">
                                        <label class="form-label">
                                            📝 Nombre del Producto *
                                            <button class="help-icon" onclick="showInfoModal('productName')" type="button">?</button>
                                        </label>
                                        <input type="text" class="form-input" id="productName" placeholder="Nombre del producto">
                                    </div>
                                </div>
                                <div class="form-row">
                                    <div class="form-group">
                                        <label class="form-label">
                                            🏢 Marca
                                            <button class="help-icon" onclick="showInfoModal('brand')" type="button">?</button>
                                        </label>
                                        <input type="text" class="form-input" id="productBrand" placeholder="Marca">
                                    </div>
                                    <div class="form-group">
                                        <label class="form-label">
                                            🏷️ Modelo
                                            <button class="help-icon" onclick="showInfoModal('model')" type="button">?</button>
                                        </label>
                                        <input type="text" class="form-input" id="productModel" placeholder="Modelo">
                                    </div>
                                </div>
                                <div class="form-group">
                                    <label class="form-label">
                                        📝 Descripción
                                        <button class="help-icon" onclick="showInfoModal('description')" type="button">?</button>
                                    </label>
                                    <textarea class="form-input" id="productDescription" placeholder="Descripción del producto" rows="3"></textarea>
                                </div>
                                <div class="form-row">
                                    <div class="form-group">
                                        <label class="form-label">
                                            📊 Cantidad *
                                            <button class="help-icon" onclick="showInfoModal('quantity')" type="button">?</button>
                                        </label>
                                        <input type="number" class="form-input" id="productQuantity" min="1" placeholder="1">
                                    </div>
                                    <div class="form-group">
                                        <label class="form-label">
                                            🔄 Estado *
                                            <button class="help-icon" onclick="showInfoModal('status')" type="button">?</button>
                                        </label>
                                        <select class="form-input" id="productStatus">
                                            <option value="Disponible">✅ Disponible</option>
                                            <option value="En uso">🔄 En uso</option>
                                            <option value="Mantenimiento">🔧 Mantenimiento</option>
                                            <option value="No disponible">❌ No disponible</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="form-group">
                                    <label class="form-label">
                                        📍 Ubicación en el Almacén *
                                        <button class="help-icon" onclick="showInfoModal('location')" type="button">?</button>
                                    </label>
                                    <div class="location-grid">
                                        <div class="location-field">
                                            <label>📚 Estantería:</label>
                                            <input type="text" class="location-input" id="productShelf" placeholder="Materiales" onkeyup="updateLocationPreview()">
                                        </div>
                                        <div class="location-field">
                                            <label>📦 Rack:</label>
                                            <input type="text" class="location-input" id="productRack" placeholder="A1" onkeyup="updateLocationPreview()">
                                        </div>
                                        <div class="location-field">
                                            <label>🔢 Nivel:</label>
                                            <input type="text" class="location-input" id="productLevel" placeholder="3" maxlength="3" onkeyup="updateLocationPreview()">
                                        </div>
                                    </div>
                                    <div class="location-preview">
                                        <div class="location-preview-value" id="locationPreview">📚 Est. Materiales • 📦 Rack A1 • 🔢 Nivel 3</div>
                                    </div>
                                </div>
                            </div>
                            
                            <div id="bookFields" class="hidden">
                                <div class="form-row">
                                    <div class="form-group">
                                        <label class="form-label">
                                            🏷️ Código de Barra *
                                            <button class="help-icon" onclick="showInfoModal('barcode')" type="button">?</button>
                                        </label>
                                        <input type="text" class="form-input" id="bookCode" placeholder="002-LIB-001">
                                    </div>
                                    <div class="form-group">
                                        <label class="form-label">
                                            📖 Título del Libro *
                                            <button class="help-icon" onclick="showInfoModal('productName')" type="button">?</button>
                                        </label>
                                        <input type="text" class="form-input" id="bookTitle" placeholder="Título del libro">
                                    </div>
                                </div>
                                <h4 style="margin: 1.5rem 0; color: var(--gray-700);">📚 Información Específica del Libro</h4>
                                <div class="form-row">
                                    <div class="form-group">
                                        <label class="form-label">
                                            ✍️ Autor *
                                            <button class="help-icon" onclick="showInfoModal('bookAuthor')" type="button">?</button>
                                        </label>
                                        <input type="text" class="form-input" id="bookAuthor" placeholder="Nombre del autor">
                                    </div>
                                    <div class="form-group">
                                        <label class="form-label">
                                            🏢 Editorial *
                                            <button class="help-icon" onclick="showInfoModal('bookPublisher')" type="button">?</button>
                                        </label>
                                        <input type="text" class="form-input" id="bookPublisher" placeholder="Editorial">
                                    </div>
                                </div>
                                <div class="form-row">
                                    <div class="form-group">
                                        <label class="form-label">
                                            📅 Año de Publicación *
                                            <button class="help-icon" onclick="showInfoModal('bookYear')" type="button">?</button>
                                        </label>
                                        <input type="number" class="form-input" id="bookYear" min="1000" max="2025" placeholder="2024">
                                    </div>
                                    <div class="form-group">
                                        <label class="form-label">
                                            🔢 ISBN *
                                            <button class="help-icon" onclick="showInfoModal('bookISBN')" type="button">?</button>
                                        </label>
                                        <input type="text" class="form-input" id="bookISBN" placeholder="978-XXX-XXX-XXX-X">
                                    </div>
                                </div>
                                <div class="form-group">
                                    <label class="form-label">
                                        📝 Sinopsis/Descripción
                                        <button class="help-icon" onclick="showInfoModal('bookSynopsis')" type="button">?</button>
                                    </label>
                                    <textarea class="form-input" id="bookSynopsis" placeholder="Descripción del contenido del libro" rows="3"></textarea>
                                </div>
                                <div class="form-row">
                                    <div class="form-group">
                                        <label class="form-label">
                                            📊 Ejemplares *
                                            <button class="help-icon" onclick="showInfoModal('bookQuantity')" type="button">?</button>
                                        </label>
                                        <input type="number" class="form-input" id="bookQuantity" min="1" placeholder="1">
                                    </div>
                                    <div class="form-group">
                                        <label class="form-label">
                                            🔄 Estado *
                                            <button class="help-icon" onclick="showInfoModal('bookStatus')" type="button">?</button>
                                        </label>
                                        <select class="form-input" id="bookStatus">
                                            <option value="Disponible">✅ Disponible</option>
                                            <option value="En uso">🔄 En uso</option>
                                            <option value="Mantenimiento">🔧 Mantenimiento</option>
                                            <option value="No disponible">❌ No disponible</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="form-group">
                                    <label class="form-label">
                                        📍 Ubicación en el Almacén *
                                        <button class="help-icon" onclick="showInfoModal('location')" type="button">?</button>
                                    </label>
                                    <div class="location-grid">
                                        <div class="location-field">
                                            <label>📚 Estantería:</label>
                                            <input type="text" class="location-input" id="bookShelf" placeholder="Biblioteca" onkeyup="updateBookLocationPreview()">
                                        </div>
                                        <div class="location-field">
                                            <label>📦 Rack:</label>
                                            <input type="text" class="location-input" id="bookRack" placeholder="A1" onkeyup="updateBookLocationPreview()">
                                        </div>
                                        <div class="location-field">
                                            <label>🔢 Nivel:</label>
                                            <input type="text" class="location-input" id="bookLevel" placeholder="1" maxlength="3" onkeyup="updateBookLocationPreview()">
                                        </div>
                                    </div>
                                    <div class="location-preview">
                                        <div class="location-preview-value" id="bookLocationPreview">📚 Est. Biblioteca • 📦 Rack A1 • 🔢 Nivel 1</div>
                                    </div>
                                </div>
                            </div>
                            
                            <button type="submit" class="btn btn-primary" style="margin-top: 1.5rem;">
                                ✅ Ejecutar Operación
                            </button>
                        </form>
                    `;

                case "updateStock":
                    return `
                        <form onsubmit="updateStock(event)">
                            <div class="form-group">
                                <label class="form-label">
                                    🏷️ Código de Barra *
                                    <button class="help-icon" onclick="showInfoModal('barcode')" type="button">?</button>
                                </label>
                                <input type="text" class="form-input" id="stockCode" onblur="verifyProduct('stock')" placeholder="001-EQ-001" required>
                            </div>
                            <div id="stockProductInfo"></div>
                            <div class="form-group">
                                <label class="form-label">
                                    📊 Cantidad a Aumentar *
                                    <button class="help-icon" onclick="showInfoModal('stockQuantity')" type="button">?</button>
                                </label>
                                <input type="number" class="form-input" id="stockQuantity" min="1" placeholder="1" required>
                            </div>
                            <button type="submit" class="btn btn-primary">✅ Ejecutar Operación</button>
                        </form>
                    `;

                case "lendProduct":
                    return `
                        <form onsubmit="lendProduct(event)">
                            <div class="form-group">
                                <label class="form-label">
                                    🏷️ Código de Barra *
                                    <button class="help-icon" onclick="showInfoModal('barcode')" type="button">?</button>
                                </label>
                                <input type="text" class="form-input" id="lendCode" onblur="verifyProduct('lend')" placeholder="001-EQ-001" required>
                            </div>
                            <div id="lendProductInfo"></div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label class="form-label">
                                        📊 Cantidad *
                                        <button class="help-icon" onclick="showInfoModal('lendQuantity')" type="button">?</button>
                                    </label>
                                    <input type="number" class="form-input" id="lendQuantity" min="1" placeholder="1" required>
                                </div>
                                <div class="form-group">
                                    <label class="form-label">
                                        👤 Nombre del Solicitante *
                                        <button class="help-icon" onclick="showInfoModal('borrowerInfo')" type="button">?</button>
                                    </label>
                                    <input type="text" class="form-input" id="borrowerName" placeholder="Juan Pérez" required>
                                </div>
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label class="form-label">
                                        🆔 RUT del Solicitante *
                                        <button class="help-icon" onclick="showInfoModal('borrowerRut')" type="button">?</button>
                                    </label>
                                    <input type="text" class="form-input" id="borrowerRut" placeholder="12.345.678-9" required>
                                </div>
                                <div class="form-group">
                                    <label class="form-label">
                                        📧 Correo del Solicitante *
                                        <button class="help-icon" onclick="showInfoModal('borrowerEmail')" type="button">?</button>
                                    </label>
                                    <input type="email" class="form-input" id="borrowerEmail" placeholder="juan@estudiante.com" required>
                                </div>
                            </div>
                            <div class="form-group">
                                <label class="form-label">
                                    📅 Fecha de Devolución *
                                    <button class="help-icon" onclick="showInfoModal('returnDate')" type="button">?</button>
                                </label>
                                <input type="date" class="form-input" id="returnDate" required>
                            </div>
                            <button type="submit" class="btn btn-primary">✅ Ejecutar Operación</button>
                        </form>
                    `;

                case "returnProduct":
                    return `
                        <form onsubmit="returnProduct(event)">
                            <div class="form-group">
                                <label class="form-label">
                                    🏷️ Código de Barra *
                                    <button class="help-icon" onclick="showInfoModal('barcode')" type="button">?</button>
                                </label>
                                <input type="text" class="form-input" id="returnCode" onblur="verifyProduct('return')" placeholder="001-EQ-001" required>
                            </div>
                            <div id="returnProductInfo"></div>
                            <div class="form-group">
                                <label class="form-label">
                                    🆔 RUT del Solicitante *
                                    <button class="help-icon" onclick="showInfoModal('returnBorrowerRut')" type="button">?</button>
                                </label>
                                <input type="text" class="form-input" id="returnBorrowerRut" onblur="verifyActiveLoan()" placeholder="12.345.678-9" required>
                            </div>
                            <div id="activeLoanInfo"></div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label class="form-label">
                                        📊 Cantidad *
                                        <button class="help-icon" onclick="showInfoModal('returnQuantity')" type="button">?</button>
                                    </label>
                                    <input type="number" class="form-input" id="returnQuantity" min="1" placeholder="1" required>
                                </div>
                                <div class="form-group">
                                    <label class="form-label">
                                        📝 Observación
                                        <button class="help-icon" onclick="showInfoModal('returnObservation')" type="button">?</button>
                                    </label>
                                    <textarea class="form-input" id="returnObservation" placeholder="Estado del producto devuelto..." rows="3"></textarea>
                                </div>
                            </div>
                            <button type="submit" class="btn btn-primary">✅ Ejecutar Operación</button>
                        </form>
                    `;

                case "removeProduct":
                    return `
                        <form onsubmit="removeProduct(event)">
                            <div class="form-group">
                                <label class="form-label">
                                    🏷️ Código de Barra *
                                    <button class="help-icon" onclick="showInfoModal('barcode')" type="button">?</button>
                                </label>
                                <input type="text" class="form-input" id="removeCode" onblur="verifyProduct('remove')" placeholder="001-EQ-001" required>
                            </div>
                            <div id="removeProductInfo"></div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label class="form-label">
                                        📊 Cantidad *
                                        <button class="help-icon" onclick="showInfoModal('removeQuantity')" type="button">?</button>
                                    </label>
                                    <input type="number" class="form-input" id="removeQuantity" min="1" placeholder="1" required>
                                </div>
                                <div class="form-group">
                                    <label class="form-label">
                                        📝 Motivo de la Baja *
                                        <button class="help-icon" onclick="showInfoModal('removeReason')" type="button">?</button>
                                    </label>
                                    <textarea class="form-input" id="removeReason" placeholder="Explicar motivo de la baja..." rows="3" required></textarea>
                                </div>
                            </div>
                            <button type="submit" class="btn btn-danger">❌ Ejecutar Operación</button>
                        </form>
                    `;

                case "deleteProduct":
                    return `
                        <form onsubmit="deleteProduct(event)">
                            <div class="alert alert-danger">
                                <span>⚠️</span>
                                <div>
                                    <strong>¡ATENCIÓN!</strong> Esta acción eliminará completamente el producto del sistema.
                                    Esta operación NO se puede deshacer.
                                </div>
                            </div>
                            <div class="form-group">
                                <label class="form-label">
                                    🏷️ Código de Barra *
                                    <button class="help-icon" onclick="showInfoModal('barcode')" type="button">?</button>
                                </label>
                                <input type="text" class="form-input" id="deleteCode" onblur="verifyProduct('delete')" placeholder="001-EQ-001" required>
                            </div>
                            <div id="deleteProductInfo"></div>
                            <div class="form-group">
                                <label class="form-label">
                                    📝 Motivo de la Eliminación *
                                    <button class="help-icon" onclick="showInfoModal('deleteReason')" type="button">?</button>
                                </label>
                                <textarea class="form-input" id="deleteReason" placeholder="Explicar motivo de la eliminación completa..." rows="3" required></textarea>
                            </div>
                            <div class="form-group">
                                <label class="form-label">
                                    ✍️ Confirmación *
                                    <button class="help-icon" onclick="showInfoModal('deleteConfirmation')" type="button">?</button>
                                </label>
                                <input type="text" class="form-input" id="deleteConfirmation" placeholder="Escribe CONFIRMAR para continuar" required>
                            </div>
                            <button type="submit" class="btn btn-danger">🗑️ Eliminar Producto Completo</button>
                        </form>
                    `;
                default:
                    return "<p>Operación no disponible</p>";
            }
        }

        function toggleProductFields() {
            const category = document.getElementById("productCategory").value;
            const generalFields = document.getElementById("generalFields");
            const bookFields = document.getElementById("bookFields");

            generalFields.classList.add("hidden");
            bookFields.classList.add("hidden");

            if (category === "Libro") {
                bookFields.classList.remove("hidden");
            } else if (category && category !== "") {
                generalFields.classList.remove("hidden");
            }
        }

        function verifyProduct(operation) {
            const codeField = document.getElementById(`${operation}Code`);
            const infoDiv = document.getElementById(`${operation}ProductInfo`);
            const code = codeField.value.trim();

            if (!code) return;

            const product = products.find((p) => p.code === code);
            if (product) {
                infoDiv.innerHTML = `
                    <div class="alert alert-success">
                        <span>✅</span>
                        <div>
                            <strong>Producto encontrado:</strong> ${product.name} (${product.category})
                            <br><strong>📊 Stock actual:</strong> ${product.quantity}
                        </div>
                    </div>
                `;
            } else {
                infoDiv.innerHTML = `
                    <div class="alert alert-danger">
                        <span>❌</span>
                        <div>
                            <strong>Producto no encontrado</strong> con el código: ${code}
                        </div>
                    </div>
                `;
            }
        }

        function verifyActiveLoan() {
            const rutField = document.getElementById("returnBorrowerRut");
            const codeField = document.getElementById("returnCode");
            const infoDiv = document.getElementById("activeLoanInfo");

            if (!rutField || !codeField) return;

            const rut = rutField.value.trim();
            const code = codeField.value.trim();

            if (!rut || !code) return;

            // Buscar préstamos activos para este RUT
            const userLoans = loans.filter(loan =>
                loan.status === "Activo" && loan.borrowerRut === rut
            );

            if (userLoans.length === 0) {
                infoDiv.innerHTML = `
            <div class="alert alert-danger">
                <span>❌</span>
                <div>
                    <strong>No se encontraron préstamos activos</strong><br>
                    Para el RUT: ${rut}<br>
                    Verifica que el RUT sea correcto.
                </div>
            </div>
        `;
                return;
            }

            // Buscar préstamo específico por código
            let matchingLoan = null;
            let isGroupLoan = false;
            let availableCodes = [];

            // Buscar en préstamos individuales
            matchingLoan = userLoans.find(loan => loan.productCode === code);

            if (!matchingLoan) {
                // Buscar en préstamos grupales
                matchingLoan = userLoans.find(loan =>
                    loan.bulkLoan &&
                    loan.individualCodes &&
                    loan.individualCodes.includes(code)
                );

                if (matchingLoan) {
                    isGroupLoan = true;
                    availableCodes = matchingLoan.individualCodes;
                }
            }

            if (!matchingLoan) {
                // Mostrar préstamos disponibles para ayudar al usuario
                const loansList = userLoans.map(loan => {
                    if (loan.bulkLoan) {
                        return `• ${loan.productName} (${loan.quantity} unidades) - Códigos: ${loan.individualCodes.slice(0, 3).join(', ')}${loan.individualCodes.length > 3 ? '...' : ''}`;
                    } else {
                        return `• ${loan.productName} - Código: ${loan.productCode}`;
                    }
                }).join('<br>');

                infoDiv.innerHTML = `
            <div class="alert alert-danger">
                <span>❌</span>
                <div>
                    <strong>Código no encontrado en préstamos activos</strong><br>
                    Código buscado: ${code}<br><br>
                    <strong>Préstamos activos para ${rut}:</strong><br>
                    ${loansList}
                </div>
            </div>
        `;
                return;
            }

            // Mostrar información del préstamo encontrado
            if (isGroupLoan) {
                const remainingCodes = matchingLoan.individualCodes.length;
                const returnedCodes = matchingLoan.returnedCodes ? matchingLoan.returnedCodes.length : 0;

                infoDiv.innerHTML = `
            <div class="alert alert-success">
                <span>✅</span>
                <div>
                    <strong>Préstamo grupal encontrado:</strong><br>
                    👤 <strong>Solicitante:</strong> ${matchingLoan.borrower}<br>
                    📦 <strong>Producto:</strong> ${matchingLoan.productName}<br>
                    📊 <strong>Cantidad original:</strong> ${matchingLoan.quantity} unidades<br>
                    📊 <strong>Pendientes:</strong> ${remainingCodes - returnedCodes} unidades<br>
                    🏷️ <strong>Código seleccionado:</strong> ${code}<br>
                    📅 <strong>Fecha préstamo:</strong> ${matchingLoan.loanDate}<br>
                    📅 <strong>Fecha devolución:</strong> ${matchingLoan.returnDate}<br><br>
                    
                    <div style="background: rgba(52, 152, 219, 0.1); padding: 1rem; border-radius: 0.5rem; margin-top: 1rem;">
                        <strong>🎯 Opciones de devolución:</strong><br>
                        • <strong>Devolución individual:</strong> Solo este código (${code})<br>
                        • <strong>Devolución completa:</strong> Todos los productos del préstamo
                    </div>
                </div>
            </div>
            
            <div style="margin-top: 1rem;">
                <label style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 1rem;">
                    <input type="radio" name="returnType" value="individual" checked onchange="updateReturnType()">
                    <span>🔧 Devolver solo este código (1 unidad)</span>
                </label>
                <label style="display: flex; align-items: center; gap: 0.5rem;">
                    <input type="radio" name="returnType" value="complete" onchange="updateReturnType()">
                    <span>📦 Devolver todos los productos del préstamo (${remainingCodes - returnedCodes} unidades)</span>
                </label>
            </div>
        `;

                // Auto-configurar cantidad
                const quantityField = document.getElementById("returnQuantity");
                if (quantityField) {
                    quantityField.value = 1;
                    quantityField.max = remainingCodes - returnedCodes;
                }

            } else {
                // Préstamo individual normal
                infoDiv.innerHTML = `
            <div class="alert alert-success">
                <span>✅</span>
                <div>
                    <strong>Préstamo individual encontrado:</strong><br>
                    👤 <strong>Solicitante:</strong> ${matchingLoan.borrower}<br>
                    📦 <strong>Producto:</strong> ${matchingLoan.productName}<br>
                    📊 <strong>Cantidad prestada:</strong> ${matchingLoan.quantity}<br>
                    📅 <strong>Fecha préstamo:</strong> ${matchingLoan.loanDate}<br>
                    📅 <strong>Fecha devolución:</strong> ${matchingLoan.returnDate}
                </div>
            </div>
        `;

                const quantityField = document.getElementById("returnQuantity");
                if (quantityField) {
                    quantityField.value = matchingLoan.quantity;
                    quantityField.max = matchingLoan.quantity;
                }
            }

            // Guardar información del préstamo para usar en la devolución
            window.currentLoanInfo = {
                loan: matchingLoan,
                isGroupLoan: isGroupLoan,
                selectedCode: code,
                availableCodes: availableCodes
            };
        }

        async function deleteProduct(event) {
            event.preventDefault();

            const code = document.getElementById("deleteCode").value.trim();
            const reason = document.getElementById("deleteReason").value.trim();
            const confirmation = document
                .getElementById("deleteConfirmation")
                .value.trim();

            if (confirmation !== "CONFIRMAR") {
                alert('❌ Debes escribir "CONFIRMAR" para autorizar la eliminación');
                return;
            }

            const product = products.find((p) => p.code === code);
            if (product) {
                if (
                    confirm(
                        `¿Estás seguro de eliminar completamente "${product.name}"? Esta acción NO se puede deshacer.`
                    )
                ) {
                    try {
                        if (isFirebaseReady) {
                            await db.collection("products").doc(product.id).delete();
                        } else {
                            const index = products.findIndex((p) => p.code === code);
                            if (index > -1) {
                                products.splice(index, 1);
                            }
                        }

                        await addToHistory(
                            "Eliminación completa",
                            product.name,
                            `Motivo: ${reason}`
                        );
                        showOperationSuccess(
                            "Producto eliminado completamente del sistema"
                        );
                    } catch (error) {
                        console.error("Error eliminando producto:", error);
                        alert("❌ Error eliminando producto. Intenta nuevamente.");
                    }
                }
            } else {
                alert("❌ Producto no encontrado");
            }
        }

        async function addProduct(event) {
            event.preventDefault();

            const category = document.getElementById("productCategory").value;

            if (!category) {
                alert("❌ Por favor selecciona una categoría");
                return;
            }

            let newProduct;

            if (category === "Libro") {
                const bookCode = document.getElementById("bookCode").value.trim();
                const bookTitle = document.getElementById("bookTitle").value.trim();
                const bookAuthor = document.getElementById("bookAuthor").value.trim();
                const bookPublisher = document
                    .getElementById("bookPublisher")
                    .value.trim();
                const bookYear = document.getElementById("bookYear").value;
                const bookISBN = document.getElementById("bookISBN").value.trim();
                const bookQuantity = document.getElementById("bookQuantity").value;
                const bookStatus = document.getElementById("bookStatus").value;
                const bookShelf = document.getElementById("bookShelf").value.trim();
                const bookRack = document.getElementById("bookRack").value.trim();
                const bookLevel = document.getElementById("bookLevel").value.trim();

                if (
                    !bookCode ||
                    !bookTitle ||
                    !bookAuthor ||
                    !bookPublisher ||
                    !bookYear ||
                    !bookISBN ||
                    !bookQuantity ||
                    !bookShelf ||
                    !bookRack ||
                    !bookLevel
                ) {
                    alert("❌ Por favor completa todos los campos obligatorios (*)");
                    return;
                }

                if (products.find((p) => p.code === bookCode)) {
                    alert("❌ Ya existe un producto con ese código");
                    return;
                }

                newProduct = {
                    code: bookCode,
                    name: bookTitle,
                    category: "Libro",
                    author: bookAuthor,
                    publisher: bookPublisher,
                    year: bookYear,
                    isbn: bookISBN,
                    synopsis: document.getElementById("bookSynopsis").value,
                    quantity: parseInt(bookQuantity),
                    status: bookStatus,
                    location: {
                        shelf: bookShelf,
                        rack: bookRack,
                        level: bookLevel,
                    },
                    createdAt: isFirebaseReady
                        ? firebase.firestore.FieldValue.serverTimestamp()
                        : new Date().toISOString(),
                };
            } else {
                const productCode = document
                    .getElementById("productCode")
                    .value.trim();
                const productName = document
                    .getElementById("productName")
                    .value.trim();
                const productQuantity =
                    document.getElementById("productQuantity").value;
                const productStatus = document.getElementById("productStatus").value;
                const productShelf = document
                    .getElementById("productShelf")
                    .value.trim();
                const productRack = document
                    .getElementById("productRack")
                    .value.trim();
                const productLevel = document
                    .getElementById("productLevel")
                    .value.trim();

                if (
                    !productCode ||
                    !productName ||
                    !productQuantity ||
                    !productShelf ||
                    !productRack ||
                    !productLevel
                ) {
                    alert("❌ Por favor completa todos los campos obligatorios (*)");
                    return;
                }

                if (products.find((p) => p.code === productCode)) {
                    alert("❌ Ya existe un producto con ese código");
                    return;
                }

                newProduct = {
                    code: productCode,
                    name: productName,
                    category: category,
                    brand: document.getElementById("productBrand").value,
                    model: document.getElementById("productModel").value,
                    description: document.getElementById("productDescription").value,
                    quantity: parseInt(productQuantity),
                    status: productStatus,
                    location: {
                        shelf: productShelf,
                        rack: productRack,
                        level: productLevel,
                    },
                    createdAt: isFirebaseReady
                        ? firebase.firestore.FieldValue.serverTimestamp()
                        : new Date().toISOString(),
                };
            }

            try {
                if (isFirebaseReady) {
                    await db.collection("products").add(newProduct);
                } else {
                    newProduct.id = products.length + 1;
                    products.push(newProduct);
                }

                await addToHistory(
                    "Ingreso de producto",
                    newProduct.name,
                    `Categoría: ${newProduct.category}, Cantidad: ${newProduct.quantity}`
                );
                showOperationSuccess("¡Producto agregado exitosamente!");
            } catch (error) {
                console.error("Error agregando producto:", error);
                alert("❌ Error agregando producto. Intenta nuevamente.");
            }
        }

        // Restore core functionality - ensuring all management functions work
        async function updateStock(event) {
            event.preventDefault();

            const code = document.getElementById("stockCode").value.trim();
            const quantity = parseInt(
                document.getElementById("stockQuantity").value
            );

            if (!code || !quantity || quantity <= 0) {
                alert("❌ Por favor completa todos los campos correctamente");
                return;
            }

            const product = products.find((p) => p.code === code);
            if (product) {
                try {
                    if (isFirebaseReady) {
                        const productRef = db.collection("products").doc(product.id);
                        await productRef.update({
                            quantity: firebase.firestore.FieldValue.increment(quantity),
                        });
                    } else {
                        product.quantity += quantity;
                    }

                    await addToHistory(
                        "Aumento de stock",
                        product.name,
                        `Cantidad agregada: ${quantity}, Nuevo stock: ${product.quantity + (isFirebaseReady ? 0 : 0)
                        }`
                    );
                    showOperationSuccess("Stock actualizado exitosamente");
                } catch (error) {
                    console.error("Error actualizando stock:", error);
                    alert("❌ Error actualizando stock. Intenta nuevamente.");
                }
            } else {
                alert("❌ Producto no encontrado");
            }
        }

        async function lendProduct(event) {
            event.preventDefault();

            const code = document.getElementById("lendCode").value.trim();
            const quantity = parseInt(
                document.getElementById("lendQuantity").value
            );
            const borrowerName = document
                .getElementById("borrowerName")
                .value.trim();
            const borrowerRut = document.getElementById("borrowerRut").value.trim();
            const borrowerEmail = document
                .getElementById("borrowerEmail")
                .value.trim();
            const returnDate = document.getElementById("returnDate").value;

            if (
                !code ||
                !quantity ||
                !borrowerName ||
                !borrowerRut ||
                !borrowerEmail ||
                !returnDate
            ) {
                alert("❌ Por favor completa todos los campos");
                return;
            }

            const product = products.find((p) => p.code === code);
            if (product && product.quantity >= quantity) {
                try {
                    const loan = {
                        productCode: code,
                        productName: product.name,
                        quantity: quantity,
                        borrower: borrowerName,
                        borrowerRut: borrowerRut,
                        borrowerEmail: borrowerEmail,
                        loanDate: new Date().toISOString().split("T")[0],
                        returnDate: returnDate,
                        status: "Activo",
                        createdAt: isFirebaseReady
                            ? firebase.firestore.FieldValue.serverTimestamp()
                            : new Date().toISOString(),
                    };

                    if (isFirebaseReady) {
                        await db.collection("loans").add(loan);
                        const productRef = db.collection("products").doc(product.id);
                        await productRef.update({
                            quantity: firebase.firestore.FieldValue.increment(-quantity),
                        });
                    } else {
                        loan.id = loans.length + 1;
                        loans.push(loan);
                        product.quantity -= quantity;
                    }

                    await addToHistory(
                        "Préstamo registrado",
                        product.name,
                        `Cantidad: ${quantity}, Solicitante: ${borrowerName}, Vence: ${returnDate}`
                    );

                    // Intentar enviar correo
                    const emailSent = await sendLoanEmail(loan);

                    if (emailSent) {
                        showOperationSuccess("¡Préstamo registrado exitosamente! Se envió confirmación por correo electrónico.");
                    } else {
                        showOperationSuccess("Préstamo registrado exitosamente");
                    }

                } catch (error) {
                    console.error("Error registrando préstamo:", error);
                    alert("❌ Error registrando préstamo. Intenta nuevamente.");
                }
            } else if (!product) {
                alert("❌ Producto no encontrado");
            } else {
                alert(
                    `❌ Stock insuficiente. Stock disponible: ${product.quantity}, Solicitado: ${quantity}`
                );
            }
        }

        async function returnProduct(event) {
            event.preventDefault();

            const code = document.getElementById("returnCode").value.trim();
            const borrowerRut = document.getElementById("returnBorrowerRut").value.trim();
            const quantity = parseInt(document.getElementById("returnQuantity").value);
            const observation = document.getElementById("returnObservation").value;

            if (!code || !borrowerRut || !quantity) {
                alert("❌ Por favor completa todos los campos obligatorios");
                return;
            }

            if (!window.currentLoanInfo) {
                alert("❌ Error: Información del préstamo no encontrada. Verifica los datos nuevamente.");
                return;
            }

            const { loan, isGroupLoan, selectedCode } = window.currentLoanInfo;
            const returnType = document.querySelector('input[name="returnType"]:checked')?.value || 'individual';

            try {
                if (isGroupLoan) {
                    await processGroupLoanReturn(loan, selectedCode, quantity, returnType, observation, borrowerRut);
                } else {
                    await processIndividualLoanReturn(loan, quantity, observation, borrowerRut);
                }

            } catch (error) {
                console.error("Error procesando devolución:", error);
                alert("❌ Error procesando devolución. Intenta nuevamente.");
            }
        }

        // Procesar devolución de préstamo grupal
        async function processGroupLoanReturn(loan, selectedCode, quantity, returnType, observation, borrowerRut) {
            const returnedCodes = loan.returnedCodes || [];
            const pendingCodes = loan.individualCodes.filter(code => !returnedCodes.includes(code));

            if (returnType === 'individual') {
                // Devolución individual de un código
                if (returnedCodes.includes(selectedCode)) {
                    alert("❌ Este código ya fue devuelto anteriormente");
                    return;
                }

                // Actualizar stock del producto específico
                const product = products.find(p => p.code === selectedCode);
                if (product) {
                    if (isFirebaseReady) {
                        const productRef = db.collection("products").doc(product.id);
                        await productRef.update({
                            quantity: firebase.firestore.FieldValue.increment(1),
                        });
                    } else {
                        product.quantity += 1;
                    }
                }

                // Actualizar el préstamo grupal
                const newReturnedCodes = [...returnedCodes, selectedCode];
                const isComplete = newReturnedCodes.length >= loan.individualCodes.length;

                if (isFirebaseReady) {
                    const loanRef = db.collection("loans").doc(loan.id);
                    await loanRef.update({
                        returnedCodes: newReturnedCodes,
                        status: isComplete ? "Devuelto" : "Parcialmente devuelto",
                        lastReturnDate: new Date().toISOString().split("T")[0],
                        lastReturnObservation: observation || "Sin observaciones",
                        processedBy: currentUser
                    });
                } else {
                    loan.returnedCodes = newReturnedCodes;
                    loan.status = isComplete ? "Devuelto" : "Parcialmente devuelto";
                    loan.lastReturnDate = new Date().toISOString().split("T")[0];
                    loan.lastReturnObservation = observation || "Sin observaciones";
                    loan.processedBy = currentUser;
                }

                await addToHistory(
                    "Devolución parcial grupal",
                    loan.productName,
                    `${loan.borrower}: Código ${selectedCode} devuelto. Restantes: ${pendingCodes.length - 1}/${loan.individualCodes.length}`
                );

                showOperationSuccess(`✅ Devolución individual procesada

📦 Producto: ${loan.productName}
🏷️ Código devuelto: ${selectedCode}
👤 Solicitante: ${loan.borrower}
📊 Progreso: ${newReturnedCodes.length}/${loan.individualCodes.length} devueltos
${isComplete ? '🎉 ¡Préstamo completamente devuelto!' : `⏳ Pendientes: ${loan.individualCodes.length - newReturnedCodes.length} códigos`}`);

            } else if (returnType === 'complete') {
                // Devolución completa de todos los códigos pendientes

                // Actualizar stock de todos los productos pendientes
                for (const codeToReturn of pendingCodes) {
                    const product = products.find(p => p.code === codeToReturn);
                    if (product) {
                        if (isFirebaseReady) {
                            const productRef = db.collection("products").doc(product.id);
                            await productRef.update({
                                quantity: firebase.firestore.FieldValue.increment(1),
                            });
                        } else {
                            product.quantity += 1;
                        }
                    }
                }

                // Marcar préstamo como completamente devuelto
                if (isFirebaseReady) {
                    const loanRef = db.collection("loans").doc(loan.id);
                    await loanRef.update({
                        status: "Devuelto",
                        returnedDate: new Date().toISOString().split("T")[0],
                        returnedCodes: loan.individualCodes,
                        bulkReturnObservation: observation || "Devolución completa sin observaciones",
                        processedBy: currentUser
                    });
                } else {
                    loan.status = "Devuelto";
                    loan.returnedDate = new Date().toISOString().split("T")[0];
                    loan.returnedCodes = loan.individualCodes;
                    loan.bulkReturnObservation = observation || "Devolución completa sin observaciones";
                    loan.processedBy = currentUser;
                }

                await addToHistory(
                    "Devolución completa grupal",
                    loan.productName,
                    `${loan.borrower}: Todos los códigos devueltos (${pendingCodes.length} unidades)`
                );

                showOperationSuccess(`Devolución completa procesada

📦 Producto: ${loan.productName}
👤 Solicitante: ${loan.borrower}
📊 Códigos devueltos: ${pendingCodes.length}
🏷️ Códigos: ${pendingCodes.join(', ')}
🎉 Préstamo completamente cerrado`);
            }
        }

        // Procesar devolución de préstamo individual (función original)
        async function processIndividualLoanReturn(loan, quantity, observation, borrowerRut) {
            if (quantity > loan.quantity) {
                alert(`❌ No puedes devolver más cantidad de la prestada.\nPrestado: ${loan.quantity}, Intentando devolver: ${quantity}`);
                return;
            }

            const product = products.find(p => p.code === loan.productCode);
            if (!product) {
                alert("❌ Producto no encontrado en el inventario");
                return;
            }

            // Aumentar el stock del producto
            if (isFirebaseReady) {
                const productRef = db.collection("products").doc(product.id);
                await productRef.update({
                    quantity: firebase.firestore.FieldValue.increment(quantity),
                });
            } else {
                product.quantity += quantity;
            }

            // Marcar el préstamo como devuelto
            if (isFirebaseReady) {
                const loanRef = db.collection("loans").doc(loan.id);
                await loanRef.update({
                    status: "Devuelto",
                    returnedDate: new Date().toISOString().split("T")[0],
                    returnedQuantity: quantity,
                    observation: observation || "Sin observaciones",
                    processedBy: currentUser
                });
            } else {
                loan.status = "Devuelto";
                loan.returnedDate = new Date().toISOString().split("T")[0];
                loan.returnedQuantity = quantity;
                loan.observation = observation || "Sin observaciones";
                loan.processedBy = currentUser;
            }

            await addToHistory(
                "Devolución individual",
                product.name,
                `${loan.borrower}: ${quantity} unidades devueltas`
            );

            showOperationSuccess(`Devolución individual procesada

📦 Producto: ${product.name}
👤 Solicitante: ${loan.borrower}
📊 Cantidad devuelta: ${quantity}
📅 Fecha: ${new Date().toLocaleDateString("es-CL")}`);
        }

        async function removeProduct(event) {
            event.preventDefault();

            const code = document.getElementById("removeCode").value.trim();
            const quantity = parseInt(
                document.getElementById("removeQuantity").value
            );
            const reason = document.getElementById("removeReason").value.trim();

            if (!code || !quantity || !reason) {
                alert("❌ Por favor completa todos los campos");
                return;
            }

            const product = products.find((p) => p.code === code);
            if (product && product.quantity >= quantity) {
                try {
                    if (isFirebaseReady) {
                        const productRef = db.collection("products").doc(product.id);
                        await productRef.update({
                            quantity: firebase.firestore.FieldValue.increment(-quantity),
                        });
                    } else {
                        product.quantity -= quantity;
                    }

                    await addToHistory(
                        "Baja de producto",
                        product.name,
                        `Cantidad: ${quantity}, Motivo: ${reason}`
                    );
                    showOperationSuccess("Producto dado de baja exitosamente");
                } catch (error) {
                    console.error("Error dando de baja:", error);
                    alert("❌ Error dando de baja producto. Intenta nuevamente.");
                }
            } else if (!product) {
                alert("❌ Producto no encontrado");
            } else {
                alert(
                    `❌ Stock insuficiente. Stock disponible: ${product.quantity}, Solicitado: ${quantity}`
                );
            }
        }

        async function addToHistory(operation, product, details) {
            const historyEntry = {
                date: new Date().toLocaleString("es-CL"),
                user: currentUser || "Usuario",
                operation: operation || "Operación",
                product: product || "Producto no especificado",
                details: details || "Sin detalles",
                timestamp: isFirebaseReady
                    ? firebase.firestore.FieldValue.serverTimestamp()
                    : new Date().toISOString(),
            };

            try {
                if (isFirebaseReady) {
                    await db.collection("history").add(historyEntry);
                } else {
                    history.unshift(historyEntry);
                }
            } catch (error) {
                console.error("Error agregando al historial:", error);
            }
        }

        function showOperationSuccess(message) {
            closeModal();
            const resultDiv = document.getElementById("operationResult");
            resultDiv.innerHTML = `
        <div class="alert alert-success">
            <span>✅</span>
            <div>${message}</div>
        </div>
    `;

            // Force update all numbers immediately
            updateDashboard();
            updateManagementInfo();

            setTimeout(() => {
                resultDiv.innerHTML = "";

                // Redireccionar según el rol
                if (currentRole === "admin") {
                    showTab("dashboard");
                    setTimeout(() => {
                        updateDashboard();
                    }, 100);
                } else if (currentRole === "operator") {
                    showTab("inventory");
                }

                // Scroll al top
                window.scrollTo(0, 0);
            }, 3000);
        }

        // Función para solicitar eliminación del historial (solo admin)
        function requestDeleteHistory() {
            if (currentRole !== "admin") {
                alert("❌ Solo el administrador puede eliminar el historial");
                return;
            }

            // Mostrar advertencia inicial
            const confirmAction = confirm(`⚠️ ADVERTENCIA CRÍTICA ⚠️

¿Estás seguro de que deseas ELIMINAR COMPLETAMENTE todo el historial?

📋 Información que se perderá:
- Registro de todas las operaciones realizadas
- Fechas y usuarios que ejecutaron acciones
- Historial de préstamos, devoluciones y bajas
- Toda la trazabilidad del sistema

🚨 ESTA ACCIÓN NO SE PUEDE DESHACER 🚨

¿Deseas continuar?`);

            if (!confirmAction) {
                return;
            }

            // Solicitar contraseña de administrador
            const adminPassword = prompt(`🔐 Para continuar, ingresa la contraseña de administrador:

⚠️ ÚLTIMA ADVERTENCIA:
Esta acción eliminará PERMANENTEMENTE todo el historial del sistema.

Contraseña de administrador:`);

            if (adminPassword === "AdminLiceo2025!") {
                // Confirmación final
                const finalConfirmation = prompt(`✍️ Para confirmar la eliminación completa del historial, escribe exactamente:

ELIMINAR HISTORIAL

(Debe ser exactamente como se muestra, respetando mayúsculas)`);

                if (finalConfirmation === "ELIMINAR HISTORIAL") {
                    deleteCompleteHistory();
                } else {
                    alert("❌ Confirmación incorrecta. Operación cancelada por seguridad.");
                }
            } else {
                alert("❌ Contraseña incorrecta. Operación cancelada.");
            }
        }

        // Función para eliminar todo el historial
        async function deleteCompleteHistory() {
            try {
                updateConnectionStatus("syncing");

                if (isFirebaseReady) {
                    // Obtener todos los documentos del historial
                    const snapshot = await db.collection("history").get();

                    // Crear un batch para eliminar todos los documentos
                    const batch = db.batch();
                    snapshot.docs.forEach((doc) => {
                        batch.delete(doc.ref);
                    });

                    // Ejecutar la eliminación en batch
                    await batch.commit();
                    console.log("✅ Historial eliminado de Firebase");
                }

                // Limpiar array local
                history.length = 0;

                // Actualizar UI inmediatamente
                updateHistory();
                updateConnectionStatus("online");

                // Registrar la acción de eliminación del historial
                await addToHistory(
                    "Eliminación de historial",
                    "Sistema completo",
                    `Historial eliminado completamente por: ${currentUser}`
                );

                alert(`✅ HISTORIAL ELIMINADO EXITOSAMENTE

📋 Se ha eliminado completamente todo el historial del sistema.
👤 Operación realizada por: ${currentUser}
📅 Fecha: ${new Date().toLocaleString("es-CL")}

El sistema continuará registrando nuevas operaciones a partir de este momento.`);

                // Refrescar la vista del historial
                setTimeout(() => {
                    if (document.querySelector(".nav-item.active").id === "tab-history") {
                        updateHistory();
                    }
                }, 1000);

            } catch (error) {
                console.error("❌ Error eliminando historial:", error);
                updateConnectionStatus("offline");
                alert(`❌ Error eliminando el historial: ${error.message}

Por favor intenta nuevamente o contacta al soporte técnico.`);
            }
        }

        function exportData(format) {
            if (format === "excel") {
                // Crear contenido con formato CSV correcto para Excel
                let csvContent =
                    "Código;Nombre;Categoría;Estado;Cantidad;Estantería;Rack;Nivel\n";

                products.forEach((product) => {
                    csvContent += `"${product.code}";"${product.name}";"${product.category}";"${product.status}";"${product.quantity}";"${product.location.shelf}";"${product.location.rack}";"${product.location.level}"\n`;
                });

                // Crear y descargar archivo
                const blob = new Blob(["\uFEFF" + csvContent], {
                    type: "text/csv;charset=utf-8;",
                });
                const link = document.createElement("a");
                link.href = URL.createObjectURL(blob);
                link.download = "Inventario_Liceo_Rios_Chile.csv";
                link.style.display = "none";
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);

                alert("📄 ¡Archivo Excel descargado exitosamente!");
            } else if (format === "pdf") {
                // Configurar estilos para impresión PDF
                const originalTitle = document.title;
                document.title = "Inventario Liceo Ríos de Chile";

                // Crear ventana de impresión con datos del inventario
                const printWindow = window.open("", "_blank");
                printWindow.document.write(`
            <!DOCTYPE html>
            <html>
            <head>
                <title>Inventario Liceo Ríos de Chile</title>
                <style>
                    @media print {
                        body { -webkit-print-color-adjust: exact !important; color-adjust: exact !important; }
                    }
                    body { 
                        font-family: Arial, sans-serif; 
                        margin: 20px; 
                        color: #000;
                        -webkit-print-color-adjust: exact;
                        color-adjust: exact;
                    }
                    .header-info { 
                        text-align: center; 
                        margin-bottom: 30px; 
                        border-bottom: 3px solid #1e7e34;
                        padding-bottom: 20px;
                    }
                    .logo { 
                        width: 70px; 
                        height: 70px; 
                        margin: 0 auto 20px; 
                        display: block;
                        padding: 5px;
                    }
                    h1 { 
                        color: #1e7e34 !important; 
                        margin-bottom: 10px; 
                        font-size: 2rem;
                        font-weight: bold;
                    }
                    h2 { 
                        color: #666 !important; 
                        margin-bottom: 20px; 
                        font-size: 1.2rem; 
                    }
                    table { 
                        width: 100%; 
                        border-collapse: collapse; 
                        margin-top: 20px; 
                        border: 2px solid #1e7e34;
                    }
                    th { 
                        border: 1px solid #000 !important; 
                        padding: 12px 8px; 
                        text-align: left; 
                        font-size: 11px; 
                        background-color: #1e7e34 !important; 
                        color: white !important; 
                        font-weight: bold;
                        -webkit-print-color-adjust: exact;
                        color-adjust: exact;
                    }
                    td { 
                        border: 1px solid #000 !important; 
                        padding: 8px; 
                        text-align: left; 
                        font-size: 10px; 
                    }
                    tr:nth-child(even) { 
                        background-color: #f5f5f5 !important;
                        -webkit-print-color-adjust: exact;
                        color-adjust: exact;
                    }
                    .export-date { 
                        text-align: right; 
                        font-size: 12px; 
                        color: #666; 
                        margin-bottom: 20px; 
                    }
                    .footer { 
                        margin-top: 30px; 
                        text-align: center; 
                        font-size: 12px; 
                        color: #666; 
                        border-top: 2px solid #1e7e34; 
                        padding-top: 20px; 
                    }
                    .code-cell { font-weight: bold !important; }
                    .quantity-cell { font-weight: bold !important; text-align: center; }
                </style>
            </head>
            <body>
                <div class="header-info">
                    <img src="LRC.png" alt="Logo" class="logo" onerror="this.style.display='none'">
                    <h1>INVENTARIO GENERAL</h1>
                    <h2>Liceo Ríos de Chile - Lirquén</h2>
                    <div class="export-date">📅 Exportado el: ${new Date().toLocaleString(
                    "es-CL"
                )}</div>
                </div>
                <table>
                    <thead>
                        <tr>
                            <th>CÓDIGO</th>
                            <th>NOMBRE</th>
                            <th>CATEGORÍA</th>
                            <th>ESTADO</th>
                            <th>CANTIDAD</th>
                            <th>ESTANTERÍA</th>
                            <th>RACK</th>
                            <th>NIVEL</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${products
                        .map(
                            (product) => `
                            <tr>
                                <td class="code-cell">${product.code}</td>
                                <td>${product.name}</td>
                                <td>${product.category}</td>
                                <td>${product.status}</td>
                                <td class="quantity-cell">${product.quantity}</td>
                                <td>${product.location.shelf}</td>
                                <td>${product.location.rack}</td>
                                <td>${product.location.level}</td>
                            </tr>
                        `
                        )
                        .join("")}
                    </tbody>
                </table>
                <div class="footer">
                    <p><strong>📊 RESUMEN:</strong> ${products.length
                    } productos registrados | ${products.reduce(
                        (sum, p) => sum + p.quantity,
                        0
                    )} unidades en stock</p>
                    <p><strong>Sistema de Inventario - Liceo Ríos de Chile</strong></p>
                    <p style="margin-top: 15px; font-size: 10px; color: #999;">Documento generado automáticamente el ${new Date().toLocaleDateString(
                        "es-CL"
                    )} a las ${new Date().toLocaleTimeString("es-CL")}</p>
                </div>
            </body>
            </html>
        `);
                printWindow.document.close();

                // Esperar a que cargue y luego imprimir
                setTimeout(() => {
                    printWindow.print();
                }, 500);

                document.title = originalTitle;
                alert("📑 ¡Preparando archivo PDF para descarga!");
            }
        }

        function hideLoading() {
            document.getElementById("loadingOverlay").style.display = "none";
        }

        // Event listeners
        window.onclick = function (event) {
            const modal = document.getElementById("operationModal");
            const infoModal = document.getElementById("infoModal");
            const requestModal = document.getElementById("requestModal");

            if (event.target === modal) {
                closeModal();
            }
            if (event.target === infoModal) {
                closeInfoModal();
            }
        };

        // Initialize
        document.addEventListener("DOMContentLoaded", function () {
            // Inicializar EmailJS al cargar la página
            initializeEmailJS();

            // Hide loading after a short delay to show the Firebase connection process
            setTimeout(() => {
                if (document.getElementById("loginScreen").style.display !== "none") {
                    hideLoading();
                }
            }, 2000);

            // Establecer fecha mínima para préstamos (hoy)
            const today = new Date().toISOString().split('T')[0];
            const returnDateInput = document.getElementById("returnDate");
            if (returnDateInput) {
                returnDateInput.min = today;
            }
        });

        // Funciones adicionales para manejo de fechas en préstamos
        function setDefaultReturnDate() {
            const returnDateInput = document.getElementById("returnDate");
            if (returnDateInput) {
                // Establecer fecha por defecto a una semana desde hoy
                const nextWeek = new Date();
                nextWeek.setDate(nextWeek.getDate() + 7);
                returnDateInput.value = nextWeek.toISOString().split('T')[0];
            }
        }

        // Función para validar email del solicitante
        function validateBorrowerEmail(email) {
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            return emailRegex.test(email);
        }

        // Función para formatear RUT automáticamente
        function formatRUT(rut) {
            // Remover todos los caracteres que no sean números o K
            rut = rut.replace(/[^0-9kK]/g, '');

            // Convertir a mayúsculas
            rut = rut.toUpperCase();

            // Validar longitud
            if (rut.length < 2) return rut;

            // Separar número y dígito verificador
            const body = rut.slice(0, -1);
            const dv = rut.slice(-1);

            // Formatear el cuerpo del RUT con puntos
            let formattedBody = '';
            for (let i = body.length - 1; i >= 0; i--) {
                if ((body.length - i) % 3 === 1 && i !== body.length - 1) {
                    formattedBody = '.' + formattedBody;
                }
                formattedBody = body[i] + formattedBody;
            }

            return formattedBody + '-' + dv;
        }

        // Agregar event listeners para formateo automático de RUT
        document.addEventListener('input', function (e) {
            if (e.target.id === 'borrowerRut' || e.target.id === 'returnBorrowerRut' || e.target.id === 'requesterRut') {
                e.target.value = formatRUT(e.target.value);
            }
        });

        // Función para verificar si EmailJS está configurado
        function checkEmailJSConfiguration() {
            if (!isEmailJSReady) {
                console.warn("⚠️ EmailJS no está configurado correctamente");
                return false;
            }

            if (emailjsConfig.publicKey === "TU_PUBLIC_KEY_AQUI" ||
                emailjsConfig.serviceId === "TU_SERVICE_ID_AQUI" ||
                emailjsConfig.templateId === "TU_TEMPLATE_ID_AQUI") {
                console.warn("⚠️ EmailJS necesita configuración personalizada");
                updateEmailStatus("error");
                return false;
            }

            return true;
        }

        // Función para mostrar información sobre configuración de EmailJS
        function showEmailJSSetupInfo() {
            if (!checkEmailJSConfiguration()) {
                alert(`📧 Para enviar correos automáticos de préstamos:

1. Crea una cuenta en EmailJS (https://emailjs.com)
2. Configura un servicio de email (Gmail, Outlook, etc.)
3. Crea un template de email para préstamos
4. Reemplaza en el código:
   - TU_PUBLIC_KEY_AQUI
   - TU_SERVICE_ID_AQUI  
   - TU_TEMPLATE_ID_AQUI

Mientras tanto, el sistema funcionará sin envío de correos.`);
            }
        }

        // Función mejorada para manejar errores de EmailJS
        function handleEmailError(error) {
            console.error("Error de EmailJS:", error);

            let userMessage = "Hubo un problema enviando el correo de confirmación.";

            if (error.text) {
                if (error.text.includes("not found")) {
                    userMessage += " Verifica la configuración del servicio.";
                } else if (error.text.includes("limit")) {
                    userMessage += " Se alcanzó el límite de correos del mes.";
                } else if (error.text.includes("invalid")) {
                    userMessage += " Los datos del correo son inválidos.";
                }
            }

            return userMessage;
        }

        // Template de ejemplo para EmailJS
        const emailTemplateExample = `
        Hola {{to_name}},

        Se ha registrado un préstamo a tu nombre en el {{liceo_name}}.

        📦 Producto: {{product_name}}
        🏷️ Código: {{product_code}}
        📊 Cantidad: {{quantity}}
        📅 Fecha de préstamo: {{loan_date}}
        📅 Fecha de devolución: {{return_date}}
        
        👤 Solicitante: {{borrower_name}}
        🆔 RUT: {{borrower_rut}}

        Por favor, devuelve el producto en la fecha indicada.

        Para consultas, contacta: {{contact_email}}

        Saludos,
        {{system_name}}
        `;

        // Función para descargar template de ejemplo
        function downloadEmailTemplate() {
            const blob = new Blob([emailTemplateExample], { type: 'text/plain' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = 'template_emailjs_prestamo.txt';
            link.click();
        }

        // Agregar funcionalidad para auto-completar fecha de retorno basada en categoría
        function setReturnDateByCategory() {
            const lendCodeInput = document.getElementById('lendCode');
            const returnDateInput = document.getElementById('returnDate');

            if (lendCodeInput && returnDateInput && lendCodeInput.value) {
                const product = products.find(p => p.code === lendCodeInput.value.trim());
                if (product) {
                    const today = new Date();
                    let daysToAdd = 7; // Default: 1 semana

                    // Ajustar días según categoría
                    switch (product.category) {
                        case 'Equipo':
                            daysToAdd = 7; // 1 semana para equipos
                            break;
                        case 'Libro':
                            daysToAdd = 21; // 3 semanas para libros
                            break;
                        case 'Material':
                            daysToAdd = 3; // 3 días para materiales
                            break;
                        case 'Herramienta':
                            daysToAdd = 7; // 1 semana para herramientas
                            break;
                        case 'Documento':
                            daysToAdd = 1; // 1 día para documentos
                            break;
                    }

                    today.setDate(today.getDate() + daysToAdd);
                    returnDateInput.value = today.toISOString().split('T')[0];
                }
            }
        }

        // Event listener para auto-completar fecha cuando se verifica un producto
        document.addEventListener('blur', function (e) {
            if (e.target.id === 'lendCode') {
                setTimeout(setReturnDateByCategory, 500); // Delay para que se ejecute después de verifyProduct
            } else if (e.target.id === 'returnBorrowerRut' || e.target.id === 'returnCode') {
                setTimeout(verifyActiveLoan, 300); // Verificar préstamo activo al cambiar RUT o código
            }
        });

        // Función para validar que la fecha de retorno no sea en el pasado
        function validateReturnDate(dateString) {
            const returnDate = new Date(dateString);
            const today = new Date();
            today.setHours(0, 0, 0, 0); // Resetear horas para comparación solo de fecha

            return returnDate >= today;
        }

        // Mejorar validación en el formulario de préstamo
        function validateLoanForm() {
            const borrowerEmail = document.getElementById('borrowerEmail').value;
            const returnDate = document.getElementById('returnDate').value;
            const borrowerRut = document.getElementById('borrowerRut').value;

            if (!validateBorrowerEmail(borrowerEmail)) {
                alert('❌ Por favor ingresa un correo electrónico válido');
                return false;
            }

            if (!validateReturnDate(returnDate)) {
                alert('❌ La fecha de devolución no puede ser en el pasado');
                return false;
            }

            if (borrowerRut.length < 11) { // RUT mínimo formateado: 1.111.111-1
                alert('❌ Por favor ingresa un RUT válido con el formato correcto');
                return false;
            }

            return true;
        }

        // Función para mostrar estadísticas de préstamos por correo (solo admin)
        function showLoanEmailStats() {
            if (currentRole !== 'admin') return;

            const totalLoans = loans.length;
            const activeLoans = loans.filter(l => l.status === 'Activo').length;
            const overdueLoans = loans.filter(l => {
                if (l.status !== 'Activo') return false;
                const returnDate = new Date(l.returnDate);
                const today = new Date();
                return returnDate < today;
            }).length;

            console.log(`📊 Estadísticas de préstamos:
- Total: ${totalLoans}
- Activos: ${activeLoans}  
- Vencidos: ${overdueLoans}`);
        }

        // Agregar función para recordatorios automáticos (concepto para futuras mejoras)
        function setupLoanReminders() {
            // Esta función podría expandirse para enviar recordatorios automáticos
            // usando un servicio como EmailJS con scheduled sends o webhooks
            console.log('🔔 Sistema de recordatorios configurado');
        }

        // Función de utilidad para logging de operaciones de email
        function logEmailOperation(operation, status, details = '') {
            const logEntry = {
                timestamp: new Date().toISOString(),
                operation: operation,
                status: status,
                details: details,
                user: currentUser || 'Sistema'
            };

            console.log('📧 Email Log:', logEntry);

            // En una implementación completa, esto podría guardarse en Firebase
            // para auditoría de correos enviados
        }

        // FUNCIONES PARA SISTEMA DE SOLICITUDES

        // Abrir modal de solicitud
        function openRequestModal() {
            const modal = document.getElementById('requestModal');
            modal.style.display = 'block';

            // Establecer fecha mínima (hoy)
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('requestedDate').min = today;

            // Establecer fecha por defecto (mañana)
            const tomorrow = new Date();
            tomorrow.setDate(tomorrow.getDate() + 1);
            document.getElementById('requestedDate').value = tomorrow.toISOString().split('T')[0];

            // Limpiar verificación previa
            document.getElementById('productVerification').classList.add('hidden');
        }

        // Cerrar modal de solicitud
        function closeRequestModal() {
            document.getElementById('requestModal').style.display = 'none';
            document.getElementById('requestForm').reset();
            document.getElementById('productVerification').classList.add('hidden');
        }

        async function approveRequest(requestId) {
            const request = productRequests.find(r => r.id === requestId);
            if (!request) {
                alert('❌ Solicitud no encontrada');
                return;
            }

            const confirmed = confirm(`¿Aprobar solicitud y crear préstamo automático?

📋 Detalles:
- Solicitante: ${request.requesterName}
- Producto: ${request.productName} 
- Cantidad: ${request.requestedQuantity}

Se creará el préstamo automáticamente.`);

            if (confirmed) {
                try {
                    // Crear préstamo automáticamente
                    const loan = {
                        productCode: request.productCode,
                        productName: request.productName,
                        quantity: request.requestedQuantity,
                        borrower: request.requesterName,
                        borrowerRut: request.requesterRut,
                        borrowerEmail: request.requesterEmail,
                        loanDate: new Date().toISOString().split("T")[0],
                        returnDate: request.requestedDate,
                        status: "Activo",
                        origin: "Solicitud aprobada",
                        createdAt: isFirebaseReady
                            ? firebase.firestore.FieldValue.serverTimestamp()
                            : new Date().toISOString(),
                    };

                    // Encontrar el producto y reducir stock
                    const product = products.find(p => p.code === request.productCode);
                    if (product && product.quantity >= request.requestedQuantity) {
                        // Guardar préstamo
                        if (isFirebaseReady) {
                            await db.collection("loans").add(loan);
                            const productRef = db.collection("products").doc(product.id);
                            await productRef.update({
                                quantity: firebase.firestore.FieldValue.increment(-request.requestedQuantity),
                            });
                        } else {
                            loan.id = loans.length + 1;
                            loans.push(loan);
                            product.quantity -= request.requestedQuantity;
                        }

                        // Marcar solicitud como aprobada
                        request.status = 'Aprobada';
                        request.approvedDate = new Date().toISOString();
                        request.approvedBy = currentUser;
                        if (isFirebaseReady) {
                            // Buscar el documento por contenido en lugar de por ID
                            const querySnapshot = await db.collection('productRequests')
                                .where('requesterRut', '==', request.requesterRut)
                                .where('productCode', '==', request.productCode)
                                .where('status', '==', 'Pendiente')
                                .limit(1)
                                .get();

                            if (!querySnapshot.empty) {
                                const doc = querySnapshot.docs[0];
                                await doc.ref.update({
                                    status: 'Aprobada',
                                    approvedDate: firebase.firestore.FieldValue.serverTimestamp(),
                                    approvedBy: currentUser
                                });
                                // Actualizar el request local con el ID correcto
                                request.id = doc.id;
                            }
                        }

                        // Registrar en historial
                        await addToHistory(
                            'Solicitud aprobada',
                            request.productName,
                            `Solicitante: ${request.requesterName}, Préstamo creado automáticamente`
                        );

                        alert('✅ Solicitud aprobada y préstamo creado exitosamente');
                        const approvalEmailData = {
                            requesterName: request.requesterName,
                            requesterRut: request.requesterRut,
                            requesterEmail: request.requesterEmail,
                            productName: request.productName,
                            productCode: request.productCode,
                            quantity: request.requestedQuantity,
                            loanDate: new Date().toLocaleDateString('es-CL'),
                            returnDate: new Date(request.requestedDate).toLocaleDateString('es-CL'),
                            approvedBy: currentUser
                        };
                        updateNotifications();
                        updateDashboard();
                    } else {
                        alert('❌ Stock insuficiente para aprobar la solicitud');
                    }
                } catch (error) {
                    console.error('Error aprobando solicitud:', error);
                    alert('❌ Error aprobando solicitud. Intenta nuevamente.');
                }
            }
        }

        async function rejectRequest(requestId) {
            const request = productRequests.find(r => r.id === requestId);
            if (!request) {
                alert('❌ Solicitud no encontrada');
                return;
            }

            const reason = prompt(`Motivo del rechazo para ${request.requesterName}:`);

            if (reason && reason.trim()) {
                // Marcar solicitud como rechazada
                request.status = 'Rechazada';
                request.rejectedDate = new Date().toISOString();
                request.rejectionReason = reason.trim();
                if (isFirebaseReady) {
                    // Buscar el documento por contenido en lugar de por ID
                    const querySnapshot = await db.collection('productRequests')
                        .where('requesterRut', '==', request.requesterRut)
                        .where('productCode', '==', request.productCode)
                        .where('status', '==', 'Pendiente')
                        .limit(1)
                        .get();

                    if (!querySnapshot.empty) {
                        const doc = querySnapshot.docs[0];
                        await doc.ref.update({
                            status: 'Rechazada',
                            rejectedDate: firebase.firestore.FieldValue.serverTimestamp(),
                            rejectedBy: currentUser,
                            rejectionReason: reason.trim()
                        });
                        // Actualizar el request local con el ID correcto
                        request.id = doc.id;
                    }
                }

                // Registrar en historial
                await addToHistory(
                    'Solicitud rechazada',
                    request.productName,
                    `Solicitante: ${request.requesterName}, Motivo: ${reason.trim()}`
                );

                alert(`❌ Solicitud rechazada. Motivo: ${reason}`);
                updateNotifications();
            }
        }

        function viewRequestDetails(requestId) {
            const request = productRequests.find(r => r.id === requestId);
            if (!request) {
                alert('❌ Solicitud no encontrada');
                return;
            }

            const details = `📋 DETALLES DE LA SOLICITUD

👤 Solicitante: ${request.requesterName}
🆔 RUT: ${request.requesterRut}
📧 Email: ${request.requesterEmail}

📦 Producto: ${request.productName}
🏷️ Código: ${request.productCode}
📊 Cantidad: ${request.requestedQuantity} unidades
📅 Fecha necesaria: ${new Date(request.requestedDate).toLocaleDateString('es-CL')}

📝 Motivo: ${request.requestReason || 'No especificado'}

📅 Fecha de solicitud: ${new Date(request.requestDate).toLocaleString('es-CL')}
🔄 Estado: ${request.status}`;

            alert(details);
        }

        // Variables para solicitudes múltiples
        let requestedProducts = [];
        let currentVerifiedProduct = null;

        // Configurar fechas mínimas al abrir modal
        function openRequestModal() {
            const modal = document.getElementById('requestModal');
            modal.style.display = 'block';

            // Establecer fecha mínima (48 horas desde ahora)
            const twoDaysFromNow = new Date();
            twoDaysFromNow.setDate(twoDaysFromNow.getDate() + 2);
            const minDate = twoDaysFromNow.toISOString().split('T')[0];

            document.getElementById('requestedDate').min = minDate;
            document.getElementById('returnDate').min = minDate;

            // Establecer fechas por defecto
            const threeDaysFromNow = new Date();
            threeDaysFromNow.setDate(threeDaysFromNow.getDate() + 3);
            document.getElementById('requestedDate').value = threeDaysFromNow.toISOString().split('T')[0];

            const oneWeekFromNow = new Date();
            oneWeekFromNow.setDate(oneWeekFromNow.getDate() + 7);
            document.getElementById('returnDate').value = oneWeekFromNow.toISOString().split('T')[0];

            // Limpiar lista de productos
            requestedProducts = [];
            updateProductsList();
            updateSubmitButton();

            // Agregar validación de fechas
            document.getElementById('requestedDate').addEventListener('change', validateDates);
            document.getElementById('returnDate').addEventListener('change', validateDates);
        }

        // Confirmar cierre del modal
        function confirmCloseRequestModal() {
            if (requestedProducts.length > 0 ||
                document.getElementById('requesterName').value.trim() ||
                document.getElementById('requesterEmail').value.trim()) {

                const confirmed = confirm('⚠️ ¿Estás seguro de cerrar?\n\nPerderás todo el progreso de tu solicitud.');
                if (confirmed) {
                    closeRequestModal();
                }
                return confirmed
            } else {
                closeRequestModal();
                return true;
            }
        }

        // Cerrar modal
        function closeRequestModal() {
            document.getElementById('requestModal').style.display = 'none';
            document.getElementById('requestForm').reset();
            requestedProducts = [];
            currentVerifiedProduct = null;
            updateProductsList();
            document.getElementById('newProductVerification').classList.add('hidden');
        }

        // Verificar nuevo producto
        function verifyNewProduct() {
            const input = document.getElementById('newProductInput');
            const verification = document.getElementById('newProductVerification');
            const query = input.value.trim().toLowerCase();

            if (!query) {
                verification.classList.add('hidden');
                currentVerifiedProduct = null;
                return;
            }

            verification.classList.remove('hidden');
            verification.className = 'product-verification product-searching';
            verification.innerHTML = '🔍 Buscando productos...';

            setTimeout(() => {
                // Buscar productos que coincidan por código o nombre
                console.log('🔍 Buscando productos con query:', query);
                console.log('📦 Total productos en sistema:', products.length);

                // Buscar productos que coincidan por código o nombre (búsqueda más flexible)
                const matchingProducts = products.filter(p => {
                    if (!p || p.status !== 'Disponible') return false;

                    const productCode = (p.code || '').toLowerCase();
                    const productName = (p.name || '').toLowerCase();

                    // Búsqueda por código exacto o parcial
                    const codeMatch = productCode.includes(query);

                    // Búsqueda por nombre exacto o por palabras clave
                    const nameExactMatch = productName === query;
                    const namePartialMatch = productName.includes(query);

                    // Si la query es corta (menos de 3 caracteres), solo búsqueda exacta
                    if (query.length < 3) {
                        return codeMatch || nameExactMatch;
                    }

                    // Para queries más largas, búsqueda más flexible
                    return codeMatch || nameExactMatch || namePartialMatch;
                });

                console.log('✅ Productos encontrados:', matchingProducts.length);
                console.log('📋 Lista de productos encontrados:', matchingProducts.map(p => ({
                    codigo: p.code,
                    nombre: p.name,
                    cantidad: p.quantity,
                    estado: p.status
                })));

                if (matchingProducts.length === 0) {
                    verification.className = 'product-verification product-not-found';
                    verification.innerHTML = `
                <div><strong>❌ Producto no encontrado</strong></div>
                <div>No se encontró ningún producto disponible con ese nombre o código.</div>
            `;
                    currentVerifiedProduct = null;
                    return;
                }

                // Agrupar productos por nombre para mostrar stock total
                const productGroups = {};
                matchingProducts.forEach(product => {
                    // Usar el nombre exacto como key (sin convertir a minúsculas para preservar formato)
                    const key = product.name.toLowerCase().trim();
                    const displayName = product.name.trim();

                    if (!productGroups[key]) {
                        productGroups[key] = {
                            name: displayName,
                            category: product.category,
                            codes: [],
                            totalStock: 0,
                            totalUnits: 0,
                            sampleProduct: product
                        };
                    }

                    // Agregar cada código individual
                    productGroups[key].codes.push({
                        code: product.code,
                        quantity: product.quantity,
                        location: product.location,
                        id: product.id
                    });

                    // Sumar stock (cada producto individual contribuye con su cantidad)
                    productGroups[key].totalStock += (product.quantity || 1);
                    productGroups[key].totalUnits += 1; // Contar unidades físicas
                });

                console.log('📊 Grupos creados:', Object.keys(productGroups).length);
                Object.values(productGroups).forEach(group => {
                    console.log(`🏷️ ${group.name}: ${group.totalStock} unidades en ${group.codes.length} códigos`);
                });

                // Mostrar resultados agrupados
                const groupNames = Object.keys(productGroups);

                if (groupNames.length === 1) {
                    // Un solo tipo de producto encontrado
                    const group = productGroups[groupNames[0]];

                    // Verificar si ya está en la lista
                    const alreadyAdded = requestedProducts.find(rp =>
                        rp.name.toLowerCase() === group.name.toLowerCase()
                    );

                    if (alreadyAdded) {
                        verification.className = 'product-verification product-not-found';
                        verification.innerHTML = `
                    <div><strong>⚠️ Producto ya agregado</strong></div>
                    <div>Este producto ya está en tu lista de solicitudes.</div>
                `;
                        currentVerifiedProduct = null;
                    } else {
                        verification.className = 'product-verification product-found';
                        verification.innerHTML = `
    <div><strong>✅ Producto encontrado:</strong></div>
    <div><strong>📦 Nombre:</strong> ${group.name}</div>
    <div><strong>📂 Categoría:</strong> ${group.category}</div>
    <div><strong>📊 Stock total disponible:</strong> ${group.totalStock} unidades</div>
    <div><strong>🏷️ Códigos disponibles:</strong> ${group.codes.length} códigos individuales</div>
    <div style="margin-top: 0.5rem; padding: 0.5rem; background: rgba(52, 152, 219, 0.1); border-radius: 0.5rem; font-size: 0.85rem;">
        <strong>📋 Detalle de códigos:</strong><br>
        ${group.codes.slice(0, 5).map(c => `• ${c.code} (${c.quantity} und.)`).join('<br>')}
        ${group.codes.length > 5 ? `<br>... y ${group.codes.length - 5} códigos más` : ''}
    </div>
    <div style="margin-top: 0.5rem; padding: 0.5rem; background: rgba(30, 126, 52, 0.1); border-radius: 0.5rem; font-size: 0.85rem;">
        💡 <strong>Tip:</strong> Puedes solicitar hasta ${Math.min(group.totalStock, 40)} unidades y el sistema asignará automáticamente los códigos disponibles.
    </div>
`;
                        currentVerifiedProduct = {
                            name: group.name,
                            category: group.category,
                            totalStock: group.totalStock,
                            availableCodes: group.codes,
                            isGrouped: true
                        };

                        // Establecer cantidad máxima
                        const quantityInput = document.getElementById('newQuantityInput');
                        const maxQuantity = Math.min(group.totalStock, 40);
                        quantityInput.max = maxQuantity;

                        if (parseInt(quantityInput.value) > maxQuantity) {
                            quantityInput.value = Math.min(maxQuantity, 1);
                        }
                    }
                } else {
                    // Múltiples tipos de productos encontrados
                    verification.className = 'product-verification product-found';
                    let html = `<div><strong>✅ Se encontraron ${groupNames.length} tipos de productos:</strong></div>`;

                    Object.values(productGroups).forEach(group => {
                        html += `
                    <div style="margin: 0.5rem 0; padding: 0.5rem; border: 1px solid var(--gray-300); border-radius: 0.5rem; cursor: pointer;" 
                         onclick="selectSpecificProduct('${group.name}')">
                        <div><strong>📦 ${group.name}</strong></div>
                        <div style="font-size: 0.85rem; color: var(--gray-600);">
                            📊 ${group.totalStock} unidades disponibles | 📂 ${group.category}
                        </div>
                    </div>
                `;
                    });

                    html += `<div style="margin-top: 0.5rem; font-size: 0.85rem; color: var(--gray-600);">
                👆 Haz clic en el producto que deseas solicitar
            </div>`;

                    verification.innerHTML = html;
                    currentVerifiedProduct = null;
                }
            }, 500);
        }

        // Agregar producto a la lista
        function addProductToList() {
            if (!currentVerifiedProduct) {
                alert('❌ Primero debes buscar y verificar un producto válido');
                return;
            }

            const quantity = parseInt(document.getElementById('newQuantityInput').value) || 1;

            if (quantity < 1 || quantity > 40) {
                alert('❌ La cantidad debe estar entre 1 y 40');
                return;
            }

            let totalAvailable;
            if (currentVerifiedProduct.isGrouped) {
                totalAvailable = currentVerifiedProduct.totalStock;
            } else {
                totalAvailable = currentVerifiedProduct.quantity;
            }

            if (quantity > totalAvailable) {
                alert(`❌ No hay suficiente stock. Disponible: ${totalAvailable} unidades`);
                return;
            }

            // Agregar a la lista
            const productToAdd = {
                name: currentVerifiedProduct.name,
                quantity: quantity,
                category: currentVerifiedProduct.category,
                availableStock: totalAvailable,
                isGrouped: currentVerifiedProduct.isGrouped || false
            };

            // Si es un producto agrupado, agregar información de códigos
            if (currentVerifiedProduct.isGrouped) {
                productToAdd.availableCodes = currentVerifiedProduct.availableCodes;
                productToAdd.codesNeeded = quantity;
            } else {
                productToAdd.code = currentVerifiedProduct.code;
            }

            requestedProducts.push(productToAdd);

            // Limpiar campos
            document.getElementById('newProductInput').value = '';
            document.getElementById('newQuantityInput').value = '1';
            document.getElementById('newProductVerification').classList.add('hidden');
            currentVerifiedProduct = null;

            // Actualizar UI
            updateProductsList();
            updateSubmitButton();

            // Mostrar mensaje de éxito
            const verification = document.getElementById('newProductVerification');
            verification.classList.remove('hidden');
            verification.className = 'product-verification product-found';
            verification.innerHTML = `✅ ${quantity} unidad${quantity > 1 ? 'es' : ''} de "${productToAdd.name}" agregada${quantity > 1 ? 's' : ''} a tu solicitud`;

            setTimeout(() => {
                verification.classList.add('hidden');
            }, 2000);
        }

        // Actualizar lista de productos
        function updateProductsList() {
            const container = document.getElementById('productsListContainer');
            const listDiv = document.getElementById('productsList');
            const totalSpan = document.getElementById('totalProducts');

            if (requestedProducts.length === 0) {
                listDiv.classList.add('hidden');
                return;
            }

            listDiv.classList.remove('hidden');
            totalSpan.textContent = requestedProducts.length;

            container.innerHTML = requestedProducts.map((product, index) => {
                let codeInfo = '';
                if (product.isGrouped) {
                    codeInfo = `<span>🏷️ Códigos: Se asignarán automáticamente (${product.quantity} unidades)</span>`;
                } else {
                    codeInfo = `<span>🏷️ Código: ${product.code}</span>`;
                }

                return `
            <div class="product-item">
                <div class="product-item-info">
                    <div class="product-item-name">${product.name}</div>
                    <div class="product-item-details">
                        ${codeInfo}
                        <span>📊 Cantidad: ${product.quantity}</span>
                        <span>📂 Categoría: ${product.category}</span>
                        <span>📦 Stock disponible: ${product.availableStock}</span>
                    </div>
                </div>
                <button type="button" class="product-item-remove" onclick="removeProductFromList(${index})" title="Eliminar producto">
                    ✕
                </button>
            </div>
        `;
            }).join('');
        }

        // Remover producto de la lista
        function removeProductFromList(index) {
            const product = requestedProducts[index];
            const confirmed = confirm(`¿Eliminar "${product.name}" de tu solicitud?`);

            if (confirmed) {
                requestedProducts.splice(index, 1);
                updateProductsList();
                updateSubmitButton();
            }
        }

        // Actualizar botón de envío
        function updateSubmitButton() {
            const submitBtn = document.getElementById('submitRequestBtn');

            if (requestedProducts.length > 0) {
                submitBtn.disabled = false;
                submitBtn.textContent = `📤 Enviar Solicitud (${requestedProducts.length} productos)`;
            } else {
                submitBtn.disabled = true;
                submitBtn.textContent = '📤 Enviar Solicitud Completa';
            }
        }

        // Validar fechas
        function validateDates() {
            const requestedDate = new Date(document.getElementById('requestedDate').value);
            const returnDate = new Date(document.getElementById('returnDate').value);
            const now = new Date();
            const twoDaysFromNow = new Date();
            twoDaysFromNow.setDate(twoDaysFromNow.getDate() + 2);

            // Validar fecha de solicitud (mínimo 48 horas)
            if (requestedDate < twoDaysFromNow) {
                showDateWarning('requestedDate', '⚠️ La fecha debe ser al menos 48 horas después de hoy');
                return false;
            }

            // Validar que fecha de devolución sea después de solicitud
            if (returnDate <= requestedDate) {
                showDateWarning('returnDate', '⚠️ La fecha de devolución debe ser posterior a la fecha solicitada');
                return false;
            }

            // Mostrar confirmación si todo está bien
            showDateSuccess();
            return true;
        }

        function showDateWarning(fieldId, message) {
            const field = document.getElementById(fieldId);
            let warning = field.parentNode.querySelector('.date-warning');

            if (warning) {
                warning.remove();
            }

            warning = document.createElement('div');
            warning.className = 'date-warning';
            warning.innerHTML = message;
            field.parentNode.appendChild(warning);
        }

        function showDateSuccess() {
            // Remover warnings previos
            document.querySelectorAll('.date-warning').forEach(w => w.remove());

            const requestedField = document.getElementById('requestedDate');
            let success = requestedField.parentNode.querySelector('.date-valid');

            if (!success) {
                success = document.createElement('div');
                success.className = 'date-valid';
                success.innerHTML = '✅ Fechas válidas - Cumple con el aviso de 48 horas';
                requestedField.parentNode.appendChild(success);
            }
        }

        // Validar que todos los productos tengan códigos válidos
        function validateProductCodes() {
            for (const product of requestedProducts) {
                if (product.isGrouped) {
                    if (!product.availableCodes || product.availableCodes.length === 0) {
                        console.error('Producto agrupado sin códigos disponibles:', product);
                        return false;
                    }
                    if (product.quantity > product.availableCodes.length) {
                        alert(`❌ Error: Se solicitan ${product.quantity} unidades de "${product.name}" pero solo hay ${product.availableCodes.length} códigos disponibles.`);
                        return false;
                    }
                } else {
                    if (!product.code) {
                        console.error('Producto individual sin código:', product);
                        return false;
                    }
                }
            }
            return true;
        }

        // Enviar solicitud múltiple
        async function submitMultipleProductRequest(event) {
            event.preventDefault();

            // Validaciones
            if (requestedProducts.length === 0) {
                alert('❌ Debes agregar al menos un producto a tu solicitud');
                return;
            }

            if (!validateDates()) {
                alert('❌ Por favor corrige las fechas antes de enviar');
                return;
            }

            if (!validateProductCodes()) {
                alert('❌ Error en la validación de productos. Por favor intenta nuevamente.');
                return;
            }

            const formData = {
                requesterName: document.getElementById('requesterName').value.trim(),
                requesterRut: document.getElementById('requesterRut').value.trim(),
                requesterEmail: document.getElementById('requesterEmail').value.trim(),
                requestedDate: document.getElementById('requestedDate').value,
                returnDate: document.getElementById('returnDate').value,
                requestReason: document.getElementById('requestReason').value.trim(),
                products: requestedProducts,
                requestDateTime: new Date().toLocaleString('es-CL'),
                status: 'Pendiente',
                totalProducts: requestedProducts.length,
                requestDate: new Date().toISOString()
            };

            // Validar email
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            if (!emailRegex.test(formData.requesterEmail)) {
                alert('❌ Por favor ingresa un correo electrónico válido');
                return;
            }

            try {
                // Guardar cada producto como solicitud separada (para compatibilidad)
                for (const product of requestedProducts) {
                    if (product.isGrouped) {
                        // Para productos agrupados, crear solicitudes individuales por cada código necesario
                        const codesNeeded = Math.min(product.quantity, product.availableCodes.length);
                        const selectedCodes = product.availableCodes.slice(0, codesNeeded);

                        for (let i = 0; i < codesNeeded; i++) {
                            const codeInfo = selectedCodes[i];
                            const singleRequest = {
                                ...formData,
                                requestedProduct: product.name,
                                productCode: codeInfo.code,
                                productName: product.name,
                                requestedQuantity: 1, // Cada código individual es 1 unidad
                                originalGroupQuantity: product.quantity,
                                isFromGroupedRequest: true,
                                groupIndex: i + 1,
                                totalInGroup: codesNeeded,
                                multipleRequestId: Date.now().toString() + '_' + Math.random().toString(36).substr(2, 9)
                            };

                            if (isFirebaseReady) {
                                const docRef = await db.collection('productRequests').add(singleRequest);
                                console.log('✅ Producto agrupado guardado:', product.name, 'Código:', codeInfo.code, 'ID:', docRef.id);
                            } else {
                                singleRequest.id = Date.now().toString() + Math.random();
                                productRequests.push(singleRequest);
                            }
                        }

                        // Registrar en historial para el grupo completo
                        await addToHistory(
                            'Solicitud múltiple (agrupada)',
                            product.name,
                            `Solicitante: ${formData.requesterName}, Cantidad: ${product.quantity} (${codesNeeded} códigos asignados), Total productos en solicitud: ${requestedProducts.length}`
                        );

                    } else {
                        // Para productos individuales (no agrupados)
                        const singleRequest = {
                            ...formData,
                            requestedProduct: product.name,
                            productCode: product.code || 'SIN_CODIGO',
                            productName: product.name,
                            requestedQuantity: product.quantity,
                            isFromGroupedRequest: false,
                            multipleRequestId: Date.now().toString() + '_' + Math.random().toString(36).substr(2, 9)
                        };

                        if (isFirebaseReady) {
                            const docRef = await db.collection('productRequests').add(singleRequest);
                            console.log('✅ Producto individual guardado:', product.name, 'ID:', docRef.id);
                        } else {
                            singleRequest.id = Date.now().toString() + Math.random();
                            productRequests.push(singleRequest);
                        }

                        // Registrar en historial para producto individual
                        await addToHistory(
                            'Solicitud múltiple',
                            product.name,
                            `Solicitante: ${formData.requesterName}, Cantidad: ${product.quantity}, Total productos en solicitud: ${requestedProducts.length}`
                        );
                    }
                }

                // Mostrar confirmación
                const totalUnits = requestedProducts.reduce((sum, p) => sum + p.quantity, 0);

                // Crear resumen detallado
                const productSummary = requestedProducts.map(p => {
                    if (p.isGrouped) {
                        const codesAssigned = Math.min(p.quantity, p.availableCodes.length);
                        return `• ${p.name}: ${p.quantity} unidades solicitadas (${codesAssigned} códigos asignados)`;
                    } else {
                        return `• ${p.name}: ${p.quantity} unidades (Código: ${p.code || 'N/A'})`;
                    }
                }).join('\n');

                // Mostrar confirmación
                alert(`✅ ¡Solicitud múltiple enviada exitosamente!

📋 Resumen:
- Productos diferentes: ${requestedProducts.length}
- Unidades totales: ${totalUnits}
- Fecha necesaria: ${new Date(formData.requestedDate).toLocaleDateString('es-CL')}
- Fecha de devolución: ${new Date(formData.returnDate).toLocaleDateString('es-CL')}

Productos solicitados:
${productSummary}

Un administrador revisará tu solicitud y te contactará por correo electrónico.`);

                closeRequestModal();

                // Actualizar notificaciones del admin si corresponde
                if (currentRole === 'admin') {
                    setTimeout(updateNotifications, 1000);
                }

            } catch (error) {
                console.error('Error enviando solicitud múltiple:', error);
                alert('❌ Error enviando la solicitud. Por favor intenta nuevamente.');
            }
        }

        // Interceptar clicks en el modal para evitar cierre accidental
        document.addEventListener('click', function (event) {
            const modal = document.getElementById('requestModal');
            const modalContent = modal?.querySelector('.modal-content');

            // Solo ejecutar si se hace click exactamente en el fondo del modal (no en el contenido)
            if (event.target === modal && modalContent && modal.style.display === 'block') {
                // Verificar si hay contenido en el formulario
                const hasContent = requestedProducts.length > 0 ||
                    document.getElementById('requesterName')?.value.trim() ||
                    document.getElementById('requesterEmail')?.value.trim();

                if (hasContent) {
                    const confirmed = confirm('⚠️ ¿Cerrar solicitud?\n\nPerderás todo el progreso si continúas.');
                    if (confirmed) {
                        closeRequestModal();
                    }
                    // Si no confirma, no hacer nada (el modal permanece abierto)
                } else {
                    closeRequestModal();
                }

                // Prevenir que el evento se propague
                event.stopPropagation();
            }
        });

        // Prevenir cierre accidental cuando se hace click dentro del contenido del modal
        function preventModalClose(event) {
            event.stopPropagation();
        }

        // Agregar el event listener al contenido del modal cuando se inicializa
        document.addEventListener('DOMContentLoaded', function () {
            const modalContent = document.querySelector('#requestModal .modal-content');
            if (modalContent) {
                modalContent.addEventListener('click', preventModalClose);
            }
        });

        function selectSpecificProduct(productName) {
            document.getElementById('newProductInput').value = productName;
            verifyNewProduct();
        }

        // Aprobar solicitudes en lote
        async function approveBulkRequest(requesterRut, productName) {
            // Buscar todas las solicitudes pendientes del usuario para este producto
            const bulkRequests = productRequests.filter(req =>
                req.status === 'Pendiente' &&
                req.requesterRut === requesterRut &&
                req.productName === productName
            );

            if (bulkRequests.length === 0) {
                alert('❌ No se encontraron solicitudes pendientes para procesar');
                return;
            }

            const firstRequest = bulkRequests[0];
            const totalQuantity = bulkRequests.reduce((sum, req) => sum + (req.requestedQuantity || 1), 0);

            const confirmed = confirm(`¿Aprobar TODAS las solicitudes en lote?

👤 Solicitante: ${firstRequest.requesterName}
📦 Producto: ${productName}
📊 Cantidad total: ${totalQuantity} unidades
🏷️ Códigos involucrados: ${bulkRequests.length}
📅 Fecha necesaria: ${new Date(firstRequest.requestedDate).toLocaleDateString('es-CL')}
📅 Fecha devolución: ${new Date(firstRequest.returnDate).toLocaleDateString('es-CL')}

Se creará UN préstamo grupal con múltiples códigos.`);

            if (!confirmed) return;

            try {
                // Verificar que todos los productos están disponibles
                const productCodes = bulkRequests.map(req => req.productCode);
                const availableProducts = products.filter(p =>
                    productCodes.includes(p.code) &&
                    p.status === 'Disponible' &&
                    p.quantity >= 1
                );

                if (availableProducts.length !== bulkRequests.length) {
                    alert(`❌ Error: Solo ${availableProducts.length} de ${bulkRequests.length} productos están disponibles actualmente.`);
                    return;
                }

                // Crear préstamo grupal
                const bulkLoan = {
                    productCode: productCodes.join(','), // Códigos separados por coma
                    productName: productName,
                    quantity: totalQuantity,
                    borrower: firstRequest.requesterName,
                    borrowerRut: firstRequest.requesterRut,
                    borrowerEmail: firstRequest.requesterEmail,
                    loanDate: new Date().toISOString().split("T")[0],
                    returnDate: firstRequest.returnDate,
                    status: "Activo",
                    origin: "Solicitud aprobada en lote",
                    bulkLoan: true,
                    individualCodes: productCodes,
                    createdAt: isFirebaseReady ? firebase.firestore.FieldValue.serverTimestamp() : new Date().toISOString(),
                };

                // Guardar préstamo
                if (isFirebaseReady) {
                    await db.collection("loans").add(bulkLoan);
                } else {
                    bulkLoan.id = loans.length + 1;
                    loans.push(bulkLoan);
                }

                // Reducir stock de todos los productos
                for (const request of bulkRequests) {
                    const product = products.find(p => p.code === request.productCode);
                    if (product) {
                        if (isFirebaseReady) {
                            const productRef = db.collection("products").doc(product.id);
                            await productRef.update({
                                quantity: firebase.firestore.FieldValue.increment(-1),
                            });
                        } else {
                            product.quantity -= 1;
                        }
                    }
                }

                // Marcar todas las solicitudes como aprobadas
                for (const request of bulkRequests) {
                    request.status = 'Aprobada';
                    request.approvedDate = new Date().toISOString();
                    request.approvedBy = currentUser;
                    request.bulkApproval = true;

                    if (isFirebaseReady && request.id) {
                        try {
                            await db.collection('productRequests').doc(request.id).update({
                                status: 'Aprobada',
                                approvedDate: firebase.firestore.FieldValue.serverTimestamp(),
                                approvedBy: currentUser,
                                bulkApproval: true
                            });
                        } catch (error) {
                            console.warn('Error actualizando solicitud individual:', error);
                        }
                    }
                }

                // Registrar en historial
                await addToHistory(
                    'Aprobación en lote',
                    productName,
                    `${firstRequest.requesterName}: ${totalQuantity} unidades, ${bulkRequests.length} códigos aprobados simultáneamente`
                );

                alert(`✅ ¡Aprobación en lote exitosa!

📦 Producto: ${productName}
👤 Solicitante: ${firstRequest.requesterName}
📊 Total aprobado: ${totalQuantity} unidades
🏷️ Códigos procesados: ${bulkRequests.length}

Se creó un préstamo grupal con todos los códigos solicitados.`);
                const bulkApprovalEmailData = {
                    requesterName: firstRequest.requesterName,
                    requesterRut: firstRequest.requesterRut,
                    requesterEmail: firstRequest.requesterEmail,
                    productName: productName,
                    assignedCodes: productCodes.slice(0, 10).join(', ') + (productCodes.length > 10 ? `... y ${productCodes.length - 10} códigos más` : ''),
                    approvedQuantity: totalQuantity,
                    loanDate: new Date().toLocaleDateString('es-CL'),
                    returnDate: new Date(firstRequest.returnDate).toLocaleDateString('es-CL'),
                    approvedBy: currentUser
                };

                sendApprovalEmail(bulkApprovalEmailData);

                updateNotifications();
                updateDashboard();

            } catch (error) {
                console.error('Error en aprobación en lote:', error);
                alert('❌ Error procesando aprobación en lote. Intenta nuevamente.');
            }
        }

        // Rechazar solicitudes en lote
        async function rejectBulkRequest(requesterRut, productName) {
            const bulkRequests = productRequests.filter(req =>
                req.status === 'Pendiente' &&
                req.requesterRut === requesterRut &&
                req.productName === productName
            );

            if (bulkRequests.length === 0) {
                alert('❌ No se encontraron solicitudes pendientes para procesar');
                return;
            }

            const firstRequest = bulkRequests[0];
            const totalQuantity = bulkRequests.reduce((sum, req) => sum + (req.requestedQuantity || 1), 0);

            const reason = prompt(`Motivo del rechazo en lote para:

👤 ${firstRequest.requesterName}
📦 ${productName} (${totalQuantity} unidades)
🏷️ ${bulkRequests.length} códigos

Ingresa el motivo:`);

            if (!reason || !reason.trim()) {
                return;
            }

            try {
                // Marcar todas las solicitudes como rechazadas
                for (const request of bulkRequests) {
                    request.status = 'Rechazada';
                    request.rejectedDate = new Date().toISOString();
                    request.rejectionReason = reason.trim();
                    request.rejectedBy = currentUser;
                    request.bulkRejection = true;

                    if (isFirebaseReady && request.id) {
                        try {
                            await db.collection('productRequests').doc(request.id).update({
                                status: 'Rechazada',
                                rejectedDate: firebase.firestore.FieldValue.serverTimestamp(),
                                rejectedBy: currentUser,
                                rejectionReason: reason.trim(),
                                bulkRejection: true
                            });
                        } catch (error) {
                            console.warn('Error actualizando solicitud individual:', error);
                        }
                    }
                }

                // Registrar en historial
                await addToHistory(
                    'Rechazo en lote',
                    productName,
                    `${firstRequest.requesterName}: ${totalQuantity} unidades rechazadas. Motivo: ${reason.trim()}`
                );

                alert(`❌ Rechazo en lote procesado

📦 Producto: ${productName}
👤 Solicitante: ${firstRequest.requesterName}
📊 Total rechazado: ${totalQuantity} unidades
📝 Motivo: ${reason.trim()}`);

                updateNotifications();

            } catch (error) {
                console.error('Error en rechazo en lote:', error);
                alert('❌ Error procesando rechazo en lote. Intenta nuevamente.');
            }
        }

        // Ver detalles de solicitud en lote
        function viewBulkRequestDetails(requesterRut, productName) {
            const bulkRequests = productRequests.filter(req =>
                req.status === 'Pendiente' &&
                req.requesterRut === requesterRut &&
                req.productName === productName
            );

            if (bulkRequests.length === 0) {
                alert('❌ No se encontraron solicitudes para mostrar');
                return;
            }

            const firstRequest = bulkRequests[0];
            const totalQuantity = bulkRequests.reduce((sum, req) => sum + (req.requestedQuantity || 1), 0);
            const codes = bulkRequests.map(req => req.productCode).join(', ');

            const details = `📋 DETALLES DE SOLICITUD EN LOTE

👤 Solicitante: ${firstRequest.requesterName}
🆔 RUT: ${firstRequest.requesterRut}
📧 Email: ${firstRequest.requesterEmail}

📦 Producto: ${productName}
📊 Cantidad total: ${totalQuantity} unidades
🏷️ Códigos involucrados: ${bulkRequests.length}
📝 Códigos específicos: ${codes}

📅 Fecha necesaria: ${new Date(firstRequest.requestedDate).toLocaleDateString('es-CL')}
📅 Fecha devolución: ${new Date(firstRequest.returnDate).toLocaleDateString('es-CL')}
📝 Motivo: ${firstRequest.requestReason || 'No especificado'}

⏰ Fecha de solicitud: ${new Date(firstRequest.requestDate).toLocaleString('es-CL')}
🔄 Estado: ${firstRequest.status}`;

            alert(details);
        }

        // Actualizar tipo de devolución según selección
        function updateReturnType() {
            const returnType = document.querySelector('input[name="returnType"]:checked')?.value;
            const quantityField = document.getElementById("returnQuantity");

            if (!window.currentLoanInfo || !quantityField) return;

            const { loan, isGroupLoan } = window.currentLoanInfo;

            if (isGroupLoan) {
                const remainingCodes = loan.individualCodes.length;
                const returnedCodes = loan.returnedCodes ? loan.returnedCodes.length : 0;
                const pendingUnits = remainingCodes - returnedCodes;

                if (returnType === 'individual') {
                    quantityField.value = 1;
                    quantityField.max = 1;
                    quantityField.disabled = true;
                } else if (returnType === 'complete') {
                    quantityField.value = pendingUnits;
                    quantityField.max = pendingUnits;
                    quantityField.disabled = false;
                }
            }
        }

        // Inicialización final del sistema
        console.log(`✅ Sistema de Inventario Liceo Ríos de Chile v4.0
📧 EmailJS: ${isEmailJSReady ? 'Configurado' : 'Requiere configuración'}
🔥 Firebase: ${isFirebaseReady ? 'Conectado' : 'Modo offline'}
👥 Usuarios soportados: Admin, Operador, Visitante`);
    </script>
</body>

</html>